<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyoMesh - Login</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCIgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0Ij4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0ic2hpbW1lckdyYWQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjM0Q4QjdBIj4KICAgICAgICA8YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJzdG9wLWNvbG9yIiB2YWx1ZXM9IiMzRDhCN0E7I0ZGQjM0NzsjRkY2QjRBOyMzRDhCN0EiIGR1cj0iM3MiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIi8+CiAgICAgIDwvc3RvcD4KICAgICAgPHN0b3Agb2Zmc2V0PSI1MCUiIHN0b3AtY29sb3I9IiNGRkIzNDciPgogICAgICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9InN0b3AtY29sb3IiIHZhbHVlcz0iI0ZGQjM0NzsjRkY2QjRBOyMzRDhCN0E7I0ZGQjM0NyIgZHVyPSIzcyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiLz4KICAgICAgPC9zdG9wPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNGRjZCNEEiPgogICAgICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9InN0b3AtY29sb3IiIHZhbHVlcz0iI0ZGNkI0QTsjM0Q4QjdBOyNGRkIzNDc7I0ZGNkI0QSIgZHVyPSIzcyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiLz4KICAgICAgPC9zdG9wPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgCiAgPCEtLSBIZXhhZ29uIEljb24gd2l0aCBTaGltbWVyIC0tPgogIDxwb2x5Z29uIHBvaW50cz0iMzIsNCA1OCwxOSA1OCw0OSAzMiw2NCA2LDQ5IDYsMTkiIGZpbGw9InVybCgjc2hpbW1lckdyYWQpIi8+Cjwvc3ZnPgo=">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* MyoMesh Warm Brand Colors */
            --forest: #1E3A34;
            --sage: #3D8B7A;
            --coral: #FF6B4A;
            --coral-light: #FF8F75;
            --amber: #FFB347;
            --peach: #FFAD85;
            
            /* Warm Surfaces */
            --cream: #FFFBF7;
            --warm-light: #FFF5ED;
            --coral-tint: #FFEBE3;
            --sage-tint: #E8F3F0;
            
            /* Text */
            --text: #2D2926;
            --text-light: #6B635B;
            
            /* Legacy mappings */
            --primary: var(--forest);
            --primary-light: var(--sage);
            --accent: var(--coral);
            --bg: var(--cream);
            --border: #E8DDD4;
            --error: #DC4F41;
            --success: var(--sage);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--cream);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        .login-container {
            width: 100%;
            max-width: 100%;
            position: relative;
            z-index: 1;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .login-inner {
            max-width: 450px;
            margin: 0 auto;
            padding: 0 20px 40px;
            width: 100%;
        }

        .logo-section {
            text-align: center;
            padding: 48px 20px;
            background: linear-gradient(135deg, var(--forest) 0%, var(--sage) 50%, var(--coral) 100%);
            position: relative;
            overflow: hidden;
            margin: 0 0 32px 0;
            width: 100%;
        }

        .logo-section::before {
            content: '';
            position: absolute;
            top: -30%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255, 107, 74, 0.15);
            border-radius: 50%;
            pointer-events: none;
        }

        .logo-section::after {
            content: '';
            position: absolute;
            bottom: -40%;
            left: -5%;
            width: 200px;
            height: 200px;
            background: rgba(255, 173, 133, 0.12);
            border-radius: 50%;
            pointer-events: none;
        }

        .logo-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 16px;
            position: relative;
            z-index: 1;
        }

        .logo-icon svg {
            width: 100%;
            height: 100%;
        }

        h1 {
            font-size: 36px;
            font-weight: 700;
            color: white;
            margin-bottom: 6px;
            letter-spacing: -0.02em;
            position: relative;
            z-index: 1;
        }

        .tagline {
            color: rgba(255, 255, 255, 0.85);
            font-size: 14px;
            font-weight: 400;
            position: relative;
            z-index: 1;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 36px;
            box-shadow: 0 10px 40px rgba(45, 41, 38, 0.08);
        }

        .tabs {
            display: flex;
            margin-bottom: 28px;
            border-bottom: 2px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            padding: 14px;
            border: none;
            background: none;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab-btn.active {
            color: var(--coral);
            border-bottom-color: var(--coral);
        }

        .tab-btn:hover:not(.active) {
            color: var(--text);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--coral);
            box-shadow: 0 0 0 3px rgba(255, 107, 74, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            background: var(--coral);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: var(--coral-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 74, 0.25);
        }

        .btn-secondary {
            width: 100%;
            padding: 16px;
            background: var(--warm-light);
            color: var(--text);
            border: none;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: var(--coral-tint);
        }

        .divider {
            text-align: center;
            margin: 24px 0;
            color: var(--text-light);
            font-size: 13px;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--border);
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .error-message {
            background: var(--coral-tint);
            color: var(--error);
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: var(--sage-tint);
            color: var(--sage);
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }

        .invite-banner {
            background: linear-gradient(135deg, var(--sage-tint) 0%, var(--warm-light) 100%);
            border: 2px solid var(--sage);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }

        .invite-banner h3 {
            color: var(--forest);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .invite-banner p {
            color: var(--text-light);
            font-size: 13px;
            line-height: 1.5;
        }

        .forgot-password {
            text-align: center;
            margin-top: 16px;
        }

        .forgot-password a {
            color: var(--coral);
            font-size: 13px;
            text-decoration: none;
            font-weight: 500;
        }

        .forgot-password a:hover {
            text-decoration: underline;
        }

        /* Register type selection */
        .register-type-selection {
            display: grid;
            gap: 12px;
            margin-bottom: 24px;
        }

        .register-option {
            padding: 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .register-option:hover {
            border-color: var(--coral);
            background: var(--coral-tint);
        }

        .register-option.selected {
            border-color: var(--coral);
            background: var(--coral-tint);
        }

        .register-option h4 {
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .register-option p {
            color: var(--text-light);
            font-size: 12px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--text-light);
            font-size: 13px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: var(--coral);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo-section">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 280 80" width="260" style="display:block;margin:0 auto 12px;position:relative;z-index:1;">
                <defs>
                    <linearGradient id="loginShimmer" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#3D8B7A"><animate attributeName="stop-color" values="#3D8B7A;#FFB347;#FF6B4A;#3D8B7A" dur="3s" repeatCount="indefinite"/></stop>
                        <stop offset="50%" stop-color="#FFB347"><animate attributeName="stop-color" values="#FFB347;#FF6B4A;#3D8B7A;#FFB347" dur="3s" repeatCount="indefinite"/></stop>
                        <stop offset="100%" stop-color="#FF6B4A"><animate attributeName="stop-color" values="#FF6B4A;#3D8B7A;#FFB347;#FF6B4A" dur="3s" repeatCount="indefinite"/></stop>
                    </linearGradient>
                </defs>
                <g transform="translate(15, 8)"><polygon points="32,0 64,18 64,54 32,72 0,54 0,18" fill="url(#loginShimmer)"/></g>
                <text x="95" y="52" font-family="Gill Sans, Century Gothic, sans-serif" font-size="38" font-weight="300" letter-spacing="1" fill="#FFFFFF"><tspan>MYOMESH</tspan></text>
            </svg>
            <p class="tagline">Practice Management Made Simple</p>
        </div>

        <div class="login-inner">
        <div class="card">
            <div id="inviteBanner" class="invite-banner" style="display: none;">
                <h3>üéâ You've Been Invited!</h3>
                <p id="inviteMessage">Create your account to join the team.</p>
            </div>

            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('login')">Sign In</button>
                <button class="tab-btn" onclick="switchTab('register')">Create Account</button>
            </div>

            <!-- Login Tab -->
            <div id="login-tab" class="tab-content active">
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="loginEmail" required placeholder="you@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" class="btn-primary">Sign In</button>
                </form>
                <div class="forgot-password">
                    <a href="#" onclick="handleForgotPassword(); return false;">Forgot your password?</a>
                </div>
            </div>

            <!-- Register Tab -->
            <div id="register-tab" class="tab-content">
                <div id="registerTypeSelection" class="register-type-selection">
                    <div class="register-option" id="registerTypeNew" onclick="selectRegisterType('new')">
                        <h4>üè¢ Create New Practice</h4>
                        <p>Start fresh with your own MyoMesh account</p>
                    </div>
                    <div class="register-option" id="registerTypeJoin" onclick="selectRegisterType('join')">
                        <h4>üë• Join Existing Practice</h4>
                        <p>I have an invite code from my team</p>
                    </div>
                </div>

                <form id="registerForm" onsubmit="handleRegister(event)" style="display: none;">
                    <div class="back-link" onclick="resetRegisterType()">
                        ‚Üê Back to options
                    </div>
                    
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="registerName" required placeholder="Jane Smith">
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="registerEmail" required placeholder="you@example.com">
                    </div>
                    <div class="form-group" id="studioNameGroup">
                        <label>Practice Name</label>
                        <input type="text" id="registerStudioName" placeholder="My Wellness Practice">
                    </div>
                    <div class="form-group" id="inviteCodeGroup" style="display: none;">
                        <label>Invite Code</label>
                        <input type="text" id="registerInviteCode" placeholder="Enter your invite code">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" required placeholder="Min 6 characters">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="registerPasswordConfirm" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" class="btn-primary" id="registerBtn">Create Account</button>
                </form>
            </div>
        </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration - replace with your own
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let registerType = null;
        let inviteOrgId = null;

        // Check for invite link
        const urlParams = new URLSearchParams(window.location.search);
        const inviteParam = urlParams.get('invite');

        if (inviteParam) {
            try {
                inviteOrgId = atob(inviteParam);
                document.getElementById('inviteBanner').style.display = 'block';
                switchTab('register');
                selectRegisterType('join');
                loadInviteOrgName();
            } catch (e) {
                console.error('Invalid invite code');
            }
        }

        async function loadInviteOrgName() {
            if (!inviteOrgId) return;
            try {
                const orgDoc = await db.collection('organizations').doc(inviteOrgId).get();
                if (orgDoc.exists) {
                    const orgName = orgDoc.data().name || 'a practice';
                    document.getElementById('inviteMessage').textContent = 
                        `You've been invited to join "${orgName}". Create your account below to get started.`;
                }
            } catch (e) {
                console.error('Error loading org name:', e);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            hideMessages();
        }

        function selectRegisterType(type) {
            registerType = type;
            
            document.querySelectorAll('.register-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById(`registerType${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('selected');
            
            // Show the form
            document.getElementById('registerTypeSelection').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            
            // Show/hide relevant fields
            if (type === 'new') {
                document.getElementById('studioNameGroup').style.display = 'block';
                document.getElementById('inviteCodeGroup').style.display = 'none';
                document.getElementById('registerStudioName').required = true;
                document.getElementById('registerInviteCode').required = false;
                document.getElementById('registerBtn').textContent = 'Create Practice Account';
            } else {
                document.getElementById('studioNameGroup').style.display = 'none';
                document.getElementById('inviteCodeGroup').style.display = inviteOrgId ? 'none' : 'block';
                document.getElementById('registerStudioName').required = false;
                document.getElementById('registerInviteCode').required = !inviteOrgId;
                document.getElementById('registerBtn').textContent = 'Join Practice';
            }
        }

        function resetRegisterType() {
            registerType = null;
            document.getElementById('registerTypeSelection').style.display = 'grid';
            document.getElementById('registerForm').style.display = 'none';
            document.querySelectorAll('.register-option').forEach(opt => opt.classList.remove('selected'));
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        async function handleLogin(event) {
            event.preventDefault();
            hideMessages();

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            const form = event.target;
            form.classList.add('loading');

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showSuccess('Login successful! Redirecting...');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            } catch (error) {
                console.error('Login error:', error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    showError('Invalid email or password.');
                } else if (error.code === 'auth/invalid-email') {
                    showError('Please enter a valid email address.');
                } else {
                    showError('Login failed: ' + error.message);
                }
                form.classList.remove('loading');
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            hideMessages();

            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (password !== passwordConfirm) {
                showError('Passwords do not match.');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters.');
                return;
            }

            const form = event.target;
            form.classList.add('loading');

            try {
                // Create the user
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                let orgId;
                let role;

                if (registerType === 'new') {
                    // Creating a new practice
                    const studioName = document.getElementById('registerStudioName').value.trim() || 'My Practice';
                    
                    // Create the organization
                    const orgRef = await db.collection('organizations').add({
                        name: studioName,
                        ownerId: user.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    orgId = orgRef.id;
                    role = 'owner';
                    
                } else {
                    // Joining an existing practice
                    if (inviteOrgId) {
                        orgId = inviteOrgId;
                    } else {
                        const inviteCode = document.getElementById('registerInviteCode').value.trim();
                        try {
                            orgId = atob(inviteCode + '===='.slice(inviteCode.length % 4));
                        } catch (e) {
                            showError('Invalid invite code.');
                            await user.delete();
                            form.classList.remove('loading');
                            return;
                        }
                    }
                    
                    // Verify organization exists
                    const orgDoc = await db.collection('organizations').doc(orgId).get();
                    if (!orgDoc.exists) {
                        showError('Organization not found. Please check your invite code.');
                        await user.delete();
                        form.classList.remove('loading');
                        return;
                    }
                    
                    role = 'staff';
                }

                // Create user document
                await db.collection('users').doc(user.uid).set({
                    email: email,
                    displayName: name,
                    name: name,
                    role: role,
                    organizationId: orgId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Add to organization's users collection
                await db.collection('organizations').doc(orgId).collection('users').doc(user.uid).set({
                    email: email,
                    displayName: name,
                    name: name,
                    role: role,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showSuccess('Account created successfully! Redirecting...');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);

            } catch (error) {
                console.error('Registration error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showError('This email is already registered. Try logging in instead.');
                } else if (error.code === 'auth/weak-password') {
                    showError('Password is too weak. Please use a stronger password.');
                } else {
                    showError('Registration failed: ' + error.message);
                }
                form.classList.remove('loading');
            }
        }

        async function handleForgotPassword() {
            const email = document.getElementById('loginEmail').value.trim();
            
            if (!email) {
                showError('Please enter your email address first.');
                return;
            }

            try {
                await auth.sendPasswordResetEmail(email);
                showSuccess('Password reset email sent! Check your inbox.');
            } catch (error) {
                console.error('Password reset error:', error);
                if (error.code === 'auth/user-not-found') {
                    showError('No account found with this email.');
                } else {
                    showError('Error sending reset email: ' + error.message);
                }
            }
        }
    </script>
</body>
</html>
