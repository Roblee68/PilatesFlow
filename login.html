<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Flow - Login</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2C4A3E;
            --primary-light: #4A6B5D;
            --accent: #D4A574;
            --bg: #FAF8F5;
            --text: #2D3436;
            --text-light: #636E72;
            --border: #E8E2DA;
            --error: #C86B5D;
            --success: #4CAF50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #FAF8F5 0%, #F5F1EA 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            width: 100%;
            max-width: 450px;
        }

        .logo-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-family: 'Cormorant Garamond', serif;
            font-size: 32px;
            font-weight: 300;
        }

        h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 36px;
            font-weight: 400;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .tagline {
            color: var(--text-light);
            font-size: 14px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-btn:hover:not(.active) {
            color: var(--text);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 74, 62, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 74, 62, 0.25);
        }

        .btn-secondary {
            width: 100%;
            padding: 16px;
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 10px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: var(--bg);
        }

        .divider {
            text-align: center;
            margin: 25px 0;
            color: var(--text-light);
            font-size: 13px;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--border);
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .error-message {
            background: #FDEAEA;
            color: var(--error);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #E8F5E9;
            color: var(--success);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }

        .invite-banner {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border: 2px solid #81C784;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .invite-banner h3 {
            color: #2E7D32;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .invite-banner p {
            color: #555;
            font-size: 13px;
        }

        .register-options {
            display: grid;
            gap: 15px;
            margin-bottom: 25px;
        }

        .register-option {
            padding: 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .register-option:hover {
            border-color: var(--primary);
            background: var(--bg);
        }

        .register-option.selected {
            border-color: var(--primary);
            background: rgba(44, 74, 62, 0.05);
        }

        .register-option h4 {
            font-size: 15px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .register-option p {
            font-size: 12px;
            color: var(--text-light);
        }

        .forgot-password {
            text-align: right;
            margin-top: -10px;
            margin-bottom: 20px;
        }

        .forgot-password a {
            color: var(--primary);
            font-size: 13px;
            text-decoration: none;
        }

        .forgot-password a:hover {
            text-decoration: underline;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @media (max-width: 500px) {
            .card {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo-section">
            <div class="logo-icon">SF</div>
            <h1>Studio Flow</h1>
            <div class="tagline">Boutique Studio Management</div>
        </div>

        <div class="card">
            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>

            <!-- Invite Banner (shown when invite code is present) -->
            <div id="inviteBanner" class="invite-banner" style="display: none;">
                <h3>üéâ You've Been Invited!</h3>
                <p id="inviteText">You've been invited to join a studio. Create your account below to get started.</p>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('login')">Login</button>
                <button class="tab-btn" onclick="switchTab('register')">Register</button>
            </div>

            <!-- Login Tab -->
            <div id="login-tab" class="tab-content active">
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="loginEmail" required placeholder="you@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required placeholder="Your password">
                    </div>
                    <div class="forgot-password">
                        <a href="#" onclick="handleForgotPassword()">Forgot password?</a>
                    </div>
                    <button type="submit" class="btn-primary">Sign In</button>
                </form>
            </div>

            <!-- Register Tab -->
            <div id="register-tab" class="tab-content">
                <!-- Registration Type Selection (hidden if invite code present) -->
                <div id="registerTypeSelection" class="register-options">
                    <div class="register-option" onclick="selectRegisterType('new')" id="registerTypeNew">
                        <h4>üè¢ Create New Studio</h4>
                        <p>I'm a studio owner setting up my business</p>
                    </div>
                    <div class="register-option" onclick="selectRegisterType('join')" id="registerTypeJoin">
                        <h4>üëã Join Existing Studio</h4>
                        <p>I have an invite code from my studio</p>
                    </div>
                </div>

                <!-- Registration Form -->
                <form id="registerForm" onsubmit="handleRegister(event)" style="display: none;">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="registerName" required placeholder="Jane Smith">
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="registerEmail" required placeholder="you@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" required minlength="6" placeholder="At least 6 characters">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="registerPasswordConfirm" required placeholder="Confirm your password">
                    </div>
                    
                    <!-- Studio Name (only for new studios) -->
                    <div class="form-group" id="studioNameGroup" style="display: none;">
                        <label>Studio Name</label>
                        <input type="text" id="registerStudioName" placeholder="My Pilates Studio">
                    </div>
                    
                    <!-- Invite Code (only for joining) -->
                    <div class="form-group" id="inviteCodeGroup" style="display: none;">
                        <label>Invite Code</label>
                        <input type="text" id="registerInviteCode" placeholder="Enter the code from your invite link">
                    </div>

                    <button type="submit" class="btn-primary" id="registerBtn">Create Account</button>
                    <button type="button" class="btn-secondary" onclick="resetRegisterType()">‚Üê Back</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD_BGXX9kB8EPKKln6WYrK0QN1abKaufNA",
            authDomain: "flow-crm-2026rl.firebaseapp.com",
            projectId: "flow-crm-2026rl",
            storageBucket: "flow-crm-2026rl.firebasestorage.app",
            messagingSenderId: "233927450484",
            appId: "1:233927450484:web:cdd4852347e8450dbbd621"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let registerType = null;
        let inviteOrgId = null;

        // Check for invite code in URL
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const inviteCode = urlParams.get('invite');
            
            if (inviteCode) {
                try {
                    // Decode the invite code to get org ID
                    inviteOrgId = atob(inviteCode + '===='.slice(inviteCode.length % 4));
                    
                    // Show invite banner
                    document.getElementById('inviteBanner').style.display = 'block';
                    
                    // Auto-switch to register tab and set type to join
                    switchTab('register');
                    selectRegisterType('join');
                    
                    // Pre-fill the invite code
                    document.getElementById('registerInviteCode').value = inviteCode;
                    
                    // Load organization name
                    loadOrgName(inviteOrgId);
                } catch (e) {
                    console.error('Invalid invite code:', e);
                }
            }
            
            // Check if already logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    window.location.href = 'index.html';
                }
            });
        });

        async function loadOrgName(orgId) {
            try {
                const orgDoc = await db.collection('organizations').doc(orgId).get();
                if (orgDoc.exists) {
                    const orgName = orgDoc.data().name || 'a studio';
                    document.getElementById('inviteText').textContent = 
                        `You've been invited to join "${orgName}". Create your account below to get started.`;
                }
            } catch (e) {
                console.error('Error loading org name:', e);
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            hideMessages();
        }

        function selectRegisterType(type) {
            registerType = type;
            
            document.querySelectorAll('.register-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById(`registerType${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('selected');
            
            // Show the form
            document.getElementById('registerTypeSelection').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            
            // Show/hide relevant fields
            if (type === 'new') {
                document.getElementById('studioNameGroup').style.display = 'block';
                document.getElementById('inviteCodeGroup').style.display = 'none';
                document.getElementById('registerStudioName').required = true;
                document.getElementById('registerInviteCode').required = false;
                document.getElementById('registerBtn').textContent = 'Create Studio Account';
            } else {
                document.getElementById('studioNameGroup').style.display = 'none';
                document.getElementById('inviteCodeGroup').style.display = inviteOrgId ? 'none' : 'block';
                document.getElementById('registerStudioName').required = false;
                document.getElementById('registerInviteCode').required = !inviteOrgId;
                document.getElementById('registerBtn').textContent = 'Join Studio';
            }
        }

        function resetRegisterType() {
            registerType = null;
            document.getElementById('registerTypeSelection').style.display = 'grid';
            document.getElementById('registerForm').style.display = 'none';
            document.querySelectorAll('.register-option').forEach(opt => opt.classList.remove('selected'));
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        async function handleLogin(event) {
            event.preventDefault();
            hideMessages();

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            const form = event.target;
            form.classList.add('loading');

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showSuccess('Login successful! Redirecting...');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            } catch (error) {
                console.error('Login error:', error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    showError('Invalid email or password.');
                } else if (error.code === 'auth/invalid-email') {
                    showError('Please enter a valid email address.');
                } else {
                    showError('Login failed: ' + error.message);
                }
                form.classList.remove('loading');
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            hideMessages();

            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            if (password !== passwordConfirm) {
                showError('Passwords do not match.');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters.');
                return;
            }

            const form = event.target;
            form.classList.add('loading');

            try {
                // Create the user
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                let orgId;
                let role;

                if (registerType === 'new') {
                    // Creating a new studio
                    const studioName = document.getElementById('registerStudioName').value.trim() || 'My Studio';
                    
                    // Create the organization
                    const orgRef = await db.collection('organizations').add({
                        name: studioName,
                        ownerId: user.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    orgId = orgRef.id;
                    role = 'owner';
                    
                } else {
                    // Joining an existing studio
                    if (inviteOrgId) {
                        orgId = inviteOrgId;
                    } else {
                        const inviteCode = document.getElementById('registerInviteCode').value.trim();
                        try {
                            orgId = atob(inviteCode + '===='.slice(inviteCode.length % 4));
                        } catch (e) {
                            showError('Invalid invite code.');
                            await user.delete();
                            form.classList.remove('loading');
                            return;
                        }
                    }
                    
                    // Verify organization exists
                    const orgDoc = await db.collection('organizations').doc(orgId).get();
                    if (!orgDoc.exists) {
                        showError('Organization not found. Please check your invite code.');
                        await user.delete();
                        form.classList.remove('loading');
                        return;
                    }
                    
                    role = 'staff';
                }

                // Create user document
                await db.collection('users').doc(user.uid).set({
                    email: email,
                    displayName: name,
                    name: name,
                    role: role,
                    organizationId: orgId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Add to organization's users collection
                await db.collection('organizations').doc(orgId).collection('users').doc(user.uid).set({
                    email: email,
                    displayName: name,
                    name: name,
                    role: role,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showSuccess('Account created successfully! Redirecting...');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);

            } catch (error) {
                console.error('Registration error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showError('This email is already registered. Try logging in instead.');
                } else if (error.code === 'auth/weak-password') {
                    showError('Password is too weak. Please use a stronger password.');
                } else {
                    showError('Registration failed: ' + error.message);
                }
                form.classList.remove('loading');
            }
        }

        async function handleForgotPassword() {
            const email = document.getElementById('loginEmail').value.trim();
            
            if (!email) {
                showError('Please enter your email address first.');
                return;
            }

            try {
                await auth.sendPasswordResetEmail(email);
                showSuccess('Password reset email sent! Check your inbox.');
            } catch (error) {
                console.error('Password reset error:', error);
                if (error.code === 'auth/user-not-found') {
                    showError('No account found with this email.');
                } else {
                    showError('Error sending reset email: ' + error.message);
                }
            }
        }
    </script>
</body>
</html>
