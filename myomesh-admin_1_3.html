<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyoMesh ‚Äî Admin Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCIgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0Ij4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0ic2hpbW1lckdyYWQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjM0Q4QjdBIj4KICAgICAgICA8YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJzdG9wLWNvbG9yIiB2YWx1ZXM9IiMzRDhCN0E7I0ZGQjM0NzsjRkY2QjRBOyMzRDhCN0EiIGR1cj0iM3MiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIi8+CiAgICAgIDwvc3RvcD4KICAgICAgPHN0b3Agb2Zmc2V0PSI1MCUiIHN0b3AtY29sb3I9IiNGRkIzNDciPgogICAgICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9InN0b3AtY29sb3IiIHZhbHVlcz0iI0ZGQjM0NzsjRkY2QjRBOyMzRDhCN0E7I0ZGQjM0NyIgZHVyPSIzcyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiLz4KICAgICAgPC9zdG9wPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNGRjZCNEEiPgogICAgICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9InN0b3AtY29sb3IiIHZhbHVlcz0iI0ZGNkI0QTsjM0Q4QjdBOyNGRkIzNDc7I0ZGNkI0QSIgZHVyPSIzcyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiLz4KICAgICAgPC9zdG9wPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgCiAgPCEtLSBIZXhhZ29uIEljb24gd2l0aCBTaGltbWVyIC0tPgogIDxwb2x5Z29uIHBvaW50cz0iMzIsNCA1OCwxOSA1OCw0OSAzMiw2NCA2LDQ5IDYsMTkiIGZpbGw9InVybCgjc2hpbW1lckdyYWQpIi8+Cjwvc3ZnPgo=">
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --forest: #1E3A34;
            --sage: #3D8B7A;
            --coral: #FF6B4A;
            --coral-light: #FF8F75;
            --amber: #FFB347;
            --peach: #FFAD85;
            --cream: #FFFBF7;
            --warm-light: #FFF5ED;
            --coral-tint: #FFEBE3;
            --sage-tint: #E8F3F0;
            --text: #2D2926;
            --text-light: #6B635B;
            --border: #E8DDD4;
            --card: #FFFFFF;
            --success: #2CA01C;
            --warning: #DAA520;
            --error: #DC4F41;
            --bg: var(--cream);
            --shadow: rgba(45, 41, 38, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--cream);
            color: var(--text);
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ ADMIN AUTH GATE ‚îÄ‚îÄ */
        .auth-gate {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(160deg, var(--forest) 0%, #264A42 40%, var(--sage) 100%);
            padding: 40px;
        }
        .auth-card {
            background: white;
            border-radius: 24px;
            padding: 48px 40px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 24px 80px rgba(0,0,0,0.15);
            text-align: center;
        }
        .auth-card h1 {
            font-family: 'DM Serif Display', serif;
            font-size: 28px;
            color: var(--forest);
            margin-bottom: 6px;
        }
        .auth-card .subtitle {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 32px;
        }
        .auth-card input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            margin-bottom: 14px;
            transition: border-color 0.2s;
            outline: none;
        }
        .auth-card input:focus { border-color: var(--sage); }
        .auth-card .btn-login {
            width: 100%;
            padding: 14px;
            background: var(--forest);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .auth-card .btn-login:hover { background: var(--sage); }

        /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
        .admin-app { display: none; }
        .admin-app.active { display: block; }

        .admin-header {
            background: var(--forest);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .admin-header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .admin-logo {
            font-family: 'DM Serif Display', serif;
            font-size: 22px;
            color: white;
        }
        .admin-badge {
            padding: 4px 12px;
            background: rgba(255,107,74,0.2);
            color: var(--coral-light);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            border-radius: 6px;
        }
        .admin-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .admin-header-right span {
            font-size: 13px;
            color: rgba(255,255,255,0.6);
        }
        .btn-logout {
            padding: 8px 16px;
            background: rgba(255,255,255,0.08);
            color: white;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s;
        }
        .btn-logout:hover { background: rgba(255,255,255,0.15); }

        /* ‚îÄ‚îÄ NAV TABS ‚îÄ‚îÄ */
        .admin-nav {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            display: flex;
            gap: 0;
            overflow-x: auto;
        }
        .admin-tab {
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
            font-family: 'DM Sans', sans-serif;
        }
        .admin-tab:hover { color: var(--forest); }
        .admin-tab.active {
            color: var(--coral);
            border-bottom-color: var(--coral);
        }

        /* ‚îÄ‚îÄ CONTAINER ‚îÄ‚îÄ */
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 28px 32px;
        }

        .admin-panel { display: none; }
        .admin-panel.active { display: block; animation: fadeUp 0.3s ease; }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ‚îÄ‚îÄ KPI CARDS ‚îÄ‚îÄ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin-bottom: 28px;
        }
        .kpi-card {
            background: white;
            border-radius: 16px;
            padding: 22px 24px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px var(--shadow);
        }
        .kpi-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            letter-spacing: 0.06em;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .kpi-value {
            font-family: 'DM Serif Display', serif;
            font-size: 32px;
            color: var(--forest);
            margin-bottom: 4px;
        }
        .kpi-detail {
            font-size: 13px;
            color: var(--text-light);
        }
        .kpi-detail.up { color: var(--success); }
        .kpi-detail.down { color: var(--error); }

        /* ‚îÄ‚îÄ DATA TABLE ‚îÄ‚îÄ */
        .data-card {
            background: white;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px var(--shadow);
            overflow: hidden;
            margin-bottom: 24px;
        }
        .data-card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .data-card-header h3 {
            font-family: 'DM Serif Display', serif;
            font-size: 20px;
            color: var(--forest);
        }
        .data-card-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-input {
            padding: 10px 14px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            width: 240px;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-input:focus { border-color: var(--sage); }
        .filter-select {
            padding: 10px 14px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            background: white;
            outline: none;
            cursor: pointer;
        }
        .btn-export {
            padding: 10px 18px;
            background: var(--forest);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: background 0.2s;
        }
        .btn-export:hover { background: var(--sage); }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        thead { background: var(--warm-light); }
        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 700;
            color: var(--text);
            font-size: 11px;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            vertical-align: middle;
        }
        tbody tr:hover { background: var(--warm-light); }
        tbody tr:last-child td { border-bottom: none; }

        .status-badge {
            display: inline-flex;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.04em;
        }
        .status-trial { background: #EDE9FE; color: #7C3AED; }
        .status-active { background: var(--sage-tint); color: var(--sage); }
        .status-cancelled { background: #FEE2E2; color: var(--error); }
        .status-past-due { background: #FEF3C7; color: #B45309; }
        .status-churned { background: #F3F4F6; color: #6B7280; }

        .studio-name-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .studio-avatar {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 13px;
            color: white;
            flex-shrink: 0;
        }
        .studio-name-text {
            display: flex;
            flex-direction: column;
        }
        .studio-name-text strong { font-size: 14px; }
        .studio-name-text span { font-size: 12px; color: var(--text-light); }

        .action-btn {
            padding: 6px 12px;
            background: var(--warm-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s;
            color: var(--text);
        }
        .action-btn:hover { background: var(--sage-tint); border-color: var(--sage); color: var(--sage); }
        .action-btn.danger:hover { background: #FEE2E2; border-color: var(--error); color: var(--error); }

        /* ‚îÄ‚îÄ CHARTS AREA ‚îÄ‚îÄ */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px var(--shadow);
        }
        .chart-card h4 {
            font-family: 'DM Serif Display', serif;
            font-size: 18px;
            color: var(--forest);
            margin-bottom: 16px;
        }
        .chart-bar-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .chart-bar-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chart-bar-label {
            font-size: 12px;
            color: var(--text-light);
            width: 100px;
            text-align: right;
            flex-shrink: 0;
        }
        .chart-bar-track {
            flex: 1;
            height: 28px;
            background: var(--warm-light);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .chart-bar-fill {
            height: 100%;
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 11px;
            font-weight: 700;
            color: white;
            transition: width 0.8s cubic-bezier(0.16,1,0.3,1);
            min-width: 32px;
        }

        /* ‚îÄ‚îÄ CANCELLATION SURVEY RESULTS ‚îÄ‚îÄ */
        .survey-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px var(--shadow);
            margin-bottom: 20px;
        }
        .survey-card h4 {
            font-family: 'DM Serif Display', serif;
            font-size: 18px;
            color: var(--forest);
            margin-bottom: 16px;
        }
        .survey-reason {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .survey-reason:last-child { border-bottom: none; }
        .survey-reason-bar {
            flex: 1;
            height: 24px;
            background: var(--warm-light);
            border-radius: 6px;
            overflow: hidden;
        }
        .survey-reason-fill {
            height: 100%;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }
        .survey-reason-label {
            font-size: 13px;
            color: var(--text);
            width: 200px;
            flex-shrink: 0;
        }
        .survey-reason-count {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            width: 50px;
            text-align: right;
            flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: white;
            border-radius: 20px;
            max-width: 560px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 24px 80px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 24px 28px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .modal-header h3 {
            font-family: 'DM Serif Display', serif;
            font-size: 22px;
            color: var(--forest);
        }
        .modal-close {
            width: 32px; height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--warm-light);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            transition: all 0.2s;
        }
        .modal-close:hover { background: var(--coral-tint); color: var(--coral); }
        .modal-body { padding: 20px 28px 28px; }
        .modal-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        .modal-row:last-child { border-bottom: none; }
        .modal-row-label { color: var(--text-light); }
        .modal-row-value { font-weight: 600; color: var(--text); }
        .modal-section-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--coral);
            margin: 20px 0 10px;
        }

        /* ‚îÄ‚îÄ GEO MAP PLACEHOLDER ‚îÄ‚îÄ */
        .geo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        .geo-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .geo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--warm-light);
            border-radius: 10px;
        }
        .geo-item-name { font-weight: 600; font-size: 14px; }
        .geo-item-count { color: var(--text-light); font-size: 13px; }

        /* ‚îÄ‚îÄ FREE ACCESS PANEL ‚îÄ‚îÄ */
        .free-access-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        .form-group {
            margin-bottom: 18px;
        }
        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-light);
            margin-bottom: 8px;
        }
        .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: white;
            color: var(--text);
        }
        .form-input:focus {
            border-color: var(--sage);
            box-shadow: 0 0 0 3px rgba(61, 139, 122, 0.1);
        }
        .form-input::placeholder { color: #C5BBAF; }
        .radio-group {
            display: flex;
            gap: 10px;
        }
        .radio-pill {
            flex: 1;
            cursor: pointer;
        }
        .radio-pill input { display: none; }
        .radio-pill span {
            display: block;
            text-align: center;
            padding: 11px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
            background: white;
        }
        .radio-pill input:checked + span {
            border-color: var(--sage);
            background: var(--sage-tint);
            color: var(--sage);
        }
        .radio-pill:hover span {
            border-color: var(--sage);
        }
        .btn-invite {
            width: 100%;
            padding: 14px 20px;
            background: var(--forest);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-invite:hover { background: var(--sage); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(30,58,52,0.2); }
        .btn-grant {
            width: 100%;
            padding: 14px 20px;
            background: var(--coral);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-grant:hover { background: var(--coral-light); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(255,107,74,0.25); }
        .grant-preview {
            background: var(--warm-light);
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .grant-preview-avatar {
            width: 38px; height: 38px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px; color: white; flex-shrink: 0;
            background: var(--sage);
        }
        .grant-preview-info { flex: 1; }
        .grant-preview-info strong { font-size: 14px; display: block; }
        .grant-preview-info span { font-size: 12px; color: var(--text-light); }
        .invite-code-box {
            background: var(--warm-light);
            border: 2px dashed var(--sage);
            border-radius: 12px;
            padding: 18px 24px;
            font-family: 'DM Serif Display', serif;
            font-size: 28px;
            color: var(--forest);
            letter-spacing: 0.12em;
            user-select: all;
        }
        .status-invite { background: #DBEAFE; color: #2563EB; }
        .status-redeemed { background: var(--sage-tint); color: var(--sage); }
        .status-grant { background: #FEF3C7; color: #D97706; }
        .status-expired { background: #F3F4F6; color: #6B7280; }

        /* ‚îÄ‚îÄ SETTINGS PANEL ‚îÄ‚îÄ */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 0;
        }
        .admin-user-row {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        .admin-user-row:hover { border-color: var(--sage); }
        .admin-user-avatar {
            width: 38px; height: 38px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px; color: white; flex-shrink: 0;
        }
        .admin-user-info { flex: 1; }
        .admin-user-info strong { font-size: 14px; display: block; }
        .admin-user-info span { font-size: 12px; color: var(--text-light); }
        .admin-role-badge {
            display: inline-flex;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
        }
        .role-super { background: var(--coral-tint); color: var(--coral); }
        .role-admin { background: var(--sage-tint); color: var(--sage); }
        .role-viewer { background: #EDE9FE; color: #7C3AED; }

        /* ‚îÄ‚îÄ MFA DIGIT INPUTS ‚îÄ‚îÄ */
        .mfa-digit {
            width: 48px; height: 56px;
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            font-family: 'DM Sans', sans-serif;
            border: 2px solid var(--border);
            border-radius: 12px;
            outline: none;
            transition: all 0.2s;
            color: var(--forest);
        }
        .mfa-digit:focus {
            border-color: var(--sage);
            box-shadow: 0 0 0 3px rgba(61, 139, 122, 0.15);
        }

        /* ‚îÄ‚îÄ PASSWORD STRENGTH ‚îÄ‚îÄ */
        .pw-bar {
            flex: 1; height: 4px; border-radius: 2px;
            background: var(--border); transition: background 0.3s;
        }
        .pw-bar.weak { background: var(--error); }
        .pw-bar.fair { background: var(--amber); }
        .pw-bar.good { background: #66BB6A; }
        .pw-bar.strong { background: var(--success); }

        /* ‚îÄ‚îÄ MFA SETUP CARD ‚îÄ‚îÄ */
        .mfa-setup-steps {
            counter-reset: mfa-step;
        }
        .mfa-step {
            display: flex;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }
        .mfa-step:last-child { border-bottom: none; }
        .mfa-step-num {
            width: 30px; height: 30px; border-radius: 50%;
            background: var(--sage-tint); color: var(--sage);
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 700; flex-shrink: 0;
        }
        .mfa-step-content { flex: 1; }
        .mfa-step-content p { font-size: 13px; color: var(--text-light); line-height: 1.5; }
        .mfa-qr-placeholder {
            width: 180px; height: 180px; margin: 12px 0;
            background: var(--warm-light); border: 2px dashed var(--border);
            border-radius: 12px; display: flex; align-items: center;
            justify-content: center; font-size: 12px; color: var(--text-light);
            text-align: center; padding: 12px;
        }
        .mfa-enabled-badge {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 10px 18px; background: var(--sage-tint);
            border-radius: 10px; font-size: 14px; font-weight: 600;
            color: var(--sage); margin-bottom: 16px;
        }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .admin-header { padding: 12px 16px; }
            .admin-nav { padding: 0 16px; }
            .admin-container { padding: 20px 16px; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
            .chart-grid, .geo-grid, .free-access-grid, .settings-grid { grid-template-columns: 1fr; }
            .search-input { width: 160px; }
            .data-card-header { flex-direction: column; align-items: flex-start; }
        }
        @media (max-width: 480px) {
            .kpi-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ADMIN LOGIN GATE                    -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="auth-gate" id="authGate">
    <div class="auth-card">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 280 80" width="220" style="display:block;margin:0 auto 8px;">
            <defs>
                <linearGradient id="loginShimmer" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#3D8B7A"><animate attributeName="stop-color" values="#3D8B7A;#FFB347;#FF6B4A;#3D8B7A" dur="3s" repeatCount="indefinite"/></stop>
                    <stop offset="50%" stop-color="#FFB347"><animate attributeName="stop-color" values="#FFB347;#FF6B4A;#3D8B7A;#FFB347" dur="3s" repeatCount="indefinite"/></stop>
                    <stop offset="100%" stop-color="#FF6B4A"><animate attributeName="stop-color" values="#FF6B4A;#3D8B7A;#FFB347;#FF6B4A" dur="3s" repeatCount="indefinite"/></stop>
                </linearGradient>
            </defs>
            <g transform="translate(15, 8)"><polygon points="32,0 64,18 64,54 32,72 0,54 0,18" fill="url(#loginShimmer)"/></g>
            <text x="95" y="52" font-family="Gill Sans, Century Gothic, sans-serif" font-size="38" font-weight="300" letter-spacing="1"><tspan fill="#3D8B7A">MYO</tspan><tspan fill="#FF6B4A">MESH</tspan></text>
        </svg>
        <p class="subtitle">Admin Dashboard</p>

        <!-- Step 1: Email & Password -->
        <div id="loginStep1">
            <input type="email" id="adminEmail" placeholder="Admin email" autocomplete="email">
            <input type="password" id="adminPassword" placeholder="Password" autocomplete="current-password">
            <button class="btn-login" onclick="adminLogin()">Sign In</button>
            <p style="margin-top:14px;">
                <a href="#" onclick="showForgotPassword(event)" style="font-size:13px;color:var(--sage);text-decoration:none;">Forgot password?</a>
            </p>
        </div>

        <!-- Step 2: MFA Verification -->
        <div id="loginStep2" style="display:none;">
            <div style="width:48px;height:48px;border-radius:50%;background:var(--sage-tint);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:20px;">üîê</div>
            <p style="font-size:14px;color:var(--text);margin-bottom:6px;font-weight:600;">Two-Factor Authentication</p>
            <p style="font-size:13px;color:var(--text-light);margin-bottom:20px;">Enter the 6-digit code from your authenticator app.</p>
            <div style="display:flex;gap:8px;justify-content:center;margin-bottom:20px;" id="mfaCodeInputs">
                <input type="text" maxlength="1" class="mfa-digit" oninput="mfaDigitInput(this, 0)" onkeydown="mfaDigitKeydown(event, 0)" autofocus>
                <input type="text" maxlength="1" class="mfa-digit" oninput="mfaDigitInput(this, 1)" onkeydown="mfaDigitKeydown(event, 1)">
                <input type="text" maxlength="1" class="mfa-digit" oninput="mfaDigitInput(this, 2)" onkeydown="mfaDigitKeydown(event, 2)">
                <input type="text" maxlength="1" class="mfa-digit" oninput="mfaDigitInput(this, 3)" onkeydown="mfaDigitKeydown(event, 3)">
                <input type="text" maxlength="1" class="mfa-digit" oninput="mfaDigitInput(this, 4)" onkeydown="mfaDigitKeydown(event, 4)">
                <input type="text" maxlength="1" class="mfa-digit" oninput="mfaDigitInput(this, 5)" onkeydown="mfaDigitKeydown(event, 5)">
            </div>
            <button class="btn-login" onclick="verifyMFA()">Verify</button>
            <p style="margin-top:14px;">
                <a href="#" onclick="backToLogin(event)" style="font-size:13px;color:var(--text-light);text-decoration:none;">‚Üê Back to sign in</a>
            </p>
        </div>

        <!-- Forgot Password -->
        <div id="loginForgot" style="display:none;">
            <div style="width:48px;height:48px;border-radius:50%;background:var(--coral-tint);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:20px;">‚úâÔ∏è</div>
            <p style="font-size:14px;color:var(--text);margin-bottom:6px;font-weight:600;">Reset Password</p>
            <p style="font-size:13px;color:var(--text-light);margin-bottom:20px;">Enter your admin email and we'll send a reset link.</p>
            <input type="email" id="resetEmail" placeholder="Admin email" autocomplete="email">
            <button class="btn-login" onclick="sendPasswordReset()">Send Reset Link</button>
            <p style="margin-top:14px;">
                <a href="#" onclick="backToLogin(event)" style="font-size:13px;color:var(--text-light);text-decoration:none;">‚Üê Back to sign in</a>
            </p>
        </div>

        <p id="authError" style="color:var(--error);font-size:13px;margin-top:12px;display:none;"></p>
        <p id="authSuccess" style="color:var(--success);font-size:13px;margin-top:12px;display:none;"></p>

        <div style="margin-top:24px;padding-top:20px;border-top:1px solid var(--border);">
            <button onclick="enterPreviewMode()" style="background:none;border:1px dashed var(--border);border-radius:10px;padding:10px 20px;font-size:12px;color:var(--text-light);cursor:pointer;font-family:'DM Sans',sans-serif;width:100%;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--sage)';this.style.color='var(--sage)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-light)'">
                üîç Preview Mode (Demo Data)
            </button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ADMIN DASHBOARD                     -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="admin-app" id="adminApp">
    <!-- Header -->
    <div class="admin-header">
        <div class="admin-header-left">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 280 80" height="36" style="display:block;">
                <defs>
                    <linearGradient id="hdrShimmer" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#3D8B7A"><animate attributeName="stop-color" values="#3D8B7A;#FFB347;#FF6B4A;#3D8B7A" dur="3s" repeatCount="indefinite"/></stop>
                        <stop offset="50%" stop-color="#FFB347"><animate attributeName="stop-color" values="#FFB347;#FF6B4A;#3D8B7A;#FFB347" dur="3s" repeatCount="indefinite"/></stop>
                        <stop offset="100%" stop-color="#FF6B4A"><animate attributeName="stop-color" values="#FF6B4A;#3D8B7A;#FFB347;#FF6B4A" dur="3s" repeatCount="indefinite"/></stop>
                    </linearGradient>
                </defs>
                <g transform="translate(15, 8)"><polygon points="32,0 64,18 64,54 32,72 0,54 0,18" fill="url(#hdrShimmer)"/></g>
                <text x="95" y="52" font-family="Gill Sans, Century Gothic, sans-serif" font-size="38" font-weight="300" letter-spacing="1" fill="#FFFFFF"><tspan>MYOMESH</tspan></text>
            </svg>
            <span class="admin-badge">Admin</span>
        </div>
        <div class="admin-header-right">
            <span id="adminEmailDisplay"></span>
            <button class="btn-logout" onclick="adminLogout()">Logout</button>
        </div>
    </div>

    <!-- Nav Tabs -->
    <div class="admin-nav">
        <button class="admin-tab active" onclick="switchAdminTab('overview')">Overview</button>
        <button class="admin-tab" onclick="switchAdminTab('studios')">Studios</button>
        <button class="admin-tab" onclick="switchAdminTab('payments')">Payments</button>
        <button class="admin-tab" onclick="switchAdminTab('geography')">Geography</button>
        <button class="admin-tab" onclick="switchAdminTab('churn')">Churn & Surveys</button>
        <button class="admin-tab" onclick="switchAdminTab('freeaccess')">Free Access</button>
        <button class="admin-tab" onclick="switchAdminTab('settings')" style="margin-left:auto;">‚öôÔ∏è Settings</button>
    </div>

    <div class="admin-container">

        <!-- ‚ïê‚ïê OVERVIEW PANEL ‚ïê‚ïê -->
        <div class="admin-panel active" id="panel-overview">
            <div class="kpi-grid" id="overviewKPIs">
                <!-- Populated by JS -->
            </div>

            <div class="chart-grid">
                <div class="chart-card">
                    <h4>Sign-ups Over Time</h4>
                    <div id="signupChart" class="chart-bar-group">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="chart-card">
                    <h4>Subscription Status Breakdown</h4>
                    <div id="statusChart" class="chart-bar-group">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-card">
                    <h4>Revenue (Monthly)</h4>
                    <div id="revenueChart" class="chart-bar-group">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="chart-card">
                    <h4>Conversion Rate</h4>
                    <div id="conversionChart" style="text-align:center;padding:20px 0;">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-card">
                    <h4>Plan Distribution</h4>
                    <div id="planDistChart" class="chart-bar-group">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="chart-card">
                    <h4>SMS Add-On Adoption</h4>
                    <div id="smsDistChart" class="chart-bar-group">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê STUDIOS PANEL ‚ïê‚ïê -->
        <div class="admin-panel" id="panel-studios">
            <div class="data-card">
                <div class="data-card-header">
                    <h3>All Studios</h3>
                    <div class="data-card-actions">
                        <input class="search-input" type="text" placeholder="Search studios..." id="studioSearch" oninput="filterStudios()">
                        <select class="filter-select" id="studioStatusFilter" onchange="filterStudios()">
                            <option value="all">All Statuses</option>
                            <option value="trial">Trial</option>
                            <option value="active">Active</option>
                            <option value="past_due">Past Due</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <button class="btn-export" onclick="exportStudiosCSV()">‚¨á Export CSV</button>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Studio</th>
                                <th>Owner</th>
                                <th>Status</th>
                                <th>Plan</th>
                                <th>Sign-up Date</th>
                                <th>Trial Ends</th>
                                <th>MRR</th>
                                <th>Staff</th>
                                <th>Sessions</th>
                                <th>Clients</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studiosTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div style="padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
                    <span id="studioCountLabel" style="font-size:13px;color:var(--text-light);"></span>
                    <div id="studioPagination" style="display:flex;gap:6px;">
                        <!-- Pagination buttons -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê PAYMENTS PANEL ‚ïê‚ïê -->
        <div class="admin-panel" id="panel-payments">
            <div class="kpi-grid" id="paymentKPIs">
                <!-- Populated by JS -->
            </div>
            <div class="data-card">
                <div class="data-card-header">
                    <h3>Payment History</h3>
                    <div class="data-card-actions">
                        <select class="filter-select" id="paymentStatusFilter" onchange="filterPayments()">
                            <option value="all">All</option>
                            <option value="succeeded">Succeeded</option>
                            <option value="failed">Failed</option>
                            <option value="refunded">Refunded</option>
                        </select>
                        <button class="btn-export" onclick="exportPaymentsCSV()">‚¨á Export CSV</button>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Studio</th>
                                <th>Amount</th>
                                <th>Currency</th>
                                <th>Status</th>
                                <th>Stripe ID</th>
                                <th>Card</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê GEOGRAPHY PANEL ‚ïê‚ïê -->
        <div class="admin-panel" id="panel-geography">
            <div class="geo-grid">
                <div class="chart-card">
                    <h4>Studios by Country</h4>
                    <div id="geoCountryList" class="geo-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="chart-card">
                    <h4>Studios by Region / Province / State</h4>
                    <div id="geoRegionList" class="geo-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            <div class="chart-card">
                <h4>Studios by City</h4>
                <div id="geoCityList" class="geo-list" style="max-height:400px;overflow-y:auto;">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê CHURN & SURVEYS PANEL ‚ïê‚ïê -->
        <div class="admin-panel" id="panel-churn">
            <div class="kpi-grid" id="churnKPIs">
                <!-- Populated by JS -->
            </div>

            <div class="chart-grid">
                <div class="survey-card">
                    <h4>Cancellation Reasons ‚Äî Trial Cancellations</h4>
                    <div id="trialCancelReasons">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="survey-card">
                    <h4>Cancellation Reasons ‚Äî Paying Subscribers</h4>
                    <div id="paidCancelReasons">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <div class="data-card">
                <div class="data-card-header">
                    <h3>All Cancellation Survey Responses</h3>
                    <div class="data-card-actions">
                        <select class="filter-select" id="churnTypeFilter" onchange="filterChurn()">
                            <option value="all">All Cancellations</option>
                            <option value="trial">Trial Only</option>
                            <option value="paid">Paid Only</option>
                        </select>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Studio</th>
                                <th>Type</th>
                                <th>Days Active</th>
                                <th>Primary Reason</th>
                                <th>Feedback</th>
                                <th>Would Return?</th>
                            </tr>
                        </thead>
                        <tbody id="churnTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê FREE ACCESS PANEL ‚ïê‚ïê -->
        <div class="admin-panel" id="panel-freeaccess">

            <!-- KPI Row -->
            <div class="kpi-grid" id="freeAccessKPIs">
                <!-- Populated by JS -->
            </div>

            <!-- Two-column: Invite + Grant -->
            <div class="free-access-grid">

                <!-- INVITE STUDIO CARD -->
                <div class="data-card">
                    <div class="data-card-header" style="border-bottom:1px solid var(--border);">
                        <h3>‚úâÔ∏è Invite a Studio</h3>
                        <span style="font-size:12px;color:var(--text-light);">New sign-up with free access</span>
                    </div>
                    <div style="padding:24px;">
                        <p style="font-size:13px;color:var(--text-light);margin-bottom:20px;line-height:1.6;">
                            Generate an invite for a new studio. They'll sign up normally but receive extended free access instead of the standard 14-day trial. The invite code is single-use.
                        </p>
                        <div class="form-group">
                            <label class="form-label">Studio / Contact Name</label>
                            <input type="text" class="form-input" id="inviteName" placeholder="e.g. Sunshine Pilates ‚Äî Jane Doe">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" id="inviteEmail" placeholder="owner@studio.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Free Access Period</label>
                            <div class="radio-group">
                                <label class="radio-pill">
                                    <input type="radio" name="inviteMonths" value="1" checked> <span>1 Month</span>
                                </label>
                                <label class="radio-pill">
                                    <input type="radio" name="inviteMonths" value="2"> <span>2 Months</span>
                                </label>
                                <label class="radio-pill">
                                    <input type="radio" name="inviteMonths" value="3"> <span>3 Months</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Plan to Assign</label>
                            <select class="form-input" id="invitePlan">
                                <option value="grow">MyoGrow (up to 3 staff)</option>
                                <option value="build" selected>MyoBuild (up to 8 staff)</option>
                                <option value="pro">MyoPro (up to 16 staff)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Internal Note <span style="font-weight:400;color:var(--text-light);">(optional)</span></label>
                            <input type="text" class="form-input" id="inviteNote" placeholder="e.g. Beta tester, referred by Sarah M.">
                        </div>
                        <button class="btn-invite" onclick="generateInvite()">
                            <span>Generate Invite Code</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                        </button>
                    </div>
                </div>

                <!-- GRANT FREE MONTHS CARD -->
                <div class="data-card">
                    <div class="data-card-header" style="border-bottom:1px solid var(--border);">
                        <h3>üéÅ Grant Free Months</h3>
                        <span style="font-size:12px;color:var(--text-light);">Existing subscriber credit</span>
                    </div>
                    <div style="padding:24px;">
                        <p style="font-size:13px;color:var(--text-light);margin-bottom:20px;line-height:1.6;">
                            Credit free months to an active or past-due subscriber. Their billing is paused for the selected period ‚Äî great for customer service recovery or goodwill gestures.
                        </p>
                        <div class="form-group">
                            <label class="form-label">Select Studio</label>
                            <select class="form-input" id="grantStudioSelect">
                                <option value="">‚Äî Choose a studio ‚Äî</option>
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div id="grantStudioPreview" style="display:none;">
                            <!-- Populated by JS when studio selected -->
                        </div>
                        <div class="form-group">
                            <label class="form-label">Free Months to Grant</label>
                            <div class="radio-group">
                                <label class="radio-pill">
                                    <input type="radio" name="grantMonths" value="1" checked> <span>1 Month</span>
                                </label>
                                <label class="radio-pill">
                                    <input type="radio" name="grantMonths" value="2"> <span>2 Months</span>
                                </label>
                                <label class="radio-pill">
                                    <input type="radio" name="grantMonths" value="3"> <span>3 Months</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Reason</label>
                            <select class="form-input" id="grantReason">
                                <option value="customer_service">Customer Service Recovery</option>
                                <option value="bug_compensation">Bug / Issue Compensation</option>
                                <option value="loyalty">Loyalty Reward</option>
                                <option value="testing">Testing / Beta</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Internal Note <span style="font-weight:400;color:var(--text-light);">(optional)</span></label>
                            <input type="text" class="form-input" id="grantNote" placeholder="e.g. Experienced downtime during migration">
                        </div>
                        <button class="btn-grant" onclick="grantFreeMonths()">
                            <span>Grant Free Months</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- GENERATED INVITE CODE MODAL -->
            <div class="invite-code-result" id="inviteCodeResult" style="display:none;">
                <div class="data-card" style="border:2px solid var(--sage);margin-bottom:24px;">
                    <div style="padding:28px;text-align:center;">
                        <div style="width:48px;height:48px;border-radius:50%;background:var(--sage-tint);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:22px;">‚úì</div>
                        <h3 style="font-family:'DM Serif Display',serif;font-size:20px;color:var(--forest);margin-bottom:6px;">Invite Generated</h3>
                        <p style="font-size:13px;color:var(--text-light);margin-bottom:20px;" id="inviteResultMeta"></p>
                        <div class="invite-code-box" id="inviteCodeBox">
                            <!-- Code displayed here -->
                        </div>
                        <div style="display:flex;gap:10px;justify-content:center;margin-top:16px;">
                            <button class="action-btn" onclick="copyInviteCode()" id="copyInviteBtn">üìã Copy Code</button>
                            <button class="action-btn" onclick="copyInviteLink()" id="copyInviteLinkBtn">üîó Copy Invite Link</button>
                            <button class="action-btn" onclick="dismissInviteResult()">‚úï Dismiss</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACTIVE FREE ACCESS TABLE -->
            <div class="data-card">
                <div class="data-card-header">
                    <h3>All Free Access Records</h3>
                    <div class="data-card-actions">
                        <select class="filter-select" id="freeAccessFilter" onchange="filterFreeAccess()">
                            <option value="all">All Records</option>
                            <option value="invite_pending">Pending Invites</option>
                            <option value="invite_redeemed">Redeemed Invites</option>
                            <option value="grant_active">Active Grants</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Studio / Invitee</th>
                                <th>Free Months</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Expires</th>
                                <th>Reason / Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="freeAccessTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div style="padding:16px 24px;border-top:1px solid var(--border);">
                    <span id="freeAccessCountLabel" style="font-size:13px;color:var(--text-light);"></span>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê SETTINGS PANEL ‚ïê‚ïê -->
        <div class="admin-panel" id="panel-settings">
            <div class="settings-grid">

                <!-- ADMIN USER MANAGEMENT -->
                <div class="data-card">
                    <div class="data-card-header" style="border-bottom:1px solid var(--border);">
                        <h3>üë• Admin Users</h3>
                        <span style="font-size:12px;color:var(--text-light);">Manage who can access this dashboard</span>
                    </div>
                    <div style="padding:24px;">
                        <p style="font-size:13px;color:var(--text-light);margin-bottom:20px;line-height:1.6;">
                            Add or remove admin users. Admins must have a Firebase Auth account ‚Äî they'll use their email and password to sign in. The first admin (you) is the <strong>Super Admin</strong> and cannot be removed.
                        </p>

                        <!-- Add Admin Form -->
                        <div style="background:var(--warm-light);border-radius:12px;padding:18px;margin-bottom:20px;">
                            <p style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-light);margin-bottom:12px;">Add New Admin</p>
                            <div class="form-group" style="margin-bottom:12px;">
                                <input type="text" class="form-input" id="newAdminName" placeholder="Full name">
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <input type="email" class="form-input" id="newAdminEmail" placeholder="Email address">
                            </div>
                            <div class="form-group" style="margin-bottom:14px;">
                                <select class="form-input" id="newAdminRole">
                                    <option value="admin">Admin ‚Äî Full dashboard access</option>
                                    <option value="viewer">Viewer ‚Äî Read-only access</option>
                                </select>
                            </div>
                            <button class="btn-invite" onclick="addAdmin()" style="padding:12px 18px;font-size:14px;">
                                <span>Add Admin</span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
                            </button>
                        </div>

                        <!-- Admin List -->
                        <div id="adminUsersList">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Password + MFA -->
                <div>
                    <!-- CHANGE PASSWORD -->
                    <div class="data-card" style="margin-bottom:20px;">
                        <div class="data-card-header" style="border-bottom:1px solid var(--border);">
                            <h3>üîë Change Password</h3>
                        </div>
                        <div style="padding:24px;">
                            <div class="form-group">
                                <label class="form-label">Current Password</label>
                                <input type="password" class="form-input" id="currentPassword" placeholder="Enter current password">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Password</label>
                                <input type="password" class="form-input" id="newPassword" placeholder="Min. 8 characters">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Confirm New Password</label>
                                <input type="password" class="form-input" id="confirmPassword" placeholder="Re-enter new password">
                            </div>
                            <div id="passwordStrength" style="margin-bottom:14px;display:none;">
                                <div style="display:flex;gap:4px;margin-bottom:6px;">
                                    <div class="pw-bar" id="pwBar1"></div>
                                    <div class="pw-bar" id="pwBar2"></div>
                                    <div class="pw-bar" id="pwBar3"></div>
                                    <div class="pw-bar" id="pwBar4"></div>
                                </div>
                                <span id="pwStrengthLabel" style="font-size:11px;font-weight:600;"></span>
                            </div>
                            <p id="passwordMsg" style="font-size:13px;margin-bottom:14px;display:none;"></p>
                            <button class="btn-invite" onclick="changePassword()" style="padding:12px 18px;font-size:14px;">
                                <span>Update Password</span>
                            </button>
                        </div>
                    </div>

                    <!-- MFA SETUP -->
                    <div class="data-card">
                        <div class="data-card-header" style="border-bottom:1px solid var(--border);">
                            <h3>üîê Two-Factor Authentication</h3>
                        </div>
                        <div style="padding:24px;">
                            <div id="mfaStatus">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ACTIVITY LOG -->
            <div class="data-card" style="margin-top:20px;">
                <div class="data-card-header">
                    <h3>üìã Admin Activity Log</h3>
                    <span style="font-size:12px;color:var(--text-light);">Recent admin actions</span>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Admin</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="activityLogBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ‚ïê‚ïê‚ïê STUDIO DETAIL MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="studioDetailModal">
    <div class="modal-box">
        <div class="modal-header">
            <h3 id="modalStudioName">Studio Details</h3>
            <button class="modal-close" onclick="closeModal('studioDetailModal')">√ó</button>
        </div>
        <div class="modal-body" id="modalStudioBody">
            <!-- Populated by JS -->
        </div>
    </div>
</div>


<script>
// ========================================
// FIREBASE CONFIG ‚Äî Replace with your config
// ========================================
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ========================================
// PLAN & SMS PACK DEFINITIONS (mirrors index)
// ========================================
const PLANS = {
    grow: { id: 'grow', name: 'MyoGrow', maxStaff: 3, price: { cad: 55, usd: 39, gbp: 31, aud: 59 } },
    build: { id: 'build', name: 'MyoBuild', maxStaff: 8, price: { cad: 85, usd: 59, gbp: 48, aud: 89 } },
    pro: { id: 'pro', name: 'MyoPro', maxStaff: 16, price: { cad: 115, usd: 79, gbp: 63, aud: 119 } }
};
const SMS_PACKS = {
    none: { id: 'none', name: 'None', count: 0, price: { cad: 0, usd: 0, gbp: 0, aud: 0 } },
    starter: { id: 'starter', name: 'Starter', count: 500, price: { cad: 15, usd: 11, gbp: 9, aud: 16 } },
    standard: { id: 'standard', name: 'Standard', count: 1500, price: { cad: 40, usd: 29, gbp: 23, aud: 42 } },
    high: { id: 'high', name: 'High Volume', count: 5000, price: { cad: 100, usd: 69, gbp: 55, aud: 105 } }
};

// ========================================
// ADMIN AUTH ‚Äî Firestore-backed
// ========================================
let currentAdminProfile = null;
let isPreviewMode = false;
let allAdmins = [];
let activityLog = [];
let mfaResolver = null; // For MFA verification flow

// Fallback: bootstrap admin email if Firestore 'platform_admins' is empty
const BOOTSTRAP_ADMIN = 'admin@myomesh.com';

async function checkIfAdmin(email) {
    try {
        const snap = await db.collection('platform_admins').where('email', '==', email.toLowerCase()).get();
        if (!snap.empty) {
            currentAdminProfile = { id: snap.docs[0].id, ...snap.docs[0].data() };
            return true;
        }
        // Fallback: if collection is empty or very first login, allow bootstrap admin
        const allSnap = await db.collection('platform_admins').get();
        if (allSnap.empty && email.toLowerCase() === BOOTSTRAP_ADMIN) {
            // Auto-create the super admin record
            const ref = await db.collection('platform_admins').add({
                email: email.toLowerCase(),
                name: 'Super Admin',
                role: 'super_admin',
                mfaEnabled: false,
                addedBy: 'system',
                addedAt: new Date().toISOString()
            });
            currentAdminProfile = { id: ref.id, email: email.toLowerCase(), name: 'Super Admin', role: 'super_admin', mfaEnabled: false };
            return true;
        }
        return false;
    } catch (err) {
        console.log('Firestore check failed, using bootstrap admin:', err.message);
        // Offline fallback
        if (email.toLowerCase() === BOOTSTRAP_ADMIN) {
            currentAdminProfile = { email: email.toLowerCase(), name: 'Super Admin', role: 'super_admin', mfaEnabled: false };
            return true;
        }
        return false;
    }
}

function adminLogin() {
    const email = document.getElementById('adminEmail').value.trim();
    const password = document.getElementById('adminPassword').value;
    const errorEl = document.getElementById('authError');
    const successEl = document.getElementById('authSuccess');
    errorEl.style.display = 'none';
    successEl.style.display = 'none';

    if (!email || !password) {
        errorEl.textContent = 'Please enter email and password.';
        errorEl.style.display = 'block';
        return;
    }

    auth.signInWithEmailAndPassword(email, password)
        .then(async (cred) => {
            const isAdmin = await checkIfAdmin(cred.user.email);
            if (!isAdmin) {
                auth.signOut();
                errorEl.textContent = 'Access denied. This account is not an admin.';
                errorEl.style.display = 'block';
                return;
            }

            // Check if MFA is enrolled on Firebase (multi-factor)
            if (cred.user.multiFactor && cred.user.multiFactor.enrolledFactors.length > 0) {
                // MFA is enrolled ‚Äî this path shouldn't be reached normally
                // because Firebase would throw auth/multi-factor-auth-required
                showAdminApp(cred.user);
            } else {
                // No MFA enrolled ‚Äî proceed directly
                logActivity('Signed in', `${cred.user.email} signed in (no MFA)`);
                showAdminApp(cred.user);
            }
        })
        .catch(err => {
            if (err.code === 'auth/multi-factor-auth-required') {
                // MFA required ‚Äî show code input
                mfaResolver = err.resolver;
                document.getElementById('loginStep1').style.display = 'none';
                document.getElementById('loginStep2').style.display = 'block';
                document.querySelector('.mfa-digit').focus();
            } else {
                errorEl.textContent = err.message;
                errorEl.style.display = 'block';
            }
        });
}

function verifyMFA() {
    const digits = document.querySelectorAll('.mfa-digit');
    const code = Array.from(digits).map(d => d.value).join('');
    const errorEl = document.getElementById('authError');
    errorEl.style.display = 'none';

    if (code.length !== 6) {
        errorEl.textContent = 'Please enter all 6 digits.';
        errorEl.style.display = 'block';
        return;
    }

    if (!mfaResolver) {
        errorEl.textContent = 'MFA session expired. Please sign in again.';
        errorEl.style.display = 'block';
        return;
    }

    // Use the first enrolled factor (TOTP)
    const factorInfo = mfaResolver.hints[0];

    if (factorInfo.factorId === firebase.auth.TotpMultiFactorGenerator?.FACTOR_ID) {
        // TOTP MFA
        const assertion = firebase.auth.TotpMultiFactorGenerator.assertionForSignIn(
            mfaResolver.hints[0].uid, code
        );
        mfaResolver.resolveSignIn(assertion)
            .then(async (cred) => {
                const isAdmin = await checkIfAdmin(cred.user.email);
                if (!isAdmin) {
                    auth.signOut();
                    errorEl.textContent = 'Access denied.';
                    errorEl.style.display = 'block';
                    return;
                }
                logActivity('Signed in', `${cred.user.email} signed in with MFA`);
                showAdminApp(cred.user);
            })
            .catch(err => {
                errorEl.textContent = 'Invalid code. Please try again.';
                errorEl.style.display = 'block';
                digits.forEach(d => d.value = '');
                digits[0].focus();
            });
    } else if (factorInfo.factorId === firebase.auth.PhoneMultiFactorGenerator?.FACTOR_ID) {
        // Phone SMS MFA
        const phoneOpts = { multiFactorHint: factorInfo, session: mfaResolver.session };
        const phoneProvider = new firebase.auth.PhoneAuthProvider();
        phoneProvider.verifyPhoneNumber(phoneOpts, window.recaptchaVerifier)
            .then(verificationId => {
                const cred = firebase.auth.PhoneAuthProvider.credential(verificationId, code);
                const assertion = firebase.auth.PhoneMultiFactorGenerator.assertion(cred);
                return mfaResolver.resolveSignIn(assertion);
            })
            .then(async (cred) => {
                const isAdmin = await checkIfAdmin(cred.user.email);
                if (isAdmin) showAdminApp(cred.user);
            })
            .catch(err => {
                errorEl.textContent = 'Verification failed: ' + err.message;
                errorEl.style.display = 'block';
            });
    }
}

function mfaDigitInput(el, index) {
    el.value = el.value.replace(/\D/g, '');
    if (el.value && index < 5) {
        document.querySelectorAll('.mfa-digit')[index + 1].focus();
    }
    // Auto-submit when all 6 digits are entered
    const allFilled = Array.from(document.querySelectorAll('.mfa-digit')).every(d => d.value);
    if (allFilled) verifyMFA();
}

function mfaDigitKeydown(e, index) {
    if (e.key === 'Backspace' && !e.target.value && index > 0) {
        document.querySelectorAll('.mfa-digit')[index - 1].focus();
    }
}

function showForgotPassword(e) {
    e.preventDefault();
    document.getElementById('loginStep1').style.display = 'none';
    document.getElementById('loginForgot').style.display = 'block';
    document.getElementById('authError').style.display = 'none';
    document.getElementById('authSuccess').style.display = 'none';
    document.getElementById('resetEmail').value = document.getElementById('adminEmail').value;
}

function backToLogin(e) {
    e.preventDefault();
    document.getElementById('loginStep1').style.display = 'block';
    document.getElementById('loginStep2').style.display = 'none';
    document.getElementById('loginForgot').style.display = 'none';
    document.getElementById('authError').style.display = 'none';
    document.getElementById('authSuccess').style.display = 'none';
    mfaResolver = null;
    document.querySelectorAll('.mfa-digit').forEach(d => d.value = '');
}

function sendPasswordReset() {
    const email = document.getElementById('resetEmail').value.trim();
    const errorEl = document.getElementById('authError');
    const successEl = document.getElementById('authSuccess');
    errorEl.style.display = 'none';
    successEl.style.display = 'none';

    if (!email) {
        errorEl.textContent = 'Please enter your email.';
        errorEl.style.display = 'block';
        return;
    }

    auth.sendPasswordResetEmail(email)
        .then(() => {
            successEl.textContent = 'Password reset email sent! Check your inbox.';
            successEl.style.display = 'block';
        })
        .catch(err => {
            errorEl.textContent = err.message;
            errorEl.style.display = 'block';
        });
}

function enterPreviewMode() {
    isPreviewMode = true;
    currentAdminProfile = { email: 'preview@myomesh.com', name: 'Preview User', role: 'super_admin', mfaEnabled: false };
    document.getElementById('authGate').style.display = 'none';
    document.getElementById('adminApp').classList.add('active');
    document.getElementById('adminEmailDisplay').textContent = 'üîç Preview Mode';
    loadDemoData();
}

function adminLogout() {
    if (confirm('Log out of admin dashboard?')) {
        if (isPreviewMode) {
            isPreviewMode = false;
            currentAdminProfile = null;
            document.getElementById('adminApp').classList.remove('active');
            document.getElementById('authGate').style.display = 'flex';
            backToLogin(new Event('click'));
            return;
        }
        auth.signOut().then(() => {
            currentAdminProfile = null;
            document.getElementById('adminApp').classList.remove('active');
            document.getElementById('authGate').style.display = 'flex';
            backToLogin(new Event('click'));
        });
    }
}

auth.onAuthStateChanged(async (user) => {
    if (user && !isPreviewMode) {
        const isAdmin = await checkIfAdmin(user.email);
        if (isAdmin) {
            showAdminApp(user);
        }
    }
});

function showAdminApp(user) {
    document.getElementById('authGate').style.display = 'none';
    document.getElementById('adminApp').classList.add('active');
    document.getElementById('adminEmailDisplay').textContent = user.email;
    loadAllAdminData();
}

// ========================================
// SETTINGS ‚Äî ADMIN MANAGEMENT
// ========================================
async function loadAdmins() {
    try {
        const snap = await db.collection('platform_admins').orderBy('addedAt', 'asc').get();
        allAdmins = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (err) {
        console.log('Could not load admins from Firestore.');
        allAdmins = currentAdminProfile ? [currentAdminProfile] : [];
    }
    renderAdminList();
    renderMFAStatus();
    renderActivityLog();
}

function renderAdminList() {
    const container = document.getElementById('adminUsersList');
    if (!container) return;

    const avatarColors = ['var(--coral)', 'var(--sage)', '#7C3AED', 'var(--forest)', '#2563EB', '#D97706'];
    const currentEmail = currentAdminProfile?.email || '';

    container.innerHTML = allAdmins.map((admin, i) => {
        const roleClass = admin.role === 'super_admin' ? 'role-super' : admin.role === 'admin' ? 'role-admin' : 'role-viewer';
        const roleLabel = admin.role === 'super_admin' ? 'Super Admin' : admin.role === 'admin' ? 'Admin' : 'Viewer';
        const isCurrentUser = admin.email === currentEmail;
        const canRemove = currentAdminProfile?.role === 'super_admin' && admin.role !== 'super_admin';

        return `<div class="admin-user-row">
            <div class="admin-user-avatar" style="background:${avatarColors[i % avatarColors.length]};">${(admin.name || admin.email).charAt(0).toUpperCase()}</div>
            <div class="admin-user-info">
                <strong>${admin.name || 'Unnamed'} ${isCurrentUser ? '<span style="font-size:11px;color:var(--sage);">(you)</span>' : ''}</strong>
                <span>${admin.email} ¬∑ <span class="admin-role-badge ${roleClass}">${roleLabel}</span>
                ${admin.mfaEnabled ? ' ¬∑ <span style="color:var(--sage);font-size:10px;font-weight:700;">üîê MFA</span>' : ''}
                </span>
            </div>
            ${canRemove ? `<button class="action-btn danger" onclick="removeAdmin('${admin.id}', '${admin.email}')" style="font-size:11px;">Remove</button>` : ''}
        </div>`;
    }).join('');

    if (allAdmins.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--text-light);font-size:13px;padding:20px;">No admin records found.</p>';
    }
}

async function addAdmin() {
    const name = document.getElementById('newAdminName').value.trim();
    const email = document.getElementById('newAdminEmail').value.trim().toLowerCase();
    const role = document.getElementById('newAdminRole').value;

    if (!name) { alert('Please enter a name.'); return; }
    if (!email || !email.includes('@')) { alert('Please enter a valid email.'); return; }

    // Check if already an admin
    if (allAdmins.find(a => a.email === email)) {
        alert('This email is already an admin.');
        return;
    }

    // Check caller is super_admin
    if (currentAdminProfile?.role !== 'super_admin') {
        alert('Only the Super Admin can add new admins.');
        return;
    }

    const adminData = {
        email: email,
        name: name,
        role: role,
        mfaEnabled: false,
        addedBy: currentAdminProfile.email,
        addedAt: new Date().toISOString()
    };

    try {
        const ref = await db.collection('platform_admins').add(adminData);
        adminData.id = ref.id;
    } catch (err) {
        console.log('Firestore save skipped (demo mode)');
        adminData.id = 'admin_' + Date.now();
    }

    allAdmins.push(adminData);
    logActivity('Admin added', `${name} (${email}) added as ${role}`);

    // Clear form
    document.getElementById('newAdminName').value = '';
    document.getElementById('newAdminEmail').value = '';
    document.getElementById('newAdminRole').value = 'admin';

    renderAdminList();
    alert(`‚úì ${name} has been added as ${role === 'admin' ? 'an Admin' : 'a Viewer'}.\n\nIMPORTANT: They need a Firebase Auth account with this email to sign in. Create one in your Firebase Console ‚Üí Authentication ‚Üí Users ‚Üí Add User.`);
}

async function removeAdmin(adminId, email) {
    if (!confirm(`Remove ${email} from admin access? They won't be able to sign into this dashboard.`)) return;

    try {
        await db.collection('platform_admins').doc(adminId).delete();
    } catch (err) {
        console.log('Firestore delete skipped (demo mode)');
    }

    allAdmins = allAdmins.filter(a => a.id !== adminId);
    logActivity('Admin removed', `${email} removed from admin access`);
    renderAdminList();
}

// ========================================
// SETTINGS ‚Äî PASSWORD CHANGE
// ========================================
document.addEventListener('DOMContentLoaded', () => {
    const pwInput = document.getElementById('newPassword');
    if (pwInput) {
        pwInput.addEventListener('input', function () {
            checkPasswordStrength(this.value);
        });
    }
});

function checkPasswordStrength(pw) {
    const container = document.getElementById('passwordStrength');
    const label = document.getElementById('pwStrengthLabel');
    const bars = [document.getElementById('pwBar1'), document.getElementById('pwBar2'), document.getElementById('pwBar3'), document.getElementById('pwBar4')];

    if (!pw) { container.style.display = 'none'; return; }
    container.style.display = 'block';

    let score = 0;
    if (pw.length >= 8) score++;
    if (pw.length >= 12) score++;
    if (/[A-Z]/.test(pw) && /[a-z]/.test(pw)) score++;
    if (/\d/.test(pw)) score++;
    if (/[^A-Za-z0-9]/.test(pw)) score++;

    const strength = score <= 1 ? 'weak' : score <= 2 ? 'fair' : score <= 3 ? 'good' : 'strong';
    const labels = { weak: 'Weak', fair: 'Fair', good: 'Good', strong: 'Strong' };
    const colors = { weak: 'var(--error)', fair: 'var(--amber)', good: '#66BB6A', strong: 'var(--success)' };

    bars.forEach((bar, i) => {
        bar.className = 'pw-bar';
        if (i < Math.ceil(score * 0.8)) bar.classList.add(strength);
    });
    label.textContent = labels[strength];
    label.style.color = colors[strength];
}

async function changePassword() {
    const current = document.getElementById('currentPassword').value;
    const newPw = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmPassword').value;
    const msgEl = document.getElementById('passwordMsg');

    msgEl.style.display = 'none';

    if (!current) { showPasswordMsg('Please enter your current password.', true); return; }
    if (newPw.length < 8) { showPasswordMsg('New password must be at least 8 characters.', true); return; }
    if (newPw !== confirm) { showPasswordMsg('Passwords do not match.', true); return; }

    if (isPreviewMode) {
        showPasswordMsg('Password change is not available in Preview Mode.', true);
        return;
    }

    try {
        const user = auth.currentUser;
        const credential = firebase.auth.EmailAuthProvider.credential(user.email, current);
        await user.reauthenticateWithCredential(credential);
        await user.updatePassword(newPw);

        showPasswordMsg('‚úì Password updated successfully!', false);
        logActivity('Password changed', `${user.email} changed their password`);

        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        document.getElementById('passwordStrength').style.display = 'none';
    } catch (err) {
        showPasswordMsg(err.message, true);
    }
}

function showPasswordMsg(msg, isError) {
    const el = document.getElementById('passwordMsg');
    el.textContent = msg;
    el.style.color = isError ? 'var(--error)' : 'var(--success)';
    el.style.display = 'block';
}

// ========================================
// SETTINGS ‚Äî MFA MANAGEMENT
// ========================================
function renderMFAStatus() {
    const container = document.getElementById('mfaStatus');
    if (!container) return;

    const user = auth.currentUser;
    const hasFirebaseMFA = user && user.multiFactor && user.multiFactor.enrolledFactors.length > 0;

    if (hasFirebaseMFA) {
        container.innerHTML = `
            <div class="mfa-enabled-badge">‚úì MFA is enabled</div>
            <p style="font-size:13px;color:var(--text-light);margin-bottom:16px;line-height:1.5;">
                Two-factor authentication is active on your account. You'll be prompted for a code from your authenticator app each time you sign in.
            </p>
            <button class="action-btn danger" onclick="disableMFA()" style="padding:10px 18px;">Disable MFA</button>
        `;
    } else if (isPreviewMode) {
        container.innerHTML = `
            <p style="font-size:13px;color:var(--text-light);margin-bottom:16px;line-height:1.5;">
                MFA adds an extra layer of security. After entering your password, you'll also need a 6-digit code from an authenticator app (Google Authenticator, Authy, 1Password, etc.).
            </p>
            <div style="background:var(--warm-light);border-radius:10px;padding:16px;margin-bottom:16px;">
                <p style="font-size:13px;color:var(--text);font-weight:600;margin-bottom:8px;">üîç Preview Mode</p>
                <p style="font-size:12px;color:var(--text-light);line-height:1.5;">MFA enrollment requires a real Firebase Auth session. Sign in with your real admin account to set up MFA.</p>
            </div>
        `;
    } else {
        container.innerHTML = `
            <p style="font-size:13px;color:var(--text-light);margin-bottom:20px;line-height:1.5;">
                MFA adds an extra layer of security. After entering your password, you'll also need a 6-digit code from an authenticator app (Google Authenticator, Authy, 1Password, etc.).
            </p>
            <div class="mfa-setup-steps">
                <div class="mfa-step">
                    <div class="mfa-step-num">1</div>
                    <div class="mfa-step-content">
                        <p><strong style="color:var(--text);">Enable MFA in Firebase Console</strong></p>
                        <p>Go to Firebase Console ‚Üí Authentication ‚Üí Sign-in method ‚Üí Multi-factor authentication and enable TOTP. This is a one-time project-level setup.</p>
                    </div>
                </div>
                <div class="mfa-step">
                    <div class="mfa-step-num">2</div>
                    <div class="mfa-step-content">
                        <p><strong style="color:var(--text);">Enroll your authenticator</strong></p>
                        <p>Click the button below to start enrollment. You'll scan a QR code with your authenticator app and verify with a 6-digit code.</p>
                    </div>
                </div>
            </div>
            <button class="btn-invite" onclick="startMFAEnrollment()" style="padding:12px 18px;font-size:14px;margin-top:18px;">
                <span>üîê Set Up MFA</span>
            </button>
            <div id="mfaEnrollmentArea" style="display:none;margin-top:20px;padding:20px;background:var(--warm-light);border-radius:12px;">
                <!-- Populated during enrollment -->
            </div>
        `;
    }
}

async function startMFAEnrollment() {
    const area = document.getElementById('mfaEnrollmentArea');
    area.style.display = 'block';

    try {
        const user = auth.currentUser;

        // Re-authenticate first (required for MFA enrollment)
        area.innerHTML = `
            <p style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:12px;">Step 1: Confirm your password</p>
            <input type="password" class="form-input" id="mfaReauthPassword" placeholder="Enter your current password" style="margin-bottom:12px;">
            <button class="btn-invite" onclick="continueEnrollment()" style="padding:10px 16px;font-size:13px;">Continue</button>
        `;
    } catch (err) {
        area.innerHTML = `<p style="color:var(--error);font-size:13px;">${err.message}</p>`;
    }
}

async function continueEnrollment() {
    const area = document.getElementById('mfaEnrollmentArea');
    const password = document.getElementById('mfaReauthPassword').value;

    if (!password) { alert('Please enter your password.'); return; }

    try {
        const user = auth.currentUser;
        const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
        await user.reauthenticateWithCredential(credential);

        // Start TOTP enrollment
        const session = await user.multiFactor.getSession();

        if (firebase.auth.TotpMultiFactorGenerator) {
            const totpSecret = await firebase.auth.TotpMultiFactorGenerator.generateSecret(session);
            const otpUri = totpSecret.generateQrCodeUrl(user.email, 'MyoMesh Admin');

            area.innerHTML = `
                <p style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:8px;">Step 2: Scan QR Code</p>
                <p style="font-size:12px;color:var(--text-light);margin-bottom:12px;">Scan this with your authenticator app, then enter the 6-digit code below.</p>
                <div style="text-align:center;margin:16px 0;">
                    <img id="mfaQrCode" style="width:180px;height:180px;border-radius:8px;" />
                    <p style="font-size:11px;color:var(--text-light);margin-top:8px;">Or enter this key manually:</p>
                    <code style="font-size:12px;color:var(--forest);background:white;padding:4px 10px;border-radius:6px;user-select:all;">${totpSecret.secretKey}</code>
                </div>
                <input type="text" class="form-input" id="mfaVerifyCode" placeholder="Enter 6-digit code" maxlength="6" style="text-align:center;font-size:18px;letter-spacing:0.2em;margin-bottom:12px;">
                <button class="btn-invite" onclick="finalizeMFAEnrollment()" style="padding:10px 16px;font-size:13px;">
                    <span>Verify & Enable MFA</span>
                </button>
            `;

            // Generate QR code using a simple API
            document.getElementById('mfaQrCode').src = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(otpUri)}`;

            // Store secret for verification
            window._totpSecret = totpSecret;
        } else {
            area.innerHTML = `
                <p style="color:var(--amber);font-size:13px;line-height:1.5;">
                    <strong>TOTP MFA</strong> requires Firebase Identity Platform (upgraded project). 
                    Enable it in your Firebase Console ‚Üí Authentication ‚Üí Settings ‚Üí Multi-factor authentication.
                </p>
            `;
        }
    } catch (err) {
        area.innerHTML = `<p style="color:var(--error);font-size:13px;">${err.message}</p>`;
    }
}

async function finalizeMFAEnrollment() {
    const code = document.getElementById('mfaVerifyCode').value.trim();
    if (code.length !== 6) { alert('Please enter a 6-digit code.'); return; }

    try {
        const assertion = firebase.auth.TotpMultiFactorGenerator.assertionForEnrollment(window._totpSecret, code);
        await auth.currentUser.multiFactor.enroll(assertion, 'Authenticator App');

        // Update admin profile
        if (currentAdminProfile?.id) {
            try {
                await db.collection('platform_admins').doc(currentAdminProfile.id).update({ mfaEnabled: true });
            } catch (e) { /* ignore in demo */ }
        }
        currentAdminProfile.mfaEnabled = true;
        const adminRecord = allAdmins.find(a => a.email === currentAdminProfile.email);
        if (adminRecord) adminRecord.mfaEnabled = true;

        logActivity('MFA enabled', `${currentAdminProfile.email} enabled two-factor authentication`);
        renderMFAStatus();
        renderAdminList();
        alert('‚úì MFA is now enabled! You\'ll need your authenticator app next time you sign in.');
    } catch (err) {
        alert('Verification failed: ' + err.message);
    }
}

async function disableMFA() {
    if (!confirm('Disable two-factor authentication? Your account will be less secure.')) return;

    try {
        const user = auth.currentUser;
        const factors = user.multiFactor.enrolledFactors;
        for (const factor of factors) {
            await user.multiFactor.unenroll(factor);
        }
        if (currentAdminProfile?.id) {
            try {
                await db.collection('platform_admins').doc(currentAdminProfile.id).update({ mfaEnabled: false });
            } catch (e) { /* ignore */ }
        }
        currentAdminProfile.mfaEnabled = false;
        const adminRecord = allAdmins.find(a => a.email === currentAdminProfile.email);
        if (adminRecord) adminRecord.mfaEnabled = false;

        logActivity('MFA disabled', `${currentAdminProfile.email} disabled two-factor authentication`);
        renderMFAStatus();
        renderAdminList();
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// ========================================
// SETTINGS ‚Äî ACTIVITY LOG
// ========================================
function logActivity(action, details) {
    const entry = {
        time: new Date().toISOString(),
        admin: currentAdminProfile?.email || 'system',
        action: action,
        details: details
    };
    activityLog.unshift(entry);
    if (activityLog.length > 50) activityLog.pop();

    // Try to save to Firestore
    try {
        db.collection('admin_activity_log').add(entry);
    } catch (e) { /* ignore in demo */ }

    renderActivityLog();
}

function renderActivityLog() {
    const tbody = document.getElementById('activityLogBody');
    if (!tbody) return;

    if (activityLog.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:30px;color:var(--text-light);font-size:13px;">No activity logged yet.</td></tr>';
        return;
    }

    tbody.innerHTML = activityLog.slice(0, 20).map(entry => {
        const time = new Date(entry.time);
        const timeStr = time.toLocaleDateString() + ' ' + time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        return `<tr>
            <td style="white-space:nowrap;font-size:12px;">${timeStr}</td>
            <td style="font-size:12px;">${entry.admin}</td>
            <td><span style="font-weight:600;font-size:13px;">${entry.action}</span></td>
            <td style="font-size:12px;color:var(--text-light);">${entry.details}</td>
        </tr>`;
    }).join('');
}

// ========================================
// TAB SWITCHING
// ========================================
function switchAdminTab(tab) {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
    document.querySelector(`[onclick="switchAdminTab('${tab}')"]`).classList.add('active');
    document.getElementById(`panel-${tab}`).classList.add('active');
}

// ========================================
// DATA LOADING
// ========================================
let allStudios = [];
let allPayments = [];
let allCancellations = [];

async function loadAllAdminData() {
    try {
        // Load subscriptions collection
        const subsSnap = await db.collection('subscriptions').get();
        allStudios = subsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Load payments collection
        const paySnap = await db.collection('payments').orderBy('date', 'desc').get();
        allPayments = paySnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Load cancellation surveys
        const cancelSnap = await db.collection('cancellation_surveys').orderBy('date', 'desc').get();
        allCancellations = cancelSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        renderOverview();
        renderStudiosTable();
        renderPayments();
        renderGeography();
        renderChurn();
        loadFreeAccessRecords();
        loadAdmins();
    } catch (err) {
        console.error('Error loading admin data:', err);
        // If collections don't exist yet, use demo data
        loadDemoData();
    }
}

function loadDemoData() {
    // Demo data for development / preview
    const statuses = ['trial', 'active', 'active', 'active', 'active', 'cancelled', 'past_due'];
    const countries = ['Canada', 'Canada', 'USA', 'UK', 'Australia', 'Canada', 'USA'];
    const regions = ['Ontario', 'British Columbia', 'California', 'London', 'NSW', 'Alberta', 'New York'];
    const cities = ['Toronto', 'Vancouver', 'Los Angeles', 'London', 'Sydney', 'Calgary', 'New York'];
    const names = ['Flow Pilates Studio', 'West Coast Wellness', 'SoCal Movement', 'London Body Works', 'Sydney Stretch Co', 'Prairie Strength', 'Brooklyn Bodywork'];
    const owners = ['Sarah Mitchell', 'James Chen', 'Maria Lopez', 'Emily Watson', 'David Kim', 'Rachel Brown', 'Alex Johnson'];
    const currencies = ['cad', 'cad', 'usd', 'gbp', 'aud', 'cad', 'usd'];
    const cancelReasons = [
        'Too expensive for my practice size',
        'Missing features I need',
        'Switched to another platform',
        'Closing my studio',
        'Not enough time to set it up',
        'Interface was confusing',
        'Customer support response time',
        'Other'
    ];

    allStudios = names.map((name, i) => {
        const signupDate = new Date();
        signupDate.setDate(signupDate.getDate() - Math.floor(Math.random() * 90) - 5);
        const trialEnd = new Date(signupDate);
        trialEnd.setDate(trialEnd.getDate() + 14);
        return {
            id: 'studio_' + i,
            studioName: name,
            ownerName: owners[i],
            ownerEmail: owners[i].toLowerCase().replace(' ', '.') + '@email.com',
            status: statuses[i],
            currency: currencies[i],
            signupDate: signupDate.toISOString(),
            trialEndDate: trialEnd.toISOString(),
            country: countries[i],
            region: regions[i],
            city: cities[i],
            staffCount: Math.floor(Math.random() * 7) + 1,
            clientCount: Math.floor(Math.random() * 80) + 5,
            sessionCount: Math.floor(Math.random() * 300) + 10,
            stripeCustomerId: 'cus_' + Math.random().toString(36).substr(2, 14),
            stripeSubscriptionId: 'sub_' + Math.random().toString(36).substr(2, 14),
            cardLast4: String(Math.floor(Math.random() * 9000) + 1000),
            cardBrand: ['visa', 'mastercard', 'amex'][Math.floor(Math.random() * 3)],
            monthlyAmount: { cad: 55, usd: 39, gbp: 31, aud: 59 }[currencies[i]],
            planId: ['grow', 'build', 'build', 'pro', 'build', 'grow', 'build'][i],
            smsPack: ['none', 'starter', 'standard', 'high', 'none', 'none', 'starter'][i]
        };
    });

    // Add more demo studios for variety
    for (let i = 0; i < 18; i++) {
        const signupDate = new Date();
        signupDate.setDate(signupDate.getDate() - Math.floor(Math.random() * 120));
        const trialEnd = new Date(signupDate);
        trialEnd.setDate(trialEnd.getDate() + 14);
        const status = ['trial', 'active', 'active', 'active', 'cancelled'][Math.floor(Math.random() * 5)];
        const currency = ['cad', 'usd', 'gbp', 'aud'][Math.floor(Math.random() * 4)];
        const planId = ['grow', 'grow', 'build', 'build', 'build', 'pro'][Math.floor(Math.random() * 6)];
        const smsPack = ['none', 'none', 'starter', 'standard', 'none', 'high'][Math.floor(Math.random() * 6)];
        allStudios.push({
            id: 'studio_x' + i,
            studioName: ['Peak Performance', 'Mindful Movement', 'Core Balance', 'Zen Studio', 'Flex & Flow', 'Body Harmony', 'Movement Lab', 'Vitality Clinic', 'Restore Studio', 'Align Wellness', 'The Pilates Room', 'Urban Stretch', 'Balance Point', 'Kinetic Health', 'Posture Pro', 'Motion Studio', 'InnerCore', 'FitBody Studio'][i],
            ownerName: 'Owner ' + (i + 8),
            ownerEmail: 'owner' + (i + 8) + '@email.com',
            status: status,
            currency: currency,
            signupDate: signupDate.toISOString(),
            trialEndDate: trialEnd.toISOString(),
            country: ['Canada', 'USA', 'UK', 'Australia'][Math.floor(Math.random() * 4)],
            region: ['Ontario', 'BC', 'California', 'London', 'NSW', 'Alberta', 'New York', 'Texas'][Math.floor(Math.random() * 8)],
            city: ['Toronto', 'Vancouver', 'LA', 'London', 'Sydney', 'Calgary', 'NYC', 'Austin'][Math.floor(Math.random() * 8)],
            staffCount: Math.floor(Math.random() * 7) + 1,
            clientCount: Math.floor(Math.random() * 60) + 2,
            sessionCount: Math.floor(Math.random() * 200) + 5,
            stripeCustomerId: 'cus_' + Math.random().toString(36).substr(2, 14),
            stripeSubscriptionId: 'sub_' + Math.random().toString(36).substr(2, 14),
            cardLast4: String(Math.floor(Math.random() * 9000) + 1000),
            cardBrand: ['visa', 'mastercard', 'amex'][Math.floor(Math.random() * 3)],
            planId: planId,
            smsPack: smsPack,
            monthlyAmount: (PLANS[planId]?.price[currency] || 55) + (SMS_PACKS[smsPack]?.price[currency] || 0)
        });
    }

    // Demo payments
    allPayments = allStudios.filter(s => s.status === 'active').map((s, i) => ({
        id: 'pay_' + i,
        studioId: s.id,
        studioName: s.studioName,
        date: new Date(Date.now() - Math.floor(Math.random() * 60) * 86400000).toISOString(),
        amount: s.monthlyAmount,
        currency: s.currency,
        status: Math.random() > 0.05 ? 'succeeded' : 'failed',
        stripePaymentId: 'pi_' + Math.random().toString(36).substr(2, 16),
        cardLast4: s.cardLast4,
        cardBrand: s.cardBrand
    }));

    // Demo cancellation surveys
    const cancelledStudios = allStudios.filter(s => s.status === 'cancelled');
    allCancellations = cancelledStudios.map((s, i) => {
        const wasTrial = Math.random() > 0.5;
        return {
            id: 'cancel_' + i,
            studioId: s.id,
            studioName: s.studioName,
            date: new Date(Date.now() - Math.floor(Math.random() * 30) * 86400000).toISOString(),
            cancelType: wasTrial ? 'trial' : 'paid',
            daysActive: wasTrial ? Math.floor(Math.random() * 14) + 1 : Math.floor(Math.random() * 90) + 15,
            primaryReason: cancelReasons[Math.floor(Math.random() * cancelReasons.length)],
            feedback: ['Great concept but not ready yet', 'Will come back when I have more clients', 'Need more integrations', 'Loved it but closing shop', ''][Math.floor(Math.random() * 5)],
            wouldReturn: Math.random() > 0.4 ? 'Yes' : 'No',
            rating: Math.floor(Math.random() * 5) + 1
        };
    });

    renderOverview();
    renderStudiosTable();
    renderPayments();
    renderGeography();
    renderChurn();
    
    // Demo free access records
    allFreeAccessRecords = [
        {
            id: 'fa_demo1',
            type: 'invite',
            inviteeName: 'Peak Studio ‚Äî Lisa Chen',
            email: 'lisa@peakstudio.com',
            freeMonths: 2,
            plan: 'build',
            inviteCode: 'MYO-R7KX-4TPN',
            note: 'Beta tester, referred by Sarah M.',
            status: 'pending',
            createdAt: new Date(Date.now() - 5 * 86400000).toISOString(),
            expiresAt: new Date(Date.now() + 25 * 86400000).toISOString(),
            createdBy: 'admin@myomesh.com'
        },
        {
            id: 'fa_demo2',
            type: 'invite',
            inviteeName: 'Harmony Wellness',
            email: 'info@harmonywellness.com',
            freeMonths: 3,
            plan: 'pro',
            inviteCode: 'MYO-8GWL-N2HM',
            note: 'Conference contact, interested in Pro',
            status: 'redeemed',
            createdAt: new Date(Date.now() - 20 * 86400000).toISOString(),
            expiresAt: new Date(Date.now() + 70 * 86400000).toISOString(),
            createdBy: 'admin@myomesh.com'
        },
        {
            id: 'fa_demo3',
            type: 'grant',
            studioId: 'studio_0',
            studioName: allStudios[0]?.studioName || 'Flow Pilates Studio',
            email: allStudios[0]?.ownerEmail || 'sarah.mitchell@email.com',
            freeMonths: 1,
            reason: 'customer_service',
            note: 'Experienced payment issue during migration',
            status: 'active',
            createdAt: new Date(Date.now() - 3 * 86400000).toISOString(),
            expiresAt: new Date(Date.now() + 27 * 86400000).toISOString(),
            createdBy: 'admin@myomesh.com'
        }
    ];
    renderFreeAccessPanel();

    // Demo admin data
    allAdmins = [
        { id: 'admin_1', email: 'preview@myomesh.com', name: 'Super Admin', role: 'super_admin', mfaEnabled: true, addedBy: 'system', addedAt: '2025-01-01T00:00:00Z' },
        { id: 'admin_2', email: 'sarah@myomesh.com', name: 'Sarah Mitchell', role: 'admin', mfaEnabled: true, addedBy: 'preview@myomesh.com', addedAt: '2025-02-15T00:00:00Z' },
        { id: 'admin_3', email: 'james@myomesh.com', name: 'James Chen', role: 'viewer', mfaEnabled: false, addedBy: 'preview@myomesh.com', addedAt: '2025-03-01T00:00:00Z' }
    ];

    // Demo activity log
    activityLog = [
        { time: new Date(Date.now() - 2 * 3600000).toISOString(), admin: 'preview@myomesh.com', action: 'Signed in', details: 'Signed in via Preview Mode' },
        { time: new Date(Date.now() - 86400000).toISOString(), admin: 'sarah@myomesh.com', action: 'Grant free months', details: '1 month granted to Flow Pilates Studio (Customer Service)' },
        { time: new Date(Date.now() - 3 * 86400000).toISOString(), admin: 'preview@myomesh.com', action: 'Invite generated', details: 'MYO-R7KX-4TPN for lisa@peakstudio.com (2 months free)' },
        { time: new Date(Date.now() - 5 * 86400000).toISOString(), admin: 'preview@myomesh.com', action: 'Admin added', details: 'James Chen (james@myomesh.com) added as Viewer' },
        { time: new Date(Date.now() - 14 * 86400000).toISOString(), admin: 'preview@myomesh.com', action: 'MFA enabled', details: 'sarah@myomesh.com enabled two-factor authentication' }
    ];

    renderAdminList();
    renderMFAStatus();
    renderActivityLog();
}

// ========================================
// OVERVIEW PANEL
// ========================================
function renderOverview() {
    const total = allStudios.length;
    const trials = allStudios.filter(s => s.status === 'trial').length;
    const active = allStudios.filter(s => s.status === 'active').length;
    const cancelled = allStudios.filter(s => s.status === 'cancelled').length;
    const pastDue = allStudios.filter(s => s.status === 'past_due').length;

    // MRR calculation
    const mrr = allStudios.filter(s => s.status === 'active').reduce((sum, s) => {
        // Normalize to USD for MRR display
        const rates = { cad: 0.73, usd: 1, gbp: 1.27, aud: 0.65 };
        return sum + (s.monthlyAmount || 0) * (rates[s.currency] || 1);
    }, 0);

    const conversionRate = total > 0 ? Math.round((active / total) * 100) : 0;

    document.getElementById('overviewKPIs').innerHTML = `
        <div class="kpi-card">
            <div class="kpi-label">Total Studios</div>
            <div class="kpi-value">${total}</div>
            <div class="kpi-detail">All time sign-ups</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Active Subscribers</div>
            <div class="kpi-value" style="color:var(--sage);">${active}</div>
            <div class="kpi-detail">${pastDue} past due</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">In Trial</div>
            <div class="kpi-value" style="color:#7C3AED;">${trials}</div>
            <div class="kpi-detail">14-day free trial</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">MRR (USD)</div>
            <div class="kpi-value">$${mrr.toLocaleString(undefined, { maximumFractionDigits: 0 })}</div>
            <div class="kpi-detail">Monthly recurring revenue</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Conversion Rate</div>
            <div class="kpi-value">${conversionRate}%</div>
            <div class="kpi-detail">Trial ‚Üí Paid</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Churned</div>
            <div class="kpi-value" style="color:var(--error);">${cancelled}</div>
            <div class="kpi-detail">${total > 0 ? Math.round((cancelled / total) * 100) : 0}% churn rate</div>
        </div>
    `;

    // Sign-up chart (last 6 months)
    renderSignupChart();
    renderStatusChart(active, trials, cancelled, pastDue);
    renderRevenueChart();
    renderConversionChart(conversionRate);
    renderPlanDistChart();
    renderSmsDistChart();
}

function renderSignupChart() {
    const months = [];
    for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        months.push({ label: d.toLocaleString('default', { month: 'short' }), year: d.getFullYear(), month: d.getMonth() });
    }
    const counts = months.map(m => {
        return allStudios.filter(s => {
            const d = new Date(s.signupDate);
            return d.getMonth() === m.month && d.getFullYear() === m.year;
        }).length;
    });
    const max = Math.max(...counts, 1);
    document.getElementById('signupChart').innerHTML = months.map((m, i) => `
        <div class="chart-bar-row">
            <span class="chart-bar-label">${m.label}</span>
            <div class="chart-bar-track">
                <div class="chart-bar-fill" style="width:${(counts[i] / max) * 100}%;background:var(--sage);">${counts[i]}</div>
            </div>
        </div>
    `).join('');
}

function renderStatusChart(active, trials, cancelled, pastDue) {
    const total = active + trials + cancelled + pastDue || 1;
    const items = [
        { label: 'Active', count: active, color: 'var(--sage)' },
        { label: 'Trial', count: trials, color: '#7C3AED' },
        { label: 'Cancelled', count: cancelled, color: 'var(--error)' },
        { label: 'Past Due', count: pastDue, color: 'var(--amber)' },
    ];
    document.getElementById('statusChart').innerHTML = items.map(it => `
        <div class="chart-bar-row">
            <span class="chart-bar-label">${it.label}</span>
            <div class="chart-bar-track">
                <div class="chart-bar-fill" style="width:${(it.count / total) * 100}%;background:${it.color};">${it.count}</div>
            </div>
        </div>
    `).join('');
}

function renderRevenueChart() {
    const months = [];
    for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        months.push({ label: d.toLocaleString('default', { month: 'short' }), year: d.getFullYear(), month: d.getMonth() });
    }
    const revenues = months.map(m => {
        return allPayments.filter(p => {
            const d = new Date(p.date);
            return d.getMonth() === m.month && d.getFullYear() === m.year && p.status === 'succeeded';
        }).reduce((sum, p) => sum + (p.amount || 0), 0);
    });
    const max = Math.max(...revenues, 1);
    document.getElementById('revenueChart').innerHTML = months.map((m, i) => `
        <div class="chart-bar-row">
            <span class="chart-bar-label">${m.label}</span>
            <div class="chart-bar-track">
                <div class="chart-bar-fill" style="width:${(revenues[i] / max) * 100}%;background:var(--coral);">$${revenues[i]}</div>
            </div>
        </div>
    `).join('');
}

function renderConversionChart(rate) {
    document.getElementById('conversionChart').innerHTML = `
        <div style="position:relative;width:160px;height:160px;margin:0 auto;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);">
                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--border)" stroke-width="3"/>
                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--sage)" stroke-width="3" stroke-dasharray="${rate}, 100" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
                <span style="font-family:'DM Serif Display',serif;font-size:32px;color:var(--forest);">${rate}%</span>
                <span style="font-size:12px;color:var(--text-light);">Trial ‚Üí Paid</span>
            </div>
        </div>
    `;
}

function renderPlanDistChart() {
    const planCounts = { grow: 0, build: 0, pro: 0, unknown: 0 };
    allStudios.filter(s => s.status === 'active' || s.status === 'trial').forEach(s => {
        const p = s.planId || 'unknown';
        if (planCounts[p] !== undefined) planCounts[p]++;
        else planCounts.unknown++;
    });
    const total = Object.values(planCounts).reduce((a, b) => a + b, 0) || 1;
    const items = [
        { label: 'MyoGrow ($55)', count: planCounts.grow, color: 'var(--sage)' },
        { label: 'MyoBuild ($85)', count: planCounts.build, color: 'var(--coral)' },
        { label: 'MyoPro ($115)', count: planCounts.pro, color: 'var(--forest)' },
    ];
    if (planCounts.unknown > 0) items.push({ label: 'Legacy / Unknown', count: planCounts.unknown, color: 'var(--amber)' });

    document.getElementById('planDistChart').innerHTML = items.map(it => `
        <div class="chart-bar-row">
            <span class="chart-bar-label">${it.label}</span>
            <div class="chart-bar-track">
                <div class="chart-bar-fill" style="width:${(it.count / total) * 100}%;background:${it.color};">${it.count}</div>
            </div>
        </div>
    `).join('');
}

function renderSmsDistChart() {
    const smsCounts = {};
    allStudios.filter(s => s.status === 'active' || s.status === 'trial').forEach(s => {
        const p = s.smsPack || 'none';
        smsCounts[p] = (smsCounts[p] || 0) + 1;
    });
    const total = Object.values(smsCounts).reduce((a, b) => a + b, 0) || 1;
    const items = [
        { label: 'No SMS', count: smsCounts.none || 0, color: '#6B7280' },
        { label: 'Starter (500)', count: smsCounts.starter || 0, color: 'var(--sage)' },
        { label: 'Standard (1.5K)', count: smsCounts.standard || 0, color: 'var(--coral)' },
        { label: 'High Vol (5K)', count: smsCounts.high || 0, color: 'var(--forest)' },
    ].filter(it => it.count > 0);

    document.getElementById('smsDistChart').innerHTML = items.length > 0 ? items.map(it => `
        <div class="chart-bar-row">
            <span class="chart-bar-label">${it.label}</span>
            <div class="chart-bar-track">
                <div class="chart-bar-fill" style="width:${(it.count / total) * 100}%;background:${it.color};">${it.count}</div>
            </div>
        </div>
    `).join('') : '<div style="padding:20px;text-align:center;color:var(--text-light);font-size:13px;">No SMS data yet</div>';
}

// ========================================
// STUDIOS TABLE
// ========================================
function renderStudiosTable(filtered) {
    const studios = filtered || allStudios;
    const tbody = document.getElementById('studiosTableBody');
    const avatarColors = ['#3D8B7A', '#FF6B4A', '#7C3AED', '#DAA520', '#2CA01C', '#DC4F41', '#3B82F6'];

    tbody.innerHTML = studios.map((s, i) => {
        const signupDate = new Date(s.signupDate).toLocaleDateString();
        const trialEnd = new Date(s.trialEndDate).toLocaleDateString();
        const statusClass = s.status === 'trial' ? 'status-trial' : s.status === 'active' ? 'status-active' : s.status === 'past_due' ? 'status-past-due' : 'status-cancelled';
        const statusLabel = s.status === 'past_due' ? 'Past Due' : s.status.charAt(0).toUpperCase() + s.status.slice(1);
        const currSymbol = { cad: 'C$', usd: '$', gbp: '¬£', aud: 'A$' }[s.currency] || '$';

        return `<tr>
            <td>
                <div class="studio-name-cell">
                    <div class="studio-avatar" style="background:${avatarColors[i % avatarColors.length]};">${s.studioName.charAt(0)}</div>
                    <div class="studio-name-text">
                        <strong>${s.studioName}</strong>
                        <span>${s.ownerEmail}</span>
                    </div>
                </div>
            </td>
            <td>${s.ownerName}</td>
            <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
            <td>
                <div style="display:flex;flex-direction:column;gap:2px;">
                    <span style="font-weight:600;font-size:13px;">${PLANS[s.planId]?.name || s.currency.toUpperCase()}</span>
                    ${s.smsPack && s.smsPack !== 'none' ? `<span style="font-size:10px;color:var(--sage);font-weight:600;">+ ${SMS_PACKS[s.smsPack]?.name || ''} SMS</span>` : ''}
                </div>
            </td>
            <td>${signupDate}</td>
            <td>${trialEnd}</td>
            <td>${s.status === 'active' || s.status === 'past_due' ? currSymbol + s.monthlyAmount : '‚Äî'}</td>
            <td>${s.staffCount || 0}</td>
            <td>${s.sessionCount || 0}</td>
            <td>${s.clientCount || 0}</td>
            <td><button class="action-btn" onclick="viewStudioDetail('${s.id}')">View</button></td>
        </tr>`;
    }).join('');

    document.getElementById('studioCountLabel').textContent = `Showing ${studios.length} of ${allStudios.length} studios`;
}

function filterStudios() {
    const search = document.getElementById('studioSearch').value.toLowerCase();
    const status = document.getElementById('studioStatusFilter').value;
    let filtered = allStudios;
    if (search) {
        filtered = filtered.filter(s =>
            s.studioName.toLowerCase().includes(search) ||
            s.ownerName.toLowerCase().includes(search) ||
            s.ownerEmail.toLowerCase().includes(search) ||
            (s.city || '').toLowerCase().includes(search)
        );
    }
    if (status !== 'all') {
        filtered = filtered.filter(s => s.status === status);
    }
    renderStudiosTable(filtered);
}

function viewStudioDetail(studioId) {
    const s = allStudios.find(st => st.id === studioId);
    if (!s) return;
    document.getElementById('modalStudioName').textContent = s.studioName;
    const currSymbol = { cad: 'C$', usd: '$', gbp: '¬£', aud: 'A$' }[s.currency] || '$';
    const statusClass = s.status === 'trial' ? 'status-trial' : s.status === 'active' ? 'status-active' : s.status === 'past_due' ? 'status-past-due' : 'status-cancelled';
    const statusLabel = s.status === 'past_due' ? 'Past Due' : s.status.charAt(0).toUpperCase() + s.status.slice(1);

    document.getElementById('modalStudioBody').innerHTML = `
        <p class="modal-section-title">Account</p>
        <div class="modal-row"><span class="modal-row-label">Owner</span><span class="modal-row-value">${s.ownerName}</span></div>
        <div class="modal-row"><span class="modal-row-label">Email</span><span class="modal-row-value">${s.ownerEmail}</span></div>
        <div class="modal-row"><span class="modal-row-label">Status</span><span class="modal-row-value"><span class="status-badge ${statusClass}">${statusLabel}</span></span></div>
        <div class="modal-row"><span class="modal-row-label">Sign-up Date</span><span class="modal-row-value">${new Date(s.signupDate).toLocaleDateString()}</span></div>
        <div class="modal-row"><span class="modal-row-label">Trial End</span><span class="modal-row-value">${new Date(s.trialEndDate).toLocaleDateString()}</span></div>

        <p class="modal-section-title">Plan & Billing</p>
        <div class="modal-row"><span class="modal-row-label">Plan</span><span class="modal-row-value">${PLANS[s.planId]?.name || 'Legacy'} (${s.currency.toUpperCase()})</span></div>
        <div class="modal-row"><span class="modal-row-label">Plan Price</span><span class="modal-row-value">${currSymbol}${PLANS[s.planId]?.price[s.currency] || s.monthlyAmount} / month</span></div>
        <div class="modal-row"><span class="modal-row-label">Staff Limit</span><span class="modal-row-value">${PLANS[s.planId]?.maxStaff || '‚Äî'} max ¬∑ ${s.staffCount || 0} active</span></div>
        <div class="modal-row"><span class="modal-row-label">SMS Add-On</span><span class="modal-row-value">${s.smsPack && s.smsPack !== 'none' ? SMS_PACKS[s.smsPack]?.name + ' (' + (SMS_PACKS[s.smsPack]?.count || 0).toLocaleString() + ' SMS/mo) ¬∑ ' + currSymbol + (SMS_PACKS[s.smsPack]?.price[s.currency] || 0) + '/mo' : 'None'}</span></div>
        <div class="modal-row"><span class="modal-row-label">Total MRR</span><span class="modal-row-value" style="color:var(--sage);font-weight:700;">${currSymbol}${s.monthlyAmount} / month</span></div>
        <div class="modal-row"><span class="modal-row-label">Card</span><span class="modal-row-value">${(s.cardBrand || 'card').toUpperCase()} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${s.cardLast4 || '‚Äî'}</span></div>
        <div class="modal-row"><span class="modal-row-label">Stripe Customer</span><span class="modal-row-value" style="font-size:12px;font-family:monospace;">${s.stripeCustomerId || '‚Äî'}</span></div>
        <div class="modal-row"><span class="modal-row-label">Stripe Subscription</span><span class="modal-row-value" style="font-size:12px;font-family:monospace;">${s.stripeSubscriptionId || '‚Äî'}</span></div>
        ${s.cancelledAt ? `
        <div class="modal-row"><span class="modal-row-label">Cancelled At</span><span class="modal-row-value" style="color:var(--error);">${new Date(s.cancelledAt).toLocaleDateString()}</span></div>
        <div class="modal-row"><span class="modal-row-label">Cancel Reason</span><span class="modal-row-value">${s.cancelReason || '‚Äî'}</span></div>
        ${s.accessEndDate ? `<div class="modal-row"><span class="modal-row-label">Access Until</span><span class="modal-row-value">${new Date(s.accessEndDate).toLocaleDateString()}</span></div>` : ''}
        ` : ''}

        <p class="modal-section-title">Location</p>
        <div class="modal-row"><span class="modal-row-label">Country</span><span class="modal-row-value">${s.country || '‚Äî'}</span></div>
        <div class="modal-row"><span class="modal-row-label">Region</span><span class="modal-row-value">${s.region || '‚Äî'}</span></div>
        <div class="modal-row"><span class="modal-row-label">City</span><span class="modal-row-value">${s.city || '‚Äî'}</span></div>

        <p class="modal-section-title">Usage</p>
        <div class="modal-row"><span class="modal-row-label">Staff Members</span><span class="modal-row-value">${s.staffCount || 0} / ${PLANS[s.planId]?.maxStaff || '‚Äî'}</span></div>
        <div class="modal-row"><span class="modal-row-label">Total Clients</span><span class="modal-row-value">${s.clientCount || 0}</span></div>
        <div class="modal-row"><span class="modal-row-label">Total Sessions</span><span class="modal-row-value">${s.sessionCount || 0}</span></div>

        ${s.freeAccessGranted ? `
        <p class="modal-section-title" style="color:var(--sage);">üéÅ Active Free Access</p>
        <div class="modal-row"><span class="modal-row-label">Free Months</span><span class="modal-row-value" style="color:var(--sage);">${s.freeMonthsGranted || 0} month(s)</span></div>
        <div class="modal-row"><span class="modal-row-label">Free Until</span><span class="modal-row-value">${s.freeAccessEnd ? new Date(s.freeAccessEnd).toLocaleDateString() : '‚Äî'}</span></div>
        <div class="modal-row"><span class="modal-row-label">Reason</span><span class="modal-row-value">${s.freeAccessReason || '‚Äî'}</span></div>
        ` : ''}

        ${s.status === 'active' || s.status === 'past_due' || s.status === 'trial' ? `
        <div style="margin-top:24px;padding-top:20px;border-top:1px solid var(--border);display:flex;gap:10px;">
            <button class="action-btn" style="flex:1;padding:10px;" onclick="closeModal('studioDetailModal');switchAdminTab('freeaccess');prefillGrantStudio('${s.id}');">üéÅ Grant Free Months</button>
        </div>
        ` : ''}
    `;
    document.getElementById('studioDetailModal').classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

// ========================================
// PAYMENTS
// ========================================
function renderPayments(filtered) {
    const payments = filtered || allPayments;
    const succeeded = payments.filter(p => p.status === 'succeeded');
    const failed = payments.filter(p => p.status === 'failed');
    const totalCollected = succeeded.reduce((s, p) => s + (p.amount || 0), 0);

    document.getElementById('paymentKPIs').innerHTML = `
        <div class="kpi-card">
            <div class="kpi-label">Total Collected</div>
            <div class="kpi-value">$${totalCollected.toLocaleString()}</div>
            <div class="kpi-detail">${succeeded.length} successful payments</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Failed Payments</div>
            <div class="kpi-value" style="color:var(--error);">${failed.length}</div>
            <div class="kpi-detail">${payments.length > 0 ? Math.round((failed.length / payments.length) * 100) : 0}% failure rate</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Avg. Payment</div>
            <div class="kpi-value">$${succeeded.length > 0 ? Math.round(totalCollected / succeeded.length) : 0}</div>
            <div class="kpi-detail">Per transaction</div>
        </div>
    `;

    const tbody = document.getElementById('paymentsTableBody');
    tbody.innerHTML = payments.map(p => {
        const statusClass = p.status === 'succeeded' ? 'status-active' : p.status === 'failed' ? 'status-cancelled' : 'status-past-due';
        const currSymbol = { cad: 'C$', usd: '$', gbp: '¬£', aud: 'A$' }[p.currency] || '$';
        return `<tr>
            <td>${new Date(p.date).toLocaleDateString()}</td>
            <td>${p.studioName}</td>
            <td>${currSymbol}${p.amount}</td>
            <td>${(p.currency || 'usd').toUpperCase()}</td>
            <td><span class="status-badge ${statusClass}">${p.status.charAt(0).toUpperCase() + p.status.slice(1)}</span></td>
            <td style="font-family:monospace;font-size:11px;">${p.stripePaymentId || '‚Äî'}</td>
            <td>${(p.cardBrand || '').toUpperCase()} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${p.cardLast4 || ''}</td>
        </tr>`;
    }).join('');
}

function filterPayments() {
    const status = document.getElementById('paymentStatusFilter').value;
    let filtered = allPayments;
    if (status !== 'all') filtered = filtered.filter(p => p.status === status);
    renderPayments(filtered);
}

// ========================================
// GEOGRAPHY
// ========================================
function renderGeography() {
    // Countries
    const countryCounts = {};
    allStudios.forEach(s => {
        const c = s.country || 'Unknown';
        countryCounts[c] = (countryCounts[c] || 0) + 1;
    });
    const sortedCountries = Object.entries(countryCounts).sort((a, b) => b[1] - a[1]);
    document.getElementById('geoCountryList').innerHTML = sortedCountries.map(([name, count]) => `
        <div class="geo-item">
            <span class="geo-item-name">${name}</span>
            <span class="geo-item-count">${count} studio${count !== 1 ? 's' : ''}</span>
        </div>
    `).join('');

    // Regions
    const regionCounts = {};
    allStudios.forEach(s => {
        const r = s.region || 'Unknown';
        regionCounts[r] = (regionCounts[r] || 0) + 1;
    });
    const sortedRegions = Object.entries(regionCounts).sort((a, b) => b[1] - a[1]);
    document.getElementById('geoRegionList').innerHTML = sortedRegions.map(([name, count]) => `
        <div class="geo-item">
            <span class="geo-item-name">${name}</span>
            <span class="geo-item-count">${count} studio${count !== 1 ? 's' : ''}</span>
        </div>
    `).join('');

    // Cities
    const cityCounts = {};
    allStudios.forEach(s => {
        const c = s.city || 'Unknown';
        cityCounts[c] = (cityCounts[c] || 0) + 1;
    });
    const sortedCities = Object.entries(cityCounts).sort((a, b) => b[1] - a[1]);
    document.getElementById('geoCityList').innerHTML = sortedCities.map(([name, count]) => `
        <div class="geo-item">
            <span class="geo-item-name">${name}</span>
            <span class="geo-item-count">${count} studio${count !== 1 ? 's' : ''}</span>
        </div>
    `).join('');
}

// ========================================
// CHURN & SURVEYS
// ========================================
function renderChurn(filtered) {
    const cancellations = filtered || allCancellations;
    const trialCancels = cancellations.filter(c => c.cancelType === 'trial');
    const paidCancels = cancellations.filter(c => c.cancelType === 'paid');
    const avgDaysActive = cancellations.length > 0 ? Math.round(cancellations.reduce((s, c) => s + (c.daysActive || 0), 0) / cancellations.length) : 0;
    const wouldReturn = cancellations.filter(c => c.wouldReturn === 'Yes').length;

    document.getElementById('churnKPIs').innerHTML = `
        <div class="kpi-card">
            <div class="kpi-label">Total Cancellations</div>
            <div class="kpi-value" style="color:var(--error);">${cancellations.length}</div>
            <div class="kpi-detail">${trialCancels.length} trial ¬∑ ${paidCancels.length} paid</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Trial Churn</div>
            <div class="kpi-value">${trialCancels.length}</div>
            <div class="kpi-detail">Cancelled before day 15</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Paid Churn</div>
            <div class="kpi-value">${paidCancels.length}</div>
            <div class="kpi-detail">Cancelled after paying</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Avg. Days Active</div>
            <div class="kpi-value">${avgDaysActive}</div>
            <div class="kpi-detail">Before cancellation</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Would Return</div>
            <div class="kpi-value" style="color:var(--sage);">${cancellations.length > 0 ? Math.round((wouldReturn / cancellations.length) * 100) : 0}%</div>
            <div class="kpi-detail">${wouldReturn} of ${cancellations.length}</div>
        </div>
    `;

    // Render reason breakdowns
    renderReasonChart('trialCancelReasons', trialCancels);
    renderReasonChart('paidCancelReasons', paidCancels);

    // Table
    const tbody = document.getElementById('churnTableBody');
    tbody.innerHTML = cancellations.map(c => {
        const typeClass = c.cancelType === 'trial' ? 'status-trial' : 'status-cancelled';
        return `<tr>
            <td>${new Date(c.date).toLocaleDateString()}</td>
            <td>${c.studioName}</td>
            <td><span class="status-badge ${typeClass}">${c.cancelType === 'trial' ? 'Trial' : 'Paid'}</span></td>
            <td>${c.daysActive} days</td>
            <td>${c.primaryReason}</td>
            <td style="max-width:200px;white-space:normal;font-size:12px;color:var(--text-light);">${c.feedback || '‚Äî'}</td>
            <td>${c.wouldReturn === 'Yes' ? '<span style="color:var(--sage);font-weight:600;">Yes</span>' : '<span style="color:var(--error);font-weight:600;">No</span>'}</td>
        </tr>`;
    }).join('');
}

function renderReasonChart(containerId, cancellations) {
    const reasonCounts = {};
    cancellations.forEach(c => {
        const r = c.primaryReason || 'Other';
        reasonCounts[r] = (reasonCounts[r] || 0) + 1;
    });
    const sorted = Object.entries(reasonCounts).sort((a, b) => b[1] - a[1]);
    const max = sorted.length > 0 ? sorted[0][1] : 1;
    const colors = ['var(--coral)', 'var(--amber)', 'var(--sage)', '#7C3AED', '#3B82F6', 'var(--forest)', '#EC4899', '#6B7280'];

    document.getElementById(containerId).innerHTML = sorted.length > 0 ? sorted.map(([reason, count], i) => `
        <div class="survey-reason">
            <span class="survey-reason-label">${reason}</span>
            <div class="survey-reason-bar">
                <div class="survey-reason-fill" style="width:${(count / max) * 100}%;background:${colors[i % colors.length]};">${count}</div>
            </div>
            <span class="survey-reason-count">${cancellations.length > 0 ? Math.round((count / cancellations.length) * 100) : 0}%</span>
        </div>
    `).join('') : '<div style="padding:20px;text-align:center;color:var(--text-light);font-size:13px;">No cancellation data yet</div>';
}

function filterChurn() {
    const type = document.getElementById('churnTypeFilter').value;
    let filtered = allCancellations;
    if (type === 'trial') filtered = filtered.filter(c => c.cancelType === 'trial');
    if (type === 'paid') filtered = filtered.filter(c => c.cancelType === 'paid');
    renderChurn(filtered);
}

// ========================================
// FREE ACCESS SYSTEM
// ========================================
let allFreeAccessRecords = [];
let lastGeneratedInvite = null;

function renderFreeAccessPanel() {
    // Populate the studio dropdown for grants
    const select = document.getElementById('grantStudioSelect');
    const eligibleStudios = allStudios.filter(s => s.status === 'active' || s.status === 'past_due' || s.status === 'trial');
    select.innerHTML = '<option value="">‚Äî Choose a studio ‚Äî</option>' +
        eligibleStudios.map(s => {
            const statusLabel = s.status === 'past_due' ? 'Past Due' : s.status.charAt(0).toUpperCase() + s.status.slice(1);
            return `<option value="${s.id}">${s.studioName} ‚Äî ${s.ownerName} (${statusLabel})</option>`;
        }).join('');

    select.onchange = function () {
        const studio = allStudios.find(s => s.id === this.value);
        const preview = document.getElementById('grantStudioPreview');
        if (studio) {
            const currSymbol = { cad: 'C$', usd: '$', gbp: '¬£', aud: 'A$' }[studio.currency] || '$';
            const statusClass = studio.status === 'trial' ? 'status-trial' : studio.status === 'active' ? 'status-active' : 'status-past-due';
            const statusLabel = studio.status === 'past_due' ? 'Past Due' : studio.status.charAt(0).toUpperCase() + studio.status.slice(1);
            preview.innerHTML = `
                <div class="grant-preview">
                    <div class="grant-preview-avatar">${studio.studioName.charAt(0)}</div>
                    <div class="grant-preview-info">
                        <strong>${studio.studioName}</strong>
                        <span>${studio.ownerEmail} ¬∑ <span class="status-badge ${statusClass}" style="padding:2px 8px;font-size:10px;">${statusLabel}</span> ¬∑ ${PLANS[studio.planId]?.name || 'Plan'} ¬∑ ${currSymbol}${studio.monthlyAmount}/mo</span>
                    </div>
                </div>
            `;
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    };

    renderFreeAccessKPIs();
    renderFreeAccessTable();
}

function renderFreeAccessKPIs() {
    const pending = allFreeAccessRecords.filter(r => r.type === 'invite' && r.status === 'pending');
    const redeemed = allFreeAccessRecords.filter(r => r.type === 'invite' && r.status === 'redeemed');
    const activeGrants = allFreeAccessRecords.filter(r => r.type === 'grant' && r.status === 'active');
    const expired = allFreeAccessRecords.filter(r => r.status === 'expired');
    const totalFreeMonths = allFreeAccessRecords.reduce((s, r) => s + (r.freeMonths || 0), 0);

    document.getElementById('freeAccessKPIs').innerHTML = `
        <div class="kpi-card">
            <div class="kpi-label">Pending Invites</div>
            <div class="kpi-value" style="color:#2563EB;">${pending.length}</div>
            <div class="kpi-detail">Awaiting sign-up</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Redeemed Invites</div>
            <div class="kpi-value" style="color:var(--sage);">${redeemed.length}</div>
            <div class="kpi-detail">Studios signed up via invite</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Active Grants</div>
            <div class="kpi-value" style="color:#D97706;">${activeGrants.length}</div>
            <div class="kpi-detail">Free months in progress</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Total Free Months Given</div>
            <div class="kpi-value">${totalFreeMonths}</div>
            <div class="kpi-detail">${allFreeAccessRecords.length} total records</div>
        </div>
    `;
}

function renderFreeAccessTable(filtered) {
    const records = filtered || allFreeAccessRecords;
    const tbody = document.getElementById('freeAccessTableBody');

    if (records.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-light);font-size:14px;">
            No free access records yet. Use the forms above to invite a studio or grant free months.
        </td></tr>`;
        document.getElementById('freeAccessCountLabel').textContent = '0 records';
        return;
    }

    tbody.innerHTML = records.map(r => {
        const typeClass = r.type === 'invite' ? 'status-invite' : 'status-grant';
        const typeLabel = r.type === 'invite' ? '‚úâÔ∏è Invite' : 'üéÅ Grant';
        let statusClass = '';
        let statusLabel = '';
        if (r.status === 'pending') { statusClass = 'status-invite'; statusLabel = 'Pending'; }
        else if (r.status === 'redeemed') { statusClass = 'status-redeemed'; statusLabel = 'Redeemed'; }
        else if (r.status === 'active') { statusClass = 'status-grant'; statusLabel = 'Active'; }
        else if (r.status === 'expired') { statusClass = 'status-expired'; statusLabel = 'Expired'; }

        return `<tr>
            <td><span class="status-badge ${typeClass}">${typeLabel}</span></td>
            <td>
                <div style="display:flex;flex-direction:column;">
                    <strong style="font-size:13px;">${r.studioName || r.inviteeName || '‚Äî'}</strong>
                    <span style="font-size:11px;color:var(--text-light);">${r.email || ''}</span>
                </div>
            </td>
            <td style="font-weight:700;color:var(--forest);">${r.freeMonths} month${r.freeMonths > 1 ? 's' : ''}</td>
            <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
            <td>${new Date(r.createdAt).toLocaleDateString()}</td>
            <td>${r.expiresAt ? new Date(r.expiresAt).toLocaleDateString() : '‚Äî'}</td>
            <td style="max-width:180px;font-size:12px;color:var(--text-light);">
                ${r.reason ? '<strong>' + formatReason(r.reason) + '</strong>' : ''}
                ${r.note ? '<br>' + r.note : ''}
                ${r.inviteCode ? '<br><span style="font-family:monospace;font-size:10px;color:var(--sage);">Code: ' + r.inviteCode + '</span>' : ''}
            </td>
            <td>
                ${r.status === 'pending' ? `<button class="action-btn danger" onclick="revokeInvite('${r.id}')" style="font-size:11px;">Revoke</button>` : ''}
                ${r.status === 'active' ? `<button class="action-btn" onclick="viewStudioDetail('${r.studioId}')" style="font-size:11px;">View Studio</button>` : ''}
            </td>
        </tr>`;
    }).join('');

    document.getElementById('freeAccessCountLabel').textContent = `Showing ${records.length} record${records.length !== 1 ? 's' : ''}`;
}

function formatReason(reason) {
    const labels = {
        customer_service: 'Customer Service',
        bug_compensation: 'Bug Compensation',
        loyalty: 'Loyalty Reward',
        testing: 'Testing / Beta',
        other: 'Other'
    };
    return labels[reason] || reason;
}

function generateInvite() {
    const name = document.getElementById('inviteName').value.trim();
    const email = document.getElementById('inviteEmail').value.trim();
    const months = parseInt(document.querySelector('input[name="inviteMonths"]:checked').value);
    const plan = document.getElementById('invitePlan').value;
    const note = document.getElementById('inviteNote').value.trim();

    if (!name) { alert('Please enter a studio or contact name.'); return; }
    if (!email || !email.includes('@')) { alert('Please enter a valid email address.'); return; }

    // Check for duplicate pending invites
    const existingInvite = allFreeAccessRecords.find(r => r.type === 'invite' && r.email === email && r.status === 'pending');
    if (existingInvite) {
        if (!confirm(`There's already a pending invite for ${email}. Generate a new one anyway? (The old one will be revoked.)`)) return;
        existingInvite.status = 'expired';
    }

    // Generate unique invite code
    const code = 'MYO-' + generateCode(4) + '-' + generateCode(4);

    const now = new Date();
    const expiresAt = new Date(now);
    expiresAt.setDate(expiresAt.getDate() + 30); // Invite valid for 30 days

    const record = {
        id: 'fa_' + Date.now(),
        type: 'invite',
        inviteeName: name,
        email: email,
        freeMonths: months,
        plan: plan,
        inviteCode: code,
        note: note || '',
        status: 'pending',
        createdAt: now.toISOString(),
        expiresAt: expiresAt.toISOString(),
        createdBy: document.getElementById('adminEmailDisplay').textContent
    };

    allFreeAccessRecords.unshift(record);
    lastGeneratedInvite = record;

    // Save to Firestore
    saveFreeAccessRecord(record);
    logActivity('Invite generated', `${code} for ${email} (${months} month${months > 1 ? 's' : ''} free)`);

    // Show result
    document.getElementById('inviteCodeBox').textContent = code;
    document.getElementById('inviteResultMeta').innerHTML = `
        <strong>${name}</strong> ¬∑ ${email}<br>
        <span style="color:var(--sage);font-weight:600;">${months} month${months > 1 ? 's' : ''} free</span> ¬∑ ${PLANS[plan]?.name || 'Plan'} ¬∑ Expires in 30 days
    `;
    document.getElementById('inviteCodeResult').style.display = 'block';

    // Clear form
    document.getElementById('inviteName').value = '';
    document.getElementById('inviteEmail').value = '';
    document.getElementById('inviteNote').value = '';
    document.querySelector('input[name="inviteMonths"][value="1"]').checked = true;

    // Refresh table and KPIs
    renderFreeAccessKPIs();
    renderFreeAccessTable();
}

function generateCode(length) {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

function copyInviteCode() {
    if (!lastGeneratedInvite) return;
    navigator.clipboard.writeText(lastGeneratedInvite.inviteCode).then(() => {
        document.getElementById('copyInviteBtn').textContent = '‚úì Copied!';
        setTimeout(() => { document.getElementById('copyInviteBtn').textContent = 'üìã Copy Code'; }, 2000);
    });
}

function copyInviteLink() {
    if (!lastGeneratedInvite) return;
    const link = window.location.origin + '/signup?invite=' + lastGeneratedInvite.inviteCode;
    navigator.clipboard.writeText(link).then(() => {
        document.getElementById('copyInviteLinkBtn').textContent = '‚úì Copied!';
        setTimeout(() => { document.getElementById('copyInviteLinkBtn').textContent = 'üîó Copy Invite Link'; }, 2000);
    });
}

function dismissInviteResult() {
    document.getElementById('inviteCodeResult').style.display = 'none';
    lastGeneratedInvite = null;
}

function grantFreeMonths() {
    const studioId = document.getElementById('grantStudioSelect').value;
    const months = parseInt(document.querySelector('input[name="grantMonths"]:checked').value);
    const reason = document.getElementById('grantReason').value;
    const note = document.getElementById('grantNote').value.trim();

    if (!studioId) { alert('Please select a studio.'); return; }

    const studio = allStudios.find(s => s.id === studioId);
    if (!studio) { alert('Studio not found.'); return; }

    // Confirm
    if (!confirm(`Grant ${months} free month${months > 1 ? 's' : ''} to "${studio.studioName}"?\n\nTheir billing will be paused and they'll have full access for ${months} month${months > 1 ? 's' : ''}.`)) return;

    const now = new Date();
    const expiresAt = new Date(now);
    expiresAt.setMonth(expiresAt.getMonth() + months);

    const record = {
        id: 'fa_' + Date.now(),
        type: 'grant',
        studioId: studio.id,
        studioName: studio.studioName,
        email: studio.ownerEmail,
        freeMonths: months,
        reason: reason,
        note: note || '',
        status: 'active',
        createdAt: now.toISOString(),
        expiresAt: expiresAt.toISOString(),
        createdBy: document.getElementById('adminEmailDisplay').textContent
    };

    allFreeAccessRecords.unshift(record);

    // Update studio record
    studio.freeAccessGranted = true;
    studio.freeMonthsGranted = months;
    studio.freeAccessEnd = expiresAt.toISOString();
    studio.freeAccessReason = formatReason(reason);

    // Save to Firestore
    saveFreeAccessRecord(record);
    updateStudioFreeAccess(studio);
    logActivity('Grant free months', `${months} month${months > 1 ? 's' : ''} granted to ${studio.studioName} (${formatReason(reason)})`);

    // Reset form
    document.getElementById('grantStudioSelect').value = '';
    document.getElementById('grantStudioPreview').style.display = 'none';
    document.getElementById('grantNote').value = '';
    document.querySelector('input[name="grantMonths"][value="1"]').checked = true;

    // Refresh
    renderFreeAccessKPIs();
    renderFreeAccessTable();

    alert(`‚úì ${months} free month${months > 1 ? 's' : ''} granted to ${studio.studioName}. Their billing is paused until ${expiresAt.toLocaleDateString()}.`);
}

function revokeInvite(recordId) {
    const record = allFreeAccessRecords.find(r => r.id === recordId);
    if (!record) return;
    if (!confirm(`Revoke invite for ${record.inviteeName || record.email}? The code will no longer work.`)) return;
    record.status = 'expired';
    renderFreeAccessKPIs();
    renderFreeAccessTable();
    // Update Firestore
    saveFreeAccessRecord(record);
}

function prefillGrantStudio(studioId) {
    const select = document.getElementById('grantStudioSelect');
    select.value = studioId;
    select.dispatchEvent(new Event('change'));
    // Scroll to grant card
    document.querySelector('.free-access-grid').scrollIntoView({ behavior: 'smooth' });
}

function filterFreeAccess() {
    const filter = document.getElementById('freeAccessFilter').value;
    let filtered = allFreeAccessRecords;
    if (filter === 'invite_pending') filtered = filtered.filter(r => r.type === 'invite' && r.status === 'pending');
    else if (filter === 'invite_redeemed') filtered = filtered.filter(r => r.type === 'invite' && r.status === 'redeemed');
    else if (filter === 'grant_active') filtered = filtered.filter(r => r.type === 'grant' && r.status === 'active');
    else if (filter === 'expired') filtered = filtered.filter(r => r.status === 'expired');
    renderFreeAccessTable(filtered);
}

// Firestore save helpers (write to 'free_access' collection)
async function saveFreeAccessRecord(record) {
    try {
        await db.collection('free_access').doc(record.id).set(record);
    } catch (err) {
        console.log('Firestore save skipped (demo mode):', err.message);
    }
}

async function updateStudioFreeAccess(studio) {
    try {
        await db.collection('subscriptions').doc(studio.id).update({
            freeAccessGranted: studio.freeAccessGranted,
            freeMonthsGranted: studio.freeMonthsGranted,
            freeAccessEnd: studio.freeAccessEnd,
            freeAccessReason: studio.freeAccessReason
        });
    } catch (err) {
        console.log('Firestore update skipped (demo mode):', err.message);
    }
}

// Load free access records from Firestore
async function loadFreeAccessRecords() {
    try {
        const snap = await db.collection('free_access').orderBy('createdAt', 'desc').get();
        allFreeAccessRecords = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (err) {
        console.log('Free access collection not found, starting empty.');
        allFreeAccessRecords = [];
    }
    renderFreeAccessPanel();
}

// ========================================
// CSV EXPORTS
// ========================================
function exportStudiosCSV() {
    const headers = ['Studio Name', 'Owner', 'Email', 'Status', 'Plan', 'SMS Pack', 'Currency', 'Monthly', 'Sign-up', 'Trial End', 'Country', 'Region', 'City', 'Staff', 'Staff Limit', 'Clients', 'Sessions'];
    const rows = allStudios.map(s => [
        s.studioName, s.ownerName, s.ownerEmail, s.status, 
        PLANS[s.planId]?.name || 'Legacy', SMS_PACKS[s.smsPack]?.name || 'None',
        s.currency,
        s.monthlyAmount, new Date(s.signupDate).toLocaleDateString(),
        new Date(s.trialEndDate).toLocaleDateString(),
        s.country, s.region, s.city, s.staffCount, PLANS[s.planId]?.maxStaff || '‚Äî', s.clientCount, s.sessionCount
    ]);
    downloadCSV('myomesh-studios.csv', headers, rows);
}

function exportPaymentsCSV() {
    const headers = ['Date', 'Studio', 'Amount', 'Currency', 'Status', 'Stripe ID', 'Card'];
    const rows = allPayments.map(p => [
        new Date(p.date).toLocaleDateString(), p.studioName, p.amount,
        p.currency, p.status, p.stripePaymentId, `${p.cardBrand} ${p.cardLast4}`
    ]);
    downloadCSV('myomesh-payments.csv', headers, rows);
}

function downloadCSV(filename, headers, rows) {
    const csvContent = [headers.join(','), ...rows.map(r => r.map(v => `"${v}"`).join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', e => {
        if (e.target === m) m.classList.remove('active');
    });
});

</script>
</body>
</html>
