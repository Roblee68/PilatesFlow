<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Flow - Boutique Pilates CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #2C4A3E;
            --primary-light: #4A6B5D;
            --accent: #D4A574;
            --accent-light: #E8C9A1;
            --bg: #FAF8F5;
            --card: #FFFFFF;
            --text: #2A2A2A;
            --text-light: #6B6B6B;
            --border: #E5DFD6;
            --success: #5F8575;
            --warning: #D4A574;
            --error: #C86B5D;
            --shadow: rgba(44, 74, 62, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #FAF8F5 0%, #F5F1EA 100%);
            color: var(--text);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            right: -20%;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(212, 165, 116, 0.06) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: -30%;
            left: -10%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(44, 74, 62, 0.04) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        header {
            background: white;
            padding: 30px 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow);
            margin-bottom: 40px;
            border: 1px solid var(--border);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-icon {
            width: 75px;
            height: 75px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(44, 74, 62, 0.2);
            overflow: hidden;
            flex-shrink: 0;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .logo-icon span {
            display: block;
        }

        h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 42px;
            font-weight: 300;
            color: var(--primary);
            letter-spacing: -0.5px;
        }

        .tagline {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .nav-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 30px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 12px var(--shadow);
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 14px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab svg {
            width: 18px;
            height: 18px;
            stroke-width: 2;
            flex-shrink: 0;
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(44, 74, 62, 0.2);
        }

        .tab:hover:not(.active) {
            background: var(--bg);
            color: var(--primary);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .card {
/* Settings specific styles */
.settings-section {
    margin-bottom: 40px;
}

.settings-section h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 24px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border);
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 8px;
    letter-spacing: 0.5px;
}

.form-group input[type="text"],
.form-group input[type="number"] {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-family: 'Montserrat', sans-serif;
    font-size: 14px;
    transition: all 0.3s ease;
}

.form-group input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(44, 74, 62, 0.1);
}

.logo-upload-section {
    display: flex;
    align-items: center;
    gap: 20px;
}

.logo-preview {
    width: 80px;
    height: 80px;
    background: var(--bg);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border: 2px solid var(--border);
}

.logo-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.logo-preview-text {
    font-family: 'Cormorant Garamond', serif;
    font-size: 36px;
    font-weight: 600;
    color: var(--primary);
}

.file-upload-wrapper {
    flex: 1;
}

.file-upload-btn {
    display: inline-block;
    padding: 10px 20px;
    background: var(--primary);
    color: white;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-upload-btn:hover {
    background: var(--primary-light);
    transform: translateY(-2px);
}

.file-upload-btn input[type="file"] {
    display: none;
}

.teacher-list {
    display: grid;
    gap: 12px;
}

.teacher-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: var(--bg);
    border-radius: 10px;
    border: 2px solid var(--border);
    transition: all 0.3s ease;
}

.teacher-item.inactive {
    opacity: 0.5;
    background: #f5f5f5;
}

.teacher-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.teacher-name {
    font-weight: 600;
    color: var(--primary);
}

.teacher-status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.status-active {
    background: #E8F5E9;
    color: #2C4A3E;
}

.status-inactive {
    background: #FFE5E5;
    color: #C86B5D;
}

.teacher-actions {
    display: flex;
    gap: 8px;
}

.class-pricing-list {
    display: grid;
    gap: 15px;
}

.class-pricing-item {
    display: grid;
    grid-template-columns: 1fr 150px auto;
    gap: 15px;
    align-items: end;
    padding: 16px;
    background: var(--bg);
    border-radius: 10px;
    border: 2px solid var(--border);
}

.price-input-group {
    position: relative;
}

.price-input-group label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-light);
    margin-bottom: 6px;
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.price-input-group input {
    width: 100%;
    padding: 10px 10px 10px 25px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
}

.price-input-group::before {
    content: '$';
    position: absolute;
    left: 10px;
    bottom: 11px;
    font-weight: 600;
    color: var(--text-light);
}

.owner-management-list {
    display: grid;
    gap: 12px;
}

.owner-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: linear-gradient(135deg, #E8F5E9 0%, #F1F8F4 100%);
    border-radius: 10px;
    border: 2px solid #5F8575;
}

.owner-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.owner-badge {
    padding: 4px 12px;
    background: #2C4A3E;
    color: white;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.btn-primary {
    padding: 12px 24px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-family: 'Montserrat', sans-serif;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(44, 74, 62, 0.3);
}

.btn-secondary {
    padding: 10px 20px;
    background: transparent;
    color: var(--primary);
    border: 2px solid var(--primary);
    border-radius: 8px;
    font-family: 'Montserrat', sans-serif;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: var(--primary);
    color: white;
}

.btn-danger {
    padding: 10px 20px;
    background: transparent;
    color: var(--error);
    border: 2px solid var(--error);
    border-radius: 8px;
    font-family: 'Montserrat', sans-serif;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-danger:hover {
    background: var(--error);
    color: white;
}

.btn-small {
    padding: 6px 12px;
    font-size: 11px;
}

.add-new-section {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.add-new-section input {
    flex: 1;
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
}

.permission-notice {
    background: #FFF9E6;
    border-left: 4px solid var(--warning);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 13px;
    color: var(--text);
}
            
            background: var(--card);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 2px 20px var(--shadow);
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .income-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .income-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 16px var(--shadow);
        }

        .income-card.secondary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
        }

        .income-card.quickbooks {
            background: linear-gradient(135deg, #2CA01C 0%, #46B536 100%);
        }

        .income-label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .income-amount {
            font-family: 'Cormorant Garamond', serif;
            font-size: 36px;
            font-weight: 600;
            letter-spacing: -1px;
        }

        .income-subtitle {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
        }

        .form-card h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            font-weight: 400;
            color: var(--primary);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 18px;
        }

        .form-row-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .price-input-wrapper {
            display: flex;
            flex-direction: column;
        }

        .price-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 6px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            color: var(--text);
            background: var(--bg);
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(44, 74, 62, 0.06);
        }

        select {
            cursor: pointer;
        }

        textarea {
            resize: vertical;
            min-height: 70px;
            font-size: 13px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.05) 0%, rgba(212, 165, 116, 0.02) 100%);
            border-radius: 8px;
            border: 1.5px solid var(--accent-light);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 18px;
        }

        .checkbox-group:hover {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.08) 0%, rgba(212, 165, 116, 0.04) 100%);
            border-color: var(--accent);
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .checkbox-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--primary);
            cursor: pointer;
            letter-spacing: 0.3px;
            text-transform: none;
            margin: 0;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        button {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(44, 74, 62, 0.2);
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 74, 62, 0.3);
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1.5px solid var(--border);
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--primary);
        }

        .btn-google {
            background: white;
            color: var(--primary);
            border: 1.5px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-google:hover {
            background: var(--primary);
            color: white;
        }

        .btn-quickbooks {
            background: white;
            color: #2CA01C;
            border: 1.5px solid #2CA01C;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-quickbooks:hover {
            background: #2CA01C;
            color: white;
        }

        .btn-outlook {
            background: white;
            color: #0078D4;
            border: 1.5px solid #0078D4;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-outlook:hover {
            background: #0078D4;
            color: white;
        }

        .btn-invoice {
            background: linear-gradient(135deg, #2CA01C 0%, #46B536 100%);
            color: white;
            padding: 10px 18px;
            font-size: 11px;
        }

        .btn-invoice:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 160, 28, 0.3);
        }

        .client-selector {
            margin-bottom: 18px;
        }

        .client-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .client-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .client-chip:hover {
            background: var(--primary-light);
            transform: scale(1.05);
        }

        .client-chip .remove {
            width: 16px;
            height: 16px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .sessions-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .session-item {
            padding: 20px;
            background: var(--bg);
            border-radius: 12px;
            border: 1.5px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .session-item:hover {
            background: white;
            border-color: var(--primary);
            transform: translateX(4px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .session-type {
            font-weight: 600;
            font-size: 16px;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .session-datetime {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .session-clients {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .session-client-badge {
            padding: 4px 10px;
            background: linear-gradient(135deg, rgba(44, 74, 62, 0.1) 0%, rgba(44, 74, 62, 0.05) 100%);
            color: var(--primary);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .session-price {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            font-weight: 600;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .session-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 14px;
            font-size: 11px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-top: 8px;
            margin-right: 6px;
        }

        .status-repeating {
            background: rgba(95, 133, 117, 0.15);
            color: var(--success);
        }

        .status-vacation {
            background: rgba(212, 165, 116, 0.15);
            color: var(--warning);
        }

        .status-invoiced {
            background: rgba(44, 160, 28, 0.15);
            color: #2CA01C;
        }

        .status-paid {
            background: rgba(44, 160, 28, 0.25);
            color: #2CA01C;
            font-weight: 700;
        }

        .status-unpaid {
            background: rgba(200, 107, 93, 0.15);
            color: var(--error);
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 16px;
        }

        .integration-setup {
            background: linear-gradient(135deg, rgba(44, 160, 28, 0.05) 0%, rgba(44, 160, 28, 0.02) 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1.5px solid rgba(44, 160, 28, 0.2);
            margin-bottom: 25px;
        }

        .integration-setup.google {
            background: linear-gradient(135deg, rgba(66, 133, 244, 0.05) 0%, rgba(66, 133, 244, 0.02) 100%);
            border: 1.5px solid rgba(66, 133, 244, 0.2);
        }

        .integration-setup.outlook {
            background: linear-gradient(135deg, rgba(0, 120, 212, 0.03) 0%, rgba(0, 120, 212, 0.01) 100%);
            border: 1.5px solid rgba(0, 120, 212, 0.2);
        }

        .integration-setup h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 18px;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .integration-setup p {
            font-size: 13px;
            color: var(--text-light);
            line-height: 1.6;
            margin-bottom: 14px;
        }

        .integration-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: white;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--success);
        }

        .setup-steps {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 16px;
            border: 1.5px solid var(--border);
        }

        .setup-steps ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .setup-steps li {
            font-size: 13px;
            color: var(--text);
            margin-bottom: 8px;
        }

        .setup-steps code {
            background: var(--bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: var(--primary);
        }

        .setup-steps a {
            color: #2CA01C;
            text-decoration: none;
            font-weight: 600;
        }

        .setup-steps a:hover {
            text-decoration: underline;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            color: var(--text-light);
        }

        .multi-select {
            border: 1.5px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            background: var(--bg);
            max-height: 200px;
            overflow-y: auto;
        }

        .multi-select-option {
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .multi-select-option:hover {
            background: white;
        }

        .multi-select-option.selected {
            background: linear-gradient(135deg, rgba(44, 74, 62, 0.1) 0%, rgba(44, 74, 62, 0.05) 100%);
        }

        .multi-select-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .teacher-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .teacher-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg);
            border-radius: 10px;
            border: 1.5px solid var(--border);
        }

        .teacher-item.default-teacher {
            background: linear-gradient(135deg, rgba(44, 74, 62, 0.06) 0%, rgba(44, 74, 62, 0.02) 100%);
            border-color: var(--primary);
        }

        .teacher-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 15px;
        }

        .teacher-actions {
            display: flex;
            gap: 8px;
        }

        .default-badge {
            padding: 4px 10px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .warning-message {
            background: rgba(212, 165, 116, 0.1);
            border: 1.5px solid var(--accent-light);
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text);
            margin-bottom: 18px;
        }

        .rate-display {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .rate-pill {
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(44, 74, 62, 0.08) 0%, rgba(44, 74, 62, 0.04) 100%);
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            color: var(--primary);
        }

        .invoice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .invoice-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            color: var(--primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-light);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .modal-close:hover {
            color: var(--text);
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        .btn-primary {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 74, 62, 0.3);
        }

        .btn-secondary {
            padding: 12px 24px;
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--primary);
        }

        .btn-danger {
            padding: 8px 16px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        /* ========================================
           VISUAL CALENDAR STYLES
           ======================================== */
        
        .calendar-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 24px var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 30px;
            background: linear-gradient(135deg, var(--bg) 0%, #fff 100%);
            border-bottom: 1px solid var(--border);
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .calendar-nav-btn {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text);
            transition: all 0.2s ease;
        }

        .calendar-nav-btn:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .calendar-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 32px;
            font-weight: 400;
            color: var(--primary);
            letter-spacing: -0.5px;
        }

        .calendar-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .calendar-view-toggle {
            display: flex;
            background: var(--bg);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .view-toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-toggle-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .today-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .today-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 165, 116, 0.3);
        }

        .calendar-body {
            display: flex;
            min-height: 700px;
        }

        .teacher-sidebar {
            width: 220px;
            background: var(--bg);
            border-right: 1px solid var(--border);
            padding: 20px 0;
            flex-shrink: 0;
        }

        .teacher-sidebar-header {
            padding: 0 20px 16px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 12px;
        }

        .teacher-sidebar-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-light);
        }

        .teacher-filter-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .teacher-filter-item:hover {
            background: white;
        }

        .teacher-filter-item.selected {
            background: white;
            border-left-color: var(--primary);
        }

        .teacher-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
        }

        .teacher-filter-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
        }

        .teacher-filter-sessions {
            font-size: 11px;
            color: var(--text-light);
        }

        .calendar-grid-wrapper {
            flex: 1;
            overflow-x: auto;
        }

        .calendar-grid {
            display: grid;
            min-width: 100%;
        }

        .calendar-grid.week-view {
            grid-template-columns: 70px repeat(7, 1fr);
        }

        .calendar-grid.day-view {
            grid-template-columns: 70px 1fr;
        }

        .calendar-day-header {
            text-align: center;
            padding: 16px 8px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
        }

        .calendar-day-header.today {
            background: linear-gradient(135deg, rgba(44, 74, 62, 0.08) 0%, rgba(44, 74, 62, 0.04) 100%);
        }

        .day-name {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .day-number {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            font-weight: 600;
            color: var(--text);
        }

        .calendar-day-header.today .day-number {
            color: var(--primary);
        }

        .time-column {
            background: var(--bg);
            border-right: 1px solid var(--border);
        }

        .time-slot-label {
            height: 60px;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-light);
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        .day-column {
            border-right: 1px solid var(--border);
            position: relative;
        }

        .time-slot {
            height: 60px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s ease;
            position: relative;
        }

        .time-slot:hover {
            background: rgba(44, 74, 62, 0.04);
        }

        .time-slot:hover::after {
            content: '+ Add';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: 600;
            color: var(--primary);
            opacity: 0.6;
        }

        .calendar-event {
            position: absolute;
            left: 4px;
            right: 4px;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .calendar-event:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            z-index: 20;
        }

        .calendar-event.private {
            background: linear-gradient(135deg, #E8D5F0 0%, #F5EDF9 100%);
            border-left: 3px solid #9B6BB3;
        }

        .calendar-event.duet {
            background: linear-gradient(135deg, #FFF3CD 0%, #FFFAEB 100%);
            border-left: 3px solid #D4A574;
        }

        .calendar-event.trio {
            background: linear-gradient(135deg, #D4EDDA 0%, #E8F5E9 100%);
            border-left: 3px solid #5F8575;
        }

        .event-time {
            font-weight: 600;
            font-size: 11px;
            color: rgba(0,0,0,0.6);
            margin-bottom: 2px;
        }

        .event-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-client {
            font-size: 11px;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-icons {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
        }

        .event-icon {
            font-size: 12px;
            opacity: 0.7;
        }

        /* Teacher columns in calendar */
        .calendar-teacher-grid {
            display: flex;
            flex: 1;
        }

        .teacher-calendar-column {
            flex: 1;
            min-width: 200px;
            border-right: 1px solid var(--border);
        }

        .teacher-column-header {
            padding: 16px;
            text-align: center;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }

        .teacher-column-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            color: white;
        }

        .teacher-column-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }

        /* Calendar Quick Book Modal */
        .quick-book-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .quick-book-modal.active {
            display: flex;
        }

        .quick-book-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 480px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quick-book-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .quick-book-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            color: var(--primary);
        }

        .quick-book-subtitle {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .quick-book-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg);
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.2s ease;
        }

        .quick-book-close:hover {
            background: var(--error);
            color: white;
        }

        /* Empty state for calendar */
        .calendar-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .calendar-empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .calendar-empty-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .calendar-empty-text {
            font-size: 14px;
            color: var(--text-light);
            max-width: 300px;
        }

        /* Legend */
        .calendar-legend {
            display: flex;
            gap: 20px;
            padding: 16px 24px;
            background: var(--bg);
            border-top: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-light);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }

        .legend-color.private {
            background: #9B6BB3;
        }

        .legend-color.duet {
            background: #D4A574;
        }

        .legend-color.trio {
            background: #5F8575;
        }

        /* Client Profile Modal */
        .client-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .client-profile-modal.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .client-profile-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 1200px;
            margin: 20px auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .client-profile-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 24px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .client-profile-header h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            font-weight: 400;
            margin: 0;
        }

        .client-profile-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .client-profile-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .client-profile-body {
            padding: 30px;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 900px) {
            .profile-grid {
                grid-template-columns: 1fr;
            }
        }

        .profile-section {
            background: var(--bg);
            border-radius: 12px;
            padding: 20px;
        }

        .profile-section h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            color: var(--primary);
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .profile-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .profile-info-row:last-child {
            border-bottom: none;
        }

        .profile-info-label {
            color: var(--text-light);
            font-size: 13px;
        }

        .profile-info-value {
            font-weight: 500;
            color: var(--text);
        }

        /* Body Chart Styles */
        .body-chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .body-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .body-chart-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            color: var(--primary);
        }

        .body-chart-tools {
            display: flex;
            gap: 8px;
        }

        .body-chart-tool {
            width: 36px;
            height: 36px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .body-chart-tool:hover {
            border-color: var(--primary);
        }

        .body-chart-tool.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .body-chart-views {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            background: #f8f8f8;
            border-radius: 12px;
            padding: 15px;
        }

        @media (max-width: 768px) {
            .body-chart-views {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .body-view {
            position: relative;
            background: white;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border: 2px solid var(--border);
        }

        .body-view-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .body-svg-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1/2;
            cursor: crosshair;
        }

        .body-svg-container svg {
            width: 100%;
            height: 100%;
        }

        .pain-marker {
            position: absolute;
            width: 24px;
            height: 24px;
            background: #e74c3c;
            border: 3px solid #c0392b;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4);
            transition: transform 0.2s;
            z-index: 10;
        }

        .pain-marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .pain-marker.severity-low {
            background: #f1c40f;
            border-color: #d4ac0d;
            box-shadow: 0 2px 8px rgba(241, 196, 15, 0.5);
        }

        .pain-marker.severity-medium {
            background: #e67e22;
            border-color: #ca6f1e;
            box-shadow: 0 2px 8px rgba(230, 126, 34, 0.5);
        }

        .pain-marker.severity-high {
            background: #e74c3c;
            border-color: #c0392b;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.5);
        }

        .body-chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item-body {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-light);
        }

        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        .legend-dot.low { background: #f1c40f; }
        .legend-dot.medium { background: #e67e22; }
        .legend-dot.high { background: #e74c3c; }

        /* Notes Section */
        .client-notes-section {
            margin-top: 20px;
        }

        .notes-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .note-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .note-date {
            font-size: 12px;
            color: var(--text-light);
        }

        .note-delete {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 14px;
        }

        .note-content {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text);
        }

        .add-note-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .add-note-form textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
        }

        .add-note-form textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Appointments List */
        .appointments-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .appointment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .appointment-info {
            flex: 1;
        }

        .appointment-type {
            font-weight: 600;
            color: var(--primary);
        }

        .appointment-datetime {
            font-size: 13px;
            color: var(--text-light);
        }

        .appointment-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .appointment-status.upcoming {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .appointment-status.past {
            background: #f5f5f5;
            color: #757575;
        }

        /* Severity Selector */
        .severity-selector {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
        }

        .severity-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .severity-btn:hover {
            transform: scale(1.05);
        }

        .severity-btn.low { border-color: #f1c40f; color: #d4ac0d; }
        .severity-btn.low.active { background: #f1c40f; color: #333; }
        
        .severity-btn.medium { border-color: #e67e22; color: #e67e22; }
        .severity-btn.medium.active { background: #e67e22; color: white; }
        
        .severity-btn.high { border-color: #e74c3c; color: #e74c3c; }
        .severity-btn.high.active { background: #e74c3c; color: white; }

        /* Note with Body Chart */
        .note-body-chart {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
            padding: 12px;
            background: #f8f8f8;
            border-radius: 8px;
        }

        .note-body-view {
            position: relative;
            background: white;
            border-radius: 6px;
            padding: 5px;
            text-align: center;
        }

        .note-body-view-label {
            font-size: 9px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .note-body-svg {
            position: relative;
            width: 100%;
            aspect-ratio: 1/2;
        }

        .note-body-svg svg {
            width: 100%;
            height: 100%;
        }

        .note-pain-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
            font-weight: bold;
            z-index: 10;
        }

        .note-pain-marker.severity-low {
            background: #f1c40f;
            border: 2px solid #d4ac0d;
        }

        .note-pain-marker.severity-medium {
            background: #e67e22;
            border: 2px solid #ca6f1e;
        }

        .note-pain-marker.severity-high {
            background: #e74c3c;
            border: 2px solid #c0392b;
        }

        .note-markers-summary {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .marker-count {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: var(--text-light);
        }

        .marker-count-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
   
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                <div class="logo-section">
                    <div class="logo-icon" id="logoIcon">
                        <img src="" alt="SF" id="logoImage" style="display: none;">
                        <span id="logoText">SF</span>
                    </div>
                    <div>
                        <h1 id="mainStudioName">Studio Flow</h1>
                        <div class="tagline">Boutique Studio Management</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div id="userInfo" style="text-align: right;">
                        <div id="userName" style="font-weight: 600; color: var(--primary); font-size: 16px;"></div>
                        <div id="userRole" style="font-size: 12px; color: var(--text-light); margin-top: 3px;"></div>
                    </div>
                    <button onclick="handleLogout()" style="padding: 12px 24px; background: linear-gradient(135deg, #C86B5D 0%, #B5564A 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease;">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <nav class="nav-tabs">
          <button class="tab active" onclick="switchTab('clients', event)">
            <i data-lucide="users"></i>
            <span>Clients</span>
          </button>
          <button class="tab" onclick="switchTab('notes', event)">
            <i data-lucide="clipboard-list"></i>
            <span>Notes</span>
          </button>
          <button class="tab" onclick="switchTab('calendar', event)">
            <i data-lucide="calendar-days"></i>
            <span>Calendar</span>
          </button>
          <button class="tab" onclick="switchTab('invoices', event)">
            <i data-lucide="file-text"></i>
            <span>Invoices</span>
          </button>
          <button class="tab" onclick="switchTab('income', event)">
            <i data-lucide="trending-up"></i>
            <span>Income</span>
          </button>
          <button class="tab" id="settingsTab" onclick="switchTab('settings', event)">
            <i data-lucide="settings"></i>
            <span>Settings</span>
          </button>
        </nav>
        <!-- CLIENTS TAB -->
        <div id="clients-tab" class="tab-content active">
            <div class="main-grid">
                <div class="card form-card">
                    <h2><span class="section-icon"></span><span id="form-title">Add New Client</span></h2>
                    <form id="clientForm" onsubmit="addClient(event)">
                        <div class="form-group">
                            <label for="name">Client Name</label>
                            <input type="text" id="name" required placeholder="First & Last Name">
                        </div>

                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" required placeholder="client@email.com">
                        </div>

                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" required placeholder="(555) 123-4567">
                        </div>

                        <div>
                            <div class="form-row-label">Session Rates ($)</div>
                            <div class="form-row">
                                <div class="price-input-wrapper">
                                    <label class="price-label" for="ratePrivate">Private</label>
                                    <input type="number" id="ratePrivate" required placeholder="85" min="0" step="0.01">
                                </div>
                                <div class="price-input-wrapper">
                                    <label class="price-label" for="rateDuet">Duet</label>
                                    <input type="number" id="rateDuet" required placeholder="60" min="0" step="0.01">
                                </div>
                                <div class="price-input-wrapper">
                                    <label class="price-label" for="rateTrio">Trio</label>
                                    <input type="number" id="rateTrio" required placeholder="45" min="0" step="0.01">
                                </div>
                            </div>
                        </div>

                        <label class="checkbox-group">
                            <input type="checkbox" id="waiver">
                            <span class="checkbox-label">Liability Waiver on File</span>
                        </label>

                        <div class="form-group">
                            <label for="notes">Session Notes</label>
                            <textarea id="notes" placeholder="Equipment preferences, injuries, modifications..."></textarea>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn-primary" id="submitBtn">Add Client</button>
                            <button type="button" class="btn-secondary" id="cancelBtn" style="display: none;">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="card clients-card">
                    <h2>
                        <span><span class="section-icon"></span> Your Clients</span>
                        <span class="client-count" id="clientCount" style="font-size: 14px; font-family: 'Montserrat', sans-serif; font-weight: 500; color: var(--accent); letter-spacing: 1px;">0 Clients</span>
                    </h2>
                    
                    <div class="search-box">
                        <span class="search-icon"></span>
                        <input type="text" id="searchInput" placeholder="Search clients by name...">
                    </div>

                    <div class="sessions-list" id="clientList">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <div class="empty-text">No clients yet. Add your first client to get started!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOTES TAB -->
        <div id="notes-tab" class="tab-content">
            <div class="main-grid">
                <!-- Add/Edit Note Section -->
                <div class="card form-card">
                    <h2><span class="section-icon"></span> Session Notes & Body Chart</h2>
                    <p style="color: var(--text-light); font-size: 13px; margin-bottom: 20px;">
                        Record session notes with body chart markers to track client progress over time.
                    </p>

                    <!-- Client Selection -->
                    <div class="form-group">
                        <label>Select Client *</label>
                        <div style="position: relative;">
                            <input type="text" id="notesClientSearch" placeholder="Type to search clients..." autocomplete="off">
                            <div id="notesClientDropdown" class="client-search-dropdown" style="display: none;"></div>
                        </div>
                        <div id="notesSelectedClient" style="margin-top: 10px;"></div>
                    </div>

                    <!-- Date Selection -->
                    <div class="form-group">
                        <label>Session Date *</label>
                        <input type="date" id="notesSessionDate" required>
                    </div>

                    <!-- Severity Selector -->
                    <div class="form-group">
                        <label>Pain Severity Level</label>
                        <div class="severity-selector" style="justify-content: flex-start; margin-top: 8px;">
                            <button type="button" class="severity-btn low" onclick="setNotesPainSeverity('low')">1 - Mild</button>
                            <button type="button" class="severity-btn medium active" onclick="setNotesPainSeverity('medium')">2 - Moderate</button>
                            <button type="button" class="severity-btn high" onclick="setNotesPainSeverity('high')">3 - Severe</button>
                        </div>
                    </div>

                    <!-- Body Chart -->
                    <div class="form-group">
                        <label>Body Chart <span style="font-weight: normal; color: var(--text-light);">(Click to mark pain areas)</span></label>
                        <div class="body-chart-views" id="notesBodyChart" style="margin-top: 10px;">
                            <!-- Front View -->
                            <div class="body-view">
                                <div class="body-view-label">Front</div>
                                <div class="body-svg-container" id="notesBodyFront" onclick="addNotesPainMarker(event, 'front')">
                                    <svg viewBox="0 0 200 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <ellipse cx="100" cy="30" rx="25" ry="28" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <ellipse cx="74" cy="30" rx="5" ry="8" fill="#F5E6D3" stroke="#333" stroke-width="1"/>
                                        <ellipse cx="126" cy="30" rx="5" ry="8" fill="#F5E6D3" stroke="#333" stroke-width="1"/>
                                        <path d="M88 55 L88 70 L112 70 L112 55" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <path d="M88 70 L55 80 L40 95 L40 120 L35 180 L45 180 L55 130 L60 200 L75 200 L75 195 L85 195 L85 200 L115 200 L115 195 L125 195 L125 200 L140 200 L145 130 L155 180 L165 180 L160 120 L160 95 L145 80 L112 70" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <ellipse cx="80" cy="105" rx="12" ry="8" fill="none" stroke="#D4B896" stroke-width="1"/>
                                        <ellipse cx="120" cy="105" rx="12" ry="8" fill="none" stroke="#D4B896" stroke-width="1"/>
                                        <ellipse cx="100" cy="170" rx="4" ry="5" fill="#D4B896"/>
                                        <path d="M40 95 L25 150 L20 200 L15 220" fill="none" stroke="#333" stroke-width="1.5"/>
                                        <path d="M160 95 L175 150 L180 200 L185 220" fill="none" stroke="#333" stroke-width="1.5"/>
                                        <ellipse cx="15" cy="228" rx="10" ry="14" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <ellipse cx="185" cy="228" rx="10" ry="14" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <path d="M75 200 L70 280 L65 360" fill="none" stroke="#333" stroke-width="1.5"/>
                                        <path d="M85 200 L82 280 L80 360" fill="none" stroke="#333" stroke-width="1.5"/>
                                        <path d="M115 200 L118 280 L120 360" fill="none" stroke="#333" stroke-width="1.5"/>
                                        <path d="M125 200 L130 280 L135 360" fill="none" stroke="#333" stroke-width="1.5"/>
                                        <path d="M85 200 L90 280 L92 340 M115 200 L110 280 L108 340" fill="none" stroke="#D4B896" stroke-width="1"/>
                                        <ellipse cx="75" cy="280" rx="12" ry="8" fill="none" stroke="#D4B896" stroke-width="1"/>
                                        <ellipse cx="125" cy="280" rx="12" ry="8" fill="none" stroke="#D4B896" stroke-width="1"/>
                                        <ellipse cx="72" cy="375" rx="18" ry="10" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <ellipse cx="128" cy="375" rx="18" ry="10" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Back View -->
                            <div class="body-view">
                                <div class="body-view-label">Back</div>
                                <div class="body-svg-container" id="notesBodyBack" onclick="addNotesPainMarker(event, 'back')">
                                    <svg viewBox="0 0 200 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <ellipse cx="100" cy="30" rx="25" ry="28" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <ellipse cx="74" cy="30" rx="5" ry="8" fill="#F5E6D3" stroke="#333" stroke-width="1"/>
                                        <ellipse cx="126" cy="30" rx="5" ry="8" fill="#F5E6D3" stroke="#333" stroke-width="1"/>
                                        <path d="M88 55 L88 70 L112 70 L112 55" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <path d="M88 70 L55 80 L40 95 L40 120 L35 180 L45 180 L55 130 L60 200 L75 200 L75 195 L85 195 L85 200 L115 200 L115 195 L125 195 L125 200 L140 200 L145 130 L155 180 L165 180 L160 120 L160 95 L145 80 L112 70" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <path d="M100 70 L100 195" stroke="#D4B896" stroke-width="2" stroke-dasharray="5,3"/>
                                        <path d="M70 90 Q65 110 75 130" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <path d="M130 90 Q135 110 125 130" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <circle cx="85" cy="185" r="4" fill="#D4B896"/>
                                        <circle cx="115" cy="185" r="4" fill="#D4B896"/>
                                        <path d="M40 95 L25 150 L20 200 L15 220" fill="none" stroke="#333" stroke-width="1.5"/>
                                        <path d="M160 95 L175 150 L180 200 L185 220" fill="none" stroke="#333" stroke-width="1.5"/>
                                        <ellipse cx="15" cy="228" rx="10" ry="14" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <ellipse cx="185" cy="228" rx="10" ry="14" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <path d="M75 200 Q100 210 125 200" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <path d="M75 200 L70 280 L65 360" fill="none" stroke="#333" stroke-width="1.5"/>
                                        <path d="M85 200 L82 280 L80 360" fill="none" stroke="#333" stroke-width="1.5"/>
                                        <path d="M115 200 L118 280 L120 360" fill="none" stroke="#333" stroke-width="1.5"/>
                                        <path d="M125 200 L130 280 L135 360" fill="none" stroke="#333" stroke-width="1.5"/>
                                        <path d="M68 300 Q65 320 70 340" stroke="#D4B896" stroke-width="1" fill="none"/>
                                        <path d="M132 300 Q135 320 130 340" stroke="#D4B896" stroke-width="1" fill="none"/>
                                        <ellipse cx="72" cy="375" rx="18" ry="10" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <ellipse cx="128" cy="375" rx="18" ry="10" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Left Side View -->
                            <div class="body-view">
                                <div class="body-view-label">Left Side</div>
                                <div class="body-svg-container" id="notesBodyLeft" onclick="addNotesPainMarker(event, 'left')">
                                    <svg viewBox="0 0 150 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <ellipse cx="75" cy="30" rx="20" ry="28" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <ellipse cx="55" cy="30" rx="5" ry="8" fill="#F5E6D3" stroke="#333" stroke-width="1"/>
                                        <path d="M65 55 L65 70 L85 70 L85 55" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <path d="M65 70 L50 75 L40 90 L35 130 L40 180 L45 200 L70 200 L75 195 L80 200 L95 200 L100 180 L105 130 L100 90 L90 75 L85 70" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <path d="M50 85 Q42 110 50 140" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <path d="M100 85 Q108 110 100 150 Q95 170 95 195" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <path d="M95 195 Q105 200 100 210" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <path d="M42 90 L30 130 L25 170 L22 200 L18 215" stroke="#333" stroke-width="1.5" fill="none"/>
                                        <ellipse cx="15" cy="225" rx="8" ry="14" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <path d="M55 200 L50 280 L48 360" stroke="#333" stroke-width="1.5" fill="none"/>
                                        <path d="M85 200 L88 280 L90 360" stroke="#333" stroke-width="1.5" fill="none"/>
                                        <ellipse cx="70" cy="280" rx="15" ry="10" fill="none" stroke="#D4B896" stroke-width="1"/>
                                        <path d="M40 365 L48 360 L90 360 L95 370 Q80 385 45 380 Q35 375 40 365" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Right Side View -->
                            <div class="body-view">
                                <div class="body-view-label">Right Side</div>
                                <div class="body-svg-container" id="notesBodyRight" onclick="addNotesPainMarker(event, 'right')">
                                    <svg viewBox="0 0 150 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <ellipse cx="75" cy="30" rx="20" ry="28" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <ellipse cx="95" cy="30" rx="5" ry="8" fill="#F5E6D3" stroke="#333" stroke-width="1"/>
                                        <path d="M65 55 L65 70 L85 70 L85 55" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <path d="M65 70 L50 75 L40 90 L35 130 L40 180 L45 200 L70 200 L75 195 L80 200 L105 200 L110 180 L115 130 L110 90 L100 75 L85 70" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <path d="M110 85 Q118 110 110 140" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <path d="M40 85 Q32 110 40 150 Q45 170 45 195" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <path d="M45 195 Q35 200 40 210" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <path d="M108 90 L120 130 L125 170 L128 200 L132 215" stroke="#333" stroke-width="1.5" fill="none"/>
                                        <ellipse cx="135" cy="225" rx="8" ry="14" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                        <path d="M55 200 L52 280 L50 360" stroke="#333" stroke-width="1.5" fill="none"/>
                                        <path d="M95 200 L98 280 L100 360" stroke="#333" stroke-width="1.5" fill="none"/>
                                        <ellipse cx="75" cy="280" rx="15" ry="10" fill="none" stroke="#D4B896" stroke-width="1"/>
                                        <path d="M45 365 L50 360 L100 360 L110 365 Q115 375 105 380 Q70 385 50 375 Q42 370 45 365" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Body Chart Legend & Clear -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; flex-wrap: wrap; gap: 10px;">
                            <div class="body-chart-legend" style="margin: 0;">
                                <div class="legend-item-body">
                                    <div class="legend-dot low"></div>
                                    <span>1 - Mild</span>
                                </div>
                                <div class="legend-item-body">
                                    <div class="legend-dot medium"></div>
                                    <span>2 - Moderate</span>
                                </div>
                                <div class="legend-item-body">
                                    <div class="legend-dot high"></div>
                                    <span>3 - Severe</span>
                                </div>
                            </div>
                            <button type="button" onclick="clearNotesBodyChart()" class="btn-secondary" style="padding: 8px 16px; font-size: 12px;"> Clear Markers</button>
                        </div>
                    </div>

                    <!-- Note Text -->
                    <div class="form-group">
                        <label>Session Notes</label>
                        <textarea id="notesTextArea" rows="4" placeholder="Describe the client's condition, treatment provided, exercises prescribed, progress notes..."></textarea>
                    </div>

                    <button type="button" onclick="saveSessionNote()" class="btn-primary" style="width: 100%;"> Save Session Note</button>
                </div>

                <!-- Notes History Section -->
                <div class="card">
                    <h2>
                        <span><span class="section-icon"></span> Notes History</span>
                    </h2>

                    <!-- Search/Filter -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px;">Filter by Client</label>
                            <div style="position: relative;">
                                <input type="text" id="notesHistoryClientSearch" placeholder="All clients" autocomplete="off">
                                <div id="notesHistoryClientDropdown" class="client-search-dropdown" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px;">Filter by Date</label>
                            <input type="date" id="notesHistoryDateFilter" onchange="filterNotesHistory()">
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span id="notesHistoryCount" style="color: var(--text-light); font-size: 13px;">0 notes found</span>
                        <button onclick="clearNotesFilters()" class="btn-secondary" style="padding: 6px 12px; font-size: 12px;">Clear Filters</button>
                    </div>

                    <!-- Notes List -->
                    <div class="notes-list" id="notesHistoryList" style="max-height: 500px;">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <div class="empty-text">No notes yet. Create your first session note above!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Note View Modal -->
        <div class="client-profile-modal" id="noteViewModal">
            <div class="client-profile-content" style="max-width: 900px;">
                <div class="client-profile-header">
                    <h2 id="noteViewTitle">Session Note</h2>
                    <button class="client-profile-close" onclick="closeNoteViewModal()">&times;</button>
                </div>
                <div class="client-profile-body" id="noteViewContent">
                    <!-- Content populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- CALENDAR TAB -->
        <div id="calendar-tab" class="tab-content">
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="calendarPrev()"></button>
                        <h2 class="calendar-title" id="calendarTitle">January 2026</h2>
                        <button class="calendar-nav-btn" onclick="calendarNext()"></button>
                    </div>
                    <div class="calendar-controls">
                        <div class="calendar-view-toggle">
                            <button class="view-toggle-btn" onclick="setCalendarView('day')" id="dayViewBtn">Day</button>
                            <button class="view-toggle-btn active" onclick="setCalendarView('week')" id="weekViewBtn">Week</button>
                        </div>
                        <button class="today-btn" onclick="goToToday()">Today</button>
                    </div>
                </div>
                
                <div class="calendar-body">
                    <div class="teacher-sidebar" id="teacherSidebar">
                        <div class="teacher-sidebar-header">
                            <div class="teacher-sidebar-title">Filter by Staff</div>
                        </div>
                        <div class="teacher-filter-item selected" onclick="filterByTeacher('all')">
                            <div class="teacher-avatar" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);">All</div>
                            <div>
                                <div class="teacher-filter-name">All Staff</div>
                                <div class="teacher-filter-sessions" id="allSessionsCount">0 sessions</div>
                            </div>
                        </div>
                        <div id="teacherFilterList"></div>
                    </div>
                    
                    <div class="calendar-grid-wrapper">
                        <div id="calendarContent">
                            <!-- Calendar grid will be rendered here -->
                        </div>
                    </div>
                </div>
                
                <div class="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-color private"></div>
                        <span>Private Session</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color duet"></div>
                        <span>Duet Session</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color trio"></div>
                        <span>Trio Session</span>
                    </div>
                </div>
            </div>
            
            <!-- Booking Section Below Calendar -->
            <div class="main-grid" style="margin-top: 30px;">
                <div class="card form-card">
                    <h2><span class="section-icon"></span><span id="session-form-title">Book New Session</span></h2>
                    <form id="sessionForm" onsubmit="addSession(event)">
                        <div class="form-group">
                            <label for="sessionType">Session Type</label>
                            <select id="sessionType" required onchange="updateClientSelection()">
                                <option value="">Select session type...</option>
                                <option value="Private">Private Session</option>
                                <option value="Duet">Duet Session</option>
                                <option value="Trio">Trio Session</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="sessionTeacher">Staff</label>
                            <select id="sessionTeacher" required>
                                <option value="">Select staff...</option>
                            </select>
                        </div>

                        <div class="form-group client-selector">
                            <label>Select Client(s)</label>
                            <div style="position: relative;">
                                <input type="text" id="clientSearchInput" placeholder="Type to search clients..." autocomplete="off" style="width: 100%;">
                                <div id="clientSearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1.5px solid var(--border); border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 100; display: none;"></div>
                            </div>
                            <div class="client-chips" id="selectedClients" style="margin-top: 10px;"></div>
                        </div>

                        <div class="form-group">
                            <label for="sessionDate">Date</label>
                            <input type="date" id="sessionDate" required>
                        </div>

                        <div class="form-group">
                            <label>Time</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="sessionHour" required style="flex: 1;">
                                    <option value="">Hour</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                                <span style="font-weight: 600;">:</span>
                                <select id="sessionMinute" required style="flex: 1;">
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                                <select id="sessionAmPm" required style="flex: 1;">
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                            </div>
                        </div>

                        <label class="checkbox-group">
                            <input type="checkbox" id="repeatSession">
                            <span class="checkbox-label">Repeating Session (Weekly)</span>
                        </label>

                        <div class="form-group">
                            <label for="sessionNotes">Session Notes</label>
                            <textarea id="sessionNotes" placeholder="Special instructions or modifications..."></textarea>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn-primary" id="sessionSubmitBtn">Book Session</button>
                            <button type="button" class="btn-secondary" id="sessionCancelBtn" style="display: none;">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h2><span class="section-icon"></span> Upcoming Sessions</h2>
                    
                    <div class="search-box">
                        <span class="search-icon"></span>
                        <input type="text" id="sessionSearchInput" placeholder="Search sessions...">
                    </div>

                    <div class="sessions-list" id="sessionsList">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <div class="empty-text">No sessions booked yet. Create your first session!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Book Modal -->
        <div class="quick-book-modal" id="quickBookModal">
            <div class="quick-book-content">
                <div class="quick-book-header">
                    <div>
                        <div class="quick-book-title">Quick Book Session</div>
                        <div class="quick-book-subtitle" id="quickBookSubtitle">Monday, Jan 20 at 10:00 AM</div>
                    </div>
                    <button class="quick-book-close" onclick="closeQuickBookModal()"></button>
                </div>
                
                <form id="quickBookForm" onsubmit="submitQuickBook(event)">
                    <div class="form-group">
                        <label for="qbSessionType">Session Type</label>
                        <select id="qbSessionType" required onchange="updateQuickBookClients()">
                            <option value="">Select session type...</option>
                            <option value="Private">Private Session</option>
                            <option value="Duet">Duet Session</option>
                            <option value="Trio">Trio Session</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="qbTeacher">Staff</label>
                        <select id="qbTeacher" required>
                            <option value="">Select staff...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Select Client(s)</label>
                        <div style="position: relative;">
                            <input type="text" id="qbClientSearchInput" placeholder="Type to search clients..." autocomplete="off" style="width: 100%;">
                            <div id="qbClientSearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1.5px solid var(--border); border-top: none; border-radius: 0 0 8px 8px; max-height: 150px; overflow-y: auto; z-index: 100; display: none;"></div>
                        </div>
                        <div id="qbSelectedClients" style="margin-top: 10px;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="qbNotes">Notes (optional)</label>
                        <textarea id="qbNotes" placeholder="Session notes..."></textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button type="submit" class="btn-primary">Book Session</button>
                        <button type="button" class="btn-secondary" onclick="closeQuickBookModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- CLIENT PROFILE MODAL -->
        <div class="client-profile-modal" id="clientProfileModal">
            <div class="client-profile-content">
                <div class="client-profile-header">
                    <h2 id="clientProfileName">Client Profile</h2>
                    <button class="client-profile-close" onclick="closeClientProfile()">&times;</button>
                </div>
                <div class="client-profile-body">
                    <div class="profile-grid">
                        <!-- Client Info Section -->
                        <div class="profile-section">
                            <h3> Client Information</h3>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Email</span>
                                <span class="profile-info-value" id="profileEmail">-</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Phone</span>
                                <span class="profile-info-value" id="profilePhone">-</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Private Rate</span>
                                <span class="profile-info-value" id="profileRatePrivate">-</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Duet Rate</span>
                                <span class="profile-info-value" id="profileRateDuet">-</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Trio Rate</span>
                                <span class="profile-info-value" id="profileRateTrio">-</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Waiver Signed</span>
                                <span class="profile-info-value" id="profileWaiver">-</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Total Sessions</span>
                                <span class="profile-info-value" id="profileTotalSessions">0</span>
                            </div>
                        </div>

                        <!-- Appointments Section -->
                        <div class="profile-section">
                            <h3> Appointments</h3>
                            <div class="appointments-list" id="clientAppointmentsList">
                                <p style="text-align: center; color: var(--text-light);">No appointments found</p>
                            </div>
                        </div>
                    </div>

                    <!-- Session Notes Summary -->
                    <div class="profile-section" style="margin-top: 20px;">
                        <h3> Session Notes</h3>
                        <div id="clientNotesPreview" style="margin-bottom: 15px;">
                            <p style="text-align: center; color: var(--text-light);">No notes recorded</p>
                        </div>
                        <button onclick="goToNotesForClient()" class="btn-primary" style="width: 100%;">
                             Add / View All Notes in Notes Tab
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- INVOICES TAB -->
        <div id="invoices-tab" class="tab-content">
            <div class="card">

                <h2 style="margin-top: 30px;"><span class="section-icon"></span> Invoice Management</h2>
                
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <button class="btn-invoice" onclick="showBulkInvoiceModal()">
                         Generate Bulk Invoices
                    </button>
                    <button class="btn-secondary" onclick="refreshInvoiceStatus()">
                         Refresh Payment Status
                    </button>
                </div>

                <div class="sessions-list" id="invoicesList">
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <div class="empty-text">No invoices yet. Book sessions and generate invoices!</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INCOME TAB -->
        <div id="income-tab" class="tab-content">
            <div class="income-summary">
                <div class="income-card">
                    <div class="income-label">This Week</div>
                    <div class="income-amount" id="weeklyIncome">$0</div>
                    <div class="income-subtitle" id="weeklySessions">0 sessions</div>
                </div>
                <div class="income-card">
                    <div class="income-label">This Month</div>
                    <div class="income-amount" id="monthlyIncome">$0</div>
                    <div class="income-subtitle" id="monthlySessions">0 sessions</div>
                </div>
                <div class="income-card secondary">
                    <div class="income-label">Projected Monthly</div>
                    <div class="income-amount" id="projectedIncome">$0</div>
                    <div class="income-subtitle">Based on repeating sessions</div>
                </div>
                <div class="income-card quickbooks">
                    <div class="income-label">Outstanding Invoices</div>
                    <div class="income-amount" id="outstandingInvoices">$0</div>
                    <div class="income-subtitle" id="outstandingCount">0 unpaid</div>
                </div>
            </div>

            <div class="card">
                <h2><span class="section-icon"></span> Income Breakdown</h2>
                <div class="sessions-list" id="incomeBreakdown">
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <div class="empty-text">No income data yet. Book sessions to track earnings!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="invoice-modal" id="invoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Generate Invoices</h3>
                <button class="modal-close" onclick="closeInvoiceModal()"></button>
            </div>
            
            <div class="form-group">
                <label>Select Date Range</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <input type="date" id="invoiceStartDate">
                    <input type="date" id="invoiceEndDate">
                </div>
            </div>

            <div class="form-group">
                <label>Due Date</label>
                <input type="date" id="invoiceDueDate">
            </div>

            <div id="invoicePreview" style="margin: 20px 0;">
                <!-- Preview will be inserted here -->
            </div>

            <div class="btn-group">
                <button class="btn-invoice" onclick="generateBulkInvoices()">Generate & Send Invoices</button>
                <button class="btn-secondary" onclick="closeInvoiceModal()">Cancel</button>
            </div>
        </div>
    </div>

        <div id="settings-tab" class="tab-content">
            <div class="card">
                <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 32px; font-weight: 300; color: var(--primary); margin-bottom: 30px;">Settings</h2>

                <!-- Business Information Section -->
                <div class="settings-section">
                    <h3>Business Information</h3>
                    <div class="form-group">
                        <label>Business Name</label>
                        <input type="text" id="studioNameSetting" placeholder="Your Studio Name">
                    </div>
                    
                    <div class="form-group">
                        <label>Business Logo</label>
                        <div class="logo-upload-section">
                            <div class="logo-preview" id="logoPreview">
                                <span class="logo-preview-text">SF</span>
                            </div>
                            <div class="file-upload-wrapper">
                                <label class="file-upload-btn">
                                    Choose Logo Image
                                    <input type="file" id="logoUpload" accept="image/*" onchange="handleLogoUpload(event)">
                                </label>
                                <p style="margin-top: 8px; font-size: 12px; color: var(--text-light);">
                                    Upload a square image (recommended 200x200px). Max file size: 500KB.
                                </p>
                                <button class="btn-secondary btn-small" onclick="removeLogo()" style="margin-top: 10px;">Remove Logo</button>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="saveBusinessInfo()">Save Business Information</button>
                </div>

                <!-- Calendar & Email Integrations Section -->
                <div class="settings-section">
                    <h3>Calendar & Email Integrations</h3>
                    <p style="margin-bottom: 20px; font-size: 13px; color: var(--text-light);">
                        Connect your calendar and email accounts to automatically create events when booking sessions.
                    </p>

                    <div class="integration-setup google" style="margin-bottom: 20px;">
                        <h3> Google Calendar Integration</h3>
                        <p>Connect your Google account to automatically create calendar events and send invites to clients.</p>
                        <button type="button" class="btn-google" onclick="connectGoogleCalendar()">
                            <span></span> Connect Google Calendar
                        </button>
                        <div id="google-status" style="display: none; margin-top: 12px;">
                            <span class="integration-status"> Connected</span>
                            <button type="button" class="btn-secondary btn-small" onclick="disconnectGoogleCalendar()" style="margin-left: 12px;">
                                Disconnect
                            </button>
                        </div>
                    </div>

                    <div class="integration-setup outlook">
                        <h3> Microsoft Outlook / Microsoft 365 Integration</h3>
                        <p>Connect your Microsoft account to access Outlook Calendar and Email for automated scheduling and client communications.</p>
                        <button type="button" class="btn-outlook" onclick="connectMicrosoftOutlook()">
                            <span></span> Connect Microsoft Outlook
                        </button>
                        <div id="outlook-status" style="display: none; margin-top: 12px;">
                            <span class="integration-status"> Connected to Microsoft Outlook</span>
                            <button type="button" class="btn-secondary btn-small" onclick="disconnectMicrosoftOutlook()" style="margin-left: 12px;">
                                Disconnect
                            </button>
                        </div>
                        
                        <div class="setup-steps" style="margin-top: 16px; font-size: 13px;">
                            <p style="margin-bottom: 8px;"><strong>What you get:</strong></p>
                            <ul style="margin-left: 20px; line-height: 1.8; color: var(--text-light);">
                                <li>Automatically create Outlook calendar events for sessions</li>
                                <li>Send appointment reminders via Outlook email</li>
                                <li>Invite clients to sessions with calendar events</li>
                                <li>Works with personal Outlook and Microsoft 365 business accounts</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- User Management Section (Owner Only) -->
                <div id="userManagementSection"></div>

                <!-- QuickBooks Integration (Owner/Admin Only) -->
                <div id="quickbooksSection"></div>

            </div>
        </div>

     <script>

        // ========================================
        // FIREBASE CONFIGURATION
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyD_BGXX9kB8EPKKln6WYrK0QN1abKaufNA",
            authDomain: "flow-crm-2026rl.firebaseapp.com",
            projectId: "flow-crm-2026rl",
            storageBucket: "flow-crm-2026rl.firebasestorage.app",
            messagingSenderId: "233927450484",
            appId: "1:233927450484:web:cdd4852347e8450dbbd621"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Current user data
        let currentUser = null;
        let currentUserData = null;
        let organizationId = null;

        // ========================================
        // AUTH - SIMPLE FIX: WAIT BEFORE CHECKING
        // ========================================
        
        // Don't do anything until page fully loads
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, waiting for Firebase auth...');
            
            // Give Firebase 2 seconds to restore the session
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Now check if user exists
            const user = auth.currentUser;
            console.log('After 2s wait, currentUser is:', user ? user.email : 'NULL');
            
            if (user) {
                // User is logged in!
                await loadUserAndInitialize(user);
            } else {
                // No user after waiting - redirect to login
                console.log('No user found - redirecting to login');
                window.location.href = 'login.html';
            }
            
            // Set up listener for future sign-outs only
            auth.onAuthStateChanged((u) => {
                if (!u && currentUser) {
                    console.log('User signed out');
                    window.location.href = 'login.html';
                }
            });
        });
        
        async function loadUserAndInitialize(user) {
            currentUser = user;
            console.log('Loading data for user:', user.email);
            
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    currentUserData = userDoc.data();
                    organizationId = currentUserData.organizationId;
                    
                    // Update UI with user info
                    document.getElementById('userName').textContent = currentUserData.fullName;
                    const displayRole = currentUserData.role === 'teacher' ? 'Staff' : currentUserData.role.charAt(0).toUpperCase() + currentUserData.role.slice(1);
                    document.getElementById('userRole').textContent = displayRole;
                    
                    // Load organization data
                    await loadOrgSettings();
                    await loadData();
                    
                    // Initialize Lucide icons
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                    
                    console.log('SUCCESS! Dashboard loaded for:', user.email);
                } else {
                    console.error('User document not found');
                    handleLogout();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadOrgSettings() {
            try {
                const orgDoc = await db.collection('organizations').doc(organizationId).get();
                if (orgDoc.exists) {
                    const orgData = orgDoc.data();
                    document.getElementById('mainStudioName').textContent = orgData.name || 'Studio Flow';
                }
            } catch (error) {
                console.error('Error loading org settings:', error);
            }
        }



        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        
        function getOrgCollection(collectionName) {
            return db.collection('organizations').doc(organizationId).collection(collectionName);
        }

        function isOwnerOrAdmin() {
            return currentUserData && (currentUserData.role === 'owner' || currentUserData.role === 'admin');
        }

        function canManageUsers() {
            return currentUserData && currentUserData.role === 'owner';
        }

        function canAccessSettings() {
            return isOwnerOrAdmin();
        }

        function getCurrentUserData() {
            return currentUserData;
        }

        function getOrgKey(key) {
            return `${key}_${organizationId}`;
        }

        function isOwner() {
            return currentUserData && currentUserData.role === 'owner';
        }

        function isAdmin() {
            return currentUserData && currentUserData.role === 'admin';
        }

        function isTeacher() {
            return currentUserData && currentUserData.role === 'teacher';
        }

        function canAccessFinancials() {
            return isOwnerOrAdmin();
        }
         
        // ========================================
        // DATA STORAGE (FIRESTORE)
        // ========================================
        
        let clients = [];
        let sessions = [];
        let staffMembers = []; // Staff are now registered users with staff/admin roles
        let invoices = [];

        async function loadData() {
            try {
                // Load clients
                const clientsSnapshot = await getOrgCollection('clients').orderBy('createdAt', 'desc').get();
                clients = clientsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load sessions
                const sessionsSnapshot = await getOrgCollection('sessions').orderBy('date', 'desc').get();
                sessions = sessionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load staff from registered users (users with staff or admin role)
                const usersSnapshot = await getOrgCollection('users').get();
                staffMembers = usersSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(user => user.role === 'admin' || user.role === 'staff' || user.role === 'teacher');
                
                // Load invoices
                const invoicesSnapshot = await getOrgCollection('invoices').orderBy('createdAt', 'desc').get();
                invoices = invoicesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderClients();
                renderSessions();
                renderInvoices();
                populateStaffDropdowns();
                updateClientSelection();
                initClientSearch();
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function saveClient(clientData) {
            try {
                const docRef = await getOrgCollection('clients').add({
                    ...clientData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error('Error saving client:', error);
                throw error;
            }
        }

        async function updateClient(clientId, clientData) {
            try {
                await getOrgCollection('clients').doc(clientId).update(clientData);
            } catch (error) {
                console.error('Error updating client:', error);
                throw error;
            }
        }

        async function deleteClientFromDb(clientId) {
            try {
                await getOrgCollection('clients').doc(clientId).delete();
            } catch (error) {
                console.error('Error deleting client:', error);
                throw error;
            }
        }

        async function saveSession(sessionData) {
            try {
                const docRef = await getOrgCollection('sessions').add({
                    ...sessionData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error('Error saving session:', error);
                throw error;
            }
        }

        async function deleteSessionFromDb(sessionId) {
            try {
                await getOrgCollection('sessions').doc(sessionId).delete();
            } catch (error) {
                console.error('Error deleting session:', error);
                throw error;
            }
        }

        async function saveInvoice(invoiceData) {
            try {
                const docRef = await getOrgCollection('invoices').add({
                    ...invoiceData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error('Error saving invoice:', error);
                throw error;
            }
        }

        // Legacy saveData function for compatibility
        function saveData() {
            // Data is now saved directly to Firestore
            // This function is kept for compatibility
        }

        // ========================================
        // TAB SWITCHING
        // ========================================
        
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'settings') {
                loadSettings();
            }
            
            if (tabName === 'calendar') {
                renderCalendar();
                initClientSearch();
                populateStaffDropdowns();
            }
            
            if (tabName === 'notes') {
                initNotesTab();
            }
        }

        // ========================================
        // LOGOUT
        // ========================================
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut().then(() => {
                    window.location.href = 'login.html';
                }).catch((error) => {
                    console.error('Logout error:', error);
                });
            }
        }

        // ========================================
        // VISUAL CALENDAR SYSTEM
        // ========================================
        
        let calendarCurrentDate = new Date();
        let calendarView = 'week'; // 'day' or 'week'
        let calendarSelectedTeacher = 'all';
        
        const teacherColors = [
            '#2C4A3E', '#9B6BB3', '#D4A574', '#5F8575', '#C86B5D',
            '#4A6B5D', '#7B5EA7', '#E8A87C', '#6FA287', '#B85C4D'
        ];
        
        function getTeacherColor(index) {
            return teacherColors[index % teacherColors.length];
        }
        
        function formatCalendarDate(date) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            return `${months[date.getMonth()]} ${date.getFullYear()}`;
        }
        
        function formatDayHeader(date) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return {
                dayName: days[date.getDay()],
                dayNumber: date.getDate()
            };
        }
        
        function getWeekDates(date) {
            const week = [];
            const start = new Date(date);
            start.setDate(start.getDate() - start.getDay()); // Start from Sunday
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(start);
                day.setDate(start.getDate() + i);
                week.push(day);
            }
            return week;
        }
        
        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }
        
        function isSameDay(date1, date2) {
            return date1.toDateString() === date2.toDateString();
        }
        
        function getSessionsForDate(date, teacherFilter = 'all') {
            return sessions.filter(session => {
                const sessionDate = new Date(session.date);
                const sameDay = isSameDay(sessionDate, date);
                const teacherMatch = teacherFilter === 'all' || session.teacherName === teacherFilter;
                return sameDay && teacherMatch;
            });
        }
        
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        function minutesToTop(minutes) {
            // Each hour slot is 60px, starting from 6 AM (360 minutes)
            const startMinutes = 6 * 60; // 6 AM
            return ((minutes - startMinutes) / 60) * 60;
        }
        
        function renderCalendar() {
            updateCalendarTitle();
            renderTeacherFilters();
            
            if (calendarView === 'week') {
                renderWeekView();
            } else {
                renderDayView();
            }
        }
        
        function updateCalendarTitle() {
            const titleEl = document.getElementById('calendarTitle');
            if (!titleEl) return;
            
            if (calendarView === 'week') {
                const weekDates = getWeekDates(calendarCurrentDate);
                const startMonth = weekDates[0].toLocaleDateString('en-US', { month: 'short' });
                const endMonth = weekDates[6].toLocaleDateString('en-US', { month: 'short' });
                const year = weekDates[0].getFullYear();
                
                if (startMonth === endMonth) {
                    titleEl.textContent = `${startMonth} ${weekDates[0].getDate()} - ${weekDates[6].getDate()}, ${year}`;
                } else {
                    titleEl.textContent = `${startMonth} ${weekDates[0].getDate()} - ${endMonth} ${weekDates[6].getDate()}, ${year}`;
                }
            } else {
                titleEl.textContent = calendarCurrentDate.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'long', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
            }
        }
        
        function renderStaffFilters() {
            const container = document.getElementById('teacherFilterList');
            if (!container) return;
            
            // Update all sessions count
            const allCount = document.getElementById('allSessionsCount');
            if (allCount) {
                const weekDates = calendarView === 'week' ? getWeekDates(calendarCurrentDate) : [calendarCurrentDate];
                let totalSessions = 0;
                weekDates.forEach(date => {
                    totalSessions += getSessionsForDate(date).length;
                });
                allCount.textContent = `${totalSessions} session${totalSessions !== 1 ? 's' : ''}`;
            }
            
            if (staffMembers.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-light); font-size: 13px;">
                        No staff registered yet.<br>Invite staff to register in Settings.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = staffMembers.map((staff, index) => {
                const displayName = staff.displayName || staff.name || staff.email;
                const weekDates = calendarView === 'week' ? getWeekDates(calendarCurrentDate) : [calendarCurrentDate];
                let staffSessions = 0;
                weekDates.forEach(date => {
                    staffSessions += getSessionsForDate(date, displayName).length;
                });
                
                const isSelected = calendarSelectedTeacher === displayName;
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                const color = getTeacherColor(index);
                
                return `
                    <div class="teacher-filter-item ${isSelected ? 'selected' : ''}" onclick="filterByTeacher('${displayName}')">
                        <div class="teacher-avatar" style="background: ${color};">${initials}</div>
                        <div>
                            <div class="teacher-filter-name">${displayName}</div>
                            <div class="teacher-filter-sessions">${staffSessions} session${staffSessions !== 1 ? 's' : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterByTeacher(teacherName) {
            calendarSelectedTeacher = teacherName;
            
            // Update selected state in sidebar
            document.querySelectorAll('.teacher-filter-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            renderCalendar();
        }
        
        function renderWeekView() {
            const container = document.getElementById('calendarContent');
            if (!container) return;
            
            const weekDates = getWeekDates(calendarCurrentDate);
            const hours = generateHours();
            
            let html = `
                <div class="calendar-grid week-view">
                    <!-- Time column header -->
                    <div class="calendar-day-header" style="background: var(--bg);"></div>
                    
                    <!-- Day headers -->
                    ${weekDates.map(date => {
                        const { dayName, dayNumber } = formatDayHeader(date);
                        const todayClass = isToday(date) ? 'today' : '';
                        return `
                            <div class="calendar-day-header ${todayClass}">
                                <div class="day-name">${dayName}</div>
                                <div class="day-number">${dayNumber}</div>
                            </div>
                        `;
                    }).join('')}
                    
                    <!-- Time column -->
                    <div class="time-column">
                        ${hours.map(hour => `
                            <div class="time-slot-label">${hour}</div>
                        `).join('')}
                    </div>
                    
                    <!-- Day columns -->
                    ${weekDates.map(date => renderDayColumn(date, hours)).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function renderDayView() {
            const container = document.getElementById('calendarContent');
            if (!container) return;
            
            const hours = generateHours();
            const date = calendarCurrentDate;
            const { dayName, dayNumber } = formatDayHeader(date);
            const todayClass = isToday(date) ? 'today' : '';
            
            let html = `
                <div class="calendar-grid day-view">
                    <!-- Time column header -->
                    <div class="calendar-day-header" style="background: var(--bg);"></div>
                    
                    <!-- Day header -->
                    <div class="calendar-day-header ${todayClass}">
                        <div class="day-name">${dayName}</div>
                        <div class="day-number">${dayNumber}</div>
                    </div>
                    
                    <!-- Time column -->
                    <div class="time-column">
                        ${hours.map(hour => `
                            <div class="time-slot-label">${hour}</div>
                        `).join('')}
                    </div>
                    
                    <!-- Day column -->
                    ${renderDayColumn(date, hours)}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function generateHours() {
            const hours = [];
            for (let i = 6; i <= 21; i++) { // 6 AM to 9 PM
                const hour = i % 12 || 12;
                const ampm = i < 12 ? 'AM' : 'PM';
                hours.push(`${hour}:00 ${ampm}`);
            }
            return hours;
        }
        
        function renderDayColumn(date, hours) {
            const dateStr = date.toISOString().split('T')[0];
            const daySessions = getSessionsForDate(date, calendarSelectedTeacher);
            
            let html = `<div class="day-column">`;
            
            // Render time slots
            for (let i = 6; i <= 21; i++) {
                const timeStr = `${String(i).padStart(2, '0')}:00`;
                html += `
                    <div class="time-slot" onclick="openQuickBook('${dateStr}', '${timeStr}')"></div>
                `;
            }
            
            // Render events
            daySessions.forEach(session => {
                const startMinutes = timeToMinutes(session.time);
                const top = minutesToTop(startMinutes);
                const duration = 60; // Default 1 hour
                const height = duration;
                
                const typeClass = session.type ? session.type.toLowerCase() : 'private';
                const clientNames = getClientNamesForSession(session);
                const timeDisplay = formatTimeDisplay(session.time);
                
                html += `
                    <div class="calendar-event ${typeClass}" 
                         style="top: ${top}px; height: ${height - 4}px;"
                         onclick="event.stopPropagation(); viewSessionDetails(${session.id})">
                        <div class="event-time">${timeDisplay}</div>
                        <div class="event-title">${session.type || 'Session'}</div>
                        <div class="event-client">${clientNames}</div>
                        <div class="event-icons">
                            ${session.teacherName ? '<span class="event-icon"></span>' : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            return html;
        }
        
        function getClientNamesForSession(session) {
            if (!session.clients || session.clients.length === 0) {
                return session.clientNames || 'No clients';
            }
            
            const names = session.clients.map(clientId => {
                const client = clients.find(c => c.id === clientId);
                return client ? client.name : 'Unknown';
            });
            
            if (names.length <= 2) {
                return names.join(' & ');
            }
            return `${names[0]} and ${names.length - 1} others`;
        }
        
        function formatTimeDisplay(timeStr) {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':').map(Number);
            const hour = hours % 12 || 12;
            const ampm = hours < 12 ? 'AM' : 'PM';
            return `${hour}:${String(minutes).padStart(2, '0')} ${ampm}`;
        }
        
        function setCalendarView(view) {
            calendarView = view;
            
            document.getElementById('dayViewBtn').classList.toggle('active', view === 'day');
            document.getElementById('weekViewBtn').classList.toggle('active', view === 'week');
            
            renderCalendar();
        }
        
        function calendarPrev() {
            if (calendarView === 'week') {
                calendarCurrentDate.setDate(calendarCurrentDate.getDate() - 7);
            } else {
                calendarCurrentDate.setDate(calendarCurrentDate.getDate() - 1);
            }
            renderCalendar();
        }
        
        function calendarNext() {
            if (calendarView === 'week') {
                calendarCurrentDate.setDate(calendarCurrentDate.getDate() + 7);
            } else {
                calendarCurrentDate.setDate(calendarCurrentDate.getDate() + 1);
            }
            renderCalendar();
        }
        
        function goToToday() {
            calendarCurrentDate = new Date();
            renderCalendar();
        }
        
        // ========================================
        // QUICK BOOK MODAL
        // ========================================
        
        let quickBookDate = null;
        let quickBookTime = null;
        
        let qbSelectedClients = [];
        let qbMaxClients = 1;
        
        function openQuickBook(dateStr, timeStr) {
            quickBookDate = dateStr;
            quickBookTime = timeStr;
            
            const date = new Date(dateStr + 'T' + timeStr);
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'short', 
                day: 'numeric' 
            });
            const formattedTime = formatTimeDisplay(timeStr);
            
            document.getElementById('quickBookSubtitle').textContent = `${formattedDate} at ${formattedTime}`;
            
            // Populate staff dropdown from registered users
            const teacherSelect = document.getElementById('qbTeacher');
            teacherSelect.innerHTML = '<option value="">Select staff...</option>';
            staffMembers.forEach(staff => {
                const displayName = staff.displayName || staff.name || staff.email;
                teacherSelect.innerHTML += `<option value="${displayName}" data-email="${staff.email}">${displayName}</option>`;
            });
            
            // Pre-select staff if filtered
            if (calendarSelectedTeacher !== 'all') {
                teacherSelect.value = calendarSelectedTeacher;
            }
            
            // Reset client selection
            qbSelectedClients = [];
            updateQuickBookClients();
            initQbClientSearch();
            
            // Reset form
            document.getElementById('qbSessionType').value = '';
            document.getElementById('qbNotes').value = '';
            document.getElementById('qbClientSearchInput').value = '';
            document.getElementById('qbClientSearchInput').disabled = false;
            document.getElementById('qbClientSearchInput').placeholder = 'Type to search clients...';
            document.getElementById('qbSelectedClients').innerHTML = '';
            
            document.getElementById('quickBookModal').classList.add('active');
        }
        
        function closeQuickBookModal() {
            document.getElementById('quickBookModal').classList.remove('active');
            quickBookDate = null;
            quickBookTime = null;
            qbSelectedClients = [];
        }
        
        function updateQuickBookClients() {
            const sessionType = document.getElementById('qbSessionType').value;
            
            // Set max clients based on session type
            qbMaxClients = 1;
            if (sessionType === 'Duet') qbMaxClients = 2;
            if (sessionType === 'Trio') qbMaxClients = 3;
            
            // Clear selection when session type changes
            qbSelectedClients = [];
            document.getElementById('qbSelectedClients').innerHTML = '';
            const searchInput = document.getElementById('qbClientSearchInput');
            if (searchInput) {
                searchInput.value = '';
                searchInput.disabled = false;
                searchInput.placeholder = 'Type to search clients...';
            }
        }
        
        function initQbClientSearch() {
            const searchInput = document.getElementById('qbClientSearchInput');
            const resultsContainer = document.getElementById('qbClientSearchResults');
            
            if (!searchInput || !resultsContainer) return;
            
            // Remove existing listeners by cloning
            const newSearchInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);
            
            // Search as user types
            newSearchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length === 0) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                // Filter clients by name
                const matchingClients = clients.filter(client => 
                    client.name.toLowerCase().includes(query) &&
                    !qbSelectedClients.includes(client.id)
                );
                
                if (matchingClients.length === 0) {
                    resultsContainer.innerHTML = '<div style="padding: 12px; color: var(--text-light); text-align: center;">No matching clients found</div>';
                    resultsContainer.style.display = 'block';
                    return;
                }
                
                resultsContainer.innerHTML = matchingClients.map(client => `
                    <div class="qb-client-search-result" onclick="selectQbClientFromSearch('${client.id}')" 
                         style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s;"
                         onmouseover="this.style.background='var(--bg)'" 
                         onmouseout="this.style.background='white'">
                        <div style="font-weight: 500;">${client.name}</div>
                        <div style="font-size: 12px; color: var(--text-light);">${client.email || 'No email'}</div>
                    </div>
                `).join('');
                resultsContainer.style.display = 'block';
            });
            
            newSearchInput.addEventListener('focus', function() {
                if (this.value.trim().length > 0) {
                    this.dispatchEvent(new Event('input'));
                }
            });
        }
        
        function selectQbClientFromSearch(clientId) {
            // Check if already at max
            if (qbSelectedClients.length >= qbMaxClients) {
                alert(`Maximum ${qbMaxClients} client(s) for this session type.`);
                return;
            }
            
            // Add client if not already selected
            if (!qbSelectedClients.includes(clientId)) {
                qbSelectedClients.push(clientId);
                updateQbSelectedClientsDisplay();
            }
            
            // Clear search input and hide results
            const searchInput = document.getElementById('qbClientSearchInput');
            const resultsContainer = document.getElementById('qbClientSearchResults');
            if (searchInput) searchInput.value = '';
            if (resultsContainer) resultsContainer.style.display = 'none';
            
            // Disable search if at max
            if (qbSelectedClients.length >= qbMaxClients) {
                searchInput.placeholder = `Maximum ${qbMaxClients} client(s) selected`;
                searchInput.disabled = true;
            }
        }
        
        function updateQbSelectedClientsDisplay() {
            const chipsContainer = document.getElementById('qbSelectedClients');
            if (!chipsContainer) return;
            
            chipsContainer.innerHTML = qbSelectedClients.map(clientId => {
                const client = clients.find(c => c.id === clientId);
                return client ? `
                    <span class="client-chip" data-client-id="${clientId}" style="display: inline-flex; align-items: center; gap: 8px; background: var(--primary); color: white; padding: 8px 12px; border-radius: 20px; margin: 4px; font-size: 13px;">
                        ${client.name}
                        <span onclick="removeQbClient('${clientId}')" style="cursor: pointer; font-weight: bold; font-size: 16px; line-height: 1;">&times;</span>
                    </span>
                ` : '';
            }).join('');
        }
        
        function removeQbClient(clientId) {
            const index = qbSelectedClients.indexOf(clientId);
            if (index > -1) {
                qbSelectedClients.splice(index, 1);
                updateQbSelectedClientsDisplay();
                
                // Re-enable search input
                const searchInput = document.getElementById('qbClientSearchInput');
                if (searchInput) {
                    searchInput.disabled = false;
                    searchInput.placeholder = 'Type to search clients...';
                }
            }
        }
        
        async function submitQuickBook(event) {
            event.preventDefault();
            
            const type = document.getElementById('qbSessionType').value;
            const teacher = document.getElementById('qbTeacher').value;
            const notes = document.getElementById('qbNotes').value;
            const selectedClients = qbSelectedClients;
            
            if (!type) {
                alert('Please select a session type');
                return;
            }
            
            if (!teacher) {
                alert('Please select a staff member');
                return;
            }
            
            if (selectedClients.length === 0) {
                alert('Please select at least one client');
                return;
            }
            
            // Get client names for display
            const clientNames = selectedClients.map(clientId => {
                const client = clients.find(c => c.id === clientId);
                return client ? client.name : 'Unknown';
            }).join(', ');
            
            try {
                const sessionData = {
                    type: type,
                    date: quickBookDate,
                    time: quickBookTime,
                    teacherName: teacher,
                    clients: selectedClients,
                    clientNames: clientNames,
                    notes: notes
                };
                
                await saveSession(sessionData);
                await loadData();
                
                closeQuickBookModal();
                renderCalendar();
                
                alert('Session booked successfully!');
            } catch (error) {
                alert('Error booking session: ' + error.message);
            }
        }
        
        async function viewSessionDetails(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const clientNames = getClientNamesForSession(session);
            const dateStr = new Date(session.date).toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'long', 
                day: 'numeric', 
                year: 'numeric' 
            });
            const timeStr = formatTimeDisplay(session.time);
            
            const details = `
Session Details:

Type: ${session.type || 'Session'}
Date: ${dateStr}
Time: ${timeStr}
Staff: ${session.teacherName || 'Not assigned'}
Client(s): ${clientNames}
${session.notes ? `Notes: ${session.notes}` : ''}
            `.trim();
            
            if (confirm(details + '\n\nWould you like to delete this session?')) {
                try {
                    await deleteSessionFromDb(sessionId);
                    await loadData();
                    renderCalendar();
                    alert('Session deleted.');
                } catch (error) {
                    alert('Error deleting session: ' + error.message);
                }
            }
        }
        
        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeQuickBookModal();
            }
        });
        
        // Close modal on background click
        document.getElementById('quickBookModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeQuickBookModal();
            }
        });

        // ========================================
        // CLIENT MANAGEMENT
        // ========================================
        
        function renderClients() {
            const container = document.getElementById('clientList');
            const countEl = document.getElementById('clientCount');
            
            if (countEl) {
                countEl.textContent = `${clients.length} Client${clients.length !== 1 ? 's' : ''}`;
            }
            
            if (!container) return;
            
            if (clients.length === 0) {
                container.innerHTML = '<p>No clients yet. Add your first client above.</p>';
                return;
            }
            
            container.innerHTML = clients.map((client, index) => `
                <div style="padding: 15px; background: var(--bg); border-radius: 8px; margin-bottom: 10px; cursor: pointer;" onclick="openClientProfile('${client.id}')">
                    <strong>${client.name}</strong><br>
                    Email: ${client.email || 'N/A'}<br>
                    Phone: ${client.phone || 'N/A'}
                    <div style="margin-top: 10px;" onclick="event.stopPropagation()">
                        <button class="btn-primary" onclick="openClientProfile('${client.id}')" style="margin-right: 5px;">View Profile</button>
                        <button class="btn-secondary" onclick="editClient(${index})" style="margin-right: 5px;">Edit</button>
                        <button class="btn-secondary" onclick="deleteClient(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function addClient(event) {
            event.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const ratePrivate = document.getElementById('ratePrivate').value;
            const rateDuet = document.getElementById('rateDuet').value;
            const rateTrio = document.getElementById('rateTrio').value;
            const waiver = document.getElementById('waiver').checked;
            const notes = document.getElementById('notes').value.trim();
            
            if (!name) {
                alert('Please enter a client name');
                return;
            }
            
            const clientData = {
                name: name,
                email: email,
                phone: phone,
                rates: {
                    private: parseFloat(ratePrivate) || 0,
                    duet: parseFloat(rateDuet) || 0,
                    trio: parseFloat(rateTrio) || 0
                },
                waiver: waiver,
                notes: notes
            };
            
            try {
                if (editingClientId) {
                    // Update existing client
                    await updateClient(editingClientId, clientData);
                    alert('Client updated successfully!');
                    cancelClientEdit();
                } else {
                    // Add new client
                    await saveClient(clientData);
                    document.getElementById('clientForm').reset();
                    alert('Client added successfully!');
                }
                await loadData();
            } catch (error) {
                console.error('Error saving client:', error);
                alert('Error saving client: ' + error.message);
            }
        }
        

        let editingClientId = null;
        
        function editClient(index) {
            const client = clients[index];
            editingClientId = client.id;
            
            // Populate form with client data
            document.getElementById('name').value = client.name || '';
            document.getElementById('email').value = client.email || '';
            document.getElementById('phone').value = client.phone || '';
            document.getElementById('ratePrivate').value = client.rates?.private || '';
            document.getElementById('rateDuet').value = client.rates?.duet || '';
            document.getElementById('rateTrio').value = client.rates?.trio || '';
            document.getElementById('waiver').checked = client.waiver || false;
            document.getElementById('notes').value = client.notes || '';
            
            // Update form UI to show edit mode
            document.getElementById('form-title').textContent = 'Edit Client';
            document.getElementById('submitBtn').textContent = 'Update Client';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            document.getElementById('cancelBtn').onclick = cancelClientEdit;
            
            // Scroll to form
            document.getElementById('clientForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelClientEdit() {
            editingClientId = null;
            document.getElementById('clientForm').reset();
            document.getElementById('form-title').textContent = 'Add New Client';
            document.getElementById('submitBtn').textContent = 'Add Client';
            document.getElementById('cancelBtn').style.display = 'none';
        }

        async function deleteClient(index) {
            if (confirm('Delete this client?')) {
                const client = clients[index];
                try {
                    await deleteClientFromDb(client.id);
                    await loadData();
                    alert('Client deleted successfully!');
                } catch (error) {
                    console.error('Error deleting client:', error);
                    alert('Error deleting client: ' + error.message);
                }
            }
        }

        // ========================================
        // CLIENT PROFILE & BODY CHART
        // ========================================
        
        let currentProfileClientId = null;
        let bodyChartMarkers = { front: [], back: [], left: [], right: [] };
        let currentPainSeverity = 'medium';
        let bodyChartTool = 'add';
        let markerCounter = 0;
        
        function openClientProfile(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            currentProfileClientId = clientId;
            
            // Populate client info
            document.getElementById('clientProfileName').textContent = client.name;
            document.getElementById('profileEmail').textContent = client.email || '-';
            document.getElementById('profilePhone').textContent = client.phone || '-';
            document.getElementById('profileRatePrivate').textContent = client.rates?.private ? `$${client.rates.private}` : '-';
            document.getElementById('profileRateDuet').textContent = client.rates?.duet ? `$${client.rates.duet}` : '-';
            document.getElementById('profileRateTrio').textContent = client.rates?.trio ? `$${client.rates.trio}` : '-';
            document.getElementById('profileWaiver').textContent = client.waiver ? ' Yes' : ' No';
            
            // Load appointments for this client
            loadClientAppointments(clientId);
            
            // Load notes preview
            loadClientNotesPreview(client);
            
            // Show modal
            document.getElementById('clientProfileModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function loadClientNotesPreview(client) {
            const container = document.getElementById('clientNotesPreview');
            if (!container) return;
            
            const notes = client.sessionNotes || [];
            
            if (notes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No notes recorded</p>';
                return;
            }
            
            // Show summary and recent notes
            const sortedNotes = notes.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
            const recentNotes = sortedNotes.slice(0, 3);
            
            container.innerHTML = `
                <div style="padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <strong style="color: var(--primary);">${notes.length} note${notes.length !== 1 ? 's' : ''} recorded</strong>
                </div>
                ${recentNotes.map(note => {
                    const sessionDate = note.sessionDate ? new Date(note.sessionDate + 'T00:00:00').toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    }) : 'No date';
                    
                    const hasMarkers = note.bodyChart && Object.values(note.bodyChart).some(arr => arr && arr.length > 0);
                    
                    return `
                        <div style="padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--primary);">
                            <div style="font-size: 12px; color: var(--text-light); margin-bottom: 5px;">
                                ${sessionDate} ${hasMarkers ? '  Body chart' : ''}
                            </div>
                            <div style="font-size: 13px; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${note.text ? note.text.substring(0, 80) + (note.text.length > 80 ? '...' : '') : '<em>Body chart only</em>'}
                            </div>
                        </div>
                    `;
                }).join('')}
                ${notes.length > 3 ? `<p style="text-align: center; color: var(--text-light); font-size: 12px;">+ ${notes.length - 3} more notes</p>` : ''}
            `;
        }
        
        function goToNotesForClient() {
            const clientId = currentProfileClientId;
            const client = clients.find(c => c.id === clientId);
            
            // Close profile modal
            closeClientProfile();
            
            // Switch to notes tab
            switchTab('notes', null);
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[onclick="switchTab(\'notes\', event)"]').classList.add('active');
            
            // Pre-select the client in the notes form
            if (client) {
                setTimeout(() => {
                    selectNotesClient(clientId);
                    
                    // Also filter history by this client
                    selectNotesHistoryClient(clientId, client.name);
                }, 100);
            }
        }
        
        function closeClientProfile() {
            document.getElementById('clientProfileModal').classList.remove('active');
            document.body.style.overflow = '';
            currentProfileClientId = null;
        }
        
        function loadClientAppointments(clientId) {
            const clientSessions = sessions.filter(s => 
                s.clients?.includes(clientId) || 
                s.clientNames?.toLowerCase().includes(clients.find(c => c.id === clientId)?.name?.toLowerCase() || '')
            );
            
            const container = document.getElementById('clientAppointmentsList');
            const totalEl = document.getElementById('profileTotalSessions');
            
            totalEl.textContent = clientSessions.length;
            
            if (clientSessions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No appointments found</p>';
                return;
            }
            
            const sorted = clientSessions.sort((a, b) => new Date(b.date) - new Date(a.date));
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            container.innerHTML = sorted.map(session => {
                const sessionDate = new Date(session.date);
                const isPast = sessionDate < today;
                const dateStr = sessionDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const timeStr = formatTimeDisplay(session.time);
                
                return `
                    <div class="appointment-item">
                        <div class="appointment-info">
                            <div class="appointment-type">${session.type || 'Session'}</div>
                            <div class="appointment-datetime">${dateStr} at ${timeStr}  ${session.teacherName || 'No staff'}</div>
                        </div>
                        <span class="appointment-status ${isPast ? 'past' : 'upcoming'}">${isPast ? 'Completed' : 'Upcoming'}</span>
                    </div>
                `;
            }).join('');
        }
        
        function loadBodyChartMarkers(client) {
            // Clear existing markers
            clearMarkersFromDOM();
            markerCounter = 0;
            
            // Load saved markers from client data
            bodyChartMarkers = client.bodyChart || { front: [], back: [], left: [], right: [] };
            
            // Render markers
            Object.keys(bodyChartMarkers).forEach(view => {
                bodyChartMarkers[view].forEach(marker => {
                    renderMarker(view, marker);
                });
            });
            
            // Update counter for new markers
            Object.values(bodyChartMarkers).forEach(markers => {
                markers.forEach(m => {
                    if (m.id > markerCounter) markerCounter = m.id;
                });
            });
        }
        
        function clearMarkersFromDOM() {
            document.querySelectorAll('.pain-marker').forEach(el => el.remove());
        }
        
        function setBodyChartTool(tool) {
            bodyChartTool = tool;
            document.getElementById('addMarkerTool').classList.toggle('active', tool === 'add');
            document.getElementById('removeMarkerTool').classList.toggle('active', tool === 'remove');
        }
        
        function setPainSeverity(severity) {
            currentPainSeverity = severity;
            document.querySelectorAll('.severity-btn').forEach(btn => {
                btn.classList.toggle('active', btn.classList.contains(severity));
            });
        }
        
        function addPainMarker(event, view) {
            if (bodyChartTool !== 'add') return;
            
            const container = event.currentTarget;
            const rect = container.getBoundingClientRect();
            
            // Calculate percentage position
            const x = ((event.clientX - rect.left) / rect.width) * 100;
            const y = ((event.clientY - rect.top) / rect.height) * 100;
            
            markerCounter++;
            
            const marker = {
                id: markerCounter,
                x: x,
                y: y,
                severity: currentPainSeverity,
                note: ''
            };
            
            bodyChartMarkers[view].push(marker);
            renderMarker(view, marker);
        }
        
        function renderMarker(view, marker) {
            const container = document.getElementById(`body${view.charAt(0).toUpperCase() + view.slice(1)}`);
            if (!container) return;
            
            const markerEl = document.createElement('div');
            markerEl.className = `pain-marker severity-${marker.severity}`;
            markerEl.style.left = `${marker.x}%`;
            markerEl.style.top = `${marker.y}%`;
            markerEl.textContent = marker.id;
            markerEl.dataset.markerId = marker.id;
            markerEl.dataset.view = view;
            markerEl.onclick = (e) => {
                e.stopPropagation();
                handleMarkerClick(marker.id, view);
            };
            
            container.appendChild(markerEl);
        }
        
        function handleMarkerClick(markerId, view) {
            if (bodyChartTool === 'remove') {
                // Remove marker
                bodyChartMarkers[view] = bodyChartMarkers[view].filter(m => m.id !== markerId);
                const markerEl = document.querySelector(`.pain-marker[data-marker-id="${markerId}"][data-view="${view}"]`);
                if (markerEl) markerEl.remove();
            } else {
                // Edit marker note
                const marker = bodyChartMarkers[view].find(m => m.id === markerId);
                if (marker) {
                    const note = prompt('Add a note for this pain point:', marker.note || '');
                    if (note !== null) {
                        marker.note = note;
                    }
                }
            }
        }
        
        function clearAllMarkers() {
            bodyChartMarkers = { front: [], back: [], left: [], right: [] };
            clearMarkersFromDOM();
            markerCounter = 0;
        }
        
        function loadClientNotes(client) {
            const container = document.getElementById('clientNotesList');
            const notes = client.sessionNotes || [];
            
            if (notes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No notes yet. Add your first note above.</p>';
                return;
            }
            
            // Sort notes by date (newest first)
            const sorted = [...notes].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sorted.map((note, index) => {
                const hasMarkers = note.bodyChart && (
                    note.bodyChart.front?.length > 0 ||
                    note.bodyChart.back?.length > 0 ||
                    note.bodyChart.left?.length > 0 ||
                    note.bodyChart.right?.length > 0
                );
                
                // Count markers by severity
                let mildCount = 0, moderateCount = 0, severeCount = 0;
                if (note.bodyChart) {
                    Object.values(note.bodyChart).forEach(markers => {
                        if (Array.isArray(markers)) {
                            markers.forEach(m => {
                                if (m.severity === 'low') mildCount++;
                                else if (m.severity === 'medium') moderateCount++;
                                else if (m.severity === 'high') severeCount++;
                            });
                        }
                    });
                }
                
                return `
                    <div class="note-item">
                        <div class="note-header">
                            <span class="note-date">${new Date(note.date).toLocaleDateString('en-US', { 
                                weekday: 'short',
                                month: 'short', 
                                day: 'numeric', 
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}</span>
                            <button class="note-delete" onclick="deleteClientNote(${index})"> Delete</button>
                        </div>
                        <div class="note-content">${note.text ? note.text.replace(/\n/g, '<br>') : '<em>Body chart only</em>'}</div>
                        
                        ${hasMarkers ? `
                            <div class="note-markers-summary">
                                ${mildCount > 0 ? `<div class="marker-count"><div class="marker-count-dot" style="background: #f1c40f;"></div>${mildCount} Mild</div>` : ''}
                                ${moderateCount > 0 ? `<div class="marker-count"><div class="marker-count-dot" style="background: #e67e22;"></div>${moderateCount} Moderate</div>` : ''}
                                ${severeCount > 0 ? `<div class="marker-count"><div class="marker-count-dot" style="background: #e74c3c;"></div>${severeCount} Severe</div>` : ''}
                                <button onclick="toggleNoteBodyChart(${index})" style="margin-left: auto; background: none; border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                     View Body Chart
                                </button>
                            </div>
                            <div class="note-body-chart" id="noteBodyChart${index}" style="display: none;">
                                ${renderNoteBodyChart(note.bodyChart)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function toggleNoteBodyChart(index) {
            const chart = document.getElementById(`noteBodyChart${index}`);
            if (chart) {
                chart.style.display = chart.style.display === 'none' ? 'grid' : 'none';
            }
        }
        
        function renderNoteBodyChart(bodyChart) {
            const views = ['front', 'back', 'left', 'right'];
            const viewBoxes = {
                front: '0 0 200 400',
                back: '0 0 200 400',
                left: '0 0 150 400',
                right: '0 0 150 400'
            };
            
            return views.map(view => {
                const markers = bodyChart[view] || [];
                
                return `
                    <div class="note-body-view">
                        <div class="note-body-view-label">${view.charAt(0).toUpperCase() + view.slice(1)}</div>
                        <div class="note-body-svg">
                            <svg viewBox="${viewBoxes[view]}" fill="none" xmlns="http://www.w3.org/2000/svg">
                                ${getBodySvgContent(view)}
                            </svg>
                            ${markers.map(m => `
                                <div class="note-pain-marker severity-${m.severity}" style="left: ${m.x}%; top: ${m.y}%;" title="${m.note || 'Pain point'}">
                                    ${m.id}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getBodySvgContent(view) {
            const svgContent = {
                front: `
                    <ellipse cx="100" cy="30" rx="25" ry="28" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <ellipse cx="74" cy="30" rx="5" ry="8" fill="#F5E6D3" stroke="#333" stroke-width="1"/>
                    <ellipse cx="126" cy="30" rx="5" ry="8" fill="#F5E6D3" stroke="#333" stroke-width="1"/>
                    <path d="M88 55 L88 70 L112 70 L112 55" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <path d="M88 70 L55 80 L40 95 L40 120 L35 180 L45 180 L55 130 L60 200 L75 200 L75 195 L85 195 L85 200 L115 200 L115 195 L125 195 L125 200 L140 200 L145 130 L155 180 L165 180 L160 120 L160 95 L145 80 L112 70" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <path d="M40 95 L25 150 L20 200 L15 220" fill="none" stroke="#333" stroke-width="1.5"/>
                    <path d="M160 95 L175 150 L180 200 L185 220" fill="none" stroke="#333" stroke-width="1.5"/>
                    <ellipse cx="15" cy="228" rx="10" ry="14" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <ellipse cx="185" cy="228" rx="10" ry="14" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <path d="M75 200 L70 280 L65 360" fill="none" stroke="#333" stroke-width="1.5"/>
                    <path d="M85 200 L82 280 L80 360" fill="none" stroke="#333" stroke-width="1.5"/>
                    <path d="M115 200 L118 280 L120 360" fill="none" stroke="#333" stroke-width="1.5"/>
                    <path d="M125 200 L130 280 L135 360" fill="none" stroke="#333" stroke-width="1.5"/>
                    <ellipse cx="72" cy="375" rx="18" ry="10" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <ellipse cx="128" cy="375" rx="18" ry="10" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                `,
                back: `
                    <ellipse cx="100" cy="30" rx="25" ry="28" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <ellipse cx="74" cy="30" rx="5" ry="8" fill="#F5E6D3" stroke="#333" stroke-width="1"/>
                    <ellipse cx="126" cy="30" rx="5" ry="8" fill="#F5E6D3" stroke="#333" stroke-width="1"/>
                    <path d="M88 55 L88 70 L112 70 L112 55" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <path d="M88 70 L55 80 L40 95 L40 120 L35 180 L45 180 L55 130 L60 200 L75 200 L75 195 L85 195 L85 200 L115 200 L115 195 L125 195 L125 200 L140 200 L145 130 L155 180 L165 180 L160 120 L160 95 L145 80 L112 70" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <path d="M100 70 L100 195" stroke="#D4B896" stroke-width="2" stroke-dasharray="5,3"/>
                    <path d="M70 90 Q65 110 75 130" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                    <path d="M130 90 Q135 110 125 130" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                    <path d="M40 95 L25 150 L20 200 L15 220" fill="none" stroke="#333" stroke-width="1.5"/>
                    <path d="M160 95 L175 150 L180 200 L185 220" fill="none" stroke="#333" stroke-width="1.5"/>
                    <ellipse cx="15" cy="228" rx="10" ry="14" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <ellipse cx="185" cy="228" rx="10" ry="14" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <path d="M75 200 L70 280 L65 360" fill="none" stroke="#333" stroke-width="1.5"/>
                    <path d="M85 200 L82 280 L80 360" fill="none" stroke="#333" stroke-width="1.5"/>
                    <path d="M115 200 L118 280 L120 360" fill="none" stroke="#333" stroke-width="1.5"/>
                    <path d="M125 200 L130 280 L135 360" fill="none" stroke="#333" stroke-width="1.5"/>
                    <ellipse cx="72" cy="375" rx="18" ry="10" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <ellipse cx="128" cy="375" rx="18" ry="10" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                `,
                left: `
                    <ellipse cx="75" cy="30" rx="20" ry="28" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <ellipse cx="55" cy="30" rx="5" ry="8" fill="#F5E6D3" stroke="#333" stroke-width="1"/>
                    <path d="M65 55 L65 70 L85 70 L85 55" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <path d="M65 70 L50 75 L40 90 L35 130 L40 180 L45 200 L70 200 L75 195 L80 200 L95 200 L100 180 L105 130 L100 90 L90 75 L85 70" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <path d="M42 90 L30 130 L25 170 L22 200 L18 215" stroke="#333" stroke-width="1.5" fill="none"/>
                    <ellipse cx="15" cy="225" rx="8" ry="14" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <path d="M55 200 L50 280 L48 360" stroke="#333" stroke-width="1.5" fill="none"/>
                    <path d="M85 200 L88 280 L90 360" stroke="#333" stroke-width="1.5" fill="none"/>
                    <path d="M40 365 L48 360 L90 360 L95 370 Q80 385 45 380 Q35 375 40 365" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                `,
                right: `
                    <ellipse cx="75" cy="30" rx="20" ry="28" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <ellipse cx="95" cy="30" rx="5" ry="8" fill="#F5E6D3" stroke="#333" stroke-width="1"/>
                    <path d="M65 55 L65 70 L85 70 L85 55" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <path d="M65 70 L50 75 L40 90 L35 130 L40 180 L45 200 L70 200 L75 195 L80 200 L105 200 L110 180 L115 130 L110 90 L100 75 L85 70" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <path d="M108 90 L120 130 L125 170 L128 200 L132 215" stroke="#333" stroke-width="1.5" fill="none"/>
                    <ellipse cx="135" cy="225" rx="8" ry="14" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                    <path d="M55 200 L52 280 L50 360" stroke="#333" stroke-width="1.5" fill="none"/>
                    <path d="M95 200 L98 280 L100 360" stroke="#333" stroke-width="1.5" fill="none"/>
                    <path d="M45 365 L50 360 L100 360 L110 365 Q115 375 105 380 Q70 385 50 375 Q42 370 45 365" fill="#F5E6D3" stroke="#333" stroke-width="1.5"/>
                `
            };
            return svgContent[view] || '';
        }
        
        async function addClientNote() {
            const noteText = document.getElementById('newNoteText').value.trim();
            
            // Check if there are any markers OR text
            const hasMarkers = Object.values(bodyChartMarkers).some(arr => arr.length > 0);
            
            if (!noteText && !hasMarkers) {
                alert('Please enter a note or mark at least one area on the body chart');
                return;
            }
            
            const client = clients.find(c => c.id === currentProfileClientId);
            if (!client) return;
            
            const newNote = {
                date: new Date().toISOString(),
                text: noteText,
                bodyChart: JSON.parse(JSON.stringify(bodyChartMarkers)) // Deep copy
            };
            
            client.sessionNotes = client.sessionNotes || [];
            client.sessionNotes.push(newNote);
            
            // Save to Firestore
            try {
                await updateClient(currentProfileClientId, { sessionNotes: client.sessionNotes });
                
                // Clear form
                document.getElementById('newNoteText').value = '';
                bodyChartMarkers = { front: [], back: [], left: [], right: [] };
                clearMarkersFromDOM();
                markerCounter = 0;
                
                loadClientNotes(client);
                alert('Note saved successfully!');
            } catch (error) {
                console.error('Error adding note:', error);
                alert('Error adding note: ' + error.message);
            }
        }
        
        async function deleteClientNote(index) {
            if (!confirm('Delete this note and its body chart?')) return;
            
            const client = clients.find(c => c.id === currentProfileClientId);
            if (!client || !client.sessionNotes) return;
            
            // Sort notes to match display order (newest first), then find the original index
            const sorted = [...client.sessionNotes].sort((a, b) => new Date(b.date) - new Date(a.date));
            const noteToDelete = sorted[index];
            const originalIndex = client.sessionNotes.findIndex(n => n.date === noteToDelete.date);
            
            if (originalIndex > -1) {
                client.sessionNotes.splice(originalIndex, 1);
                
                try {
                    await updateClient(currentProfileClientId, { sessionNotes: client.sessionNotes });
                    loadClientNotes(client);
                } catch (error) {
                    console.error('Error deleting note:', error);
                    alert('Error deleting note: ' + error.message);
                }
            }
        }
        
        async function saveClientProfile() {
            alert('Notes are saved automatically when you click "Save Note with Body Chart"');
        }
        
        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('clientProfileModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeClientProfile();
                    }
                });
            }
            
            // Note view modal close handler
            const noteModal = document.getElementById('noteViewModal');
            if (noteModal) {
                noteModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeNoteViewModal();
                    }
                });
            }
        });

        // ========================================
        // NOTES TAB
        // ========================================
        
        let notesSelectedClientId = null;
        let notesBodyChartMarkers = { front: [], back: [], left: [], right: [] };
        let notesPainSeverity = 'medium';
        let notesMarkerCounter = 0;
        let notesHistoryFilterClientId = null;
        
        // Initialize notes tab when switched to
        function initNotesTab() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('notesSessionDate').value = today;
            
            // Initialize client search
            initNotesClientSearch();
            initNotesHistoryClientSearch();
            
            // Load notes history
            loadNotesHistory();
        }
        
        // Client search for notes form
        function initNotesClientSearch() {
            const searchInput = document.getElementById('notesClientSearch');
            const dropdown = document.getElementById('notesClientDropdown');
            
            if (!searchInput || !dropdown) return;
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 1) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                const matches = clients.filter(c => 
                    c.name.toLowerCase().includes(query) || 
                    (c.email && c.email.toLowerCase().includes(query))
                ).slice(0, 8);
                
                if (matches.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                dropdown.innerHTML = matches.map(client => `
                    <div class="client-search-item" onclick="selectNotesClient('${client.id}')">
                        <strong>${client.name}</strong>
                        <span style="color: var(--text-light); font-size: 12px;">${client.email || ''}</span>
                    </div>
                `).join('');
                dropdown.style.display = 'block';
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        function selectNotesClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            notesSelectedClientId = clientId;
            
            document.getElementById('notesClientSearch').value = '';
            document.getElementById('notesClientDropdown').style.display = 'none';
            document.getElementById('notesSelectedClient').innerHTML = `
                <span class="client-chip" style="display: inline-flex; align-items: center; gap: 8px; background: var(--primary); color: white; padding: 10px 15px; border-radius: 25px; font-size: 14px;">
                    ${client.name}
                    <span onclick="clearNotesClient()" style="cursor: pointer; font-weight: bold; font-size: 18px; line-height: 1;">&times;</span>
                </span>
            `;
        }
        
        function clearNotesClient() {
            notesSelectedClientId = null;
            document.getElementById('notesSelectedClient').innerHTML = '';
            document.getElementById('notesClientSearch').value = '';
        }
        
        // Pain severity for notes
        function setNotesPainSeverity(severity) {
            notesPainSeverity = severity;
            document.querySelectorAll('#notes-tab .severity-btn').forEach(btn => {
                btn.classList.toggle('active', btn.classList.contains(severity));
            });
        }
        
        // Body chart markers for notes
        function addNotesPainMarker(event, view) {
            const container = event.currentTarget;
            const rect = container.getBoundingClientRect();
            
            const x = ((event.clientX - rect.left) / rect.width) * 100;
            const y = ((event.clientY - rect.top) / rect.height) * 100;
            
            notesMarkerCounter++;
            
            const marker = {
                id: notesMarkerCounter,
                x: x,
                y: y,
                severity: notesPainSeverity,
                note: ''
            };
            
            notesBodyChartMarkers[view].push(marker);
            renderNotesMarker(view, marker);
        }
        
        function renderNotesMarker(view, marker) {
            const container = document.getElementById(`notesBody${view.charAt(0).toUpperCase() + view.slice(1)}`);
            if (!container) return;
            
            const markerEl = document.createElement('div');
            markerEl.className = `pain-marker severity-${marker.severity}`;
            markerEl.style.left = `${marker.x}%`;
            markerEl.style.top = `${marker.y}%`;
            markerEl.textContent = marker.id;
            markerEl.dataset.markerId = marker.id;
            markerEl.dataset.view = view;
            markerEl.onclick = (e) => {
                e.stopPropagation();
                removeNotesMarker(marker.id, view);
            };
            markerEl.title = 'Click to remove';
            
            container.appendChild(markerEl);
        }
        
        function removeNotesMarker(markerId, view) {
            notesBodyChartMarkers[view] = notesBodyChartMarkers[view].filter(m => m.id !== markerId);
            const markerEl = document.querySelector(`#notesBody${view.charAt(0).toUpperCase() + view.slice(1)} .pain-marker[data-marker-id="${markerId}"]`);
            if (markerEl) markerEl.remove();
        }
        
        function clearNotesBodyChart() {
            notesBodyChartMarkers = { front: [], back: [], left: [], right: [] };
            document.querySelectorAll('#notesBodyChart .pain-marker').forEach(el => el.remove());
            notesMarkerCounter = 0;
        }
        
        // Save session note
        async function saveSessionNote() {
            if (!notesSelectedClientId) {
                alert('Please select a client');
                return;
            }
            
            const sessionDate = document.getElementById('notesSessionDate').value;
            if (!sessionDate) {
                alert('Please select a session date');
                return;
            }
            
            const noteText = document.getElementById('notesTextArea').value.trim();
            const hasMarkers = Object.values(notesBodyChartMarkers).some(arr => arr.length > 0);
            
            if (!noteText && !hasMarkers) {
                alert('Please enter a note or mark at least one area on the body chart');
                return;
            }
            
            const client = clients.find(c => c.id === notesSelectedClientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            const newNote = {
                date: new Date().toISOString(),
                sessionDate: sessionDate,
                text: noteText,
                bodyChart: JSON.parse(JSON.stringify(notesBodyChartMarkers)),
                staffName: currentUserData?.fullName || currentUserData?.displayName || 'Staff'
            };
            
            client.sessionNotes = client.sessionNotes || [];
            client.sessionNotes.push(newNote);
            
            try {
                await updateClient(notesSelectedClientId, { sessionNotes: client.sessionNotes });
                
                // Clear form
                document.getElementById('notesTextArea').value = '';
                clearNotesBodyChart();
                clearNotesClient();
                document.getElementById('notesSessionDate').value = new Date().toISOString().split('T')[0];
                
                // Refresh notes history
                loadNotesHistory();
                
                alert('Session note saved successfully!');
            } catch (error) {
                console.error('Error saving note:', error);
                alert('Error saving note: ' + error.message);
            }
        }
        
        // Notes history search
        function initNotesHistoryClientSearch() {
            const searchInput = document.getElementById('notesHistoryClientSearch');
            const dropdown = document.getElementById('notesHistoryClientDropdown');
            
            if (!searchInput || !dropdown) return;
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 1) {
                    dropdown.style.display = 'none';
                    notesHistoryFilterClientId = null;
                    filterNotesHistory();
                    return;
                }
                
                const matches = clients.filter(c => 
                    c.name.toLowerCase().includes(query) || 
                    (c.email && c.email.toLowerCase().includes(query))
                ).slice(0, 8);
                
                if (matches.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                dropdown.innerHTML = matches.map(client => `
                    <div class="client-search-item" onclick="selectNotesHistoryClient('${client.id}', '${client.name.replace(/'/g, "\\'")}')">
                        <strong>${client.name}</strong>
                        <span style="color: var(--text-light); font-size: 12px;">${client.email || ''}</span>
                    </div>
                `).join('');
                dropdown.style.display = 'block';
            });
            
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        function selectNotesHistoryClient(clientId, clientName) {
            notesHistoryFilterClientId = clientId;
            document.getElementById('notesHistoryClientSearch').value = clientName;
            document.getElementById('notesHistoryClientDropdown').style.display = 'none';
            filterNotesHistory();
        }
        
        function clearNotesFilters() {
            notesHistoryFilterClientId = null;
            document.getElementById('notesHistoryClientSearch').value = '';
            document.getElementById('notesHistoryDateFilter').value = '';
            filterNotesHistory();
        }
        
        function filterNotesHistory() {
            loadNotesHistory();
        }
        
        // Load and display notes history
        function loadNotesHistory() {
            const container = document.getElementById('notesHistoryList');
            const countEl = document.getElementById('notesHistoryCount');
            const dateFilter = document.getElementById('notesHistoryDateFilter')?.value;
            
            if (!container) return;
            
            // Collect all notes from all clients
            let allNotes = [];
            clients.forEach(client => {
                if (client.sessionNotes && client.sessionNotes.length > 0) {
                    client.sessionNotes.forEach(note => {
                        allNotes.push({
                            ...note,
                            clientId: client.id,
                            clientName: client.name
                        });
                    });
                }
            });
            
            // Apply filters
            if (notesHistoryFilterClientId) {
                allNotes = allNotes.filter(n => n.clientId === notesHistoryFilterClientId);
            }
            
            if (dateFilter) {
                allNotes = allNotes.filter(n => n.sessionDate === dateFilter);
            }
            
            // Sort by date (newest first)
            allNotes.sort((a, b) => {
                const dateA = new Date(a.sessionDate || a.date);
                const dateB = new Date(b.sessionDate || b.date);
                return dateB - dateA;
            });
            
            countEl.textContent = `${allNotes.length} note${allNotes.length !== 1 ? 's' : ''} found`;
            
            if (allNotes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <div class="empty-text">${notesHistoryFilterClientId || dateFilter ? 'No notes match your filters' : 'No notes yet. Create your first session note above!'}</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allNotes.map((note, index) => {
                const hasMarkers = note.bodyChart && Object.values(note.bodyChart).some(arr => arr && arr.length > 0);
                let markerCount = 0;
                if (hasMarkers) {
                    Object.values(note.bodyChart).forEach(arr => {
                        if (Array.isArray(arr)) markerCount += arr.length;
                    });
                }
                
                const sessionDate = note.sessionDate ? new Date(note.sessionDate + 'T00:00:00').toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                }) : 'No date';
                
                const createdDate = new Date(note.date).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="note-item" style="cursor: pointer;" onclick="viewNoteDetail('${note.clientId}', ${clients.find(c => c.id === note.clientId)?.sessionNotes?.indexOf(note) || 0})">
                        <div class="note-header">
                            <div>
                                <strong style="color: var(--primary);">${note.clientName}</strong>
                                <span style="color: var(--text-light); font-size: 12px; margin-left: 10px;">Session: ${sessionDate}</span>
                            </div>
                            <span class="note-date">Created: ${createdDate}</span>
                        </div>
                        <div class="note-content" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            ${note.text ? note.text.replace(/\n/g, ' ').substring(0, 150) + (note.text.length > 150 ? '...' : '') : '<em style="color: var(--text-light);">Body chart only</em>'}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                ${hasMarkers ? `<span style="font-size: 12px; color: var(--text-light);"> ${markerCount} marker${markerCount !== 1 ? 's' : ''}</span>` : ''}
                                ${note.staffName ? `<span style="font-size: 12px; color: var(--text-light);"> ${note.staffName}</span>` : ''}
                            </div>
                            <span style="color: var(--primary); font-size: 12px; font-weight: 600;">View Details </span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // View note detail in modal
        function viewNoteDetail(clientId, noteIndex) {
            const client = clients.find(c => c.id === clientId);
            if (!client || !client.sessionNotes || !client.sessionNotes[noteIndex]) {
                // Try to find note by searching
                const allNotes = [];
                clients.forEach(c => {
                    if (c.sessionNotes) {
                        c.sessionNotes.forEach((n, i) => {
                            allNotes.push({ client: c, note: n, index: i });
                        });
                    }
                });
                
                const found = allNotes.find(item => item.client.id === clientId);
                if (found) {
                    showNoteInModal(found.client, found.note);
                } else {
                    alert('Note not found');
                }
                return;
            }
            
            showNoteInModal(client, client.sessionNotes[noteIndex]);
        }
        
        function showNoteInModal(client, note) {
            const sessionDate = note.sessionDate ? new Date(note.sessionDate + 'T00:00:00').toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            }) : 'No date';
            
            document.getElementById('noteViewTitle').textContent = `${client.name} - ${sessionDate}`;
            
            const hasMarkers = note.bodyChart && Object.values(note.bodyChart).some(arr => arr && arr.length > 0);
            
            let content = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <span style="color: var(--text-light); font-size: 13px;">Client:</span>
                            <strong style="margin-left: 5px;">${client.name}</strong>
                        </div>
                        <div>
                            <span style="color: var(--text-light); font-size: 13px;">Session Date:</span>
                            <strong style="margin-left: 5px;">${sessionDate}</strong>
                        </div>
                        ${note.staffName ? `
                            <div>
                                <span style="color: var(--text-light); font-size: 13px;">Staff:</span>
                                <strong style="margin-left: 5px;">${note.staffName}</strong>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            if (hasMarkers) {
                content += `
                    <div class="profile-section" style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px;"> Body Chart</h3>
                        <div class="note-body-chart" style="display: grid;">
                            ${renderNoteBodyChartForModal(note.bodyChart)}
                        </div>
                        <div class="body-chart-legend" style="margin-top: 15px;">
                            <div class="legend-item-body"><div class="legend-dot low"></div><span>1 - Mild</span></div>
                            <div class="legend-item-body"><div class="legend-dot medium"></div><span>2 - Moderate</span></div>
                            <div class="legend-item-body"><div class="legend-dot high"></div><span>3 - Severe</span></div>
                        </div>
                    </div>
                `;
            }
            
            content += `
                <div class="profile-section">
                    <h3 style="margin-bottom: 15px;"> Session Notes</h3>
                    <div style="background: white; padding: 20px; border-radius: 8px; line-height: 1.8;">
                        ${note.text ? note.text.replace(/\n/g, '<br>') : '<em style="color: var(--text-light);">No text notes recorded</em>'}
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: right; color: var(--text-light); font-size: 12px;">
                    Note created: ${new Date(note.date).toLocaleString()}
                </div>
            `;
            
            document.getElementById('noteViewContent').innerHTML = content;
            document.getElementById('noteViewModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function renderNoteBodyChartForModal(bodyChart) {
            const views = ['front', 'back', 'left', 'right'];
            const viewBoxes = {
                front: '0 0 200 400',
                back: '0 0 200 400',
                left: '0 0 150 400',
                right: '0 0 150 400'
            };
            
            return views.map(view => {
                const markers = bodyChart[view] || [];
                
                return `
                    <div class="note-body-view">
                        <div class="note-body-view-label">${view.charAt(0).toUpperCase() + view.slice(1)}</div>
                        <div class="note-body-svg">
                            <svg viewBox="${viewBoxes[view]}" fill="none" xmlns="http://www.w3.org/2000/svg">
                                ${getBodySvgContent(view)}
                            </svg>
                            ${markers.map(m => `
                                <div class="note-pain-marker severity-${m.severity}" style="left: ${m.x}%; top: ${m.y}%;" title="Marker ${m.id}">
                                    ${m.id}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function closeNoteViewModal() {
            document.getElementById('noteViewModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // ========================================
        // SESSION MANAGEMENT
        // ========================================
        
        function populateStaffDropdowns() {
            // Populate the session form staff dropdown
            const sessionTeacherSelect = document.getElementById('sessionTeacher');
            if (sessionTeacherSelect) {
                sessionTeacherSelect.innerHTML = '<option value="">Select staff...</option>';
                staffMembers.forEach(staff => {
                    const displayName = staff.displayName || staff.name || staff.email;
                    sessionTeacherSelect.innerHTML += `<option value="${displayName}" data-email="${staff.email}">${displayName}</option>`;
                });
            }
            
            // Also update calendar staff filters
            renderStaffFilters();
        }
        
        let selectedSessionClients = [];
        let maxSessionClients = 1;
        
        function updateClientSelection() {
            const chipsContainer = document.getElementById('selectedClients');
            const searchInput = document.getElementById('clientSearchInput');
            const sessionType = document.getElementById('sessionType').value;
            
            // Clear selected clients when session type changes
            selectedSessionClients = [];
            if (chipsContainer) chipsContainer.innerHTML = '';
            if (searchInput) searchInput.value = '';
            
            // Set max clients based on session type
            maxSessionClients = 1;
            if (sessionType === 'Duet') maxSessionClients = 2;
            if (sessionType === 'Trio') maxSessionClients = 3;
            
            // Hide search results
            const resultsContainer = document.getElementById('clientSearchResults');
            if (resultsContainer) resultsContainer.style.display = 'none';
        }
        
        function initClientSearch() {
            const searchInput = document.getElementById('clientSearchInput');
            const resultsContainer = document.getElementById('clientSearchResults');
            
            if (!searchInput || !resultsContainer) return;
            
            // Search as user types
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length === 0) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                // Filter clients by name
                const matchingClients = clients.filter(client => 
                    client.name.toLowerCase().includes(query) &&
                    !selectedSessionClients.includes(client.id)
                );
                
                if (matchingClients.length === 0) {
                    resultsContainer.innerHTML = '<div style="padding: 12px; color: var(--text-light); text-align: center;">No matching clients found</div>';
                    resultsContainer.style.display = 'block';
                    return;
                }
                
                resultsContainer.innerHTML = matchingClients.map(client => `
                    <div class="client-search-result" onclick="selectClientFromSearch('${client.id}')" 
                         style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s;"
                         onmouseover="this.style.background='var(--bg)'" 
                         onmouseout="this.style.background='white'">
                        <div style="font-weight: 500;">${client.name}</div>
                        <div style="font-size: 12px; color: var(--text-light);">${client.email || 'No email'}</div>
                    </div>
                `).join('');
                resultsContainer.style.display = 'block';
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                    resultsContainer.style.display = 'none';
                }
            });
            
            // Show results when focusing on input
            searchInput.addEventListener('focus', function() {
                if (this.value.trim().length > 0) {
                    this.dispatchEvent(new Event('input'));
                }
            });
        }
        
        function selectClientFromSearch(clientId) {
            // Check if already at max
            if (selectedSessionClients.length >= maxSessionClients) {
                alert(`Maximum ${maxSessionClients} client(s) for this session type.`);
                return;
            }
            
            // Add client if not already selected
            if (!selectedSessionClients.includes(clientId)) {
                selectedSessionClients.push(clientId);
                updateSelectedClientsDisplay();
            }
            
            // Clear search input and hide results
            const searchInput = document.getElementById('clientSearchInput');
            const resultsContainer = document.getElementById('clientSearchResults');
            if (searchInput) searchInput.value = '';
            if (resultsContainer) resultsContainer.style.display = 'none';
            
            // Disable search if at max
            if (selectedSessionClients.length >= maxSessionClients) {
                searchInput.placeholder = `Maximum ${maxSessionClients} client(s) selected`;
                searchInput.disabled = true;
            }
        }
        
        function updateSelectedClientsDisplay() {
            const chipsContainer = document.getElementById('selectedClients');
            if (!chipsContainer) return;
            
            chipsContainer.innerHTML = selectedSessionClients.map(clientId => {
                const client = clients.find(c => c.id === clientId);
                return client ? `
                    <span class="client-chip" data-client-id="${clientId}" style="display: inline-flex; align-items: center; gap: 8px; background: var(--primary); color: white; padding: 8px 12px; border-radius: 20px; margin: 4px; font-size: 13px;">
                        ${client.name}
                        <span onclick="removeSessionClient('${clientId}')" style="cursor: pointer; font-weight: bold; font-size: 16px; line-height: 1;">&times;</span>
                    </span>
                ` : '';
            }).join('');
        }
        
        function removeSessionClient(clientId) {
            const index = selectedSessionClients.indexOf(clientId);
            if (index > -1) {
                selectedSessionClients.splice(index, 1);
                updateSelectedClientsDisplay();
                
                // Re-enable search input
                const searchInput = document.getElementById('clientSearchInput');
                if (searchInput) {
                    searchInput.disabled = false;
                    searchInput.placeholder = 'Type to search clients...';
                }
            }
        }
        
        function renderSessions() {
            const container = document.getElementById('sessionsList');
            if (!container) return;
            
            if (sessions.length === 0) {
                container.innerHTML = '<p>No sessions booked yet.</p>';
                return;
            }
            
            const sorted = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sorted.map((session, index) => `
                <div style="padding: 15px; background: var(--bg); border-radius: 8px; margin-bottom: 10px;">
                    <strong>${session.type || 'Session'}</strong><br>
                    Date: ${new Date(session.date).toLocaleDateString()}<br>
                    Time: ${formatTimeDisplay(session.time)}<br>
                    Staff: ${session.teacherName || 'N/A'}<br>
                    Clients: ${session.clientNames || 'N/A'}
                    <div style="margin-top: 10px;">
                        <button class="btn-secondary" onclick="deleteSession(${sessions.indexOf(session)})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function addSession(event) {
            event.preventDefault();
            
            const type = document.getElementById('sessionType').value;
            const date = document.getElementById('sessionDate').value;
            const hour = document.getElementById('sessionHour').value;
            const minute = document.getElementById('sessionMinute').value;
            const ampm = document.getElementById('sessionAmPm').value;
            const teacher = document.getElementById('sessionTeacher').value;
            const notes = document.getElementById('sessionNotes').value;
            
            if (!type || !date || !hour) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (selectedSessionClients.length === 0) {
                alert('Please select at least one client');
                return;
            }
            
            // Convert 12-hour to 24-hour format for storage
            const time = convertTo24Hour(hour, minute, ampm);
            
            // Get client names for display
            const clientNames = selectedSessionClients.map(clientId => {
                const client = clients.find(c => c.id === clientId);
                return client ? client.name : 'Unknown';
            }).join(', ');
            
            const sessionData = {
                type: type,
                date: date,
                time: time,
                teacherName: teacher,
                clients: selectedSessionClients,
                clientNames: clientNames,
                notes: notes
            };
            
            try {
                await saveSession(sessionData);
                await loadData();
                
                // Refresh calendar to show new session
                renderCalendar();
                
                // Reset form
                document.getElementById('sessionForm').reset();
                selectedSessionClients = [];
                updateClientSelection();
                
                // Re-enable search input
                const searchInput = document.getElementById('clientSearchInput');
                if (searchInput) {
                    searchInput.disabled = false;
                    searchInput.placeholder = 'Type to search clients...';
                }
                
                alert('Session booked successfully!');
            } catch (error) {
                console.error('Error booking session:', error);
                alert('Error booking session: ' + error.message);
            }
        }

        async function deleteSession(index) {
            if (confirm('Delete this session?')) {
                const session = sessions[index];
                try {
                    await deleteSessionFromDb(session.id);
                    await loadData();
                    renderCalendar();
                    alert('Session deleted successfully!');
                } catch (error) {
                    console.error('Error deleting session:', error);
                    alert('Error deleting session: ' + error.message);
                }
            }
        }

        // ========================================
        // INVOICE MANAGEMENT
        // ========================================
        
        // Helper function to convert 12-hour to 24-hour time format
        function convertTo24Hour(hour, minute, ampm) {
            let h = parseInt(hour);
            if (ampm === 'PM' && h !== 12) {
                h += 12;
            } else if (ampm === 'AM' && h === 12) {
                h = 0;
            }
            return `${String(h).padStart(2, '0')}:${minute}`;
        }
        
        function renderInvoices() {
            const container = document.getElementById('invoicesList');
            if (!container) return;
            
            if (invoices.length === 0) {
                container.innerHTML = '<p>No invoices yet.</p>';
                return;
            }
            
            container.innerHTML = invoices.map((invoice, index) => `
                <div style="padding: 15px; background: var(--bg); border-radius: 8px; margin-bottom: 10px;">
                    <strong>Invoice #${invoice.id}</strong><br>
                    Amount: $${invoice.amount}<br>
                    Status: ${invoice.status || 'unpaid'}<br>
                    Date: ${new Date(invoice.date).toLocaleDateString()}
                    <div style="margin-top: 10px;">
                        <button class="btn-secondary" onclick="toggleInvoiceStatus(${index})">
                            Mark as ${invoice.status === 'paid' ? 'Unpaid' : 'Paid'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function generateInvoice() {
            const amount = prompt('Enter invoice amount:');
            if (!amount || isNaN(amount)) {
                alert('Invalid amount');
                return;
            }
            
            const invoice = {
                id: Date.now(),
                amount: parseFloat(amount),
                status: 'unpaid',
                date: new Date().toISOString()
            };
            
            invoices.push(invoice);
            saveData();
            renderInvoices();
            alert('Invoice created!');
        }

        function toggleInvoiceStatus(index) {
            invoices[index].status = invoices[index].status === 'paid' ? 'unpaid' : 'paid';
            saveData();
            renderInvoices();
        }

        // ========================================
        // SETTINGS FUNCTIONS
        // ========================================
        
        function loadSettings() {
            if (!isOwnerOrAdmin()) {
                document.getElementById('settingsTab').style.display = 'none';
                switchTab('clients', event);
                alert('You do not have permission to access Settings.');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            const userData = getCurrentUserData();
            
            if (userData) {
                const nameInput = document.getElementById('studioNameSetting');
                if (nameInput) {
                    nameInput.value = userData.studioName || '';
                }
                document.getElementById('mainStudioName').textContent = userData.studioName || 'Studio Flow';
            }
            
            if (settings.logo) {
                updateLogoDisplay(settings.logo);
            } else {
                updateLogoDisplay(null);
            }
            // Load user management (owner only)
            const userMgmtSection = document.getElementById('userManagementSection');
            if (userMgmtSection) {
                if (canManageUsers()) {
                    userMgmtSection.innerHTML = renderUserManagement();
                } else {
                    userMgmtSection.innerHTML = '';
                }
            }

        // Load QuickBooks settings (owner/admin only)
        const qbSection = document.getElementById('quickbooksSection');
        if (qbSection) {
            if (canAccessSettings()) {
                qbSection.innerHTML = renderQuickBooksSettings();
            } else {
                qbSection.innerHTML = '';
            }
        }

        renderOwnersList();
        renderClassPricing();
        }

        function saveBusinessInfo() {
            const studioName = document.getElementById('studioNameSetting').value.trim();
            
            if (!studioName) {
                alert('Please enter a business name');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
            const localUser = localStorage.getItem('currentUser');
            if (users[currentUser]) {
                users[currentUser].studioName = studioName;
                localStorage.setItem('studioFlowUsers', JSON.stringify(users));
            }
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            settings.studioName = studioName;
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            
            document.getElementById('mainStudioName').textContent = studioName;
            
            alert('Business information saved successfully!');
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 500000) {
                alert('File size must be less than 500KB');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
                settings.logo = imageData;
                localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
                updateLogoDisplay(imageData);
                alert('Logo uploaded successfully!');
            };
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            if (!confirm('Remove your business logo?')) return;
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            delete settings.logo;
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            updateLogoDisplay(null);
            alert('Logo removed successfully!');
        }

        function updateLogoDisplay(imageData) {
            const logoPreview = document.getElementById('logoPreview');
            const mainLogo = document.getElementById('mainLogo');
            const userData = getCurrentUserData();
            const studioName = userData ? userData.studioName : 'Studio Flow';
            const initials = studioName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
            
            if (imageData) {
                if (logoPreview) logoPreview.innerHTML = '<img src="' + imageData + '" alt="Logo" style="width:100%;height:100%;object-fit:cover;">';
                if (mainLogo) mainLogo.innerHTML = '<img src="' + imageData + '" alt="Logo" style="width:100%;height:100%;object-fit:cover;">';
            } else {
                if (logoPreview) logoPreview.innerHTML = '<span style="font-size:36px;color:var(--primary);">' + initials + '</span>';
                if (mainLogo) mainLogo.innerHTML = initials;
            }
        }

        function renderOwnersList() {
            const container = document.getElementById('ownersList');
            if (!container) return;
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            const currentUserEmail = localStorage.getItem('currentUser');
            
            if (!settings.owners || settings.owners.length === 0) {
                settings.owners = [currentUserEmail];
                localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            }
            
            container.innerHTML = '<p><strong>Owners:</strong> ' + settings.owners.join(', ') + '</p>';
        }

        function addOwner() {
            const email = document.getElementById('newOwnerEmail').value.trim().toLowerCase();
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
            
            if (!users[email]) {
                alert('This user does not have an account.');
                return;
            }
            
            const currentOrgId = localStorage.getItem('currentOrganization');
            if (users[email].organizationId !== currentOrgId) {
                alert('This user belongs to a different organization.');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            if (!settings.owners) settings.owners = [];
            
            if (settings.owners.includes(email)) {
                alert('This user is already an owner');
                return;
            }
            
            settings.owners.push(email);
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            
            document.getElementById('newOwnerEmail').value = '';
            renderOwnersList();
            alert('Owner added successfully!');
        }

        function renderClassPricing() {
            const container = document.getElementById('classPricingList');
            if (!container) return;
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            
            if (!settings.sessionTypes || settings.sessionTypes.length === 0) {
                settings.sessionTypes = [
                    { name: 'Private', id: 1, defaultPrice: 120 },
                    { name: 'Duet', id: 2, defaultPrice: 60 },
                    { name: 'Trio', id: 3, defaultPrice: 45 }
                ];
                localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            }
            
            container.innerHTML = '<ul>' + settings.sessionTypes.map((type, index) => 
                '<li>' + type.name + ': $' + (type.defaultPrice || 0) + 
                ' <button class="btn-secondary" onclick="editClassPrice(' + index + ')">Edit</button>' +
                ' <button class="btn-secondary" onclick="deleteClassType(' + index + ')">Delete</button></li>'
            ).join('') + '</ul>';
        }

        function editClassPrice(index) {
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            const type = settings.sessionTypes[index];
            
            const newName = prompt('Edit class name:', type.name);
            if (newName && newName.trim()) {
                type.name = newName.trim();
            }
            
            const newPrice = prompt('Edit default price:', type.defaultPrice);
            if (newPrice && !isNaN(newPrice)) {
                type.defaultPrice = parseFloat(newPrice);
            }
            
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            renderClassPricing();
        }

        function addClassType() {
            const name = document.getElementById('newClassName').value.trim();
            const price = parseFloat(document.getElementById('newClassPrice').value) || 0;
            
            if (!name) {
                alert('Please enter a class name');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            if (!settings.sessionTypes) settings.sessionTypes = [];
            
            if (settings.sessionTypes.some(t => t.name.toLowerCase() === name.toLowerCase())) {
                alert('A class type with this name already exists');
                return;
            }
            
            settings.sessionTypes.push({
                name: name,
                id: Date.now(),
                defaultPrice: price
            });
            
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            
            document.getElementById('newClassName').value = '';
            document.getElementById('newClassPrice').value = '';
            
            renderClassPricing();
            alert('Class type added successfully!');
        }

        function deleteClassType(index) {
            if (!confirm('Delete this class type?')) return;
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            settings.sessionTypes.splice(index, 1);
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            
            renderClassPricing();
        }

        // ========================================
        // CALENDAR & EMAIL INTEGRATIONS
        // ========================================
        
        // Google Calendar Integration
        function connectGoogleCalendar() {
            if (localStorage.getItem(getOrgKey('google_calendar_connected'))) {
                alert('Google Calendar is already connected!');
                return;
            }
            
            // In production, this would initiate OAuth 2.0 flow with Google
            // Scope needed: https://www.googleapis.com/auth/calendar
            const clientId = 'YOUR_GOOGLE_CLIENT_ID';
            const redirectUri = window.location.origin + '/google-callback';
            const scope = 'https://www.googleapis.com/auth/calendar';
            
            // Production OAuth URL:
            // const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=${scope}`;
            // window.location.href = authUrl;
            
            if (confirm('Connect to Google Calendar?\n\nThis will allow automatic calendar event creation for sessions.\n\n(Demo mode - simulating connection)')) {
                localStorage.setItem(getOrgKey('google_calendar_connected'), 'true');
                localStorage.setItem(getOrgKey('google_calendar_token'), 'demo_token_' + Date.now());
                document.getElementById('google-status').style.display = 'block';
                alert(' Successfully connected to Google Calendar!\n\nCalendar events will be created when booking sessions.');
            }
        }
        
        function disconnectGoogleCalendar() {
            if (confirm('Disconnect Google Calendar?')) {
                localStorage.removeItem(getOrgKey('google_calendar_connected'));
                localStorage.removeItem(getOrgKey('google_calendar_token'));
                document.getElementById('google-status').style.display = 'none';
                alert('Disconnected from Google Calendar');
            }
        }
        
        function createGoogleCalendarEvent(sessionData) {
            const isConnected = localStorage.getItem(getOrgKey('google_calendar_connected'));
            if (!isConnected) return;
            
            // In production: POST to https://www.googleapis.com/calendar/v3/calendars/primary/events
            const event = {
                summary: `${sessionData.type} Session - ${sessionData.clientNames}`,
                description: sessionData.notes || 'Pilates session',
                start: {
                    dateTime: new Date(sessionData.date + 'T' + sessionData.time).toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                end: {
                    dateTime: new Date(new Date(sessionData.date + 'T' + sessionData.time).getTime() + 3600000).toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                attendees: sessionData.clientEmails.map(email => ({ email }))
            };
            
            console.log(' Google Calendar event created:', event.summary);
        }
        
        // Microsoft Outlook / Microsoft 365 Integration
        function connectMicrosoftOutlook() {
            if (localStorage.getItem(getOrgKey('outlook_connected'))) {
                alert('Microsoft Outlook is already connected!');
                return;
            }
            
            // In production, this would initiate OAuth 2.0 flow with Microsoft
            // Scopes needed: Calendars.ReadWrite, Mail.Send
            const clientId = 'YOUR_MICROSOFT_CLIENT_ID';
            const redirectUri = window.location.origin + '/microsoft-callback';
            const scope = 'Calendars.ReadWrite Mail.Send offline_access';
            
            // Production OAuth URL:
            // const authUrl = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${clientId}&response_type=code&redirect_uri=${redirectUri}&scope=${scope}`;
            // window.location.href = authUrl;
            
            if (confirm('Connect to Microsoft Outlook / Microsoft 365?\n\nThis enables:\n Outlook calendar event creation\n Email sending via Outlook\n Client appointment invites\n\n(Demo mode - simulating connection)')) {
                localStorage.setItem(getOrgKey('outlook_connected'), 'true');
                localStorage.setItem(getOrgKey('outlook_token'), 'demo_outlook_token_' + Date.now());
                document.getElementById('outlook-status').style.display = 'block';
                alert(' Successfully connected to Microsoft Outlook!\n\nYou can now:\n Create Outlook calendar events\n Send emails via Outlook\n Access Microsoft 365 features');
            }
        }
        
        function disconnectMicrosoftOutlook() {
            if (confirm('Disconnect Microsoft Outlook?')) {
                localStorage.removeItem(getOrgKey('outlook_connected'));
                localStorage.removeItem(getOrgKey('outlook_token'));
                document.getElementById('outlook-status').style.display = 'none';
                alert('Disconnected from Microsoft Outlook');
            }
        }
        
        function createOutlookCalendarEvent(sessionData) {
            const isConnected = localStorage.getItem(getOrgKey('outlook_connected'));
            if (!isConnected) return;
            
            // In production: POST to https://graph.microsoft.com/v1.0/me/events
            const event = {
                subject: `${sessionData.type} Session - ${sessionData.clientNames}`,
                body: {
                    contentType: 'HTML',
                    content: sessionData.notes || 'Pilates session booking'
                },
                start: {
                    dateTime: new Date(sessionData.date + 'T' + sessionData.time).toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                end: {
                    dateTime: new Date(new Date(sessionData.date + 'T' + sessionData.time).getTime() + 3600000).toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                attendees: sessionData.clientEmails.map(email => ({
                    emailAddress: { address: email },
                    type: 'required'
                }))
            };
            
            console.log(' Outlook Calendar event created:', event.subject);
        }
        
        function sendOutlookEmail(emailData) {
            const isConnected = localStorage.getItem(getOrgKey('outlook_connected'));
            if (!isConnected) {
                console.log('Outlook not connected, cannot send email');
                return false;
            }
            
            // In production: POST to https://graph.microsoft.com/v1.0/me/sendMail
            const message = {
                message: {
                    subject: emailData.subject,
                    body: {
                        contentType: 'HTML',
                        content: emailData.body
                    },
                    toRecipients: emailData.recipients.map(email => ({
                        emailAddress: { address: email }
                    }))
                },
                saveToSentItems: true
            };
            
            console.log(' Outlook email sent:', message.message.subject);
            return true;
        }
        
        // Unified function to create calendar events across all connected platforms
        function createCalendarEventsForSession(session) {
            const clientEmails = [];
            const clientNames = [];
            
            if (session.clients && Array.isArray(session.clients)) {
                session.clients.forEach(clientId => {
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        if (client.email) clientEmails.push(client.email);
                        clientNames.push(client.name);
                    }
                });
            }
            
            const sessionData = {
                type: session.type,
                clientNames: clientNames.join(', ') || 'Client',
                clientEmails: clientEmails,
                date: session.date,
                time: session.time,
                notes: session.notes
            };
            
            let eventsCreated = 0;
            
            if (localStorage.getItem(getOrgKey('google_calendar_connected'))) {
                createGoogleCalendarEvent(sessionData);
                eventsCreated++;
            }
            
            if (localStorage.getItem(getOrgKey('outlook_connected'))) {
                createOutlookCalendarEvent(sessionData);
                eventsCreated++;
            }
            
            if (eventsCreated > 0) {
                console.log(` Created ${eventsCreated} calendar event(s) for session`);
            }
        }
        
        // QuickBooks Integration
        function connectQuickBooks() {
            if (localStorage.getItem(getOrgKey('quickbooks_connected'))) {
                alert('QuickBooks is already connected!');
                return;
            }
            
            // In production: OAuth 2.0 flow with Intuit
            if (confirm('Connect to QuickBooks Online?\n\nThis enables:\n Automatic invoice generation\n Client syncing\n Payment tracking\n\n(Demo mode - simulating connection)')) {
                localStorage.setItem(getOrgKey('quickbooks_connected'), 'true');
                localStorage.setItem(getOrgKey('quickbooks_token'), 'demo_qb_token_' + Date.now());
                document.getElementById('quickbooks-status').style.display = 'block';
                alert(' Successfully connected to QuickBooks!\n\nYou can now sync clients and generate invoices.');
            }
        }
        
        function syncClientsToQuickBooks() {
            const isConnected = localStorage.getItem(getOrgKey('quickbooks_connected'));
            if (!isConnected) {
                alert('Please connect to QuickBooks first');
                return;
            }
            
            if (clients.length === 0) {
                alert('No clients to sync. Add clients first.');
                return;
            }
            
            // In production: POST to QuickBooks API to create/update customers
            console.log('Syncing ' + clients.length + ' clients to QuickBooks...');
            
            alert(` Successfully synced ${clients.length} client(s) to QuickBooks!\n\n(Demo mode - in production, clients would be created/updated in QuickBooks)`);
        }
        
        // Check integration status on page load
        function checkIntegrationStatus() {
            if (localStorage.getItem(getOrgKey('google_calendar_connected'))) {
                const statusDiv = document.getElementById('google-status');
                if (statusDiv) statusDiv.style.display = 'block';
            }
            
            if (localStorage.getItem(getOrgKey('outlook_connected'))) {
                const statusDiv = document.getElementById('outlook-status');
                if (statusDiv) statusDiv.style.display = 'block';
            }
            
            if (localStorage.getItem(getOrgKey('quickbooks_connected'))) {
                const statusDiv = document.getElementById('quickbooks-status');
                if (statusDiv) statusDiv.style.display = 'block';
            }
        }

      
        // ========================================
        // USER MANAGEMENT FUNCTIONS
        // ========================================

function removeUserFromOrganization(email) {
    if (!canManageUsers()) {
        alert('Only owners can remove users.');
        return false;
    }
    const localUser = localStorage.getItem('currentUser');
    if (email === localUser) {
        alert('You cannot remove yourself.');
        return false;
    }

    if (!confirm(`Are you sure you want to remove this user?\n\nEmail: ${email}\n\nThey will no longer be able to access this organization.`)) {
        return false;
    }

    const orgId = localStorage.getItem('currentOrganization');

    // Remove from organization users
    const orgUsers = JSON.parse(localStorage.getItem(`org_users_${orgId}`) || '{}');
    delete orgUsers[email];
    localStorage.setItem(`org_users_${orgId}`, JSON.stringify(orgUsers));

    // Remove from global users
    const allUsers = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
    delete allUsers[email];
    localStorage.setItem('studioFlowUsers', JSON.stringify(allUsers));

    return true;
}

function updateUserRole(email, newRole) {
    if (!canManageUsers()) {
        alert('Only owners can change user roles.');
        return false;
    }

    const localUser = localStorage.getItem('currentUser');
    if (email === localUser) {
        alert('You cannot change your own role.');
        return false;
    }

    const orgId = localStorage.getItem('currentOrganization');

    // Update in organization users
    const orgUsers = JSON.parse(localStorage.getItem(`org_users_${orgId}`) || '{}');
    if (orgUsers[email]) {
        orgUsers[email].role = newRole;
        localStorage.setItem(`org_users_${orgId}`, JSON.stringify(orgUsers));
    }

    // Update in global users
    const allUsers = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
    if (allUsers[email]) {
        allUsers[email].role = newRole;
        localStorage.setItem('studioFlowUsers', JSON.stringify(allUsers));
    }

    return true;
}

// ========================================
// UI RENDERING FUNCTIONS
// ========================================

function renderUserManagement() {
    if (!canManageUsers()) {
        return '<div class="card"><p>Only organization owners can manage users.</p></div>';
    }

    // Generate invite link
    const inviteCode = organizationId ? btoa(organizationId).substring(0, 12) : '';
    const inviteLink = window.location.origin + '/login.html?invite=' + inviteCode;

    let html = `
        <div class="settings-section">
            <h3> Staff & User Management</h3>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Manage your team members. Staff can self-register using the invite link, or you can add them manually below.
            </p>

            <!-- Invite Link Section -->
            <div class="card" style="margin-bottom: 30px; background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); border: 2px solid #81C784;">
                <h4 style="margin-bottom: 15px; color: #2E7D32;"> Staff Invite Link</h4>
                <p style="color: #555; font-size: 14px; margin-bottom: 15px;">
                    Share this link with staff members so they can create their own account and join your studio. 
                    They'll be added with "Staff" role by default - you can change their role after they register.
                </p>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="inviteLinkInput" value="${inviteLink}" readonly 
                        style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid #81C784; border-radius: 8px; font-size: 13px; background: white;">
                    <button onclick="copyInviteLink()" class="btn-primary" style="background: #4CAF50; white-space: nowrap;">
                         Copy Link
                    </button>
                </div>
                <p style="margin-top: 10px; font-size: 12px; color: #666;">
                     Staff will have verified emails for calendar invites and communications
                </p>
            </div>

            <!-- Manual Add User Section -->
            <div class="card" style="margin-bottom: 30px;">
                <h4 style="margin-bottom: 20px; color: var(--primary);"> Add Staff Manually</h4>
                <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">
                    Create an account on behalf of a staff member. They can reset their password via the login page.
                </p>
                <form onsubmit="handleAddStaffUser(event)" style="display: grid; gap: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="new-staff-name" required placeholder="Jane Smith">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="new-staff-email" required placeholder="jane@example.com">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Temporary Password</label>
                            <input type="password" id="new-staff-password" required minlength="6" placeholder="At least 6 characters">
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select id="new-staff-role" required>
                                <option value="staff">Staff - Can manage clients and sessions</option>
                                <option value="admin">Admin - Full access except billing</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">Add Staff Member</button>
                </form>
            </div>

            <!-- Current Staff List -->
            <div class="card">
                <h4 style="margin-bottom: 20px; color: var(--primary);"> Current Team (${staffMembers.length} members)</h4>
                <div class="user-list">
    `;

    if (staffMembers.length === 0) {
        html += `
            <div style="text-align: center; padding: 40px; color: var(--text-light);">
                <div style="font-size: 48px; margin-bottom: 15px;"></div>
                <p>No staff members yet. Share the invite link above or add staff manually.</p>
            </div>
        `;
    } else {
        staffMembers.forEach(user => {
            const isCurrentUser = currentUser && user.email === currentUser.email;
            const displayName = user.displayName || user.name || user.email.split('@')[0];
            const roleColor = user.role === 'owner' ? '#2C4A3E' : user.role === 'admin' ? '#4A6B5D' : '#D4A574';
            const roleLabel = user.role === 'teacher' ? 'Staff' : (user.role === 'staff' ? 'Staff' : user.role.charAt(0).toUpperCase() + user.role.slice(1));

            html += `
                <div class="user-item" style="padding: 20px; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 5px;">
                            ${displayName} ${isCurrentUser ? '<span style="color: var(--accent); font-size: 12px;">(You)</span>' : ''}
                        </div>
                        <div style="color: var(--text-light); font-size: 14px; margin-bottom: 8px;">
                             ${user.email}
                        </div>
                        <span style="display: inline-block; padding: 4px 12px; background: ${roleColor}; color: white; border-radius: 6px; font-size: 12px; font-weight: 600;">
                            ${roleLabel}
                        </span>
                    </div>
                    ${!isCurrentUser && user.role !== 'owner' ? `
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <select onchange="handleChangeUserRole('${user.id}', this.value)" style="padding: 8px 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 13px;">
                                <option value="">Change Role...</option>
                                <option value="admin" ${user.role === 'admin' ? 'disabled' : ''}>Make Admin</option>
                                <option value="staff" ${user.role === 'staff' || user.role === 'teacher' ? 'disabled' : ''}>Make Staff</option>
                            </select>
                            <button onclick="handleRemoveStaffUser('${user.id}')" class="btn-danger" style="padding: 8px 16px; background: var(--error); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                Remove
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        });
    }

    html += `
                </div>
            </div>
        </div>
    `;

    return html;
}

function copyInviteLink() {
    const input = document.getElementById('inviteLinkInput');
    input.select();
    document.execCommand('copy');
    alert('Invite link copied to clipboard! Share this with your staff.');
}

async function handleAddStaffUser(event) {
    event.preventDefault();

    const fullName = document.getElementById('new-staff-name').value.trim();
    const email = document.getElementById('new-staff-email').value.trim();
    const password = document.getElementById('new-staff-password').value;
    const role = document.getElementById('new-staff-role').value;

    if (!fullName || !email || !password || !role) {
        alert('Please fill in all fields.');
        return;
    }

    if (password.length < 6) {
        alert('Password must be at least 6 characters.');
        return;
    }

    try {
        // Create user in Firebase Auth using a secondary app to avoid logging out current user
        const secondaryApp = firebase.initializeApp(firebaseConfig, 'Secondary' + Date.now());
        const secondaryAuth = secondaryApp.auth();
        
        const userCredential = await secondaryAuth.createUserWithEmailAndPassword(email, password);
        const newUser = userCredential.user;
        
        // Create user document in Firestore
        await db.collection('users').doc(newUser.uid).set({
            email: email,
            displayName: fullName,
            name: fullName,
            role: role,
            organizationId: organizationId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Add to organization's users collection
        await getOrgCollection('users').doc(newUser.uid).set({
            email: email,
            displayName: fullName,
            name: fullName,
            role: role,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Sign out of secondary app and delete it
        await secondaryAuth.signOut();
        await secondaryApp.delete();
        
        alert(` Staff member added successfully!\n\n${fullName} can now log in with:\nEmail: ${email}\nPassword: [as set]\n\nThey should change their password after first login.`);
        
        // Clear form
        document.getElementById('new-staff-name').value = '';
        document.getElementById('new-staff-email').value = '';
        document.getElementById('new-staff-password').value = '';
        
        // Refresh data
        await loadData();
        
    } catch (error) {
        console.error('Error adding staff:', error);
        if (error.code === 'auth/email-already-in-use') {
            alert('This email is already registered. The user may need to request access to your organization.');
        } else {
            alert('Error adding staff: ' + error.message);
        }
    }
}

async function handleChangeUserRole(userId, newRole) {
    if (!newRole) return;
    
    try {
        // Update in global users collection
        await db.collection('users').doc(userId).update({ role: newRole });
        
        // Update in organization's users collection
        await getOrgCollection('users').doc(userId).update({ role: newRole });
        
        alert('Role updated successfully!');
        await loadData();
    } catch (error) {
        console.error('Error changing role:', error);
        alert('Error changing role: ' + error.message);
    }
}

async function handleRemoveStaffUser(userId) {
    if (!confirm('Remove this staff member from your organization? They will no longer have access to your studio data.')) {
        return;
    }
    
    try {
        // Remove from organization's users collection (don't delete their auth account)
        await getOrgCollection('users').doc(userId).delete();
        
        // Update their user document to remove organization association
        await db.collection('users').doc(userId).update({ 
            organizationId: null,
            role: 'removed'
        });
        
        alert('Staff member removed from your organization.');
        await loadData();
    } catch (error) {
        console.error('Error removing user:', error);
        alert('Error removing user: ' + error.message);
    }
}

function renderQuickBooksSettings() {
    if (!canAccessSettings()) {
        return '';
    }

    const isConnected = localStorage.getItem(getOrgKey('quickbooks_connected'));
    
    return `
        <div class="settings-section">
            <h3> QuickBooks Online Integration</h3>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Connect your QuickBooks Online account to automatically sync clients, generate invoices, 
                and track payments.
            </p>

            <div class="card">
                ${isConnected ? `
                    <div class="status-badge" style="background: #E8F5E9; color: #2C4A3E; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;"></span>
                        <div>
                            <div style="font-weight: 600;">Connected to QuickBooks</div>
                            <div style="font-size: 12px; opacity: 0.8;">Your account is synced and ready</div>
                        </div>
                    </div>

                    <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <button onclick="syncClientsToQuickBooks()" class="btn-primary">
                            Sync Clients to QuickBooks
                        </button>
                        <button onclick="disconnectQuickBooks()" class="btn-secondary" style="background: var(--error);">
                            Disconnect QuickBooks
                        </button>
                    </div>

                    <div style="background: var(--bg); padding: 15px; border-radius: 8px; font-size: 13px; color: var(--text-light);">
                        <strong>Available Features:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px; line-height: 1.8;">
                            <li>Automatic client syncing</li>
                            <li>Invoice generation</li>
                            <li>Payment tracking</li>
                            <li>Financial reporting</li>
                        </ul>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <h4 style="margin-bottom: 10px; color: var(--primary);">Connect QuickBooks Online</h4>
                        <p style="color: var(--text-light); margin-bottom: 25px; line-height: 1.6;">
                            Streamline your accounting by connecting QuickBooks. Automatically sync clients, 
                            generate invoices, and track all your studio finances in one place.
                        </p>
                        <button onclick="connectQuickBooks()" class="btn-primary">
                            Connect to QuickBooks
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}

function disconnectQuickBooks() {
    if (!canAccessSettings()) {
        alert('Only owners and admins can manage integrations.');
        return;
    }

    if (confirm('Disconnect QuickBooks?\n\nYou can reconnect at any time.')) {
        localStorage.removeItem(getOrgKey('quickbooks_connected'));
        localStorage.removeItem(getOrgKey('quickbooks_token'));
        alert('Disconnected from QuickBooks');
        loadData();
    }
}

// Logout function
function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
        auth.signOut().then(() => {
            window.location.href = 'login.html';
        }).catch((error) => {
            console.error('Logout error:', error);
            alert('Error logging out: ' + error.message);
        });
    }
}

// Initialize Lucide icons - moved to auth state listener
        
    </script>
</body>
</html>
