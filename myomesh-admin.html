<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyoMesh — Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --forest: #1E3A34;
            --sage: #3D8B7A;
            --coral: #FF6B4A;
            --coral-light: #FF8F75;
            --amber: #FFB347;
            --peach: #FFAD85;
            --cream: #FFFBF7;
            --warm-light: #FFF5ED;
            --coral-tint: #FFEBE3;
            --sage-tint: #E8F3F0;
            --text: #2D2926;
            --text-light: #6B635B;
            --border: #E8DDD4;
            --card: #FFFFFF;
            --success: #2CA01C;
            --warning: #DAA520;
            --error: #DC4F41;
            --bg: var(--cream);
            --shadow: rgba(45, 41, 38, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--cream);
            color: var(--text);
            min-height: 100vh;
        }

        /* ── ADMIN AUTH GATE ── */
        .auth-gate {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(160deg, var(--forest) 0%, #264A42 40%, var(--sage) 100%);
            padding: 40px;
        }
        .auth-card {
            background: white;
            border-radius: 24px;
            padding: 48px 40px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 24px 80px rgba(0,0,0,0.15);
            text-align: center;
        }
        .auth-card h1 {
            font-family: 'DM Serif Display', serif;
            font-size: 28px;
            color: var(--forest);
            margin-bottom: 6px;
        }
        .auth-card .subtitle {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 32px;
        }
        .auth-card input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            margin-bottom: 14px;
            transition: border-color 0.2s;
            outline: none;
        }
        .auth-card input:focus { border-color: var(--sage); }
        .auth-card .btn-login {
            width: 100%;
            padding: 14px;
            background: var(--forest);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .auth-card .btn-login:hover { background: var(--sage); }

        /* ── LAYOUT ── */
        .admin-app { display: none; }
        .admin-app.active { display: block; }

        .admin-header {
            background: var(--forest);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .admin-header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .admin-logo {
            font-family: 'DM Serif Display', serif;
            font-size: 22px;
            color: white;
        }
        .admin-badge {
            padding: 4px 12px;
            background: rgba(255,107,74,0.2);
            color: var(--coral-light);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            border-radius: 6px;
        }
        .admin-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .admin-header-right span {
            font-size: 13px;
            color: rgba(255,255,255,0.6);
        }
        .btn-logout {
            padding: 8px 16px;
            background: rgba(255,255,255,0.08);
            color: white;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s;
        }
        .btn-logout:hover { background: rgba(255,255,255,0.15); }

        /* ── NAV TABS ── */
        .admin-nav {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            display: flex;
            gap: 0;
            overflow-x: auto;
        }
        .admin-tab {
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
            font-family: 'DM Sans', sans-serif;
        }
        .admin-tab:hover { color: var(--forest); }
        .admin-tab.active {
            color: var(--coral);
            border-bottom-color: var(--coral);
        }

        /* ── CONTAINER ── */
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 28px 32px;
        }

        .admin-panel { display: none; }
        .admin-panel.active { display: block; animation: fadeUp 0.3s ease; }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ── KPI CARDS ── */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin-bottom: 28px;
        }
        .kpi-card {
            background: white;
            border-radius: 16px;
            padding: 22px 24px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px var(--shadow);
        }
        .kpi-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-light);
            letter-spacing: 0.06em;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .kpi-value {
            font-family: 'DM Serif Display', serif;
            font-size: 32px;
            color: var(--forest);
            margin-bottom: 4px;
        }
        .kpi-detail {
            font-size: 13px;
            color: var(--text-light);
        }
        .kpi-detail.up { color: var(--success); }
        .kpi-detail.down { color: var(--error); }

        /* ── DATA TABLE ── */
        .data-card {
            background: white;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px var(--shadow);
            overflow: hidden;
            margin-bottom: 24px;
        }
        .data-card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .data-card-header h3 {
            font-family: 'DM Serif Display', serif;
            font-size: 20px;
            color: var(--forest);
        }
        .data-card-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-input {
            padding: 10px 14px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            width: 240px;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-input:focus { border-color: var(--sage); }
        .filter-select {
            padding: 10px 14px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            background: white;
            outline: none;
            cursor: pointer;
        }
        .btn-export {
            padding: 10px 18px;
            background: var(--forest);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: background 0.2s;
        }
        .btn-export:hover { background: var(--sage); }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        thead { background: var(--warm-light); }
        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 700;
            color: var(--text);
            font-size: 11px;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            vertical-align: middle;
        }
        tbody tr:hover { background: var(--warm-light); }
        tbody tr:last-child td { border-bottom: none; }

        .status-badge {
            display: inline-flex;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.04em;
        }
        .status-trial { background: #EDE9FE; color: #7C3AED; }
        .status-active { background: var(--sage-tint); color: var(--sage); }
        .status-cancelled { background: #FEE2E2; color: var(--error); }
        .status-past-due { background: #FEF3C7; color: #B45309; }
        .status-churned { background: #F3F4F6; color: #6B7280; }

        .studio-name-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .studio-avatar {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 13px;
            color: white;
            flex-shrink: 0;
        }
        .studio-name-text {
            display: flex;
            flex-direction: column;
        }
        .studio-name-text strong { font-size: 14px; }
        .studio-name-text span { font-size: 12px; color: var(--text-light); }

        .action-btn {
            padding: 6px 12px;
            background: var(--warm-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s;
            color: var(--text);
        }
        .action-btn:hover { background: var(--sage-tint); border-color: var(--sage); color: var(--sage); }
        .action-btn.danger:hover { background: #FEE2E2; border-color: var(--error); color: var(--error); }

        /* ── CHARTS AREA ── */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px var(--shadow);
        }
        .chart-card h4 {
            font-family: 'DM Serif Display', serif;
            font-size: 18px;
            color: var(--forest);
            margin-bottom: 16px;
        }
        .chart-bar-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .chart-bar-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chart-bar-label {
            font-size: 12px;
            color: var(--text-light);
            width: 100px;
            text-align: right;
            flex-shrink: 0;
        }
        .chart-bar-track {
            flex: 1;
            height: 28px;
            background: var(--warm-light);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .chart-bar-fill {
            height: 100%;
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 11px;
            font-weight: 700;
            color: white;
            transition: width 0.8s cubic-bezier(0.16,1,0.3,1);
            min-width: 32px;
        }

        /* ── CANCELLATION SURVEY RESULTS ── */
        .survey-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px var(--shadow);
            margin-bottom: 20px;
        }
        .survey-card h4 {
            font-family: 'DM Serif Display', serif;
            font-size: 18px;
            color: var(--forest);
            margin-bottom: 16px;
        }
        .survey-reason {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .survey-reason:last-child { border-bottom: none; }
        .survey-reason-bar {
            flex: 1;
            height: 24px;
            background: var(--warm-light);
            border-radius: 6px;
            overflow: hidden;
        }
        .survey-reason-fill {
            height: 100%;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }
        .survey-reason-label {
            font-size: 13px;
            color: var(--text);
            width: 200px;
            flex-shrink: 0;
        }
        .survey-reason-count {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            width: 50px;
            text-align: right;
            flex-shrink: 0;
        }

        /* ── MODAL ── */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: white;
            border-radius: 20px;
            max-width: 560px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 24px 80px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 24px 28px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .modal-header h3 {
            font-family: 'DM Serif Display', serif;
            font-size: 22px;
            color: var(--forest);
        }
        .modal-close {
            width: 32px; height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--warm-light);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            transition: all 0.2s;
        }
        .modal-close:hover { background: var(--coral-tint); color: var(--coral); }
        .modal-body { padding: 20px 28px 28px; }
        .modal-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        .modal-row:last-child { border-bottom: none; }
        .modal-row-label { color: var(--text-light); }
        .modal-row-value { font-weight: 600; color: var(--text); }
        .modal-section-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--coral);
            margin: 20px 0 10px;
        }

        /* ── GEO MAP PLACEHOLDER ── */
        .geo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        .geo-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .geo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--warm-light);
            border-radius: 10px;
        }
        .geo-item-name { font-weight: 600; font-size: 14px; }
        .geo-item-count { color: var(--text-light); font-size: 13px; }

        /* ── RESPONSIVE ── */
        @media (max-width: 768px) {
            .admin-header { padding: 12px 16px; }
            .admin-nav { padding: 0 16px; }
            .admin-container { padding: 20px 16px; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
            .chart-grid, .geo-grid { grid-template-columns: 1fr; }
            .search-input { width: 160px; }
            .data-card-header { flex-direction: column; align-items: flex-start; }
        }
        @media (max-width: 480px) {
            .kpi-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- ═══════════════════════════════════ -->
<!-- ADMIN LOGIN GATE                    -->
<!-- ═══════════════════════════════════ -->
<div class="auth-gate" id="authGate">
    <div class="auth-card">
        <h1>MyoMesh Admin</h1>
        <p class="subtitle">Platform management dashboard</p>
        <input type="email" id="adminEmail" placeholder="Admin email" autocomplete="email">
        <input type="password" id="adminPassword" placeholder="Password" autocomplete="current-password">
        <button class="btn-login" onclick="adminLogin()">Sign In</button>
        <p id="authError" style="color:var(--error);font-size:13px;margin-top:12px;display:none;"></p>
    </div>
</div>

<!-- ═══════════════════════════════════ -->
<!-- ADMIN DASHBOARD                     -->
<!-- ═══════════════════════════════════ -->
<div class="admin-app" id="adminApp">
    <!-- Header -->
    <div class="admin-header">
        <div class="admin-header-left">
            <span class="admin-logo">MyoMesh</span>
            <span class="admin-badge">Admin</span>
        </div>
        <div class="admin-header-right">
            <span id="adminEmailDisplay"></span>
            <button class="btn-logout" onclick="adminLogout()">Logout</button>
        </div>
    </div>

    <!-- Nav Tabs -->
    <div class="admin-nav">
        <button class="admin-tab active" onclick="switchAdminTab('overview')">Overview</button>
        <button class="admin-tab" onclick="switchAdminTab('studios')">Studios</button>
        <button class="admin-tab" onclick="switchAdminTab('payments')">Payments</button>
        <button class="admin-tab" onclick="switchAdminTab('geography')">Geography</button>
        <button class="admin-tab" onclick="switchAdminTab('churn')">Churn & Surveys</button>
    </div>

    <div class="admin-container">

        <!-- ══ OVERVIEW PANEL ══ -->
        <div class="admin-panel active" id="panel-overview">
            <div class="kpi-grid" id="overviewKPIs">
                <!-- Populated by JS -->
            </div>

            <div class="chart-grid">
                <div class="chart-card">
                    <h4>Sign-ups Over Time</h4>
                    <div id="signupChart" class="chart-bar-group">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="chart-card">
                    <h4>Subscription Status Breakdown</h4>
                    <div id="statusChart" class="chart-bar-group">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-card">
                    <h4>Revenue (Monthly)</h4>
                    <div id="revenueChart" class="chart-bar-group">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="chart-card">
                    <h4>Conversion Rate</h4>
                    <div id="conversionChart" style="text-align:center;padding:20px 0;">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ══ STUDIOS PANEL ══ -->
        <div class="admin-panel" id="panel-studios">
            <div class="data-card">
                <div class="data-card-header">
                    <h3>All Studios</h3>
                    <div class="data-card-actions">
                        <input class="search-input" type="text" placeholder="Search studios..." id="studioSearch" oninput="filterStudios()">
                        <select class="filter-select" id="studioStatusFilter" onchange="filterStudios()">
                            <option value="all">All Statuses</option>
                            <option value="trial">Trial</option>
                            <option value="active">Active</option>
                            <option value="past_due">Past Due</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <button class="btn-export" onclick="exportStudiosCSV()">⬇ Export CSV</button>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Studio</th>
                                <th>Owner</th>
                                <th>Status</th>
                                <th>Plan</th>
                                <th>Sign-up Date</th>
                                <th>Trial Ends</th>
                                <th>MRR</th>
                                <th>Staff</th>
                                <th>Sessions</th>
                                <th>Clients</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studiosTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div style="padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
                    <span id="studioCountLabel" style="font-size:13px;color:var(--text-light);"></span>
                    <div id="studioPagination" style="display:flex;gap:6px;">
                        <!-- Pagination buttons -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ══ PAYMENTS PANEL ══ -->
        <div class="admin-panel" id="panel-payments">
            <div class="kpi-grid" id="paymentKPIs">
                <!-- Populated by JS -->
            </div>
            <div class="data-card">
                <div class="data-card-header">
                    <h3>Payment History</h3>
                    <div class="data-card-actions">
                        <select class="filter-select" id="paymentStatusFilter" onchange="filterPayments()">
                            <option value="all">All</option>
                            <option value="succeeded">Succeeded</option>
                            <option value="failed">Failed</option>
                            <option value="refunded">Refunded</option>
                        </select>
                        <button class="btn-export" onclick="exportPaymentsCSV()">⬇ Export CSV</button>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Studio</th>
                                <th>Amount</th>
                                <th>Currency</th>
                                <th>Status</th>
                                <th>Stripe ID</th>
                                <th>Card</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ══ GEOGRAPHY PANEL ══ -->
        <div class="admin-panel" id="panel-geography">
            <div class="geo-grid">
                <div class="chart-card">
                    <h4>Studios by Country</h4>
                    <div id="geoCountryList" class="geo-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="chart-card">
                    <h4>Studios by Region / Province / State</h4>
                    <div id="geoRegionList" class="geo-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            <div class="chart-card">
                <h4>Studios by City</h4>
                <div id="geoCityList" class="geo-list" style="max-height:400px;overflow-y:auto;">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- ══ CHURN & SURVEYS PANEL ══ -->
        <div class="admin-panel" id="panel-churn">
            <div class="kpi-grid" id="churnKPIs">
                <!-- Populated by JS -->
            </div>

            <div class="chart-grid">
                <div class="survey-card">
                    <h4>Cancellation Reasons — Trial Cancellations</h4>
                    <div id="trialCancelReasons">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="survey-card">
                    <h4>Cancellation Reasons — Paying Subscribers</h4>
                    <div id="paidCancelReasons">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <div class="data-card">
                <div class="data-card-header">
                    <h3>All Cancellation Survey Responses</h3>
                    <div class="data-card-actions">
                        <select class="filter-select" id="churnTypeFilter" onchange="filterChurn()">
                            <option value="all">All Cancellations</option>
                            <option value="trial">Trial Only</option>
                            <option value="paid">Paid Only</option>
                        </select>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Studio</th>
                                <th>Type</th>
                                <th>Days Active</th>
                                <th>Primary Reason</th>
                                <th>Feedback</th>
                                <th>Would Return?</th>
                            </tr>
                        </thead>
                        <tbody id="churnTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ═══ STUDIO DETAIL MODAL ═══ -->
<div class="modal-overlay" id="studioDetailModal">
    <div class="modal-box">
        <div class="modal-header">
            <h3 id="modalStudioName">Studio Details</h3>
            <button class="modal-close" onclick="closeModal('studioDetailModal')">×</button>
        </div>
        <div class="modal-body" id="modalStudioBody">
            <!-- Populated by JS -->
        </div>
    </div>
</div>


<script>
// ========================================
// FIREBASE CONFIG — Replace with your config
// ========================================
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ========================================
// ADMIN AUTH — Whitelist of admin emails
// ========================================
const ADMIN_EMAILS = [
    // Add your admin email(s) here
    'admin@myomesh.com'
];

function adminLogin() {
    const email = document.getElementById('adminEmail').value.trim();
    const password = document.getElementById('adminPassword').value;
    const errorEl = document.getElementById('authError');
    errorEl.style.display = 'none';

    if (!email || !password) {
        errorEl.textContent = 'Please enter email and password.';
        errorEl.style.display = 'block';
        return;
    }

    auth.signInWithEmailAndPassword(email, password)
        .then(cred => {
            if (!ADMIN_EMAILS.includes(cred.user.email.toLowerCase())) {
                auth.signOut();
                errorEl.textContent = 'Access denied. This account is not an admin.';
                errorEl.style.display = 'block';
                return;
            }
            showAdminApp(cred.user);
        })
        .catch(err => {
            errorEl.textContent = err.message;
            errorEl.style.display = 'block';
        });
}

function adminLogout() {
    if (confirm('Log out of admin dashboard?')) {
        auth.signOut().then(() => {
            document.getElementById('adminApp').classList.remove('active');
            document.getElementById('authGate').style.display = 'flex';
        });
    }
}

auth.onAuthStateChanged(user => {
    if (user && ADMIN_EMAILS.includes(user.email.toLowerCase())) {
        showAdminApp(user);
    }
});

function showAdminApp(user) {
    document.getElementById('authGate').style.display = 'none';
    document.getElementById('adminApp').classList.add('active');
    document.getElementById('adminEmailDisplay').textContent = user.email;
    loadAllAdminData();
}

// ========================================
// TAB SWITCHING
// ========================================
function switchAdminTab(tab) {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
    document.querySelector(`[onclick="switchAdminTab('${tab}')"]`).classList.add('active');
    document.getElementById(`panel-${tab}`).classList.add('active');
}

// ========================================
// DATA LOADING
// ========================================
let allStudios = [];
let allPayments = [];
let allCancellations = [];

async function loadAllAdminData() {
    try {
        // Load subscriptions collection
        const subsSnap = await db.collection('subscriptions').get();
        allStudios = subsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Load payments collection
        const paySnap = await db.collection('payments').orderBy('date', 'desc').get();
        allPayments = paySnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Load cancellation surveys
        const cancelSnap = await db.collection('cancellation_surveys').orderBy('date', 'desc').get();
        allCancellations = cancelSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        renderOverview();
        renderStudiosTable();
        renderPayments();
        renderGeography();
        renderChurn();
    } catch (err) {
        console.error('Error loading admin data:', err);
        // If collections don't exist yet, use demo data
        loadDemoData();
    }
}

function loadDemoData() {
    // Demo data for development / preview
    const statuses = ['trial', 'active', 'active', 'active', 'active', 'cancelled', 'past_due'];
    const countries = ['Canada', 'Canada', 'USA', 'UK', 'Australia', 'Canada', 'USA'];
    const regions = ['Ontario', 'British Columbia', 'California', 'London', 'NSW', 'Alberta', 'New York'];
    const cities = ['Toronto', 'Vancouver', 'Los Angeles', 'London', 'Sydney', 'Calgary', 'New York'];
    const names = ['Flow Pilates Studio', 'West Coast Wellness', 'SoCal Movement', 'London Body Works', 'Sydney Stretch Co', 'Prairie Strength', 'Brooklyn Bodywork'];
    const owners = ['Sarah Mitchell', 'James Chen', 'Maria Lopez', 'Emily Watson', 'David Kim', 'Rachel Brown', 'Alex Johnson'];
    const currencies = ['cad', 'cad', 'usd', 'gbp', 'aud', 'cad', 'usd'];
    const cancelReasons = [
        'Too expensive for my practice size',
        'Missing features I need',
        'Switched to another platform',
        'Closing my studio',
        'Not enough time to set it up',
        'Interface was confusing',
        'Customer support response time',
        'Other'
    ];

    allStudios = names.map((name, i) => {
        const signupDate = new Date();
        signupDate.setDate(signupDate.getDate() - Math.floor(Math.random() * 90) - 5);
        const trialEnd = new Date(signupDate);
        trialEnd.setDate(trialEnd.getDate() + 14);
        return {
            id: 'studio_' + i,
            studioName: name,
            ownerName: owners[i],
            ownerEmail: owners[i].toLowerCase().replace(' ', '.') + '@email.com',
            status: statuses[i],
            currency: currencies[i],
            signupDate: signupDate.toISOString(),
            trialEndDate: trialEnd.toISOString(),
            country: countries[i],
            region: regions[i],
            city: cities[i],
            staffCount: Math.floor(Math.random() * 7) + 1,
            clientCount: Math.floor(Math.random() * 80) + 5,
            sessionCount: Math.floor(Math.random() * 300) + 10,
            stripeCustomerId: 'cus_' + Math.random().toString(36).substr(2, 14),
            stripeSubscriptionId: 'sub_' + Math.random().toString(36).substr(2, 14),
            cardLast4: String(Math.floor(Math.random() * 9000) + 1000),
            cardBrand: ['visa', 'mastercard', 'amex'][Math.floor(Math.random() * 3)],
            monthlyAmount: { cad: 55, usd: 39, gbp: 31, aud: 59 }[currencies[i]]
        };
    });

    // Add more demo studios for variety
    for (let i = 0; i < 18; i++) {
        const signupDate = new Date();
        signupDate.setDate(signupDate.getDate() - Math.floor(Math.random() * 120));
        const trialEnd = new Date(signupDate);
        trialEnd.setDate(trialEnd.getDate() + 14);
        const status = ['trial', 'active', 'active', 'active', 'cancelled'][Math.floor(Math.random() * 5)];
        const currency = ['cad', 'usd', 'gbp', 'aud'][Math.floor(Math.random() * 4)];
        allStudios.push({
            id: 'studio_x' + i,
            studioName: ['Peak Performance', 'Mindful Movement', 'Core Balance', 'Zen Studio', 'Flex & Flow', 'Body Harmony', 'Movement Lab', 'Vitality Clinic', 'Restore Studio', 'Align Wellness', 'The Pilates Room', 'Urban Stretch', 'Balance Point', 'Kinetic Health', 'Posture Pro', 'Motion Studio', 'InnerCore', 'FitBody Studio'][i],
            ownerName: 'Owner ' + (i + 8),
            ownerEmail: 'owner' + (i + 8) + '@email.com',
            status: status,
            currency: currency,
            signupDate: signupDate.toISOString(),
            trialEndDate: trialEnd.toISOString(),
            country: ['Canada', 'USA', 'UK', 'Australia'][Math.floor(Math.random() * 4)],
            region: ['Ontario', 'BC', 'California', 'London', 'NSW', 'Alberta', 'New York', 'Texas'][Math.floor(Math.random() * 8)],
            city: ['Toronto', 'Vancouver', 'LA', 'London', 'Sydney', 'Calgary', 'NYC', 'Austin'][Math.floor(Math.random() * 8)],
            staffCount: Math.floor(Math.random() * 7) + 1,
            clientCount: Math.floor(Math.random() * 60) + 2,
            sessionCount: Math.floor(Math.random() * 200) + 5,
            stripeCustomerId: 'cus_' + Math.random().toString(36).substr(2, 14),
            stripeSubscriptionId: 'sub_' + Math.random().toString(36).substr(2, 14),
            cardLast4: String(Math.floor(Math.random() * 9000) + 1000),
            cardBrand: ['visa', 'mastercard', 'amex'][Math.floor(Math.random() * 3)],
            monthlyAmount: { cad: 55, usd: 39, gbp: 31, aud: 59 }[currency]
        });
    }

    // Demo payments
    allPayments = allStudios.filter(s => s.status === 'active').map((s, i) => ({
        id: 'pay_' + i,
        studioId: s.id,
        studioName: s.studioName,
        date: new Date(Date.now() - Math.floor(Math.random() * 60) * 86400000).toISOString(),
        amount: s.monthlyAmount,
        currency: s.currency,
        status: Math.random() > 0.05 ? 'succeeded' : 'failed',
        stripePaymentId: 'pi_' + Math.random().toString(36).substr(2, 16),
        cardLast4: s.cardLast4,
        cardBrand: s.cardBrand
    }));

    // Demo cancellation surveys
    const cancelledStudios = allStudios.filter(s => s.status === 'cancelled');
    allCancellations = cancelledStudios.map((s, i) => {
        const wasTrial = Math.random() > 0.5;
        return {
            id: 'cancel_' + i,
            studioId: s.id,
            studioName: s.studioName,
            date: new Date(Date.now() - Math.floor(Math.random() * 30) * 86400000).toISOString(),
            cancelType: wasTrial ? 'trial' : 'paid',
            daysActive: wasTrial ? Math.floor(Math.random() * 14) + 1 : Math.floor(Math.random() * 90) + 15,
            primaryReason: cancelReasons[Math.floor(Math.random() * cancelReasons.length)],
            feedback: ['Great concept but not ready yet', 'Will come back when I have more clients', 'Need more integrations', 'Loved it but closing shop', ''][Math.floor(Math.random() * 5)],
            wouldReturn: Math.random() > 0.4 ? 'Yes' : 'No',
            rating: Math.floor(Math.random() * 5) + 1
        };
    });

    renderOverview();
    renderStudiosTable();
    renderPayments();
    renderGeography();
    renderChurn();
}

// ========================================
// OVERVIEW PANEL
// ========================================
function renderOverview() {
    const total = allStudios.length;
    const trials = allStudios.filter(s => s.status === 'trial').length;
    const active = allStudios.filter(s => s.status === 'active').length;
    const cancelled = allStudios.filter(s => s.status === 'cancelled').length;
    const pastDue = allStudios.filter(s => s.status === 'past_due').length;

    // MRR calculation
    const mrr = allStudios.filter(s => s.status === 'active').reduce((sum, s) => {
        // Normalize to USD for MRR display
        const rates = { cad: 0.73, usd: 1, gbp: 1.27, aud: 0.65 };
        return sum + (s.monthlyAmount || 0) * (rates[s.currency] || 1);
    }, 0);

    const conversionRate = total > 0 ? Math.round((active / total) * 100) : 0;

    document.getElementById('overviewKPIs').innerHTML = `
        <div class="kpi-card">
            <div class="kpi-label">Total Studios</div>
            <div class="kpi-value">${total}</div>
            <div class="kpi-detail">All time sign-ups</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Active Subscribers</div>
            <div class="kpi-value" style="color:var(--sage);">${active}</div>
            <div class="kpi-detail">${pastDue} past due</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">In Trial</div>
            <div class="kpi-value" style="color:#7C3AED;">${trials}</div>
            <div class="kpi-detail">14-day free trial</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">MRR (USD)</div>
            <div class="kpi-value">$${mrr.toLocaleString(undefined, { maximumFractionDigits: 0 })}</div>
            <div class="kpi-detail">Monthly recurring revenue</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Conversion Rate</div>
            <div class="kpi-value">${conversionRate}%</div>
            <div class="kpi-detail">Trial → Paid</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Churned</div>
            <div class="kpi-value" style="color:var(--error);">${cancelled}</div>
            <div class="kpi-detail">${total > 0 ? Math.round((cancelled / total) * 100) : 0}% churn rate</div>
        </div>
    `;

    // Sign-up chart (last 6 months)
    renderSignupChart();
    renderStatusChart(active, trials, cancelled, pastDue);
    renderRevenueChart();
    renderConversionChart(conversionRate);
}

function renderSignupChart() {
    const months = [];
    for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        months.push({ label: d.toLocaleString('default', { month: 'short' }), year: d.getFullYear(), month: d.getMonth() });
    }
    const counts = months.map(m => {
        return allStudios.filter(s => {
            const d = new Date(s.signupDate);
            return d.getMonth() === m.month && d.getFullYear() === m.year;
        }).length;
    });
    const max = Math.max(...counts, 1);
    document.getElementById('signupChart').innerHTML = months.map((m, i) => `
        <div class="chart-bar-row">
            <span class="chart-bar-label">${m.label}</span>
            <div class="chart-bar-track">
                <div class="chart-bar-fill" style="width:${(counts[i] / max) * 100}%;background:var(--sage);">${counts[i]}</div>
            </div>
        </div>
    `).join('');
}

function renderStatusChart(active, trials, cancelled, pastDue) {
    const total = active + trials + cancelled + pastDue || 1;
    const items = [
        { label: 'Active', count: active, color: 'var(--sage)' },
        { label: 'Trial', count: trials, color: '#7C3AED' },
        { label: 'Cancelled', count: cancelled, color: 'var(--error)' },
        { label: 'Past Due', count: pastDue, color: 'var(--amber)' },
    ];
    document.getElementById('statusChart').innerHTML = items.map(it => `
        <div class="chart-bar-row">
            <span class="chart-bar-label">${it.label}</span>
            <div class="chart-bar-track">
                <div class="chart-bar-fill" style="width:${(it.count / total) * 100}%;background:${it.color};">${it.count}</div>
            </div>
        </div>
    `).join('');
}

function renderRevenueChart() {
    const months = [];
    for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        months.push({ label: d.toLocaleString('default', { month: 'short' }), year: d.getFullYear(), month: d.getMonth() });
    }
    const revenues = months.map(m => {
        return allPayments.filter(p => {
            const d = new Date(p.date);
            return d.getMonth() === m.month && d.getFullYear() === m.year && p.status === 'succeeded';
        }).reduce((sum, p) => sum + (p.amount || 0), 0);
    });
    const max = Math.max(...revenues, 1);
    document.getElementById('revenueChart').innerHTML = months.map((m, i) => `
        <div class="chart-bar-row">
            <span class="chart-bar-label">${m.label}</span>
            <div class="chart-bar-track">
                <div class="chart-bar-fill" style="width:${(revenues[i] / max) * 100}%;background:var(--coral);">$${revenues[i]}</div>
            </div>
        </div>
    `).join('');
}

function renderConversionChart(rate) {
    document.getElementById('conversionChart').innerHTML = `
        <div style="position:relative;width:160px;height:160px;margin:0 auto;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);">
                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--border)" stroke-width="3"/>
                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--sage)" stroke-width="3" stroke-dasharray="${rate}, 100" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
                <span style="font-family:'DM Serif Display',serif;font-size:32px;color:var(--forest);">${rate}%</span>
                <span style="font-size:12px;color:var(--text-light);">Trial → Paid</span>
            </div>
        </div>
    `;
}

// ========================================
// STUDIOS TABLE
// ========================================
function renderStudiosTable(filtered) {
    const studios = filtered || allStudios;
    const tbody = document.getElementById('studiosTableBody');
    const avatarColors = ['#3D8B7A', '#FF6B4A', '#7C3AED', '#DAA520', '#2CA01C', '#DC4F41', '#3B82F6'];

    tbody.innerHTML = studios.map((s, i) => {
        const signupDate = new Date(s.signupDate).toLocaleDateString();
        const trialEnd = new Date(s.trialEndDate).toLocaleDateString();
        const statusClass = s.status === 'trial' ? 'status-trial' : s.status === 'active' ? 'status-active' : s.status === 'past_due' ? 'status-past-due' : 'status-cancelled';
        const statusLabel = s.status === 'past_due' ? 'Past Due' : s.status.charAt(0).toUpperCase() + s.status.slice(1);
        const currSymbol = { cad: 'C$', usd: '$', gbp: '£', aud: 'A$' }[s.currency] || '$';

        return `<tr>
            <td>
                <div class="studio-name-cell">
                    <div class="studio-avatar" style="background:${avatarColors[i % avatarColors.length]};">${s.studioName.charAt(0)}</div>
                    <div class="studio-name-text">
                        <strong>${s.studioName}</strong>
                        <span>${s.ownerEmail}</span>
                    </div>
                </div>
            </td>
            <td>${s.ownerName}</td>
            <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
            <td>${s.currency.toUpperCase()}</td>
            <td>${signupDate}</td>
            <td>${trialEnd}</td>
            <td>${s.status === 'active' || s.status === 'past_due' ? currSymbol + s.monthlyAmount : '—'}</td>
            <td>${s.staffCount || 0}</td>
            <td>${s.sessionCount || 0}</td>
            <td>${s.clientCount || 0}</td>
            <td><button class="action-btn" onclick="viewStudioDetail('${s.id}')">View</button></td>
        </tr>`;
    }).join('');

    document.getElementById('studioCountLabel').textContent = `Showing ${studios.length} of ${allStudios.length} studios`;
}

function filterStudios() {
    const search = document.getElementById('studioSearch').value.toLowerCase();
    const status = document.getElementById('studioStatusFilter').value;
    let filtered = allStudios;
    if (search) {
        filtered = filtered.filter(s =>
            s.studioName.toLowerCase().includes(search) ||
            s.ownerName.toLowerCase().includes(search) ||
            s.ownerEmail.toLowerCase().includes(search) ||
            (s.city || '').toLowerCase().includes(search)
        );
    }
    if (status !== 'all') {
        filtered = filtered.filter(s => s.status === status);
    }
    renderStudiosTable(filtered);
}

function viewStudioDetail(studioId) {
    const s = allStudios.find(st => st.id === studioId);
    if (!s) return;
    document.getElementById('modalStudioName').textContent = s.studioName;
    const currSymbol = { cad: 'C$', usd: '$', gbp: '£', aud: 'A$' }[s.currency] || '$';
    const statusClass = s.status === 'trial' ? 'status-trial' : s.status === 'active' ? 'status-active' : s.status === 'past_due' ? 'status-past-due' : 'status-cancelled';
    const statusLabel = s.status === 'past_due' ? 'Past Due' : s.status.charAt(0).toUpperCase() + s.status.slice(1);

    document.getElementById('modalStudioBody').innerHTML = `
        <p class="modal-section-title">Account</p>
        <div class="modal-row"><span class="modal-row-label">Owner</span><span class="modal-row-value">${s.ownerName}</span></div>
        <div class="modal-row"><span class="modal-row-label">Email</span><span class="modal-row-value">${s.ownerEmail}</span></div>
        <div class="modal-row"><span class="modal-row-label">Status</span><span class="modal-row-value"><span class="status-badge ${statusClass}">${statusLabel}</span></span></div>
        <div class="modal-row"><span class="modal-row-label">Sign-up Date</span><span class="modal-row-value">${new Date(s.signupDate).toLocaleDateString()}</span></div>
        <div class="modal-row"><span class="modal-row-label">Trial End</span><span class="modal-row-value">${new Date(s.trialEndDate).toLocaleDateString()}</span></div>

        <p class="modal-section-title">Billing</p>
        <div class="modal-row"><span class="modal-row-label">Plan</span><span class="modal-row-value">${currSymbol}${s.monthlyAmount} / month (${s.currency.toUpperCase()})</span></div>
        <div class="modal-row"><span class="modal-row-label">Card</span><span class="modal-row-value">${(s.cardBrand || 'card').toUpperCase()} •••• ${s.cardLast4 || '—'}</span></div>
        <div class="modal-row"><span class="modal-row-label">Stripe Customer</span><span class="modal-row-value" style="font-size:12px;font-family:monospace;">${s.stripeCustomerId || '—'}</span></div>
        <div class="modal-row"><span class="modal-row-label">Stripe Subscription</span><span class="modal-row-value" style="font-size:12px;font-family:monospace;">${s.stripeSubscriptionId || '—'}</span></div>

        <p class="modal-section-title">Location</p>
        <div class="modal-row"><span class="modal-row-label">Country</span><span class="modal-row-value">${s.country || '—'}</span></div>
        <div class="modal-row"><span class="modal-row-label">Region</span><span class="modal-row-value">${s.region || '—'}</span></div>
        <div class="modal-row"><span class="modal-row-label">City</span><span class="modal-row-value">${s.city || '—'}</span></div>

        <p class="modal-section-title">Usage</p>
        <div class="modal-row"><span class="modal-row-label">Staff Members</span><span class="modal-row-value">${s.staffCount || 0}</span></div>
        <div class="modal-row"><span class="modal-row-label">Total Clients</span><span class="modal-row-value">${s.clientCount || 0}</span></div>
        <div class="modal-row"><span class="modal-row-label">Total Sessions</span><span class="modal-row-value">${s.sessionCount || 0}</span></div>
    `;
    document.getElementById('studioDetailModal').classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

// ========================================
// PAYMENTS
// ========================================
function renderPayments(filtered) {
    const payments = filtered || allPayments;
    const succeeded = payments.filter(p => p.status === 'succeeded');
    const failed = payments.filter(p => p.status === 'failed');
    const totalCollected = succeeded.reduce((s, p) => s + (p.amount || 0), 0);

    document.getElementById('paymentKPIs').innerHTML = `
        <div class="kpi-card">
            <div class="kpi-label">Total Collected</div>
            <div class="kpi-value">$${totalCollected.toLocaleString()}</div>
            <div class="kpi-detail">${succeeded.length} successful payments</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Failed Payments</div>
            <div class="kpi-value" style="color:var(--error);">${failed.length}</div>
            <div class="kpi-detail">${payments.length > 0 ? Math.round((failed.length / payments.length) * 100) : 0}% failure rate</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Avg. Payment</div>
            <div class="kpi-value">$${succeeded.length > 0 ? Math.round(totalCollected / succeeded.length) : 0}</div>
            <div class="kpi-detail">Per transaction</div>
        </div>
    `;

    const tbody = document.getElementById('paymentsTableBody');
    tbody.innerHTML = payments.map(p => {
        const statusClass = p.status === 'succeeded' ? 'status-active' : p.status === 'failed' ? 'status-cancelled' : 'status-past-due';
        const currSymbol = { cad: 'C$', usd: '$', gbp: '£', aud: 'A$' }[p.currency] || '$';
        return `<tr>
            <td>${new Date(p.date).toLocaleDateString()}</td>
            <td>${p.studioName}</td>
            <td>${currSymbol}${p.amount}</td>
            <td>${(p.currency || 'usd').toUpperCase()}</td>
            <td><span class="status-badge ${statusClass}">${p.status.charAt(0).toUpperCase() + p.status.slice(1)}</span></td>
            <td style="font-family:monospace;font-size:11px;">${p.stripePaymentId || '—'}</td>
            <td>${(p.cardBrand || '').toUpperCase()} •••• ${p.cardLast4 || ''}</td>
        </tr>`;
    }).join('');
}

function filterPayments() {
    const status = document.getElementById('paymentStatusFilter').value;
    let filtered = allPayments;
    if (status !== 'all') filtered = filtered.filter(p => p.status === status);
    renderPayments(filtered);
}

// ========================================
// GEOGRAPHY
// ========================================
function renderGeography() {
    // Countries
    const countryCounts = {};
    allStudios.forEach(s => {
        const c = s.country || 'Unknown';
        countryCounts[c] = (countryCounts[c] || 0) + 1;
    });
    const sortedCountries = Object.entries(countryCounts).sort((a, b) => b[1] - a[1]);
    document.getElementById('geoCountryList').innerHTML = sortedCountries.map(([name, count]) => `
        <div class="geo-item">
            <span class="geo-item-name">${name}</span>
            <span class="geo-item-count">${count} studio${count !== 1 ? 's' : ''}</span>
        </div>
    `).join('');

    // Regions
    const regionCounts = {};
    allStudios.forEach(s => {
        const r = s.region || 'Unknown';
        regionCounts[r] = (regionCounts[r] || 0) + 1;
    });
    const sortedRegions = Object.entries(regionCounts).sort((a, b) => b[1] - a[1]);
    document.getElementById('geoRegionList').innerHTML = sortedRegions.map(([name, count]) => `
        <div class="geo-item">
            <span class="geo-item-name">${name}</span>
            <span class="geo-item-count">${count} studio${count !== 1 ? 's' : ''}</span>
        </div>
    `).join('');

    // Cities
    const cityCounts = {};
    allStudios.forEach(s => {
        const c = s.city || 'Unknown';
        cityCounts[c] = (cityCounts[c] || 0) + 1;
    });
    const sortedCities = Object.entries(cityCounts).sort((a, b) => b[1] - a[1]);
    document.getElementById('geoCityList').innerHTML = sortedCities.map(([name, count]) => `
        <div class="geo-item">
            <span class="geo-item-name">${name}</span>
            <span class="geo-item-count">${count} studio${count !== 1 ? 's' : ''}</span>
        </div>
    `).join('');
}

// ========================================
// CHURN & SURVEYS
// ========================================
function renderChurn(filtered) {
    const cancellations = filtered || allCancellations;
    const trialCancels = cancellations.filter(c => c.cancelType === 'trial');
    const paidCancels = cancellations.filter(c => c.cancelType === 'paid');
    const avgDaysActive = cancellations.length > 0 ? Math.round(cancellations.reduce((s, c) => s + (c.daysActive || 0), 0) / cancellations.length) : 0;
    const wouldReturn = cancellations.filter(c => c.wouldReturn === 'Yes').length;

    document.getElementById('churnKPIs').innerHTML = `
        <div class="kpi-card">
            <div class="kpi-label">Total Cancellations</div>
            <div class="kpi-value" style="color:var(--error);">${cancellations.length}</div>
            <div class="kpi-detail">${trialCancels.length} trial · ${paidCancels.length} paid</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Trial Churn</div>
            <div class="kpi-value">${trialCancels.length}</div>
            <div class="kpi-detail">Cancelled before day 15</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Paid Churn</div>
            <div class="kpi-value">${paidCancels.length}</div>
            <div class="kpi-detail">Cancelled after paying</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Avg. Days Active</div>
            <div class="kpi-value">${avgDaysActive}</div>
            <div class="kpi-detail">Before cancellation</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Would Return</div>
            <div class="kpi-value" style="color:var(--sage);">${cancellations.length > 0 ? Math.round((wouldReturn / cancellations.length) * 100) : 0}%</div>
            <div class="kpi-detail">${wouldReturn} of ${cancellations.length}</div>
        </div>
    `;

    // Render reason breakdowns
    renderReasonChart('trialCancelReasons', trialCancels);
    renderReasonChart('paidCancelReasons', paidCancels);

    // Table
    const tbody = document.getElementById('churnTableBody');
    tbody.innerHTML = cancellations.map(c => {
        const typeClass = c.cancelType === 'trial' ? 'status-trial' : 'status-cancelled';
        return `<tr>
            <td>${new Date(c.date).toLocaleDateString()}</td>
            <td>${c.studioName}</td>
            <td><span class="status-badge ${typeClass}">${c.cancelType === 'trial' ? 'Trial' : 'Paid'}</span></td>
            <td>${c.daysActive} days</td>
            <td>${c.primaryReason}</td>
            <td style="max-width:200px;white-space:normal;font-size:12px;color:var(--text-light);">${c.feedback || '—'}</td>
            <td>${c.wouldReturn === 'Yes' ? '<span style="color:var(--sage);font-weight:600;">Yes</span>' : '<span style="color:var(--error);font-weight:600;">No</span>'}</td>
        </tr>`;
    }).join('');
}

function renderReasonChart(containerId, cancellations) {
    const reasonCounts = {};
    cancellations.forEach(c => {
        const r = c.primaryReason || 'Other';
        reasonCounts[r] = (reasonCounts[r] || 0) + 1;
    });
    const sorted = Object.entries(reasonCounts).sort((a, b) => b[1] - a[1]);
    const max = sorted.length > 0 ? sorted[0][1] : 1;
    const colors = ['var(--coral)', 'var(--amber)', 'var(--sage)', '#7C3AED', '#3B82F6', 'var(--forest)', '#EC4899', '#6B7280'];

    document.getElementById(containerId).innerHTML = sorted.length > 0 ? sorted.map(([reason, count], i) => `
        <div class="survey-reason">
            <span class="survey-reason-label">${reason}</span>
            <div class="survey-reason-bar">
                <div class="survey-reason-fill" style="width:${(count / max) * 100}%;background:${colors[i % colors.length]};">${count}</div>
            </div>
            <span class="survey-reason-count">${cancellations.length > 0 ? Math.round((count / cancellations.length) * 100) : 0}%</span>
        </div>
    `).join('') : '<div style="padding:20px;text-align:center;color:var(--text-light);font-size:13px;">No cancellation data yet</div>';
}

function filterChurn() {
    const type = document.getElementById('churnTypeFilter').value;
    let filtered = allCancellations;
    if (type === 'trial') filtered = filtered.filter(c => c.cancelType === 'trial');
    if (type === 'paid') filtered = filtered.filter(c => c.cancelType === 'paid');
    renderChurn(filtered);
}

// ========================================
// CSV EXPORTS
// ========================================
function exportStudiosCSV() {
    const headers = ['Studio Name', 'Owner', 'Email', 'Status', 'Currency', 'Monthly', 'Sign-up', 'Trial End', 'Country', 'Region', 'City', 'Staff', 'Clients', 'Sessions'];
    const rows = allStudios.map(s => [
        s.studioName, s.ownerName, s.ownerEmail, s.status, s.currency,
        s.monthlyAmount, new Date(s.signupDate).toLocaleDateString(),
        new Date(s.trialEndDate).toLocaleDateString(),
        s.country, s.region, s.city, s.staffCount, s.clientCount, s.sessionCount
    ]);
    downloadCSV('myomesh-studios.csv', headers, rows);
}

function exportPaymentsCSV() {
    const headers = ['Date', 'Studio', 'Amount', 'Currency', 'Status', 'Stripe ID', 'Card'];
    const rows = allPayments.map(p => [
        new Date(p.date).toLocaleDateString(), p.studioName, p.amount,
        p.currency, p.status, p.stripePaymentId, `${p.cardBrand} ${p.cardLast4}`
    ]);
    downloadCSV('myomesh-payments.csv', headers, rows);
}

function downloadCSV(filename, headers, rows) {
    const csvContent = [headers.join(','), ...rows.map(r => r.map(v => `"${v}"`).join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', e => {
        if (e.target === m) m.classList.remove('active');
    });
});

</script>
</body>
</html>
