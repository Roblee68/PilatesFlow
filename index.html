<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyoMesh - Practice Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js for Income Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            /* MyoMesh Warm Brand Colors */
            --forest: #1E3A34;
            --sage: #3D8B7A;
            --coral: #FF6B4A;
            --coral-light: #FF8F75;
            --amber: #FFB347;
            --peach: #FFAD85;
            
            /* Warm Surfaces */
            --cream: #FFFBF7;
            --warm-light: #FFF5ED;
            --coral-tint: #FFEBE3;
            --sage-tint: #E8F3F0;
            
            /* Legacy variable mappings */
            --primary: #1E3A34;
            --primary-light: #3D8B7A;
            --accent: #FF6B4A;
            --accent-light: #FF8F75;
            --bg: #FFFBF7;
            --card: #FFFFFF;
            --text: #2D2926;
            --text-light: #6B635B;
            --border: #E8DDD4;
            --success: #3D8B7A;
            --warning: #FFB347;
            --error: #DC4F41;
            --shadow: rgba(45, 41, 38, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--cream);
            color: var(--text);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            right: -20%;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(255, 107, 74, 0.06) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: -30%;
            left: -10%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(255, 179, 71, 0.05) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
        }

        .page-header {
            background: linear-gradient(135deg, var(--forest) 0%, var(--sage) 50%, var(--coral) 100%);
            padding: 24px 40px;
            position: relative;
            overflow: hidden;
            margin-bottom: 0;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: rgba(255, 107, 74, 0.15);
            border-radius: 50%;
            pointer-events: none;
        }

        .page-header::after {
            content: '';
            position: absolute;
            bottom: -60%;
            left: 5%;
            width: 250px;
            height: 250px;
            background: rgba(255, 173, 133, 0.12);
            border-radius: 50%;
            pointer-events: none;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px 20px;
            position: relative;
            z-index: 1;
        }

        header {
            background: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 0;
            border: none;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: transparent;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 24px;
            box-shadow: none;
            overflow: visible;
            flex-shrink: 0;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .logo-icon span {
            display: block;
        }

        h1 {
            font-family: 'Inter', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.02em;
        }

        .tagline {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 400;
        }

        .nav-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 30px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 12px var(--shadow);
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 14px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab svg {
            width: 18px;
            height: 18px;
            stroke-width: 2;
            flex-shrink: 0;
        }

        .tab.active {
            background: var(--coral);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 74, 0.25);
        }

        .tab:hover:not(.active) {
            background: var(--coral-tint);
            color: var(--coral);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .card {         
/* Settings specific styles */
.settings-section {
    margin-bottom: 40px;
}

.settings-section h3 {
    font-family: 'Inter', sans-serif;
    font-size: 20px;
    font-weight: 600;
    color: var(--coral);
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border);
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 8px;
    letter-spacing: 0.5px;
}

.form-group input[type="text"],
.form-group input[type="number"] {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: 10px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    transition: all 0.3s ease;
}

.form-group input:focus {
    outline: none;
    border-color: var(--coral);
    box-shadow: 0 0 0 3px rgba(255, 107, 74, 0.1);
}

.teacher-list {
    display: grid;
    gap: 12px;
}

.teacher-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: var(--bg);
    border-radius: 10px;
    border: 2px solid var(--border);
    transition: all 0.3s ease;
}

.teacher-item.inactive {
    opacity: 0.5;
    background: #f5f5f5;
}

.teacher-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.teacher-name {
    font-weight: 600;
    color: var(--primary);
}

.teacher-status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.status-active {
    background: #E8F5E9;
    color: #1E3A34;
}

.status-inactive {
    background: #FFE5E5;
    color: #C86B5D;
}

.teacher-actions {
    display: flex;
    gap: 8px;
}

.class-pricing-list {
    display: grid;
    gap: 15px;
}

.class-pricing-item {
    display: grid;
    grid-template-columns: 1fr 150px auto;
    gap: 15px;
    align-items: end;
    padding: 16px;
    background: var(--bg);
    border-radius: 10px;
    border: 2px solid var(--border);
}

.price-input-group {
    position: relative;
}

.price-input-group label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-light);
    margin-bottom: 6px;
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.price-input-group input {
    width: 100%;
    padding: 10px 10px 10px 25px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
}

.price-input-group::before {
    content: '$';
    position: absolute;
    left: 10px;
    bottom: 11px;
    font-weight: 600;
    color: var(--text-light);
}

.owner-management-list {
    display: grid;
    gap: 12px;
}

.owner-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: linear-gradient(135deg, #E8F5E9 0%, #F1F8F4 100%);
    border-radius: 10px;
    border: 2px solid #5F8575;
}

.owner-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.owner-badge {
    padding: 4px 12px;
    background: #1E3A34;
    color: white;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.btn-primary {
    padding: 12px 24px;
    background: var(--coral);
    color: white;
    border: none;
    border-radius: 10px;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    background: var(--coral-light);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 107, 74, 0.3);
}

.btn-secondary {
    padding: 10px 20px;
    background: var(--warm-light);
    color: var(--forest);
    border: 2px solid var(--forest);
    border-radius: 10px;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: var(--forest);
    color: white;
}

.btn-danger {
    padding: 10px 20px;
    background: var(--coral-tint);
    color: var(--error);
    border: 2px solid var(--error);
    border-radius: 10px;
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-danger:hover {
    background: var(--error);
    color: white;
}

.btn-small {
    padding: 6px 12px;
    font-size: 11px;
}

.add-new-section {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.add-new-section input {
    flex: 1;
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
}

.permission-notice {
    background: #FFF9E6;
    border-left: 4px solid var(--warning);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 13px;
    color: var(--text);
}
            
            background: var(--card);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 2px 20px var(--shadow);
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .income-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .income-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 16px var(--shadow);
        }

        .income-card.secondary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
        }

        .income-card.quickbooks {
            background: linear-gradient(135deg, #2CA01C 0%, #46B536 100%);
        }

        .income-label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .income-amount {
            font-family: 'Inter', sans-serif;
            font-size: 36px;
            font-weight: 600;
            letter-spacing: -1px;
        }

        .income-subtitle {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }

        /* Income Tab Enhanced Styles */
        .income-view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .income-view-btn {
            padding: 10px 20px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: white;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .income-view-btn.active {
            background: var(--coral);
            border-color: var(--coral);
            color: white;
        }
        
        .income-view-btn:hover:not(.active) {
            border-color: var(--coral);
            color: var(--coral);
        }
        
        .income-charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .income-chart-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 12px var(--shadow);
            border: 1px solid var(--border);
        }
        
        .income-chart-card h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--forest);
            margin-bottom: 16px;
        }
        
        .income-chart-container {
            height: 280px;
            position: relative;
        }
        
        .income-stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .income-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px var(--shadow);
            border: 1px solid var(--border);
        }
        
        .income-stat-card.highlight {
            background: linear-gradient(135deg, var(--coral) 0%, var(--coral-light) 100%);
            color: white;
            border: none;
        }
        
        .income-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--forest);
        }
        
        .income-stat-card.highlight .income-stat-value {
            color: white;
        }
        
        .income-stat-label {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .income-stat-card.highlight .income-stat-label {
            color: rgba(255,255,255,0.9);
        }
        
        .income-stat-change {
            font-size: 13px;
            margin-top: 8px;
            font-weight: 600;
        }
        
        .income-stat-change.positive {
            color: var(--sage);
        }
        
        .income-stat-change.negative {
            color: var(--error);
        }
        
        .income-history-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .income-history-table th,
        .income-history-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .income-history-table th {
            background: var(--warm-light);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-light);
        }
        
        .income-history-table td {
            font-size: 14px;
        }
        
        .income-history-table tr:hover {
            background: var(--cream);
        }
        
        /* Email Settings Styles */
        .email-settings-card {
            background: var(--warm-light);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .email-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .email-toggle-row:last-child {
            border-bottom: none;
        }
        
        .email-toggle-label {
            font-size: 14px;
            color: var(--text);
        }
        
        .email-toggle-desc {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 2px;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: 0.3s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--coral);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* Import/Export Styles */
        .import-export-section {
            background: var(--warm-light);
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
        }
        
        .import-dropzone {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .import-dropzone:hover {
            border-color: var(--coral);
            background: var(--coral-tint);
        }
        
        .import-dropzone.dragover {
            border-color: var(--coral);
            background: var(--coral-tint);
        }
        
        .import-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .import-preview {
            margin-top: 20px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: none;
        }
        
        .import-preview.visible {
            display: block;
        }
        
        .currency-selector {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .currency-option {
            padding: 12px 20px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .currency-option:hover {
            border-color: var(--coral);
        }
        
        .currency-option.selected {
            border-color: var(--coral);
            background: var(--coral-tint);
        }
        
        .currency-code {
            font-weight: 700;
            font-size: 16px;
            color: var(--forest);
        }
        
        .currency-name {
            font-size: 12px;
            color: var(--text-light);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
        }

        .form-card h2 {
            font-family: 'Inter', sans-serif;
            font-size: 28px;
            font-weight: 400;
            color: var(--primary);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 18px;
        }

        .form-row-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .price-input-wrapper {
            display: flex;
            flex-direction: column;
        }

        .price-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 6px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            color: var(--text);
            background: var(--bg);
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(255, 107, 74, 0.06);
        }

        select {
            cursor: pointer;
        }

        textarea {
            resize: vertical;
            min-height: 70px;
            font-size: 13px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.05) 0%, rgba(212, 165, 116, 0.02) 100%);
            border-radius: 8px;
            border: 1.5px solid var(--accent-light);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 18px;
        }

        .checkbox-group:hover {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.08) 0%, rgba(212, 165, 116, 0.04) 100%);
            border-color: var(--accent);
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .checkbox-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--primary);
            cursor: pointer;
            letter-spacing: 0.3px;
            text-transform: none;
            margin: 0;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        button {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 74, 0.2);
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 74, 0.3);
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1.5px solid var(--border);
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--primary);
        }

        .btn-google {
            background: white;
            color: var(--primary);
            border: 1.5px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-google:hover {
            background: var(--primary);
            color: white;
        }

        .btn-quickbooks {
            background: white;
            color: #2CA01C;
            border: 1.5px solid #2CA01C;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-quickbooks:hover {
            background: #2CA01C;
            color: white;
        }

        .btn-outlook {
            background: white;
            color: #0078D4;
            border: 1.5px solid #0078D4;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-outlook:hover {
            background: #0078D4;
            color: white;
        }

        .btn-invoice {
            background: linear-gradient(135deg, #2CA01C 0%, #46B536 100%);
            color: white;
            padding: 10px 18px;
            font-size: 11px;
        }

        .btn-invoice:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 160, 28, 0.3);
        }

        .client-selector {
            margin-bottom: 18px;
        }

        .client-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .client-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .client-chip:hover {
            background: var(--primary-light);
            transform: scale(1.05);
        }

        .client-chip .remove {
            width: 16px;
            height: 16px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .sessions-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .session-item {
            padding: 20px;
            background: var(--bg);
            border-radius: 12px;
            border: 1.5px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .session-item:hover {
            background: white;
            border-color: var(--primary);
            transform: translateX(4px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .session-type {
            font-weight: 600;
            font-size: 16px;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .session-datetime {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .session-clients {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .session-client-badge {
            padding: 4px 10px;
            background: linear-gradient(135deg, rgba(255, 107, 74, 0.1) 0%, rgba(255, 107, 74, 0.05) 100%);
            color: var(--primary);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .session-price {
            font-family: 'Inter', sans-serif;
            font-size: 24px;
            font-weight: 600;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .session-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 14px;
            font-size: 11px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-top: 8px;
            margin-right: 6px;
        }

        .status-repeating {
            background: rgba(95, 133, 117, 0.15);
            color: var(--success);
        }

        .status-vacation {
            background: rgba(212, 165, 116, 0.15);
            color: var(--warning);
        }

        .status-invoiced {
            background: rgba(44, 160, 28, 0.15);
            color: #2CA01C;
        }

        .status-paid {
            background: rgba(44, 160, 28, 0.25);
            color: #2CA01C;
            font-weight: 700;
        }

        .status-unpaid {
            background: rgba(200, 107, 93, 0.15);
            color: var(--error);
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 16px;
        }

        .integration-setup {
            background: linear-gradient(135deg, rgba(44, 160, 28, 0.05) 0%, rgba(44, 160, 28, 0.02) 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1.5px solid rgba(44, 160, 28, 0.2);
            margin-bottom: 25px;
        }

        .integration-setup.google {
            background: linear-gradient(135deg, rgba(66, 133, 244, 0.05) 0%, rgba(66, 133, 244, 0.02) 100%);
            border: 1.5px solid rgba(66, 133, 244, 0.2);
        }

        .integration-setup.outlook {
            background: linear-gradient(135deg, rgba(0, 120, 212, 0.03) 0%, rgba(0, 120, 212, 0.01) 100%);
            border: 1.5px solid rgba(0, 120, 212, 0.2);
        }

        .integration-setup h3 {
            font-family: 'Inter', sans-serif;
            font-size: 18px;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .integration-setup p {
            font-size: 13px;
            color: var(--text-light);
            line-height: 1.6;
            margin-bottom: 14px;
        }

        .integration-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: white;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--success);
        }

        .setup-steps {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 16px;
            border: 1.5px solid var(--border);
        }

        .setup-steps ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .setup-steps li {
            font-size: 13px;
            color: var(--text);
            margin-bottom: 8px;
        }

        .setup-steps code {
            background: var(--bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: var(--primary);
        }

        .setup-steps a {
            color: #2CA01C;
            text-decoration: none;
            font-weight: 600;
        }

        .setup-steps a:hover {
            text-decoration: underline;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-text {
            font-family: 'Inter', sans-serif;
            font-size: 20px;
            color: var(--text-light);
        }

        .multi-select {
            border: 1.5px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            background: var(--bg);
            max-height: 200px;
            overflow-y: auto;
        }

        .multi-select-option {
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .multi-select-option:hover {
            background: white;
        }

        .multi-select-option.selected {
            background: linear-gradient(135deg, rgba(255, 107, 74, 0.1) 0%, rgba(255, 107, 74, 0.05) 100%);
        }

        .multi-select-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .teacher-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .teacher-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg);
            border-radius: 10px;
            border: 1.5px solid var(--border);
        }

        .teacher-item.default-teacher {
            background: linear-gradient(135deg, rgba(255, 107, 74, 0.06) 0%, rgba(255, 107, 74, 0.02) 100%);
            border-color: var(--primary);
        }

        .teacher-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 15px;
        }

        .teacher-actions {
            display: flex;
            gap: 8px;
        }

        .default-badge {
            padding: 4px 10px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .warning-message {
            background: rgba(212, 165, 116, 0.1);
            border: 1.5px solid var(--accent-light);
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text);
            margin-bottom: 18px;
        }

        .rate-display {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .rate-pill {
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(255, 107, 74, 0.08) 0%, rgba(255, 107, 74, 0.04) 100%);
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            color: var(--primary);
        }

        .invoice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .invoice-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-family: 'Inter', sans-serif;
            font-size: 28px;
            color: var(--primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-light);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .modal-close:hover {
            color: var(--text);
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        .btn-primary {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 74, 0.3);
        }

        .btn-secondary {
            padding: 12px 24px;
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--primary);
        }

        .btn-danger {
            padding: 8px 16px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        /* ========================================
           VISUAL CALENDAR STYLES
           ======================================== */
        
        .calendar-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 24px var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 30px;
            background: linear-gradient(135deg, var(--bg) 0%, #fff 100%);
            border-bottom: 1px solid var(--border);
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .calendar-nav-btn {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text);
            transition: all 0.2s ease;
        }

        .calendar-nav-btn:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .calendar-title {
            font-family: 'Inter', sans-serif;
            font-size: 32px;
            font-weight: 400;
            color: var(--primary);
            letter-spacing: -0.5px;
        }

        .calendar-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .calendar-view-toggle {
            display: flex;
            background: var(--bg);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .view-toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-toggle-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .today-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .today-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 165, 116, 0.3);
        }

        .calendar-body {
            display: flex;
            min-height: 700px;
        }

        .teacher-sidebar {
            width: 220px;
            background: var(--bg);
            border-right: 1px solid var(--border);
            padding: 20px 0;
            flex-shrink: 0;
        }

        .teacher-sidebar-header {
            padding: 0 20px 16px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 12px;
        }

        .teacher-sidebar-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-light);
        }

        .teacher-filter-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .teacher-filter-item:hover {
            background: white;
        }

        .teacher-filter-item.selected {
            background: white;
            border-left-color: var(--primary);
        }

        .teacher-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
        }

        .teacher-filter-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
        }

        .teacher-filter-sessions {
            font-size: 11px;
            color: var(--text-light);
        }

        .calendar-grid-wrapper {
            flex: 1;
            overflow-x: auto;
        }

        .calendar-grid {
            display: grid;
            min-width: 100%;
        }

        .calendar-grid.week-view {
            grid-template-columns: 70px repeat(7, 1fr);
        }

        .calendar-grid.day-view {
            grid-template-columns: 70px 1fr;
        }

        .calendar-day-header {
            text-align: center;
            padding: 16px 8px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
        }

        .calendar-day-header.today {
            background: linear-gradient(135deg, rgba(255, 107, 74, 0.08) 0%, rgba(255, 107, 74, 0.04) 100%);
        }

        .day-name {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .day-number {
            font-family: 'Inter', sans-serif;
            font-size: 24px;
            font-weight: 600;
            color: var(--text);
        }

        .calendar-day-header.today .day-number {
            color: var(--primary);
        }

        .time-column {
            background: var(--bg);
            border-right: 1px solid var(--border);
        }

        .time-slot-label {
            height: 60px;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-light);
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        .day-column {
            border-right: 1px solid var(--border);
            position: relative;
        }

        .time-slot {
            height: 60px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s ease;
            position: relative;
        }

        .time-slot:hover {
            background: rgba(255, 107, 74, 0.04);
        }

        .time-slot:hover::after {
            content: '+ Add';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: 600;
            color: var(--primary);
            opacity: 0.6;
        }

        .calendar-event {
            position: absolute;
            left: 4px;
            right: 4px;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .calendar-event:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            z-index: 20;
        }

        .calendar-event.private {
            background: linear-gradient(135deg, #E8D5F0 0%, #F5EDF9 100%);
            border-left: 3px solid #9B6BB3;
        }

        .calendar-event.duet {
            background: linear-gradient(135deg, #FFF3CD 0%, #FFFAEB 100%);
            border-left: 3px solid #D4A574;
        }

        .calendar-event.trio {
            background: linear-gradient(135deg, #D4EDDA 0%, #E8F5E9 100%);
            border-left: 3px solid #5F8575;
        }

        .event-time {
            font-weight: 600;
            font-size: 11px;
            color: rgba(0,0,0,0.6);
            margin-bottom: 2px;
        }

        .event-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-client {
            font-size: 11px;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .event-icons {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
        }

        .event-icon {
            font-size: 12px;
            opacity: 0.7;
        }

        /* Teacher columns in calendar */
        .calendar-teacher-grid {
            display: flex;
            flex: 1;
        }

        .teacher-calendar-column {
            flex: 1;
            min-width: 200px;
            border-right: 1px solid var(--border);
        }

        .teacher-column-header {
            padding: 16px;
            text-align: center;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }

        .teacher-column-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            color: white;
        }

        .teacher-column-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }

        /* Calendar Quick Book Modal */
        .quick-book-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .quick-book-modal.active {
            display: flex;
        }

        .quick-book-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 480px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quick-book-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .quick-book-title {
            font-family: 'Inter', sans-serif;
            font-size: 28px;
            color: var(--primary);
        }

        .quick-book-subtitle {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 4px;
        }

        .quick-book-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg);
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.2s ease;
        }

        .quick-book-close:hover {
            background: var(--error);
            color: white;
        }

        /* Empty state for calendar */
        .calendar-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .calendar-empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .calendar-empty-title {
            font-family: 'Inter', sans-serif;
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .calendar-empty-text {
            font-size: 14px;
            color: var(--text-light);
            max-width: 300px;
        }

        /* Legend */
        .calendar-legend {
            display: flex;
            gap: 20px;
            padding: 16px 24px;
            background: var(--bg);
            border-top: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-light);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }

        .legend-color.private {
            background: #9B6BB3;
        }

        .legend-color.duet {
            background: #D4A574;
        }

        .legend-color.trio {
            background: #5F8575;
        }

        /* Client Profile Modal */
        .client-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .client-profile-modal.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .client-profile-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 1200px;
            margin: 20px auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .client-profile-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 24px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .client-profile-header h2 {
            font-family: 'Inter', sans-serif;
            font-size: 28px;
            font-weight: 400;
            margin: 0;
        }

        .client-profile-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .client-profile-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .client-profile-body {
            padding: 30px;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 900px) {
            .profile-grid {
                grid-template-columns: 1fr;
            }
        }

        .profile-section {
            background: var(--bg);
            border-radius: 12px;
            padding: 20px;
        }

        .profile-section h3 {
            font-family: 'Inter', sans-serif;
            font-size: 20px;
            color: var(--primary);
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .profile-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .profile-info-row:last-child {
            border-bottom: none;
        }

        .profile-info-label {
            color: var(--text-light);
            font-size: 13px;
        }

        .profile-info-value {
            font-weight: 500;
            color: var(--text);
        }

        /* Body Chart Styles */
        .body-chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .body-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .body-chart-title {
            font-family: 'Inter', sans-serif;
            font-size: 20px;
            color: var(--primary);
        }

        .body-chart-tools {
            display: flex;
            gap: 8px;
        }

        .body-chart-tool {
            width: 36px;
            height: 36px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .body-chart-tool:hover {
            border-color: var(--primary);
        }

        .body-chart-tool.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .body-chart-views {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            background: #f8f8f8;
            border-radius: 12px;
            padding: 15px;
        }

        @media (max-width: 768px) {
            .body-chart-views {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .body-view {
            position: relative;
            background: white;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border: 2px solid var(--border);
        }

        .body-view-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .body-svg-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1/2;
            cursor: crosshair;
        }

        .body-svg-container svg {
            width: 100%;
            height: 100%;
        }

        .pain-marker {
            position: absolute;
            width: 24px;
            height: 24px;
            background: #e74c3c;
            border: 3px solid #c0392b;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4);
            transition: transform 0.2s;
            z-index: 10;
        }

        .pain-marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .pain-marker.severity-low {
            background: #f1c40f;
            border-color: #d4ac0d;
            box-shadow: 0 2px 8px rgba(241, 196, 15, 0.5);
        }

        .pain-marker.severity-medium {
            background: #e67e22;
            border-color: #ca6f1e;
            box-shadow: 0 2px 8px rgba(230, 126, 34, 0.5);
        }

        .pain-marker.severity-high {
            background: #e74c3c;
            border-color: #c0392b;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.5);
        }

        .body-chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item-body {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-light);
        }

        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        .legend-dot.low { background: #f1c40f; }
        .legend-dot.medium { background: #e67e22; }
        .legend-dot.high { background: #e74c3c; }

        /* Notes Section */
        .client-notes-section {
            margin-top: 20px;
        }

        .notes-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .note-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .note-date {
            font-size: 12px;
            color: var(--text-light);
        }

        .note-delete {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 14px;
        }

        .note-content {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text);
        }

        .add-note-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .add-note-form textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
        }

        .add-note-form textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Appointments List */
        .appointments-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .appointment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .appointment-info {
            flex: 1;
        }

        .appointment-type {
            font-weight: 600;
            color: var(--primary);
        }

        .appointment-datetime {
            font-size: 13px;
            color: var(--text-light);
        }

        .appointment-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .appointment-status.upcoming {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .appointment-status.past {
            background: #f5f5f5;
            color: #757575;
        }

        /* Severity Selector */
        .severity-selector {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
        }

        .severity-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .severity-btn:hover {
            transform: scale(1.05);
        }

        .severity-btn.low { border-color: #f1c40f; color: #d4ac0d; }
        .severity-btn.low.active { background: #f1c40f; color: #333; }
        
        .severity-btn.medium { border-color: #e67e22; color: #e67e22; }
        .severity-btn.medium.active { background: #e67e22; color: white; }
        
        .severity-btn.high { border-color: #e74c3c; color: #e74c3c; }
        .severity-btn.high.active { background: #e74c3c; color: white; }

        /* Note with Body Chart */
        .note-body-chart {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
            padding: 12px;
            background: #f8f8f8;
            border-radius: 8px;
        }

        .note-body-view {
            position: relative;
            background: white;
            border-radius: 6px;
            padding: 5px;
            text-align: center;
        }

        .note-body-view-label {
            font-size: 9px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .note-body-svg {
            position: relative;
            width: 100%;
            aspect-ratio: 1/2;
        }

        .note-body-svg svg {
            width: 100%;
            height: 100%;
        }

        .note-pain-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
            font-weight: bold;
            z-index: 10;
        }

        .note-pain-marker.severity-low {
            background: #f1c40f;
            border: 2px solid #d4ac0d;
        }

        .note-pain-marker.severity-medium {
            background: #e67e22;
            border: 2px solid #ca6f1e;
        }

        .note-pain-marker.severity-high {
            background: #e74c3c;
            border: 2px solid #c0392b;
        }

        .note-markers-summary {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .marker-count {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: var(--text-light);
        }

        .marker-count-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
   
    </style>
</head>
<body>
    <div class="page-header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon" id="logoIcon">
                    <!-- MyoMesh Logo SVG - Mono Light (Always visible) -->
                    <svg id="logoSvg" width="56" height="56" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M28 6 L46 16 Q48 17 48 19 L48 37 Q48 39 46 40 L28 50 L10 40 Q8 39 8 37 L8 19 Q8 17 10 16 Z" stroke="white" stroke-width="2" stroke-linejoin="round" fill="none"/>
                        <path d="M28 10 L42 18 L42 34 L28 42 L14 34 L14 18 Z" stroke="white" stroke-width="1.6" stroke-linejoin="round" fill="none"/>
                        <path d="M28 10 V42" stroke="white" stroke-width="1.4" stroke-linecap="round"/>
                        <path d="M14 18 L42 34" stroke="white" stroke-width="1.2" stroke-linecap="round"/>
                        <path d="M42 18 L14 34" stroke="white" stroke-width="1.2" stroke-linecap="round"/>
                        <path d="M14 26 H42" stroke="white" stroke-width="1.2" stroke-linecap="round"/>
                        <path d="M28 20 L34 24 V32 L28 36 L22 32 V24 Z" fill="white"/>
                        <circle cx="28" cy="6" r="2.6" fill="white"/>
                        <circle cx="48" cy="18" r="2.6" fill="white"/>
                        <circle cx="48" cy="38" r="2.6" fill="white"/>
                        <circle cx="28" cy="50" r="2.6" fill="white"/>
                        <circle cx="8" cy="38" r="2.6" fill="white"/>
                        <circle cx="8" cy="18" r="2.6" fill="white"/>
                        <circle cx="14" cy="18" r="2.2" fill="white"/>
                        <circle cx="42" cy="18" r="2.2" fill="white"/>
                        <circle cx="42" cy="34" r="2.2" fill="white"/>
                        <circle cx="14" cy="34" r="2.2" fill="white"/>
                        <circle cx="28" cy="28" r="4.2" fill="white"/>
                    </svg>
                </div>
                <div>
                    <h1>MyoMesh</h1>
                    <div class="tagline">Practice Management Made Simple</div>
                </div>
            </div>
            
            <!-- Business Name in Center -->
            <div id="businessNameDisplay" style="position: absolute; left: 50%; transform: translateX(-50%); text-align: center;">
                <div id="mainStudioName" style="font-size: 20px; font-weight: 700; color: white; letter-spacing: -0.01em;"></div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 20px;">
                <div id="userInfo" style="text-align: right;">
                    <div id="userName" style="font-weight: 600; color: white; font-size: 16px;"></div>
                    <div id="userRole" style="font-size: 12px; color: rgba(255,255,255,0.75); margin-top: 3px;"></div>
                </div>
                <button onclick="handleLogout()" style="padding: 12px 24px; background: rgba(255,255,255,0.15); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; backdrop-filter: blur(10px);">
                    Logout
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <header style="display: none;"></header>

        <nav class="nav-tabs">
          <button class="tab active" onclick="switchTab('clients', event)">
            <i data-lucide="users"></i>
            <span>Clients</span>
          </button>
          <button class="tab" onclick="switchTab('notes', event)">
            <i data-lucide="clipboard-list"></i>
            <span>Notes</span>
          </button>
          <button class="tab" onclick="switchTab('calendar', event)">
            <i data-lucide="calendar-days"></i>
            <span>Calendar</span>
          </button>
          <button class="tab" onclick="switchTab('invoices', event)">
            <i data-lucide="file-text"></i>
            <span>Invoices</span>
          </button>
          <button class="tab" onclick="switchTab('income', event)">
            <i data-lucide="trending-up"></i>
            <span>Income</span>
          </button>
          <button class="tab" id="settingsTab" onclick="switchTab('settings', event)">
            <i data-lucide="settings"></i>
            <span>Settings</span>
          </button>
        </nav>
        <!-- CLIENTS TAB -->
        <div id="clients-tab" class="tab-content active">
            <div class="main-grid">
                <div class="card form-card">
                    <h2><span class="section-icon"></span><span id="form-title">Add New Client</span></h2>
                    <form id="clientForm" onsubmit="addClient(event)">
                        <div class="form-group">
                            <label for="name">Client Name</label>
                            <input type="text" id="name" required placeholder="First & Last Name">
                        </div>

                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" required placeholder="client@email.com">
                        </div>

                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" required placeholder="(555) 123-4567">
                        </div>

                        <div>
                            <div class="form-row-label">Session Rates ($)</div>
                            <div class="form-row">
                                <div class="price-input-wrapper">
                                    <label class="price-label" for="ratePrivate">Private</label>
                                    <input type="number" id="ratePrivate" required placeholder="85" min="0" step="0.01">
                                </div>
                                <div class="price-input-wrapper">
                                    <label class="price-label" for="rateDuet">Duet</label>
                                    <input type="number" id="rateDuet" required placeholder="60" min="0" step="0.01">
                                </div>
                                <div class="price-input-wrapper">
                                    <label class="price-label" for="rateTrio">Trio</label>
                                    <input type="number" id="rateTrio" required placeholder="45" min="0" step="0.01">
                                </div>
                            </div>
                        </div>

                        <label class="checkbox-group">
                            <input type="checkbox" id="waiver">
                            <span class="checkbox-label">Liability Waiver on File</span>
                        </label>

                        <div class="form-group">
                            <label for="notes">Session Notes</label>
                            <textarea id="notes" placeholder="Equipment preferences, injuries, modifications..."></textarea>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn-primary" id="submitBtn">Add Client</button>
                            <button type="button" class="btn-secondary" id="cancelBtn" style="display: none;">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="card clients-card">
                    <h2>
                        <span><span class="section-icon"></span> Your Clients</span>
                        <span class="client-count" id="clientCount" style="font-size: 14px; font-family: 'Inter', sans-serif; font-weight: 500; color: var(--accent); letter-spacing: 1px;">0 Clients</span>
                    </h2>
                    
                    <div class="search-box">
                        <span class="search-icon"></span>
                        <input type="text" id="searchInput" placeholder="Search clients by name...">
                    </div>

                    <div class="sessions-list" id="clientList">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <div class="empty-text">No clients yet. Add your first client to get started!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOTES TAB -->
        <div id="notes-tab" class="tab-content">
            <div class="main-grid">
                <!-- Add/Edit Note Section -->
                <div class="card form-card">
                    <h2>Session Notes & Body Chart</h2>
                    <p style="color: var(--text-light); font-size: 13px; margin-bottom: 20px;">
                        Record session notes with body chart markers to track client progress over time.
                    </p>

                    <!-- Client Selection -->
                    <div class="form-group">
                        <label>Select Client *</label>
                        <div style="position: relative;">
                            <input type="text" id="notesClientSearch" placeholder="Type to search clients..." autocomplete="off">
                            <div id="notesClientDropdown" class="client-search-dropdown" style="display: none;"></div>
                        </div>
                        <div id="notesSelectedClient" style="margin-top: 10px;"></div>
                    </div>

                    <!-- Date Selection -->
                    <div class="form-group">
                        <label>Session Date *</label>
                        <input type="date" id="notesSessionDate" required>
                    </div>

                    <!-- Severity Selector -->
                    <div class="form-group">
                        <label>Pain Severity Level</label>
                        <div class="severity-selector" style="justify-content: flex-start; margin-top: 8px;">
                            <button type="button" class="severity-btn low" onclick="setNotesPainSeverity('low')">1 - Mild</button>
                            <button type="button" class="severity-btn medium active" onclick="setNotesPainSeverity('medium')">2 - Moderate</button>
                            <button type="button" class="severity-btn high" onclick="setNotesPainSeverity('high')">3 - Severe</button>
                        </div>
                    </div>

                    <!-- Body Chart -->
                    <div class="form-group">
                        <label>Body Chart <span style="font-weight: normal; color: var(--text-light);">(Click to mark pain areas)</span></label>
                        <div class="body-chart-views" id="notesBodyChart" style="margin-top: 10px;">
                            <!-- Front View -->
                            <div class="body-view">
                                <div class="body-view-label">Front</div>
                                <div class="body-svg-container" id="notesBodyFront" onclick="addNotesPainMarker(event, 'front')">
                                    <svg viewBox="0 0 200 420" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <!-- Head -->
                                        <ellipse cx="100" cy="32" rx="26" ry="30" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Ears -->
                                        <ellipse cx="73" cy="32" rx="5" ry="9" fill="#F5E6D3" stroke="#2D2926" stroke-width="1"/>
                                        <ellipse cx="127" cy="32" rx="5" ry="9" fill="#F5E6D3" stroke="#2D2926" stroke-width="1"/>
                                        <!-- Neck -->
                                        <path d="M88 58 L88 72 L112 72 L112 58" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Torso -->
                                        <path d="M88 72 L60 82 L52 100 L50 140 L52 180 L58 200 L70 205 L100 210 L130 205 L142 200 L148 180 L150 140 L148 100 L140 82 L112 72 Z" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Chest details -->
                                        <ellipse cx="80" cy="105" rx="10" ry="6" fill="none" stroke="#D4B896" stroke-width="1"/>
                                        <ellipse cx="120" cy="105" rx="10" ry="6" fill="none" stroke="#D4B896" stroke-width="1"/>
                                        <!-- Navel -->
                                        <ellipse cx="100" cy="175" rx="4" ry="5" fill="#D4B896"/>
                                        <!-- Left Arm -->
                                        <path d="M52 100 L38 108 L28 130 L22 160 L18 190 L16 210 L14 225 C10 235 8 245 12 250 L22 252 L28 248 C32 242 30 235 28 225 L32 210 L36 180 L42 150 L50 120 L52 100" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Left Hand -->
                                        <ellipse cx="17" cy="258" rx="10" ry="14" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Right Arm -->
                                        <path d="M148 100 L162 108 L172 130 L178 160 L182 190 L184 210 L186 225 C190 235 192 245 188 250 L178 252 L172 248 C168 242 170 235 172 225 L168 210 L164 180 L158 150 L150 120 L148 100" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Right Hand -->
                                        <ellipse cx="183" cy="258" rx="10" ry="14" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Pelvis/Hips -->
                                        <path d="M70 205 L65 220 L68 235 L80 240 L100 242 L120 240 L132 235 L135 220 L130 205" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Left Leg -->
                                        <path d="M80 240 L75 260 L70 300 L68 340 L66 370 L64 390 L62 400 C58 408 60 415 68 418 L82 418 C90 415 88 408 84 400 L82 390 L84 370 L86 340 L88 300 L90 260 L92 240" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Left Foot -->
                                        <path d="M62 400 L55 405 L50 410 L48 415 L52 420 L75 420 L85 418 L84 400" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Left Knee -->
                                        <ellipse cx="78" cy="300" rx="10" ry="8" fill="none" stroke="#D4B896" stroke-width="1"/>
                                        <!-- Right Leg -->
                                        <path d="M108 240 L110 260 L112 300 L114 340 L116 370 L118 390 L120 400 C124 408 122 415 114 418 L100 418 C92 415 94 408 98 400 L100 390 L98 370 L96 340 L94 300 L92 260 L90 240" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Right Foot -->
                                        <path d="M120 400 L127 405 L132 410 L134 415 L130 420 L107 420 L97 418 L98 400" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Right Knee -->
                                        <ellipse cx="104" cy="300" rx="10" ry="8" fill="none" stroke="#D4B896" stroke-width="1"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Back View -->
                            <div class="body-view">
                                <div class="body-view-label">Back</div>
                                <div class="body-svg-container" id="notesBodyBack" onclick="addNotesPainMarker(event, 'back')">
                                    <svg viewBox="0 0 200 420" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <!-- Head -->
                                        <ellipse cx="100" cy="32" rx="26" ry="30" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Ears -->
                                        <ellipse cx="73" cy="32" rx="5" ry="9" fill="#F5E6D3" stroke="#2D2926" stroke-width="1"/>
                                        <ellipse cx="127" cy="32" rx="5" ry="9" fill="#F5E6D3" stroke="#2D2926" stroke-width="1"/>
                                        <!-- Neck -->
                                        <path d="M88 58 L88 72 L112 72 L112 58" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Torso -->
                                        <path d="M88 72 L60 82 L52 100 L50 140 L52 180 L58 200 L70 205 L100 210 L130 205 L142 200 L148 180 L150 140 L148 100 L140 82 L112 72 Z" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Spine -->
                                        <path d="M100 72 L100 205" stroke="#D4B896" stroke-width="2" stroke-dasharray="4,3"/>
                                        <!-- Shoulder blades -->
                                        <path d="M72 95 Q68 115 78 135" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <path d="M128 95 Q132 115 122 135" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <!-- Lower back dimples -->
                                        <circle cx="88" cy="190" r="4" fill="#D4B896"/>
                                        <circle cx="112" cy="190" r="4" fill="#D4B896"/>
                                        <!-- Left Arm -->
                                        <path d="M52 100 L38 108 L28 130 L22 160 L18 190 L16 210 L14 225 C10 235 8 245 12 250 L22 252 L28 248 C32 242 30 235 28 225 L32 210 L36 180 L42 150 L50 120 L52 100" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Left Hand -->
                                        <ellipse cx="17" cy="258" rx="10" ry="14" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Right Arm -->
                                        <path d="M148 100 L162 108 L172 130 L178 160 L182 190 L184 210 L186 225 C190 235 192 245 188 250 L178 252 L172 248 C168 242 170 235 172 225 L168 210 L164 180 L158 150 L150 120 L148 100" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Right Hand -->
                                        <ellipse cx="183" cy="258" rx="10" ry="14" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Pelvis/Hips (Buttocks) -->
                                        <path d="M70 205 L65 220 L68 235 L80 240 L100 242 L120 240 L132 235 L135 220 L130 205" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <path d="M75 210 Q100 225 125 210" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <!-- Left Leg -->
                                        <path d="M80 240 L75 260 L70 300 L68 340 L66 370 L64 390 L62 400 C58 408 60 415 68 418 L82 418 C90 415 88 408 84 400 L82 390 L84 370 L86 340 L88 300 L90 260 L92 240" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Left Foot -->
                                        <path d="M62 400 L55 405 L50 410 L48 415 L52 420 L75 420 L85 418 L84 400" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Left Calf detail -->
                                        <path d="M70 310 Q66 330 72 355" stroke="#D4B896" stroke-width="1" fill="none"/>
                                        <!-- Right Leg -->
                                        <path d="M108 240 L110 260 L112 300 L114 340 L116 370 L118 390 L120 400 C124 408 122 415 114 418 L100 418 C92 415 94 408 98 400 L100 390 L98 370 L96 340 L94 300 L92 260 L90 240" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Right Foot -->
                                        <path d="M120 400 L127 405 L132 410 L134 415 L130 420 L107 420 L97 418 L98 400" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Right Calf detail -->
                                        <path d="M112 310 Q116 330 110 355" stroke="#D4B896" stroke-width="1" fill="none"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Left Side View -->
                            <div class="body-view">
                                <div class="body-view-label">Left Side</div>
                                <div class="body-svg-container" id="notesBodyLeft" onclick="addNotesPainMarker(event, 'left')">
                                    <svg viewBox="0 0 140 420" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <!-- Head -->
                                        <ellipse cx="70" cy="32" rx="22" ry="30" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Ear -->
                                        <ellipse cx="48" cy="32" rx="5" ry="9" fill="#F5E6D3" stroke="#2D2926" stroke-width="1"/>
                                        <!-- Neck -->
                                        <path d="M60 58 L58 72 L82 72 L80 58" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Torso -->
                                        <path d="M58 72 L45 80 L38 100 L35 130 L38 170 L42 200 L55 210 L85 210 L98 200 L102 170 L105 130 L102 100 L95 80 L82 72 Z" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Chest/Back curve -->
                                        <path d="M45 85 Q38 110 42 145" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <path d="M95 85 Q102 115 98 155" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <!-- Arm -->
                                        <path d="M38 100 L28 110 L20 135 L15 165 L12 195 L10 220 L10 240 C8 250 10 258 18 260 L26 258 C32 252 28 242 26 230 L28 200 L32 170 L38 140 L42 115 L45 100" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Hand -->
                                        <ellipse cx="14" cy="268" rx="10" ry="14" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Pelvis -->
                                        <path d="M55 210 L50 225 L52 238 L70 242 L88 238 L90 225 L85 210" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Leg -->
                                        <path d="M60 240 L55 270 L52 310 L50 350 L48 380 L46 400 C42 410 45 418 55 420 L75 420 C85 418 82 410 78 400 L76 380 L78 350 L80 310 L82 270 L80 240" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Knee -->
                                        <ellipse cx="66" cy="310" rx="12" ry="10" fill="none" stroke="#D4B896" stroke-width="1"/>
                                        <!-- Foot -->
                                        <path d="M46 400 L35 408 L28 415 L30 420 L80 420 L85 415 L78 400" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- Right Side View -->
                            <div class="body-view">
                                <div class="body-view-label">Right Side</div>
                                <div class="body-svg-container" id="notesBodyRight" onclick="addNotesPainMarker(event, 'right')">
                                    <svg viewBox="0 0 140 420" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <!-- Head -->
                                        <ellipse cx="70" cy="32" rx="22" ry="30" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Ear -->
                                        <ellipse cx="92" cy="32" rx="5" ry="9" fill="#F5E6D3" stroke="#2D2926" stroke-width="1"/>
                                        <!-- Neck -->
                                        <path d="M60 58 L58 72 L82 72 L80 58" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Torso -->
                                        <path d="M58 72 L45 80 L38 100 L35 130 L38 170 L42 200 L55 210 L85 210 L98 200 L102 170 L105 130 L102 100 L95 80 L82 72 Z" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Chest/Back curve -->
                                        <path d="M95 85 Q102 110 98 145" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <path d="M45 85 Q38 115 42 155" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                                        <!-- Arm -->
                                        <path d="M102 100 L112 110 L120 135 L125 165 L128 195 L130 220 L130 240 C132 250 130 258 122 260 L114 258 C108 252 112 242 114 230 L112 200 L108 170 L102 140 L98 115 L95 100" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Hand -->
                                        <ellipse cx="126" cy="268" rx="10" ry="14" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Pelvis -->
                                        <path d="M55 210 L50 225 L52 238 L70 242 L88 238 L90 225 L85 210" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Leg -->
                                        <path d="M60 240 L55 270 L52 310 L50 350 L48 380 L46 400 C42 410 45 418 55 420 L75 420 C85 418 82 410 78 400 L76 380 L78 350 L80 310 L82 270 L80 240" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                        <!-- Knee -->
                                        <ellipse cx="66" cy="310" rx="12" ry="10" fill="none" stroke="#D4B896" stroke-width="1"/>
                                        <!-- Foot -->
                                        <path d="M46 400 L35 408 L28 415 L30 420 L80 420 L85 415 L78 400" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Body Chart Legend & Clear -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; flex-wrap: wrap; gap: 10px;">
                            <div class="body-chart-legend" style="margin: 0;">
                                <div class="legend-item-body">
                                    <div class="legend-dot low"></div>
                                    <span>1 - Mild</span>
                                </div>
                                <div class="legend-item-body">
                                    <div class="legend-dot medium"></div>
                                    <span>2 - Moderate</span>
                                </div>
                                <div class="legend-item-body">
                                    <div class="legend-dot high"></div>
                                    <span>3 - Severe</span>
                                </div>
                            </div>
                            <button type="button" onclick="clearNotesBodyChart()" class="btn-secondary" style="padding: 8px 16px; font-size: 12px;"> Clear Markers</button>
                        </div>
                    </div>

                    <!-- Note Text -->
                    <div class="form-group">
                        <label>Session Notes</label>
                        <textarea id="notesTextArea" rows="4" placeholder="Describe the client's condition, treatment provided, exercises prescribed, progress notes..."></textarea>
                    </div>

                    <button type="button" onclick="saveSessionNote()" class="btn-primary" style="width: 100%;"> Save Session Note</button>
                </div>

                <!-- Notes History Section -->
                <div class="card">
                    <h2>Notes History</h2>

                    <!-- Search/Filter -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px;">Filter by Client</label>
                            <div style="position: relative;">
                                <input type="text" id="notesHistoryClientSearch" placeholder="All clients" autocomplete="off">
                                <div id="notesHistoryClientDropdown" class="client-search-dropdown" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 12px;">Filter by Date</label>
                            <input type="date" id="notesHistoryDateFilter" onchange="filterNotesHistory()">
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span id="notesHistoryCount" style="color: var(--text-light); font-size: 13px;">0 notes found</span>
                        <button onclick="clearNotesFilters()" class="btn-secondary" style="padding: 6px 12px; font-size: 12px;">Clear Filters</button>
                    </div>

                    <!-- Notes List -->
                    <div class="notes-list" id="notesHistoryList" style="max-height: 500px;">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <div class="empty-text">No notes yet. Create your first session note above!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Note View Modal -->
        <div class="client-profile-modal" id="noteViewModal">
            <div class="client-profile-content" style="max-width: 900px;">
                <div class="client-profile-header">
                    <h2 id="noteViewTitle">Session Note</h2>
                    <button class="client-profile-close" onclick="closeNoteViewModal()">&times;</button>
                </div>
                <div class="client-profile-body" id="noteViewContent">
                    <!-- Content populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- CALENDAR TAB -->
        <div id="calendar-tab" class="tab-content">
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="calendarPrev()"></button>
                        <h2 class="calendar-title" id="calendarTitle">January 2026</h2>
                        <button class="calendar-nav-btn" onclick="calendarNext()"></button>
                    </div>
                    <div class="calendar-controls">
                        <div class="calendar-view-toggle">
                            <button class="view-toggle-btn" onclick="setCalendarView('day')" id="dayViewBtn">Day</button>
                            <button class="view-toggle-btn active" onclick="setCalendarView('week')" id="weekViewBtn">Week</button>
                        </div>
                        <button class="today-btn" onclick="goToToday()">Today</button>
                    </div>
                </div>
                
                <div class="calendar-body">
                    <div class="teacher-sidebar" id="teacherSidebar">
                        <div class="teacher-sidebar-header">
                            <div class="teacher-sidebar-title">Filter by Staff</div>
                        </div>
                        <div class="teacher-filter-item selected" onclick="filterByTeacher('all')">
                            <div class="teacher-avatar" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);">All</div>
                            <div>
                                <div class="teacher-filter-name">All Staff</div>
                                <div class="teacher-filter-sessions" id="allSessionsCount">0 sessions</div>
                            </div>
                        </div>
                        <div id="teacherFilterList"></div>
                    </div>
                    
                    <div class="calendar-grid-wrapper">
                        <div id="calendarContent">
                            <!-- Calendar grid will be rendered here -->
                        </div>
                    </div>
                </div>
                
                <div class="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-color private"></div>
                        <span>Private Session</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color duet"></div>
                        <span>Duet Session</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color trio"></div>
                        <span>Trio Session</span>
                    </div>
                </div>
            </div>
            
            <!-- Booking Section Below Calendar -->
            <div class="main-grid" style="margin-top: 30px;">
                <div class="card form-card">
                    <h2><span class="section-icon"></span><span id="session-form-title">Book New Session</span></h2>
                    <form id="sessionForm" onsubmit="addSession(event)">
                        <div class="form-group">
                            <label for="sessionType">Session Type</label>
                            <select id="sessionType" required onchange="updateClientSelection()">
                                <option value="">Select session type...</option>
                                <option value="Private">Private Session</option>
                                <option value="Duet">Duet Session</option>
                                <option value="Trio">Trio Session</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="sessionTeacher">Staff</label>
                            <select id="sessionTeacher" required>
                                <option value="">Select staff...</option>
                            </select>
                        </div>

                        <div class="form-group client-selector">
                            <label>Select Client(s)</label>
                            <div style="position: relative;">
                                <input type="text" id="clientSearchInput" placeholder="Type to search clients..." autocomplete="off" style="width: 100%;">
                                <div id="clientSearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1.5px solid var(--border); border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 100; display: none;"></div>
                            </div>
                            <div class="client-chips" id="selectedClients" style="margin-top: 10px;"></div>
                        </div>

                        <div class="form-group">
                            <label for="sessionDate">Date</label>
                            <input type="date" id="sessionDate" required>
                        </div>

                        <div class="form-group">
                            <label>Time</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="sessionHour" required style="flex: 1;">
                                    <option value="">Hour</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                                <span style="font-weight: 600;">:</span>
                                <select id="sessionMinute" required style="flex: 1;">
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                                <select id="sessionAmPm" required style="flex: 1;">
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                            </div>
                        </div>

                        <label class="checkbox-group">
                            <input type="checkbox" id="repeatSession">
                            <span class="checkbox-label">Repeating Session (Weekly)</span>
                        </label>

                        <div class="form-group">
                            <label for="sessionNotes">Session Notes</label>
                            <textarea id="sessionNotes" placeholder="Special instructions or modifications..."></textarea>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn-primary" id="sessionSubmitBtn">Book Session</button>
                            <button type="button" class="btn-secondary" id="sessionCancelBtn" style="display: none;">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h2><span class="section-icon"></span> Upcoming Sessions</h2>
                    
                    <div class="search-box">
                        <span class="search-icon"></span>
                        <input type="text" id="sessionSearchInput" placeholder="Search sessions...">
                    </div>

                    <div class="sessions-list" id="sessionsList">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <div class="empty-text">No sessions booked yet. Create your first session!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Book Modal -->
        <div class="quick-book-modal" id="quickBookModal">
            <div class="quick-book-content">
                <div class="quick-book-header">
                    <div>
                        <div class="quick-book-title">Quick Book Session</div>
                        <div class="quick-book-subtitle" id="quickBookSubtitle">Monday, Jan 20 at 10:00 AM</div>
                    </div>
                    <button class="quick-book-close" onclick="closeQuickBookModal()"></button>
                </div>
                
                <form id="quickBookForm" onsubmit="submitQuickBook(event)">
                    <div class="form-group">
                        <label for="qbSessionType">Session Type</label>
                        <select id="qbSessionType" required onchange="updateQuickBookClients()">
                            <option value="">Select session type...</option>
                            <option value="Private">Private Session</option>
                            <option value="Duet">Duet Session</option>
                            <option value="Trio">Trio Session</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="qbTeacher">Staff</label>
                        <select id="qbTeacher" required>
                            <option value="">Select staff...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Select Client(s)</label>
                        <div style="position: relative;">
                            <input type="text" id="qbClientSearchInput" placeholder="Type to search clients..." autocomplete="off" style="width: 100%;">
                            <div id="qbClientSearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1.5px solid var(--border); border-top: none; border-radius: 0 0 8px 8px; max-height: 150px; overflow-y: auto; z-index: 100; display: none;"></div>
                        </div>
                        <div id="qbSelectedClients" style="margin-top: 10px;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="qbNotes">Notes (optional)</label>
                        <textarea id="qbNotes" placeholder="Session notes..."></textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button type="submit" class="btn-primary">Book Session</button>
                        <button type="button" class="btn-secondary" onclick="closeQuickBookModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- CLIENT PROFILE MODAL -->
        <div class="client-profile-modal" id="clientProfileModal">
            <div class="client-profile-content">
                <div class="client-profile-header">
                    <h2 id="clientProfileName">Client Profile</h2>
                    <button class="client-profile-close" onclick="closeClientProfile()">&times;</button>
                </div>
                <div class="client-profile-body">
                    <div class="profile-grid">
                        <!-- Client Info Section -->
                        <div class="profile-section">
                            <h3> Client Information</h3>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Email</span>
                                <span class="profile-info-value" id="profileEmail">-</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Phone</span>
                                <span class="profile-info-value" id="profilePhone">-</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Private Rate</span>
                                <span class="profile-info-value" id="profileRatePrivate">-</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Duet Rate</span>
                                <span class="profile-info-value" id="profileRateDuet">-</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Trio Rate</span>
                                <span class="profile-info-value" id="profileRateTrio">-</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Waiver Signed</span>
                                <span class="profile-info-value" id="profileWaiver">-</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-info-label">Total Sessions</span>
                                <span class="profile-info-value" id="profileTotalSessions">0</span>
                            </div>
                        </div>

                        <!-- Appointments Section -->
                        <div class="profile-section">
                            <h3> Appointments</h3>
                            <div class="appointments-list" id="clientAppointmentsList">
                                <p style="text-align: center; color: var(--text-light);">No appointments found</p>
                            </div>
                        </div>
                    </div>

                    <!-- Session Notes Summary -->
                    <div class="profile-section" style="margin-top: 20px;">
                        <h3> Session Notes</h3>
                        <div id="clientNotesPreview" style="margin-bottom: 15px;">
                            <p style="text-align: center; color: var(--text-light);">No notes recorded</p>
                        </div>
                        <button onclick="goToNotesForClient()" class="btn-primary" style="width: 100%;">
                             Add / View All Notes in Notes Tab
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- INVOICES TAB -->
        <div id="invoices-tab" class="tab-content">
            <div class="card">

                <h2 style="margin-top: 30px;"><span class="section-icon"></span> Invoice Management</h2>
                
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <button class="btn-invoice" onclick="showBulkInvoiceModal()">
                         Generate Bulk Invoices
                    </button>
                    <button class="btn-secondary" onclick="refreshInvoiceStatus()">
                         Refresh Payment Status
                    </button>
                </div>

                <div class="sessions-list" id="invoicesList">
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <div class="empty-text">No invoices yet. Book sessions and generate invoices!</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INCOME TAB -->
        <div id="income-tab" class="tab-content">
            <!-- View Toggle -->
            <div class="income-view-toggle">
                <button class="income-view-btn active" onclick="switchIncomeView('monthly')">Monthly View</button>
                <button class="income-view-btn" onclick="switchIncomeView('yearly')">Yearly View</button>
                <button class="income-view-btn" onclick="switchIncomeView('history')">Historical Data</button>
            </div>
            
            <!-- Summary Cards -->
            <div class="income-summary">
                <div class="income-card">
                    <div class="income-label">This Week</div>
                    <div class="income-amount" id="weeklyIncome">$0</div>
                    <div class="income-subtitle" id="weeklySessions">0 sessions</div>
                </div>
                <div class="income-card">
                    <div class="income-label">This Month</div>
                    <div class="income-amount" id="monthlyIncome">$0</div>
                    <div class="income-subtitle" id="monthlySessions">0 sessions</div>
                </div>
                <div class="income-card secondary">
                    <div class="income-label">Last Month</div>
                    <div class="income-amount" id="lastMonthIncome">$0</div>
                    <div class="income-subtitle" id="monthComparison">-</div>
                </div>
                <div class="income-card quickbooks">
                    <div class="income-label">Outstanding Invoices</div>
                    <div class="income-amount" id="outstandingInvoices">$0</div>
                    <div class="income-subtitle" id="outstandingCount">0 unpaid</div>
                </div>
            </div>
            
            <!-- Monthly View -->
            <div id="incomeMonthlyView">
                <div class="income-stats-row">
                    <div class="income-stat-card highlight">
                        <div class="income-stat-value" id="ytdTotal">$0</div>
                        <div class="income-stat-label">Year to Date</div>
                    </div>
                    <div class="income-stat-card">
                        <div class="income-stat-value" id="avgMonthly">$0</div>
                        <div class="income-stat-label">Avg Monthly</div>
                    </div>
                    <div class="income-stat-card">
                        <div class="income-stat-value" id="bestMonth">$0</div>
                        <div class="income-stat-label">Best Month</div>
                    </div>
                    <div class="income-stat-card">
                        <div class="income-stat-value" id="growthRate">0%</div>
                        <div class="income-stat-label">Growth Rate</div>
                        <div class="income-stat-change positive" id="growthTrend"></div>
                    </div>
                </div>
                
                <div class="income-charts-grid">
                    <div class="income-chart-card">
                        <h3> Monthly Comparison</h3>
                        <div class="income-chart-container">
                            <canvas id="monthlyComparisonChart"></canvas>
                        </div>
                    </div>
                    <div class="income-chart-card">
                        <h3> 12-Month Trend</h3>
                        <div class="income-chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2><span class="section-icon"></span> Income Breakdown - This Month</h2>
                    <div class="sessions-list" id="incomeBreakdown">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <div class="empty-text">No income data yet. Book sessions to track earnings!</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Yearly View -->
            <div id="incomeYearlyView" style="display: none;">
                <div class="income-charts-grid">
                    <div class="income-chart-card" style="grid-column: span 2;">
                        <h3> Yearly Overview - <span id="currentYearLabel"></span></h3>
                        <div class="income-chart-container" style="height: 350px;">
                            <canvas id="yearlyOverviewChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h2><span class="section-icon"></span> Monthly Totals</h2>
                    <table class="income-history-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Sessions</th>
                                <th>Subtotal</th>
                                <th>Tax Collected</th>
                                <th>Total</th>
                                <th>Change</th>
                            </tr>
                        </thead>
                        <tbody id="yearlyBreakdownTable">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Historical Data View -->
            <div id="incomeHistoryView" style="display: none;">
                <div class="card">
                    <h2><span class="section-icon"></span> Historical Income Data</h2>
                    <p style="color: var(--text-light); margin-bottom: 20px;">
                        View and manage your historical income records. Data can be imported via CSV in Settings.
                    </p>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="font-weight: 600; margin-right: 12px;">Filter by Year:</label>
                        <select id="historyYearFilter" onchange="renderIncomeHistory()" style="padding: 8px 16px; border-radius: 8px; border: 2px solid var(--border);">
                            <option value="all">All Years</option>
                        </select>
                    </div>
                    
                    <table class="income-history-table">
                        <thead>
                            <tr>
                                <th>Month/Year</th>
                                <th>Source</th>
                                <th>Subtotal</th>
                                <th>Tax</th>
                                <th>Total</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="incomeHistoryTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="invoice-modal" id="invoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Generate Invoices</h3>
                <button class="modal-close" onclick="closeInvoiceModal()"></button>
            </div>
            
            <div class="form-group">
                <label>Select Date Range</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <input type="date" id="invoiceStartDate">
                    <input type="date" id="invoiceEndDate">
                </div>
            </div>

            <div class="form-group">
                <label>Due Date</label>
                <input type="date" id="invoiceDueDate">
            </div>

            <div id="invoicePreview" style="margin: 20px 0;">
                <!-- Preview will be inserted here -->
            </div>

            <div class="btn-group">
                <button class="btn-invoice" onclick="generateBulkInvoices()">Generate & Send Invoices</button>
                <button class="btn-secondary" onclick="closeInvoiceModal()">Cancel</button>
            </div>
        </div>
    </div>

        <div id="settings-tab" class="tab-content">
            <div class="card">
                <h2 style="font-family: 'Inter', sans-serif; font-size: 32px; font-weight: 300; color: var(--primary); margin-bottom: 30px;">Settings</h2>

                <!-- Business Information Section -->
                <div class="settings-section">
                    <h3>Business Information</h3>
                    <div class="form-group">
                        <label>Business Name</label>
                        <input type="text" id="studioNameSetting" placeholder="Your Practice Name">
                        <p style="margin-top: 8px; font-size: 12px; color: var(--text-light);">
                            Your business name appears in the header and will be used in calendar invites and emails sent to your clients.
                        </p>
                    </div>
                    
                    <button class="btn-primary" onclick="saveBusinessInfo()">Save Business Information</button>
                </div>

                <!-- Calendar & Email Integrations Section -->
                <div class="settings-section">
                    <h3>Calendar & Email Integrations</h3>
                    <p style="margin-bottom: 20px; font-size: 13px; color: var(--text-light);">
                        Connect your calendar and email accounts to automatically create events when booking sessions.
                    </p>

                    <div class="integration-setup google" style="margin-bottom: 20px;">
                        <h3> Google Calendar Integration</h3>
                        <p>Connect your Google account to automatically create calendar events and send invites to clients.</p>
                        <button type="button" class="btn-google" onclick="connectGoogleCalendar()">
                            <span></span> Connect Google Calendar
                        </button>
                        <div id="google-status" style="display: none; margin-top: 12px;">
                            <span class="integration-status"> Connected</span>
                            <button type="button" class="btn-secondary btn-small" onclick="disconnectGoogleCalendar()" style="margin-left: 12px;">
                                Disconnect
                            </button>
                        </div>
                    </div>

                    <div class="integration-setup outlook">
                        <h3> Microsoft Outlook / Microsoft 365 Integration</h3>
                        <p>Connect your Microsoft account to access Outlook Calendar and Email for automated scheduling and client communications.</p>
                        <button type="button" class="btn-outlook" onclick="connectMicrosoftOutlook()">
                            <span></span> Connect Microsoft Outlook
                        </button>
                        <div id="outlook-status" style="display: none; margin-top: 12px;">
                            <span class="integration-status"> Connected to Microsoft Outlook</span>
                            <button type="button" class="btn-secondary btn-small" onclick="disconnectMicrosoftOutlook()" style="margin-left: 12px;">
                                Disconnect
                            </button>
                        </div>
                        
                        <div class="setup-steps" style="margin-top: 16px; font-size: 13px;">
                            <p style="margin-bottom: 8px;"><strong>What you get:</strong></p>
                            <ul style="margin-left: 20px; line-height: 1.8; color: var(--text-light);">
                                <li>Automatically create Outlook calendar events for sessions</li>
                                <li>Send appointment reminders via Outlook email</li>
                                <li>Invite clients to sessions with calendar events</li>
                                <li>Works with personal Outlook and Microsoft 365 business accounts</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Email Notifications Section (Owner/Admin Only) -->
                <div id="emailNotificationsSection" class="settings-section" style="display: none;">
                    <h3> Email Notifications (Postmark)</h3>
                    <p style="margin-bottom: 20px; font-size: 13px; color: var(--text-light);">
                        Configure automatic email notifications for appointments. Requires a 
                        <a href="https://postmarkapp.com" target="_blank" style="color: var(--coral);">Postmark</a> account.
                    </p>
                    
                    <div class="email-settings-card">
                        <div class="form-group">
                            <label>Postmark Server API Token</label>
                            <input type="password" id="postmarkToken" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                            <p style="margin-top: 6px; font-size: 11px; color: var(--text-light);">
                                Find this in your Postmark dashboard under Server  API Tokens
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label>Sender Email Address</label>
                            <input type="email" id="emailFromAddress" placeholder="appointments@yourdomain.com">
                            <p style="margin-top: 6px; font-size: 11px; color: var(--text-light);">
                                Must be a verified sender signature in Postmark
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label>Sender Name</label>
                            <input type="text" id="emailFromName" placeholder="Your Practice Name">
                        </div>
                    </div>
                    
                    <div class="email-settings-card">
                        <h4 style="margin-bottom: 16px; color: var(--forest);">Notification Settings</h4>
                        
                        <div class="email-toggle-row">
                            <div>
                                <div class="email-toggle-label">Enable Email Notifications</div>
                                <div class="email-toggle-desc">Master switch for all email notifications</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="emailNotificationsEnabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="email-toggle-row">
                            <div>
                                <div class="email-toggle-label">Client Confirmations</div>
                                <div class="email-toggle-desc">Send booking confirmations and updates to clients</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="sendClientConfirmations" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="email-toggle-row">
                            <div>
                                <div class="email-toggle-label">Staff Notifications</div>
                                <div class="email-toggle-desc">Notify staff when sessions are booked or changed</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="sendStaffNotifications" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="email-toggle-row">
                            <div>
                                <div class="email-toggle-label">Daily Schedule Summaries</div>
                                <div class="email-toggle-desc">Send staff their next day's schedule at 6 PM with client history</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="sendDaySummaries" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn-primary" onclick="saveEmailSettings()">Save Email Settings</button>
                        <button class="btn-secondary" onclick="sendTestEmail()">Send Test Email</button>
                    </div>
                </div>
                
                <!-- Currency Settings Section (Owner/Admin Only) -->
                <div id="currencySection" class="settings-section" style="display: none;">
                    <h3> Currency & Tax Settings</h3>
                    
                    <div class="form-group">
                        <label>Currency</label>
                        <div class="currency-selector" id="currencySelector">
                            <div class="currency-option selected" data-currency="CAD">
                                <div class="currency-code">CAD $</div>
                                <div class="currency-name">Canadian Dollar</div>
                            </div>
                            <div class="currency-option" data-currency="USD">
                                <div class="currency-code">USD $</div>
                                <div class="currency-name">US Dollar</div>
                            </div>
                            <div class="currency-option" data-currency="EUR">
                                <div class="currency-code">EUR </div>
                                <div class="currency-name">Euro</div>
                            </div>
                            <div class="currency-option" data-currency="GBP">
                                <div class="currency-code">GBP </div>
                                <div class="currency-name">British Pound</div>
                            </div>
                            <div class="currency-option" data-currency="AUD">
                                <div class="currency-code">AUD $</div>
                                <div class="currency-name">Australian Dollar</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Default Tax Rate (%)</label>
                        <input type="number" id="defaultTaxRate" placeholder="13" min="0" max="50" step="0.01" style="width: 120px;">
                        <p style="margin-top: 6px; font-size: 11px; color: var(--text-light);">
                            e.g., 13% for Ontario HST, 5% for GST only
                        </p>
                    </div>
                    
                    <button class="btn-primary" onclick="saveCurrencySettings()" style="margin-top: 20px;">Save Currency Settings</button>
                </div>
                
                <!-- Historical Income Import Section (Owner/Admin Only) -->
                <div id="incomeImportSection" class="settings-section" style="display: none;">
                    <h3> Historical Income Data</h3>
                    <p style="margin-bottom: 20px; font-size: 13px; color: var(--text-light);">
                        Import historical income data or add manual entries for months before you started using MyoMesh.
                    </p>
                    
                    <!-- Manual Entry -->
                    <div class="email-settings-card" style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 16px; color: var(--forest);">Add Manual Entry</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Month</label>
                                <select id="manualEntryMonth">
                                    <option value="01">January</option>
                                    <option value="02">February</option>
                                    <option value="03">March</option>
                                    <option value="04">April</option>
                                    <option value="05">May</option>
                                    <option value="06">June</option>
                                    <option value="07">July</option>
                                    <option value="08">August</option>
                                    <option value="09">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Year</label>
                                <select id="manualEntryYear"></select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Subtotal</label>
                                <input type="number" id="manualEntrySubtotal" placeholder="0.00" step="0.01" min="0">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Tax Collected</label>
                                <input type="number" id="manualEntryTax" placeholder="0.00" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 12px;">
                            <label>Notes (optional)</label>
                            <input type="text" id="manualEntryNotes" placeholder="e.g., Pre-MyoMesh records from QuickBooks">
                        </div>
                        <button class="btn-primary" onclick="addManualIncomeEntry()" style="margin-top: 12px;">Add Entry</button>
                    </div>
                    
                    <!-- CSV Import -->
                    <div class="import-export-section">
                        <h4 style="margin-bottom: 16px; color: var(--forest);">Import from CSV</h4>
                        <p style="font-size: 13px; color: var(--text-light); margin-bottom: 16px;">
                            Upload a CSV file with your historical income data. 
                            <a href="#" onclick="downloadIncomeTemplate()" style="color: var(--coral);">Download template</a>
                        </p>
                        
                        <div class="import-dropzone" id="incomeImportDropzone" onclick="document.getElementById('incomeFileInput').click()">
                            <div class="import-icon"></div>
                            <div style="font-weight: 600; color: var(--text);">Drop CSV file here or click to browse</div>
                            <div style="font-size: 12px; color: var(--text-light); margin-top: 8px;">Supported: .csv files</div>
                        </div>
                        <input type="file" id="incomeFileInput" accept=".csv" style="display: none;" onchange="handleIncomeFileSelect(event)">
                        
                        <div class="import-preview" id="importPreview">
                            <h4 style="margin-bottom: 12px;">Preview Import</h4>
                            <div id="importPreviewContent"></div>
                            <div class="btn-group" style="margin-top: 16px;">
                                <button class="btn-primary" onclick="confirmIncomeImport()">Import Data</button>
                                <button class="btn-secondary" onclick="cancelIncomeImport()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Section (Owner Only) -->
                <div id="userManagementSection"></div>

                <!-- QuickBooks Integration (Owner/Admin Only) -->
                <div id="quickbooksSection"></div>

            </div>
        </div>

     <script>

        // ========================================
        // FIREBASE CONFIGURATION
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyD_BGXX9kB8EPKKln6WYrK0QN1abKaufNA",
            authDomain: "flow-crm-2026rl.firebaseapp.com",
            projectId: "flow-crm-2026rl",
            storageBucket: "flow-crm-2026rl.firebasestorage.app",
            messagingSenderId: "233927450484",
            appId: "1:233927450484:web:cdd4852347e8450dbbd621"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Current user data
        let currentUser = null;
        let currentUserData = null;
        let organizationId = null;

        // ========================================
        // AUTH - SIMPLE FIX: WAIT BEFORE CHECKING
        // ========================================
        
        // Don't do anything until page fully loads
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, waiting for Firebase auth...');
            
            // Give Firebase 2 seconds to restore the session
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Now check if user exists
            const user = auth.currentUser;
            console.log('After 2s wait, currentUser is:', user ? user.email : 'NULL');
            
            if (user) {
                // User is logged in!
                await loadUserAndInitialize(user);
            } else {
                // No user after waiting - redirect to login
                console.log('No user found - redirecting to login');
                window.location.href = 'login.html';
            }
            
            // Set up listener for future sign-outs only
            auth.onAuthStateChanged((u) => {
                if (!u && currentUser) {
                    console.log('User signed out');
                    window.location.href = 'login.html';
                }
            });
        });
        
        async function loadUserAndInitialize(user) {
            currentUser = user;
            console.log('Loading data for user:', user.email);
            
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    currentUserData = userDoc.data();
                    organizationId = currentUserData.organizationId;
                    
                    // Update UI with user info
                    document.getElementById('userName').textContent = currentUserData.fullName;
                    const displayRole = currentUserData.role === 'teacher' ? 'Staff' : currentUserData.role.charAt(0).toUpperCase() + currentUserData.role.slice(1);
                    document.getElementById('userRole').textContent = displayRole;
                    
                    // Load organization data
                    await loadOrgSettings();
                    await loadData();
                    
                    // Initialize Lucide icons
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                    
                    console.log('SUCCESS! Dashboard loaded for:', user.email);
                } else {
                    console.error('User document not found');
                    handleLogout();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadOrgSettings() {
            try {
                const orgDoc = await db.collection('organizations').doc(organizationId).get();
                if (orgDoc.exists) {
                    const orgData = orgDoc.data();
                    document.getElementById('mainStudioName').textContent = orgData.name || 'MyoMesh';
                }
            } catch (error) {
                console.error('Error loading org settings:', error);
            }
        }



        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        
        function getOrgCollection(collectionName) {
            return db.collection('organizations').doc(organizationId).collection(collectionName);
        }

        function isOwnerOrAdmin() {
            return currentUserData && (currentUserData.role === 'owner' || currentUserData.role === 'admin');
        }

        function canManageUsers() {
            return currentUserData && currentUserData.role === 'owner';
        }

        function canAccessSettings() {
            return isOwnerOrAdmin();
        }

        function getCurrentUserData() {
            return currentUserData;
        }

        function getOrgKey(key) {
            return `${key}_${organizationId}`;
        }

        function isOwner() {
            return currentUserData && currentUserData.role === 'owner';
        }

        function isAdmin() {
            return currentUserData && currentUserData.role === 'admin';
        }

        function isTeacher() {
            return currentUserData && currentUserData.role === 'teacher';
        }

        function canAccessFinancials() {
            return isOwnerOrAdmin();
        }
         
        // ========================================
        // DATA STORAGE (FIRESTORE)
        // ========================================
        
        let clients = [];
        let sessions = [];
        let staffMembers = []; // Staff are now registered users with staff/admin roles
        let invoices = [];

        async function loadData() {
            try {
                // Load clients
                const clientsSnapshot = await getOrgCollection('clients').orderBy('createdAt', 'desc').get();
                clients = clientsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load sessions
                const sessionsSnapshot = await getOrgCollection('sessions').orderBy('date', 'desc').get();
                sessions = sessionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load staff from registered users (users with staff or admin role)
                const usersSnapshot = await getOrgCollection('users').get();
                staffMembers = usersSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(user => user.role === 'admin' || user.role === 'staff' || user.role === 'teacher');
                
                // Load invoices
                const invoicesSnapshot = await getOrgCollection('invoices').orderBy('createdAt', 'desc').get();
                invoices = invoicesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderClients();
                renderSessions();
                renderInvoices();
                populateStaffDropdowns();
                updateClientSelection();
                initClientSearch();
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function saveClient(clientData) {
            try {
                const docRef = await getOrgCollection('clients').add({
                    ...clientData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error('Error saving client:', error);
                throw error;
            }
        }

        async function updateClient(clientId, clientData) {
            try {
                await getOrgCollection('clients').doc(clientId).update(clientData);
            } catch (error) {
                console.error('Error updating client:', error);
                throw error;
            }
        }

        async function deleteClientFromDb(clientId) {
            try {
                await getOrgCollection('clients').doc(clientId).delete();
            } catch (error) {
                console.error('Error deleting client:', error);
                throw error;
            }
        }

        async function saveSession(sessionData) {
            try {
                const docRef = await getOrgCollection('sessions').add({
                    ...sessionData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error('Error saving session:', error);
                throw error;
            }
        }

        async function deleteSessionFromDb(sessionId) {
            try {
                await getOrgCollection('sessions').doc(sessionId).delete();
            } catch (error) {
                console.error('Error deleting session:', error);
                throw error;
            }
        }

        async function saveInvoice(invoiceData) {
            try {
                const docRef = await getOrgCollection('invoices').add({
                    ...invoiceData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error('Error saving invoice:', error);
                throw error;
            }
        }

        // Legacy saveData function for compatibility
        function saveData() {
            // Data is now saved directly to Firestore
            // This function is kept for compatibility
        }

        // ========================================
        // TAB SWITCHING
        // ========================================
        
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'settings') {
                loadSettings();
            }
            
            if (tabName === 'calendar') {
                renderCalendar();
                initClientSearch();
                populateStaffDropdowns();
            }
            
            if (tabName === 'notes') {
                initNotesTab();
            }
        }

        // ========================================
        // LOGOUT
        // ========================================
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut().then(() => {
                    window.location.href = 'login.html';
                }).catch((error) => {
                    console.error('Logout error:', error);
                });
            }
        }

        // ========================================
        // VISUAL CALENDAR SYSTEM
        // ========================================
        
        let calendarCurrentDate = new Date();
        let calendarView = 'week'; // 'day' or 'week'
        let calendarSelectedTeacher = 'all';
        
        const teacherColors = [
            '#1E3A34', '#9B6BB3', '#D4A574', '#5F8575', '#C86B5D',
            '#4A6B5D', '#7B5EA7', '#E8A87C', '#6FA287', '#B85C4D'
        ];
        
        function getTeacherColor(index) {
            return teacherColors[index % teacherColors.length];
        }
        
        function formatCalendarDate(date) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            return `${months[date.getMonth()]} ${date.getFullYear()}`;
        }
        
        function formatDayHeader(date) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return {
                dayName: days[date.getDay()],
                dayNumber: date.getDate()
            };
        }
        
        function getWeekDates(date) {
            const week = [];
            const start = new Date(date);
            start.setDate(start.getDate() - start.getDay()); // Start from Sunday
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(start);
                day.setDate(start.getDate() + i);
                week.push(day);
            }
            return week;
        }
        
        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }
        
        function isSameDay(date1, date2) {
            return date1.toDateString() === date2.toDateString();
        }
        
        function getSessionsForDate(date, teacherFilter = 'all') {
            return sessions.filter(session => {
                const sessionDate = new Date(session.date);
                const sameDay = isSameDay(sessionDate, date);
                const teacherMatch = teacherFilter === 'all' || session.teacherName === teacherFilter;
                return sameDay && teacherMatch;
            });
        }
        
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        function minutesToTop(minutes) {
            // Each hour slot is 60px, starting from 6 AM (360 minutes)
            const startMinutes = 6 * 60; // 6 AM
            return ((minutes - startMinutes) / 60) * 60;
        }
        
        function renderCalendar() {
            updateCalendarTitle();
            renderTeacherFilters();
            
            if (calendarView === 'week') {
                renderWeekView();
            } else {
                renderDayView();
            }
        }
        
        function updateCalendarTitle() {
            const titleEl = document.getElementById('calendarTitle');
            if (!titleEl) return;
            
            if (calendarView === 'week') {
                const weekDates = getWeekDates(calendarCurrentDate);
                const startMonth = weekDates[0].toLocaleDateString('en-US', { month: 'short' });
                const endMonth = weekDates[6].toLocaleDateString('en-US', { month: 'short' });
                const year = weekDates[0].getFullYear();
                
                if (startMonth === endMonth) {
                    titleEl.textContent = `${startMonth} ${weekDates[0].getDate()} - ${weekDates[6].getDate()}, ${year}`;
                } else {
                    titleEl.textContent = `${startMonth} ${weekDates[0].getDate()} - ${endMonth} ${weekDates[6].getDate()}, ${year}`;
                }
            } else {
                titleEl.textContent = calendarCurrentDate.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'long', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
            }
        }
        
        function renderStaffFilters() {
            const container = document.getElementById('teacherFilterList');
            if (!container) return;
            
            // Update all sessions count
            const allCount = document.getElementById('allSessionsCount');
            if (allCount) {
                const weekDates = calendarView === 'week' ? getWeekDates(calendarCurrentDate) : [calendarCurrentDate];
                let totalSessions = 0;
                weekDates.forEach(date => {
                    totalSessions += getSessionsForDate(date).length;
                });
                allCount.textContent = `${totalSessions} session${totalSessions !== 1 ? 's' : ''}`;
            }
            
            if (staffMembers.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-light); font-size: 13px;">
                        No staff registered yet.<br>Invite staff in Settings.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = staffMembers.map((staff, index) => {
                const displayName = staff.displayName || staff.name || staff.email;
                const weekDates = calendarView === 'week' ? getWeekDates(calendarCurrentDate) : [calendarCurrentDate];
                let staffSessions = 0;
                weekDates.forEach(date => {
                    staffSessions += getSessionsForDate(date, displayName).length;
                });
                
                const isSelected = calendarSelectedTeacher === displayName;
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                const color = staff.paused ? 'var(--text-light)' : getTeacherColor(index);
                const pausedLabel = staff.paused ? '<span style="font-size: 10px; color: var(--text-light); margin-left: 4px;">(Paused)</span>' : '';
                
                return `
                    <div class="teacher-filter-item ${isSelected ? 'selected' : ''} ${staff.paused ? 'paused' : ''}" onclick="filterByTeacher('${displayName}')" style="${staff.paused ? 'opacity: 0.6;' : ''}">
                        <div class="teacher-avatar" style="background: ${color};">${initials}</div>
                        <div>
                            <div class="teacher-filter-name">${displayName}${pausedLabel}</div>
                            <div class="teacher-filter-sessions">${staffSessions} session${staffSessions !== 1 ? 's' : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterByTeacher(teacherName) {
            calendarSelectedTeacher = teacherName;
            
            // Update selected state in sidebar
            document.querySelectorAll('.teacher-filter-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            renderCalendar();
        }
        
        function renderWeekView() {
            const container = document.getElementById('calendarContent');
            if (!container) return;
            
            const weekDates = getWeekDates(calendarCurrentDate);
            const hours = generateHours();
            
            let html = `
                <div class="calendar-grid week-view">
                    <!-- Time column header -->
                    <div class="calendar-day-header" style="background: var(--bg);"></div>
                    
                    <!-- Day headers -->
                    ${weekDates.map(date => {
                        const { dayName, dayNumber } = formatDayHeader(date);
                        const todayClass = isToday(date) ? 'today' : '';
                        return `
                            <div class="calendar-day-header ${todayClass}">
                                <div class="day-name">${dayName}</div>
                                <div class="day-number">${dayNumber}</div>
                            </div>
                        `;
                    }).join('')}
                    
                    <!-- Time column -->
                    <div class="time-column">
                        ${hours.map(hour => `
                            <div class="time-slot-label">${hour}</div>
                        `).join('')}
                    </div>
                    
                    <!-- Day columns -->
                    ${weekDates.map(date => renderDayColumn(date, hours)).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function renderDayView() {
            const container = document.getElementById('calendarContent');
            if (!container) return;
            
            const hours = generateHours();
            const date = calendarCurrentDate;
            const { dayName, dayNumber } = formatDayHeader(date);
            const todayClass = isToday(date) ? 'today' : '';
            
            let html = `
                <div class="calendar-grid day-view">
                    <!-- Time column header -->
                    <div class="calendar-day-header" style="background: var(--bg);"></div>
                    
                    <!-- Day header -->
                    <div class="calendar-day-header ${todayClass}">
                        <div class="day-name">${dayName}</div>
                        <div class="day-number">${dayNumber}</div>
                    </div>
                    
                    <!-- Time column -->
                    <div class="time-column">
                        ${hours.map(hour => `
                            <div class="time-slot-label">${hour}</div>
                        `).join('')}
                    </div>
                    
                    <!-- Day column -->
                    ${renderDayColumn(date, hours)}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function generateHours() {
            const hours = [];
            for (let i = 6; i <= 21; i++) { // 6 AM to 9 PM
                const hour = i % 12 || 12;
                const ampm = i < 12 ? 'AM' : 'PM';
                hours.push(`${hour}:00 ${ampm}`);
            }
            return hours;
        }
        
        function renderDayColumn(date, hours) {
            const dateStr = date.toISOString().split('T')[0];
            const daySessions = getSessionsForDate(date, calendarSelectedTeacher);
            
            let html = `<div class="day-column">`;
            
            // Render time slots
            for (let i = 6; i <= 21; i++) {
                const timeStr = `${String(i).padStart(2, '0')}:00`;
                html += `
                    <div class="time-slot" onclick="openQuickBook('${dateStr}', '${timeStr}')"></div>
                `;
            }
            
            // Render events
            daySessions.forEach(session => {
                const startMinutes = timeToMinutes(session.time);
                const top = minutesToTop(startMinutes);
                const duration = 60; // Default 1 hour
                const height = duration;
                
                const typeClass = session.type ? session.type.toLowerCase() : 'private';
                const clientNames = getClientNamesForSession(session);
                const timeDisplay = formatTimeDisplay(session.time);
                
                html += `
                    <div class="calendar-event ${typeClass}" 
                         style="top: ${top}px; height: ${height - 4}px;"
                         onclick="event.stopPropagation(); viewSessionDetails(${session.id})">
                        <div class="event-time">${timeDisplay}</div>
                        <div class="event-title">${session.type || 'Session'}</div>
                        <div class="event-client">${clientNames}</div>
                        <div class="event-icons">
                            ${session.teacherName ? '<span class="event-icon"></span>' : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            return html;
        }
        
        function getClientNamesForSession(session) {
            if (!session.clients || session.clients.length === 0) {
                return session.clientNames || 'No clients';
            }
            
            const names = session.clients.map(clientId => {
                const client = clients.find(c => c.id === clientId);
                return client ? client.name : 'Unknown';
            });
            
            if (names.length <= 2) {
                return names.join(' & ');
            }
            return `${names[0]} and ${names.length - 1} others`;
        }
        
        function formatTimeDisplay(timeStr) {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':').map(Number);
            const hour = hours % 12 || 12;
            const ampm = hours < 12 ? 'AM' : 'PM';
            return `${hour}:${String(minutes).padStart(2, '0')} ${ampm}`;
        }
        
        function setCalendarView(view) {
            calendarView = view;
            
            document.getElementById('dayViewBtn').classList.toggle('active', view === 'day');
            document.getElementById('weekViewBtn').classList.toggle('active', view === 'week');
            
            renderCalendar();
        }
        
        function calendarPrev() {
            if (calendarView === 'week') {
                calendarCurrentDate.setDate(calendarCurrentDate.getDate() - 7);
            } else {
                calendarCurrentDate.setDate(calendarCurrentDate.getDate() - 1);
            }
            renderCalendar();
        }
        
        function calendarNext() {
            if (calendarView === 'week') {
                calendarCurrentDate.setDate(calendarCurrentDate.getDate() + 7);
            } else {
                calendarCurrentDate.setDate(calendarCurrentDate.getDate() + 1);
            }
            renderCalendar();
        }
        
        function goToToday() {
            calendarCurrentDate = new Date();
            renderCalendar();
        }
        
        // ========================================
        // QUICK BOOK MODAL
        // ========================================
        
        let quickBookDate = null;
        let quickBookTime = null;
        
        let qbSelectedClients = [];
        let qbMaxClients = 1;
        
        function openQuickBook(dateStr, timeStr) {
            quickBookDate = dateStr;
            quickBookTime = timeStr;
            
            const date = new Date(dateStr + 'T' + timeStr);
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'short', 
                day: 'numeric' 
            });
            const formattedTime = formatTimeDisplay(timeStr);
            
            document.getElementById('quickBookSubtitle').textContent = `${formattedDate} at ${formattedTime}`;
            
            // Populate staff dropdown from registered users
            const teacherSelect = document.getElementById('qbTeacher');
            teacherSelect.innerHTML = '<option value="">Select staff...</option>';
            staffMembers.forEach(staff => {
                const displayName = staff.displayName || staff.name || staff.email;
                teacherSelect.innerHTML += `<option value="${displayName}" data-email="${staff.email}">${displayName}</option>`;
            });
            
            // Pre-select staff if filtered
            if (calendarSelectedTeacher !== 'all') {
                teacherSelect.value = calendarSelectedTeacher;
            }
            
            // Reset client selection
            qbSelectedClients = [];
            updateQuickBookClients();
            initQbClientSearch();
            
            // Reset form
            document.getElementById('qbSessionType').value = '';
            document.getElementById('qbNotes').value = '';
            document.getElementById('qbClientSearchInput').value = '';
            document.getElementById('qbClientSearchInput').disabled = false;
            document.getElementById('qbClientSearchInput').placeholder = 'Type to search clients...';
            document.getElementById('qbSelectedClients').innerHTML = '';
            
            document.getElementById('quickBookModal').classList.add('active');
        }
        
        function closeQuickBookModal() {
            document.getElementById('quickBookModal').classList.remove('active');
            quickBookDate = null;
            quickBookTime = null;
            qbSelectedClients = [];
        }
        
        function updateQuickBookClients() {
            const sessionType = document.getElementById('qbSessionType').value;
            
            // Set max clients based on session type
            qbMaxClients = 1;
            if (sessionType === 'Duet') qbMaxClients = 2;
            if (sessionType === 'Trio') qbMaxClients = 3;
            
            // Clear selection when session type changes
            qbSelectedClients = [];
            document.getElementById('qbSelectedClients').innerHTML = '';
            const searchInput = document.getElementById('qbClientSearchInput');
            if (searchInput) {
                searchInput.value = '';
                searchInput.disabled = false;
                searchInput.placeholder = 'Type to search clients...';
            }
        }
        
        function initQbClientSearch() {
            const searchInput = document.getElementById('qbClientSearchInput');
            const resultsContainer = document.getElementById('qbClientSearchResults');
            
            if (!searchInput || !resultsContainer) return;
            
            // Remove existing listeners by cloning
            const newSearchInput = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(newSearchInput, searchInput);
            
            // Search as user types
            newSearchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length === 0) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                // Filter clients by name
                const matchingClients = clients.filter(client => 
                    client.name.toLowerCase().includes(query) &&
                    !qbSelectedClients.includes(client.id)
                );
                
                if (matchingClients.length === 0) {
                    resultsContainer.innerHTML = '<div style="padding: 12px; color: var(--text-light); text-align: center;">No matching clients found</div>';
                    resultsContainer.style.display = 'block';
                    return;
                }
                
                resultsContainer.innerHTML = matchingClients.map(client => `
                    <div class="qb-client-search-result" onclick="selectQbClientFromSearch('${client.id}')" 
                         style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s;"
                         onmouseover="this.style.background='var(--bg)'" 
                         onmouseout="this.style.background='white'">
                        <div style="font-weight: 500;">${client.name}</div>
                        <div style="font-size: 12px; color: var(--text-light);">${client.email || 'No email'}</div>
                    </div>
                `).join('');
                resultsContainer.style.display = 'block';
            });
            
            newSearchInput.addEventListener('focus', function() {
                if (this.value.trim().length > 0) {
                    this.dispatchEvent(new Event('input'));
                }
            });
        }
        
        function selectQbClientFromSearch(clientId) {
            // Check if already at max
            if (qbSelectedClients.length >= qbMaxClients) {
                alert(`Maximum ${qbMaxClients} client(s) for this session type.`);
                return;
            }
            
            // Add client if not already selected
            if (!qbSelectedClients.includes(clientId)) {
                qbSelectedClients.push(clientId);
                updateQbSelectedClientsDisplay();
            }
            
            // Clear search input and hide results
            const searchInput = document.getElementById('qbClientSearchInput');
            const resultsContainer = document.getElementById('qbClientSearchResults');
            if (searchInput) searchInput.value = '';
            if (resultsContainer) resultsContainer.style.display = 'none';
            
            // Disable search if at max
            if (qbSelectedClients.length >= qbMaxClients) {
                searchInput.placeholder = `Maximum ${qbMaxClients} client(s) selected`;
                searchInput.disabled = true;
            }
        }
        
        function updateQbSelectedClientsDisplay() {
            const chipsContainer = document.getElementById('qbSelectedClients');
            if (!chipsContainer) return;
            
            chipsContainer.innerHTML = qbSelectedClients.map(clientId => {
                const client = clients.find(c => c.id === clientId);
                return client ? `
                    <span class="client-chip" data-client-id="${clientId}" style="display: inline-flex; align-items: center; gap: 8px; background: var(--primary); color: white; padding: 8px 12px; border-radius: 20px; margin: 4px; font-size: 13px;">
                        ${client.name}
                        <span onclick="removeQbClient('${clientId}')" style="cursor: pointer; font-weight: bold; font-size: 16px; line-height: 1;">&times;</span>
                    </span>
                ` : '';
            }).join('');
        }
        
        function removeQbClient(clientId) {
            const index = qbSelectedClients.indexOf(clientId);
            if (index > -1) {
                qbSelectedClients.splice(index, 1);
                updateQbSelectedClientsDisplay();
                
                // Re-enable search input
                const searchInput = document.getElementById('qbClientSearchInput');
                if (searchInput) {
                    searchInput.disabled = false;
                    searchInput.placeholder = 'Type to search clients...';
                }
            }
        }
        
        async function submitQuickBook(event) {
            event.preventDefault();
            
            const type = document.getElementById('qbSessionType').value;
            const teacher = document.getElementById('qbTeacher').value;
            const notes = document.getElementById('qbNotes').value;
            const selectedClients = qbSelectedClients;
            
            if (!type) {
                alert('Please select a session type');
                return;
            }
            
            if (!teacher) {
                alert('Please select a staff member');
                return;
            }
            
            if (selectedClients.length === 0) {
                alert('Please select at least one client');
                return;
            }
            
            // Get client names for display
            const clientNames = selectedClients.map(clientId => {
                const client = clients.find(c => c.id === clientId);
                return client ? client.name : 'Unknown';
            }).join(', ');
            
            try {
                const sessionData = {
                    type: type,
                    date: quickBookDate,
                    time: quickBookTime,
                    teacherName: teacher,
                    clients: selectedClients,
                    clientNames: clientNames,
                    notes: notes
                };
                
                await saveSession(sessionData);
                await loadData();
                
                closeQuickBookModal();
                renderCalendar();
                
                alert('Session booked successfully!');
            } catch (error) {
                alert('Error booking session: ' + error.message);
            }
        }
        
        async function viewSessionDetails(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const clientNames = getClientNamesForSession(session);
            const dateStr = new Date(session.date).toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'long', 
                day: 'numeric', 
                year: 'numeric' 
            });
            const timeStr = formatTimeDisplay(session.time);
            
            const details = `
Session Details:

Type: ${session.type || 'Session'}
Date: ${dateStr}
Time: ${timeStr}
Staff: ${session.teacherName || 'Not assigned'}
Client(s): ${clientNames}
${session.notes ? `Notes: ${session.notes}` : ''}
            `.trim();
            
            if (confirm(details + '\n\nWould you like to delete this session?')) {
                try {
                    await deleteSessionFromDb(sessionId);
                    await loadData();
                    renderCalendar();
                    alert('Session deleted.');
                } catch (error) {
                    alert('Error deleting session: ' + error.message);
                }
            }
        }
        
        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeQuickBookModal();
            }
        });
        
        // Close modal on background click
        document.getElementById('quickBookModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeQuickBookModal();
            }
        });

        // ========================================
        // CLIENT MANAGEMENT
        // ========================================
        
        function renderClients() {
            const container = document.getElementById('clientList');
            const countEl = document.getElementById('clientCount');
            
            if (countEl) {
                countEl.textContent = `${clients.length} Client${clients.length !== 1 ? 's' : ''}`;
            }
            
            if (!container) return;
            
            if (clients.length === 0) {
                container.innerHTML = '<p>No clients yet. Add your first client above.</p>';
                return;
            }
            
            container.innerHTML = clients.map((client, index) => `
                <div style="padding: 15px; background: var(--bg); border-radius: 8px; margin-bottom: 10px; cursor: pointer;" onclick="openClientProfile('${client.id}')">
                    <strong>${client.name}</strong><br>
                    Email: ${client.email || 'N/A'}<br>
                    Phone: ${client.phone || 'N/A'}
                    <div style="margin-top: 10px;" onclick="event.stopPropagation()">
                        <button class="btn-primary" onclick="openClientProfile('${client.id}')" style="margin-right: 5px;">View Profile</button>
                        <button class="btn-secondary" onclick="editClient(${index})" style="margin-right: 5px;">Edit</button>
                        <button class="btn-secondary" onclick="deleteClient(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function addClient(event) {
            event.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const ratePrivate = document.getElementById('ratePrivate').value;
            const rateDuet = document.getElementById('rateDuet').value;
            const rateTrio = document.getElementById('rateTrio').value;
            const waiver = document.getElementById('waiver').checked;
            const notes = document.getElementById('notes').value.trim();
            
            if (!name) {
                alert('Please enter a client name');
                return;
            }
            
            const clientData = {
                name: name,
                email: email,
                phone: phone,
                rates: {
                    private: parseFloat(ratePrivate) || 0,
                    duet: parseFloat(rateDuet) || 0,
                    trio: parseFloat(rateTrio) || 0
                },
                waiver: waiver,
                notes: notes
            };
            
            try {
                if (editingClientId) {
                    // Update existing client
                    await updateClient(editingClientId, clientData);
                    alert('Client updated successfully!');
                    cancelClientEdit();
                } else {
                    // Add new client
                    await saveClient(clientData);
                    document.getElementById('clientForm').reset();
                    alert('Client added successfully!');
                }
                await loadData();
            } catch (error) {
                console.error('Error saving client:', error);
                alert('Error saving client: ' + error.message);
            }
        }
        

        let editingClientId = null;
        
        function editClient(index) {
            const client = clients[index];
            editingClientId = client.id;
            
            // Populate form with client data
            document.getElementById('name').value = client.name || '';
            document.getElementById('email').value = client.email || '';
            document.getElementById('phone').value = client.phone || '';
            document.getElementById('ratePrivate').value = client.rates?.private || '';
            document.getElementById('rateDuet').value = client.rates?.duet || '';
            document.getElementById('rateTrio').value = client.rates?.trio || '';
            document.getElementById('waiver').checked = client.waiver || false;
            document.getElementById('notes').value = client.notes || '';
            
            // Update form UI to show edit mode
            document.getElementById('form-title').textContent = 'Edit Client';
            document.getElementById('submitBtn').textContent = 'Update Client';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            document.getElementById('cancelBtn').onclick = cancelClientEdit;
            
            // Scroll to form
            document.getElementById('clientForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelClientEdit() {
            editingClientId = null;
            document.getElementById('clientForm').reset();
            document.getElementById('form-title').textContent = 'Add New Client';
            document.getElementById('submitBtn').textContent = 'Add Client';
            document.getElementById('cancelBtn').style.display = 'none';
        }

        async function deleteClient(index) {
            if (confirm('Delete this client?')) {
                const client = clients[index];
                try {
                    await deleteClientFromDb(client.id);
                    await loadData();
                    alert('Client deleted successfully!');
                } catch (error) {
                    console.error('Error deleting client:', error);
                    alert('Error deleting client: ' + error.message);
                }
            }
        }

        // ========================================
        // CLIENT PROFILE & BODY CHART
        // ========================================
        
        let currentProfileClientId = null;
        let bodyChartMarkers = { front: [], back: [], left: [], right: [] };
        let currentPainSeverity = 'medium';
        let bodyChartTool = 'add';
        let markerCounter = 0;
        
        function openClientProfile(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            currentProfileClientId = clientId;
            
            // Populate client info
            document.getElementById('clientProfileName').textContent = client.name;
            document.getElementById('profileEmail').textContent = client.email || '-';
            document.getElementById('profilePhone').textContent = client.phone || '-';
            document.getElementById('profileRatePrivate').textContent = client.rates?.private ? `$${client.rates.private}` : '-';
            document.getElementById('profileRateDuet').textContent = client.rates?.duet ? `$${client.rates.duet}` : '-';
            document.getElementById('profileRateTrio').textContent = client.rates?.trio ? `$${client.rates.trio}` : '-';
            document.getElementById('profileWaiver').textContent = client.waiver ? ' Yes' : ' No';
            
            // Load appointments for this client
            loadClientAppointments(clientId);
            
            // Load notes preview
            loadClientNotesPreview(client);
            
            // Show modal
            document.getElementById('clientProfileModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function loadClientNotesPreview(client) {
            const container = document.getElementById('clientNotesPreview');
            if (!container) return;
            
            const notes = client.sessionNotes || [];
            
            if (notes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No notes recorded</p>';
                return;
            }
            
            // Show summary and recent notes
            const sortedNotes = notes.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
            const recentNotes = sortedNotes.slice(0, 3);
            
            container.innerHTML = `
                <div style="padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <strong style="color: var(--primary);">${notes.length} note${notes.length !== 1 ? 's' : ''} recorded</strong>
                </div>
                ${recentNotes.map(note => {
                    const sessionDate = note.sessionDate ? new Date(note.sessionDate + 'T00:00:00').toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    }) : 'No date';
                    
                    const hasMarkers = note.bodyChart && Object.values(note.bodyChart).some(arr => arr && arr.length > 0);
                    
                    return `
                        <div style="padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--primary);">
                            <div style="font-size: 12px; color: var(--text-light); margin-bottom: 5px;">
                                ${sessionDate} ${hasMarkers ? '  Body chart' : ''}
                            </div>
                            <div style="font-size: 13px; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${note.text ? note.text.substring(0, 80) + (note.text.length > 80 ? '...' : '') : '<em>Body chart only</em>'}
                            </div>
                        </div>
                    `;
                }).join('')}
                ${notes.length > 3 ? `<p style="text-align: center; color: var(--text-light); font-size: 12px;">+ ${notes.length - 3} more notes</p>` : ''}
            `;
        }
        
        function goToNotesForClient() {
            const clientId = currentProfileClientId;
            const client = clients.find(c => c.id === clientId);
            
            // Close profile modal
            closeClientProfile();
            
            // Switch to notes tab
            switchTab('notes', null);
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[onclick="switchTab(\'notes\', event)"]').classList.add('active');
            
            // Pre-select the client in the notes form
            if (client) {
                setTimeout(() => {
                    selectNotesClient(clientId);
                    
                    // Also filter history by this client
                    selectNotesHistoryClient(clientId, client.name);
                }, 100);
            }
        }
        
        function closeClientProfile() {
            document.getElementById('clientProfileModal').classList.remove('active');
            document.body.style.overflow = '';
            currentProfileClientId = null;
        }
        
        function loadClientAppointments(clientId) {
            const clientSessions = sessions.filter(s => 
                s.clients?.includes(clientId) || 
                s.clientNames?.toLowerCase().includes(clients.find(c => c.id === clientId)?.name?.toLowerCase() || '')
            );
            
            const container = document.getElementById('clientAppointmentsList');
            const totalEl = document.getElementById('profileTotalSessions');
            
            totalEl.textContent = clientSessions.length;
            
            if (clientSessions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No appointments found</p>';
                return;
            }
            
            const sorted = clientSessions.sort((a, b) => new Date(b.date) - new Date(a.date));
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            container.innerHTML = sorted.map(session => {
                const sessionDate = new Date(session.date);
                const isPast = sessionDate < today;
                const dateStr = sessionDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const timeStr = formatTimeDisplay(session.time);
                
                return `
                    <div class="appointment-item">
                        <div class="appointment-info">
                            <div class="appointment-type">${session.type || 'Session'}</div>
                            <div class="appointment-datetime">${dateStr} at ${timeStr}  ${session.teacherName || 'No staff'}</div>
                        </div>
                        <span class="appointment-status ${isPast ? 'past' : 'upcoming'}">${isPast ? 'Completed' : 'Upcoming'}</span>
                    </div>
                `;
            }).join('');
        }
        
        function loadBodyChartMarkers(client) {
            // Clear existing markers
            clearMarkersFromDOM();
            markerCounter = 0;
            
            // Load saved markers from client data
            bodyChartMarkers = client.bodyChart || { front: [], back: [], left: [], right: [] };
            
            // Render markers
            Object.keys(bodyChartMarkers).forEach(view => {
                bodyChartMarkers[view].forEach(marker => {
                    renderMarker(view, marker);
                });
            });
            
            // Update counter for new markers
            Object.values(bodyChartMarkers).forEach(markers => {
                markers.forEach(m => {
                    if (m.id > markerCounter) markerCounter = m.id;
                });
            });
        }
        
        function clearMarkersFromDOM() {
            document.querySelectorAll('.pain-marker').forEach(el => el.remove());
        }
        
        function setBodyChartTool(tool) {
            bodyChartTool = tool;
            document.getElementById('addMarkerTool').classList.toggle('active', tool === 'add');
            document.getElementById('removeMarkerTool').classList.toggle('active', tool === 'remove');
        }
        
        function setPainSeverity(severity) {
            currentPainSeverity = severity;
            document.querySelectorAll('.severity-btn').forEach(btn => {
                btn.classList.toggle('active', btn.classList.contains(severity));
            });
        }
        
        function addPainMarker(event, view) {
            if (bodyChartTool !== 'add') return;
            
            const container = event.currentTarget;
            const rect = container.getBoundingClientRect();
            
            // Calculate percentage position
            const x = ((event.clientX - rect.left) / rect.width) * 100;
            const y = ((event.clientY - rect.top) / rect.height) * 100;
            
            markerCounter++;
            
            const marker = {
                id: markerCounter,
                x: x,
                y: y,
                severity: currentPainSeverity,
                note: ''
            };
            
            bodyChartMarkers[view].push(marker);
            renderMarker(view, marker);
        }
        
        function renderMarker(view, marker) {
            const container = document.getElementById(`body${view.charAt(0).toUpperCase() + view.slice(1)}`);
            if (!container) return;
            
            const markerEl = document.createElement('div');
            markerEl.className = `pain-marker severity-${marker.severity}`;
            markerEl.style.left = `${marker.x}%`;
            markerEl.style.top = `${marker.y}%`;
            markerEl.textContent = marker.id;
            markerEl.dataset.markerId = marker.id;
            markerEl.dataset.view = view;
            markerEl.onclick = (e) => {
                e.stopPropagation();
                handleMarkerClick(marker.id, view);
            };
            
            container.appendChild(markerEl);
        }
        
        function handleMarkerClick(markerId, view) {
            if (bodyChartTool === 'remove') {
                // Remove marker
                bodyChartMarkers[view] = bodyChartMarkers[view].filter(m => m.id !== markerId);
                const markerEl = document.querySelector(`.pain-marker[data-marker-id="${markerId}"][data-view="${view}"]`);
                if (markerEl) markerEl.remove();
            } else {
                // Edit marker note
                const marker = bodyChartMarkers[view].find(m => m.id === markerId);
                if (marker) {
                    const note = prompt('Add a note for this pain point:', marker.note || '');
                    if (note !== null) {
                        marker.note = note;
                    }
                }
            }
        }
        
        function clearAllMarkers() {
            bodyChartMarkers = { front: [], back: [], left: [], right: [] };
            clearMarkersFromDOM();
            markerCounter = 0;
        }
        
        function loadClientNotes(client) {
            const container = document.getElementById('clientNotesList');
            const notes = client.sessionNotes || [];
            
            if (notes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-light);">No notes yet. Add your first note above.</p>';
                return;
            }
            
            // Sort notes by date (newest first)
            const sorted = [...notes].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sorted.map((note, index) => {
                const hasMarkers = note.bodyChart && (
                    note.bodyChart.front?.length > 0 ||
                    note.bodyChart.back?.length > 0 ||
                    note.bodyChart.left?.length > 0 ||
                    note.bodyChart.right?.length > 0
                );
                
                // Count markers by severity
                let mildCount = 0, moderateCount = 0, severeCount = 0;
                if (note.bodyChart) {
                    Object.values(note.bodyChart).forEach(markers => {
                        if (Array.isArray(markers)) {
                            markers.forEach(m => {
                                if (m.severity === 'low') mildCount++;
                                else if (m.severity === 'medium') moderateCount++;
                                else if (m.severity === 'high') severeCount++;
                            });
                        }
                    });
                }
                
                return `
                    <div class="note-item">
                        <div class="note-header">
                            <span class="note-date">${new Date(note.date).toLocaleDateString('en-US', { 
                                weekday: 'short',
                                month: 'short', 
                                day: 'numeric', 
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}</span>
                            <button class="note-delete" onclick="deleteClientNote(${index})"> Delete</button>
                        </div>
                        <div class="note-content">${note.text ? note.text.replace(/\n/g, '<br>') : '<em>Body chart only</em>'}</div>
                        
                        ${hasMarkers ? `
                            <div class="note-markers-summary">
                                ${mildCount > 0 ? `<div class="marker-count"><div class="marker-count-dot" style="background: #f1c40f;"></div>${mildCount} Mild</div>` : ''}
                                ${moderateCount > 0 ? `<div class="marker-count"><div class="marker-count-dot" style="background: #e67e22;"></div>${moderateCount} Moderate</div>` : ''}
                                ${severeCount > 0 ? `<div class="marker-count"><div class="marker-count-dot" style="background: #e74c3c;"></div>${severeCount} Severe</div>` : ''}
                                <button onclick="toggleNoteBodyChart(${index})" style="margin-left: auto; background: none; border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                     View Body Chart
                                </button>
                            </div>
                            <div class="note-body-chart" id="noteBodyChart${index}" style="display: none;">
                                ${renderNoteBodyChart(note.bodyChart)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function toggleNoteBodyChart(index) {
            const chart = document.getElementById(`noteBodyChart${index}`);
            if (chart) {
                chart.style.display = chart.style.display === 'none' ? 'grid' : 'none';
            }
        }
        
        function renderNoteBodyChart(bodyChart) {
            const views = ['front', 'back', 'left', 'right'];
            const viewBoxes = {
                front: '0 0 200 420',
                back: '0 0 200 420',
                left: '0 0 140 420',
                right: '0 0 140 420'
            };
            
            return views.map(view => {
                const markers = bodyChart[view] || [];
                
                return `
                    <div class="note-body-view">
                        <div class="note-body-view-label">${view.charAt(0).toUpperCase() + view.slice(1)}</div>
                        <div class="note-body-svg">
                            <svg viewBox="${viewBoxes[view]}" fill="none" xmlns="http://www.w3.org/2000/svg">
                                ${getBodySvgContent(view)}
                            </svg>
                            ${markers.map(m => `
                                <div class="note-pain-marker severity-${m.severity}" style="left: ${m.x}%; top: ${m.y}%;" title="${m.note || 'Pain point'}">
                                    ${m.id}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getBodySvgContent(view) {
            const svgContent = {
                front: `
                    <!-- Head -->
                    <ellipse cx="100" cy="32" rx="26" ry="30" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Ears -->
                    <ellipse cx="73" cy="32" rx="5" ry="9" fill="#F5E6D3" stroke="#2D2926" stroke-width="1"/>
                    <ellipse cx="127" cy="32" rx="5" ry="9" fill="#F5E6D3" stroke="#2D2926" stroke-width="1"/>
                    <!-- Neck -->
                    <path d="M88 58 L88 72 L112 72 L112 58" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Torso -->
                    <path d="M88 72 L60 82 L52 100 L50 140 L52 180 L58 200 L70 205 L100 210 L130 205 L142 200 L148 180 L150 140 L148 100 L140 82 L112 72 Z" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Chest details -->
                    <ellipse cx="80" cy="105" rx="10" ry="6" fill="none" stroke="#D4B896" stroke-width="1"/>
                    <ellipse cx="120" cy="105" rx="10" ry="6" fill="none" stroke="#D4B896" stroke-width="1"/>
                    <!-- Navel -->
                    <ellipse cx="100" cy="175" rx="4" ry="5" fill="#D4B896"/>
                    <!-- Left Arm -->
                    <path d="M52 100 L38 108 L28 130 L22 160 L18 190 L16 210 L14 225 C10 235 8 245 12 250 L22 252 L28 248 C32 242 30 235 28 225 L32 210 L36 180 L42 150 L50 120 L52 100" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Left Hand -->
                    <ellipse cx="17" cy="258" rx="10" ry="14" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Right Arm -->
                    <path d="M148 100 L162 108 L172 130 L178 160 L182 190 L184 210 L186 225 C190 235 192 245 188 250 L178 252 L172 248 C168 242 170 235 172 225 L168 210 L164 180 L158 150 L150 120 L148 100" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Right Hand -->
                    <ellipse cx="183" cy="258" rx="10" ry="14" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Pelvis/Hips -->
                    <path d="M70 205 L65 220 L68 235 L80 240 L100 242 L120 240 L132 235 L135 220 L130 205" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Left Leg -->
                    <path d="M80 240 L75 260 L70 300 L68 340 L66 370 L64 390 L62 400 C58 408 60 415 68 418 L82 418 C90 415 88 408 84 400 L82 390 L84 370 L86 340 L88 300 L90 260 L92 240" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Left Foot -->
                    <path d="M62 400 L55 405 L50 410 L48 415 L52 420 L75 420 L85 418 L84 400" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Left Knee -->
                    <ellipse cx="78" cy="300" rx="10" ry="8" fill="none" stroke="#D4B896" stroke-width="1"/>
                    <!-- Right Leg -->
                    <path d="M108 240 L110 260 L112 300 L114 340 L116 370 L118 390 L120 400 C124 408 122 415 114 418 L100 418 C92 415 94 408 98 400 L100 390 L98 370 L96 340 L94 300 L92 260 L90 240" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Right Foot -->
                    <path d="M120 400 L127 405 L132 410 L134 415 L130 420 L107 420 L97 418 L98 400" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Right Knee -->
                    <ellipse cx="104" cy="300" rx="10" ry="8" fill="none" stroke="#D4B896" stroke-width="1"/>
                `,
                back: `
                    <!-- Head -->
                    <ellipse cx="100" cy="32" rx="26" ry="30" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Ears -->
                    <ellipse cx="73" cy="32" rx="5" ry="9" fill="#F5E6D3" stroke="#2D2926" stroke-width="1"/>
                    <ellipse cx="127" cy="32" rx="5" ry="9" fill="#F5E6D3" stroke="#2D2926" stroke-width="1"/>
                    <!-- Neck -->
                    <path d="M88 58 L88 72 L112 72 L112 58" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Torso -->
                    <path d="M88 72 L60 82 L52 100 L50 140 L52 180 L58 200 L70 205 L100 210 L130 205 L142 200 L148 180 L150 140 L148 100 L140 82 L112 72 Z" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Spine -->
                    <path d="M100 72 L100 205" stroke="#D4B896" stroke-width="2" stroke-dasharray="4,3"/>
                    <!-- Shoulder blades -->
                    <path d="M72 95 Q68 115 78 135" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                    <path d="M128 95 Q132 115 122 135" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                    <!-- Lower back dimples -->
                    <circle cx="88" cy="190" r="4" fill="#D4B896"/>
                    <circle cx="112" cy="190" r="4" fill="#D4B896"/>
                    <!-- Left Arm -->
                    <path d="M52 100 L38 108 L28 130 L22 160 L18 190 L16 210 L14 225 C10 235 8 245 12 250 L22 252 L28 248 C32 242 30 235 28 225 L32 210 L36 180 L42 150 L50 120 L52 100" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Left Hand -->
                    <ellipse cx="17" cy="258" rx="10" ry="14" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Right Arm -->
                    <path d="M148 100 L162 108 L172 130 L178 160 L182 190 L184 210 L186 225 C190 235 192 245 188 250 L178 252 L172 248 C168 242 170 235 172 225 L168 210 L164 180 L158 150 L150 120 L148 100" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Right Hand -->
                    <ellipse cx="183" cy="258" rx="10" ry="14" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Pelvis/Hips (Buttocks) -->
                    <path d="M70 205 L65 220 L68 235 L80 240 L100 242 L120 240 L132 235 L135 220 L130 205" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <path d="M75 210 Q100 225 125 210" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                    <!-- Left Leg -->
                    <path d="M80 240 L75 260 L70 300 L68 340 L66 370 L64 390 L62 400 C58 408 60 415 68 418 L82 418 C90 415 88 408 84 400 L82 390 L84 370 L86 340 L88 300 L90 260 L92 240" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Left Foot -->
                    <path d="M62 400 L55 405 L50 410 L48 415 L52 420 L75 420 L85 418 L84 400" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Left Calf detail -->
                    <path d="M70 310 Q66 330 72 355" stroke="#D4B896" stroke-width="1" fill="none"/>
                    <!-- Right Leg -->
                    <path d="M108 240 L110 260 L112 300 L114 340 L116 370 L118 390 L120 400 C124 408 122 415 114 418 L100 418 C92 415 94 408 98 400 L100 390 L98 370 L96 340 L94 300 L92 260 L90 240" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Right Foot -->
                    <path d="M120 400 L127 405 L132 410 L134 415 L130 420 L107 420 L97 418 L98 400" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Right Calf detail -->
                    <path d="M112 310 Q116 330 110 355" stroke="#D4B896" stroke-width="1" fill="none"/>
                `,
                left: `
                    <!-- Head -->
                    <ellipse cx="70" cy="32" rx="22" ry="30" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Ear -->
                    <ellipse cx="48" cy="32" rx="5" ry="9" fill="#F5E6D3" stroke="#2D2926" stroke-width="1"/>
                    <!-- Neck -->
                    <path d="M60 58 L58 72 L82 72 L80 58" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Torso -->
                    <path d="M58 72 L45 80 L38 100 L35 130 L38 170 L42 200 L55 210 L85 210 L98 200 L102 170 L105 130 L102 100 L95 80 L82 72 Z" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Chest/Back curve -->
                    <path d="M45 85 Q38 110 42 145" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                    <path d="M95 85 Q102 115 98 155" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                    <!-- Arm -->
                    <path d="M38 100 L28 110 L20 135 L15 165 L12 195 L10 220 L10 240 C8 250 10 258 18 260 L26 258 C32 252 28 242 26 230 L28 200 L32 170 L38 140 L42 115 L45 100" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Hand -->
                    <ellipse cx="14" cy="268" rx="10" ry="14" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Pelvis -->
                    <path d="M55 210 L50 225 L52 238 L70 242 L88 238 L90 225 L85 210" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Leg -->
                    <path d="M60 240 L55 270 L52 310 L50 350 L48 380 L46 400 C42 410 45 418 55 420 L75 420 C85 418 82 410 78 400 L76 380 L78 350 L80 310 L82 270 L80 240" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Knee -->
                    <ellipse cx="66" cy="310" rx="12" ry="10" fill="none" stroke="#D4B896" stroke-width="1"/>
                    <!-- Foot -->
                    <path d="M46 400 L35 408 L28 415 L30 420 L80 420 L85 415 L78 400" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                `,
                right: `
                    <!-- Head -->
                    <ellipse cx="70" cy="32" rx="22" ry="30" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Ear -->
                    <ellipse cx="92" cy="32" rx="5" ry="9" fill="#F5E6D3" stroke="#2D2926" stroke-width="1"/>
                    <!-- Neck -->
                    <path d="M60 58 L58 72 L82 72 L80 58" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Torso -->
                    <path d="M58 72 L45 80 L38 100 L35 130 L38 170 L42 200 L55 210 L85 210 L98 200 L102 170 L105 130 L102 100 L95 80 L82 72 Z" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Chest/Back curve -->
                    <path d="M95 85 Q102 110 98 145" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                    <path d="M45 85 Q38 115 42 155" stroke="#D4B896" stroke-width="1.5" fill="none"/>
                    <!-- Arm -->
                    <path d="M102 100 L112 110 L120 135 L125 165 L128 195 L130 220 L130 240 C132 250 130 258 122 260 L114 258 C108 252 112 242 114 230 L112 200 L108 170 L102 140 L98 115 L95 100" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Hand -->
                    <ellipse cx="126" cy="268" rx="10" ry="14" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Pelvis -->
                    <path d="M55 210 L50 225 L52 238 L70 242 L88 238 L90 225 L85 210" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Leg -->
                    <path d="M60 240 L55 270 L52 310 L50 350 L48 380 L46 400 C42 410 45 418 55 420 L75 420 C85 418 82 410 78 400 L76 380 L78 350 L80 310 L82 270 L80 240" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                    <!-- Knee -->
                    <ellipse cx="66" cy="310" rx="12" ry="10" fill="none" stroke="#D4B896" stroke-width="1"/>
                    <!-- Foot -->
                    <path d="M46 400 L35 408 L28 415 L30 420 L80 420 L85 415 L78 400" fill="#F5E6D3" stroke="#2D2926" stroke-width="1.5"/>
                `
            };
            return svgContent[view] || '';
        }
        
        async function addClientNote() {
            const noteText = document.getElementById('newNoteText').value.trim();
            
            // Check if there are any markers OR text
            const hasMarkers = Object.values(bodyChartMarkers).some(arr => arr.length > 0);
            
            if (!noteText && !hasMarkers) {
                alert('Please enter a note or mark at least one area on the body chart');
                return;
            }
            
            const client = clients.find(c => c.id === currentProfileClientId);
            if (!client) return;
            
            const newNote = {
                date: new Date().toISOString(),
                text: noteText,
                bodyChart: JSON.parse(JSON.stringify(bodyChartMarkers)) // Deep copy
            };
            
            client.sessionNotes = client.sessionNotes || [];
            client.sessionNotes.push(newNote);
            
            // Save to Firestore
            try {
                await updateClient(currentProfileClientId, { sessionNotes: client.sessionNotes });
                
                // Clear form
                document.getElementById('newNoteText').value = '';
                bodyChartMarkers = { front: [], back: [], left: [], right: [] };
                clearMarkersFromDOM();
                markerCounter = 0;
                
                loadClientNotes(client);
                alert('Note saved successfully!');
            } catch (error) {
                console.error('Error adding note:', error);
                alert('Error adding note: ' + error.message);
            }
        }
        
        async function deleteClientNote(index) {
            if (!confirm('Delete this note and its body chart?')) return;
            
            const client = clients.find(c => c.id === currentProfileClientId);
            if (!client || !client.sessionNotes) return;
            
            // Sort notes to match display order (newest first), then find the original index
            const sorted = [...client.sessionNotes].sort((a, b) => new Date(b.date) - new Date(a.date));
            const noteToDelete = sorted[index];
            const originalIndex = client.sessionNotes.findIndex(n => n.date === noteToDelete.date);
            
            if (originalIndex > -1) {
                client.sessionNotes.splice(originalIndex, 1);
                
                try {
                    await updateClient(currentProfileClientId, { sessionNotes: client.sessionNotes });
                    loadClientNotes(client);
                } catch (error) {
                    console.error('Error deleting note:', error);
                    alert('Error deleting note: ' + error.message);
                }
            }
        }
        
        async function saveClientProfile() {
            alert('Notes are saved automatically when you click "Save Note with Body Chart"');
        }
        
        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('clientProfileModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeClientProfile();
                    }
                });
            }
            
            // Note view modal close handler
            const noteModal = document.getElementById('noteViewModal');
            if (noteModal) {
                noteModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeNoteViewModal();
                    }
                });
            }
        });

        // ========================================
        // NOTES TAB
        // ========================================
        
        let notesSelectedClientId = null;
        let notesBodyChartMarkers = { front: [], back: [], left: [], right: [] };
        let notesPainSeverity = 'medium';
        let notesMarkerCounter = 0;
        let notesHistoryFilterClientId = null;
        
        // Initialize notes tab when switched to
        function initNotesTab() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('notesSessionDate').value = today;
            
            // Initialize client search
            initNotesClientSearch();
            initNotesHistoryClientSearch();
            
            // Load notes history
            loadNotesHistory();
        }
        
        // Client search for notes form
        function initNotesClientSearch() {
            const searchInput = document.getElementById('notesClientSearch');
            const dropdown = document.getElementById('notesClientDropdown');
            
            if (!searchInput || !dropdown) return;
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 1) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                const matches = clients.filter(c => 
                    c.name.toLowerCase().includes(query) || 
                    (c.email && c.email.toLowerCase().includes(query))
                ).slice(0, 8);
                
                if (matches.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                dropdown.innerHTML = matches.map(client => `
                    <div class="client-search-item" onclick="selectNotesClient('${client.id}')">
                        <strong>${client.name}</strong>
                        <span style="color: var(--text-light); font-size: 12px;">${client.email || ''}</span>
                    </div>
                `).join('');
                dropdown.style.display = 'block';
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        function selectNotesClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            notesSelectedClientId = clientId;
            
            document.getElementById('notesClientSearch').value = '';
            document.getElementById('notesClientDropdown').style.display = 'none';
            document.getElementById('notesSelectedClient').innerHTML = `
                <span class="client-chip" style="display: inline-flex; align-items: center; gap: 8px; background: var(--primary); color: white; padding: 10px 15px; border-radius: 25px; font-size: 14px;">
                    ${client.name}
                    <span onclick="clearNotesClient()" style="cursor: pointer; font-weight: bold; font-size: 18px; line-height: 1;">&times;</span>
                </span>
            `;
        }
        
        function clearNotesClient() {
            notesSelectedClientId = null;
            document.getElementById('notesSelectedClient').innerHTML = '';
            document.getElementById('notesClientSearch').value = '';
        }
        
        // Pain severity for notes
        function setNotesPainSeverity(severity) {
            notesPainSeverity = severity;
            document.querySelectorAll('#notes-tab .severity-btn').forEach(btn => {
                btn.classList.toggle('active', btn.classList.contains(severity));
            });
        }
        
        // Body chart markers for notes
        function addNotesPainMarker(event, view) {
            const container = event.currentTarget;
            const rect = container.getBoundingClientRect();
            
            const x = ((event.clientX - rect.left) / rect.width) * 100;
            const y = ((event.clientY - rect.top) / rect.height) * 100;
            
            notesMarkerCounter++;
            
            const marker = {
                id: notesMarkerCounter,
                x: x,
                y: y,
                severity: notesPainSeverity,
                note: ''
            };
            
            notesBodyChartMarkers[view].push(marker);
            renderNotesMarker(view, marker);
        }
        
        function renderNotesMarker(view, marker) {
            const container = document.getElementById(`notesBody${view.charAt(0).toUpperCase() + view.slice(1)}`);
            if (!container) return;
            
            const markerEl = document.createElement('div');
            markerEl.className = `pain-marker severity-${marker.severity}`;
            markerEl.style.left = `${marker.x}%`;
            markerEl.style.top = `${marker.y}%`;
            markerEl.textContent = marker.id;
            markerEl.dataset.markerId = marker.id;
            markerEl.dataset.view = view;
            markerEl.onclick = (e) => {
                e.stopPropagation();
                removeNotesMarker(marker.id, view);
            };
            markerEl.title = 'Click to remove';
            
            container.appendChild(markerEl);
        }
        
        function removeNotesMarker(markerId, view) {
            notesBodyChartMarkers[view] = notesBodyChartMarkers[view].filter(m => m.id !== markerId);
            const markerEl = document.querySelector(`#notesBody${view.charAt(0).toUpperCase() + view.slice(1)} .pain-marker[data-marker-id="${markerId}"]`);
            if (markerEl) markerEl.remove();
        }
        
        function clearNotesBodyChart() {
            notesBodyChartMarkers = { front: [], back: [], left: [], right: [] };
            document.querySelectorAll('#notesBodyChart .pain-marker').forEach(el => el.remove());
            notesMarkerCounter = 0;
        }
        
        // Save session note
        async function saveSessionNote() {
            if (!notesSelectedClientId) {
                alert('Please select a client');
                return;
            }
            
            const sessionDate = document.getElementById('notesSessionDate').value;
            if (!sessionDate) {
                alert('Please select a session date');
                return;
            }
            
            const noteText = document.getElementById('notesTextArea').value.trim();
            const hasMarkers = Object.values(notesBodyChartMarkers).some(arr => arr.length > 0);
            
            if (!noteText && !hasMarkers) {
                alert('Please enter a note or mark at least one area on the body chart');
                return;
            }
            
            const client = clients.find(c => c.id === notesSelectedClientId);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            const newNote = {
                date: new Date().toISOString(),
                sessionDate: sessionDate,
                text: noteText,
                bodyChart: JSON.parse(JSON.stringify(notesBodyChartMarkers)),
                staffName: currentUserData?.fullName || currentUserData?.displayName || 'Staff'
            };
            
            client.sessionNotes = client.sessionNotes || [];
            client.sessionNotes.push(newNote);
            
            try {
                await updateClient(notesSelectedClientId, { sessionNotes: client.sessionNotes });
                
                // Clear form
                document.getElementById('notesTextArea').value = '';
                clearNotesBodyChart();
                clearNotesClient();
                document.getElementById('notesSessionDate').value = new Date().toISOString().split('T')[0];
                
                // Refresh notes history
                loadNotesHistory();
                
                alert('Session note saved successfully!');
            } catch (error) {
                console.error('Error saving note:', error);
                alert('Error saving note: ' + error.message);
            }
        }
        
        // Notes history search
        function initNotesHistoryClientSearch() {
            const searchInput = document.getElementById('notesHistoryClientSearch');
            const dropdown = document.getElementById('notesHistoryClientDropdown');
            
            if (!searchInput || !dropdown) return;
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 1) {
                    dropdown.style.display = 'none';
                    notesHistoryFilterClientId = null;
                    filterNotesHistory();
                    return;
                }
                
                const matches = clients.filter(c => 
                    c.name.toLowerCase().includes(query) || 
                    (c.email && c.email.toLowerCase().includes(query))
                ).slice(0, 8);
                
                if (matches.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                dropdown.innerHTML = matches.map(client => `
                    <div class="client-search-item" onclick="selectNotesHistoryClient('${client.id}', '${client.name.replace(/'/g, "\\'")}')">
                        <strong>${client.name}</strong>
                        <span style="color: var(--text-light); font-size: 12px;">${client.email || ''}</span>
                    </div>
                `).join('');
                dropdown.style.display = 'block';
            });
            
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        function selectNotesHistoryClient(clientId, clientName) {
            notesHistoryFilterClientId = clientId;
            document.getElementById('notesHistoryClientSearch').value = clientName;
            document.getElementById('notesHistoryClientDropdown').style.display = 'none';
            filterNotesHistory();
        }
        
        function clearNotesFilters() {
            notesHistoryFilterClientId = null;
            document.getElementById('notesHistoryClientSearch').value = '';
            document.getElementById('notesHistoryDateFilter').value = '';
            filterNotesHistory();
        }
        
        function filterNotesHistory() {
            loadNotesHistory();
        }
        
        // Load and display notes history
        function loadNotesHistory() {
            const container = document.getElementById('notesHistoryList');
            const countEl = document.getElementById('notesHistoryCount');
            const dateFilter = document.getElementById('notesHistoryDateFilter')?.value;
            
            if (!container) return;
            
            // Collect all notes from all clients
            let allNotes = [];
            clients.forEach(client => {
                if (client.sessionNotes && client.sessionNotes.length > 0) {
                    client.sessionNotes.forEach(note => {
                        allNotes.push({
                            ...note,
                            clientId: client.id,
                            clientName: client.name
                        });
                    });
                }
            });
            
            // Apply filters
            if (notesHistoryFilterClientId) {
                allNotes = allNotes.filter(n => n.clientId === notesHistoryFilterClientId);
            }
            
            if (dateFilter) {
                allNotes = allNotes.filter(n => n.sessionDate === dateFilter);
            }
            
            // Sort by date (newest first)
            allNotes.sort((a, b) => {
                const dateA = new Date(a.sessionDate || a.date);
                const dateB = new Date(b.sessionDate || b.date);
                return dateB - dateA;
            });
            
            countEl.textContent = `${allNotes.length} note${allNotes.length !== 1 ? 's' : ''} found`;
            
            if (allNotes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <div class="empty-text">${notesHistoryFilterClientId || dateFilter ? 'No notes match your filters' : 'No notes yet. Create your first session note above!'}</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allNotes.map((note, index) => {
                const hasMarkers = note.bodyChart && Object.values(note.bodyChart).some(arr => arr && arr.length > 0);
                let markerCount = 0;
                if (hasMarkers) {
                    Object.values(note.bodyChart).forEach(arr => {
                        if (Array.isArray(arr)) markerCount += arr.length;
                    });
                }
                
                const sessionDate = note.sessionDate ? new Date(note.sessionDate + 'T00:00:00').toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                }) : 'No date';
                
                const createdDate = new Date(note.date).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="note-item" style="cursor: pointer;" onclick="viewNoteDetail('${note.clientId}', ${clients.find(c => c.id === note.clientId)?.sessionNotes?.indexOf(note) || 0})">
                        <div class="note-header">
                            <div>
                                <strong style="color: var(--primary);">${note.clientName}</strong>
                                <span style="color: var(--text-light); font-size: 12px; margin-left: 10px;">Session: ${sessionDate}</span>
                            </div>
                            <span class="note-date">Created: ${createdDate}</span>
                        </div>
                        <div class="note-content" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            ${note.text ? note.text.replace(/\n/g, ' ').substring(0, 150) + (note.text.length > 150 ? '...' : '') : '<em style="color: var(--text-light);">Body chart only</em>'}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                ${hasMarkers ? `<span style="font-size: 12px; color: var(--text-light);"> ${markerCount} marker${markerCount !== 1 ? 's' : ''}</span>` : ''}
                                ${note.staffName ? `<span style="font-size: 12px; color: var(--text-light);"> ${note.staffName}</span>` : ''}
                            </div>
                            <span style="color: var(--primary); font-size: 12px; font-weight: 600;">View Details </span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // View note detail in modal
        function viewNoteDetail(clientId, noteIndex) {
            const client = clients.find(c => c.id === clientId);
            if (!client || !client.sessionNotes || !client.sessionNotes[noteIndex]) {
                // Try to find note by searching
                const allNotes = [];
                clients.forEach(c => {
                    if (c.sessionNotes) {
                        c.sessionNotes.forEach((n, i) => {
                            allNotes.push({ client: c, note: n, index: i });
                        });
                    }
                });
                
                const found = allNotes.find(item => item.client.id === clientId);
                if (found) {
                    showNoteInModal(found.client, found.note);
                } else {
                    alert('Note not found');
                }
                return;
            }
            
            showNoteInModal(client, client.sessionNotes[noteIndex]);
        }
        
        function showNoteInModal(client, note) {
            const sessionDate = note.sessionDate ? new Date(note.sessionDate + 'T00:00:00').toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            }) : 'No date';
            
            document.getElementById('noteViewTitle').textContent = `${client.name} - ${sessionDate}`;
            
            const hasMarkers = note.bodyChart && Object.values(note.bodyChart).some(arr => arr && arr.length > 0);
            
            let content = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <span style="color: var(--text-light); font-size: 13px;">Client:</span>
                            <strong style="margin-left: 5px;">${client.name}</strong>
                        </div>
                        <div>
                            <span style="color: var(--text-light); font-size: 13px;">Session Date:</span>
                            <strong style="margin-left: 5px;">${sessionDate}</strong>
                        </div>
                        ${note.staffName ? `
                            <div>
                                <span style="color: var(--text-light); font-size: 13px;">Staff:</span>
                                <strong style="margin-left: 5px;">${note.staffName}</strong>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            if (hasMarkers) {
                content += `
                    <div class="profile-section" style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px;"> Body Chart</h3>
                        <div class="note-body-chart" style="display: grid;">
                            ${renderNoteBodyChartForModal(note.bodyChart)}
                        </div>
                        <div class="body-chart-legend" style="margin-top: 15px;">
                            <div class="legend-item-body"><div class="legend-dot low"></div><span>1 - Mild</span></div>
                            <div class="legend-item-body"><div class="legend-dot medium"></div><span>2 - Moderate</span></div>
                            <div class="legend-item-body"><div class="legend-dot high"></div><span>3 - Severe</span></div>
                        </div>
                    </div>
                `;
            }
            
            content += `
                <div class="profile-section">
                    <h3 style="margin-bottom: 15px;"> Session Notes</h3>
                    <div style="background: white; padding: 20px; border-radius: 8px; line-height: 1.8;">
                        ${note.text ? note.text.replace(/\n/g, '<br>') : '<em style="color: var(--text-light);">No text notes recorded</em>'}
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: right; color: var(--text-light); font-size: 12px;">
                    Note created: ${new Date(note.date).toLocaleString()}
                </div>
            `;
            
            document.getElementById('noteViewContent').innerHTML = content;
            document.getElementById('noteViewModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function renderNoteBodyChartForModal(bodyChart) {
            const views = ['front', 'back', 'left', 'right'];
            const viewBoxes = {
                front: '0 0 200 420',
                back: '0 0 200 420',
                left: '0 0 140 420',
                right: '0 0 140 420'
            };
            
            return views.map(view => {
                const markers = bodyChart[view] || [];
                
                return `
                    <div class="note-body-view">
                        <div class="note-body-view-label">${view.charAt(0).toUpperCase() + view.slice(1)}</div>
                        <div class="note-body-svg">
                            <svg viewBox="${viewBoxes[view]}" fill="none" xmlns="http://www.w3.org/2000/svg">
                                ${getBodySvgContent(view)}
                            </svg>
                            ${markers.map(m => `
                                <div class="note-pain-marker severity-${m.severity}" style="left: ${m.x}%; top: ${m.y}%;" title="Marker ${m.id}">
                                    ${m.id}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function closeNoteViewModal() {
            document.getElementById('noteViewModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // ========================================
        // SESSION MANAGEMENT
        // ========================================
        
        function populateStaffDropdowns() {
            // Filter out paused staff for new bookings
            const activeStaff = staffMembers.filter(s => !s.paused);
            
            // Populate the session form staff dropdown
            const sessionTeacherSelect = document.getElementById('sessionTeacher');
            if (sessionTeacherSelect) {
                sessionTeacherSelect.innerHTML = '<option value="">Select staff...</option>';
                activeStaff.forEach(staff => {
                    const displayName = staff.displayName || staff.name || staff.email;
                    sessionTeacherSelect.innerHTML += `<option value="${displayName}" data-email="${staff.email}">${displayName}</option>`;
                });
            }
            
            // Also update calendar staff filters (include all for history viewing)
            renderStaffFilters();
        }
        
        let selectedSessionClients = [];
        let maxSessionClients = 1;
        
        function updateClientSelection() {
            const chipsContainer = document.getElementById('selectedClients');
            const searchInput = document.getElementById('clientSearchInput');
            const sessionType = document.getElementById('sessionType').value;
            
            // Clear selected clients when session type changes
            selectedSessionClients = [];
            if (chipsContainer) chipsContainer.innerHTML = '';
            if (searchInput) searchInput.value = '';
            
            // Set max clients based on session type
            maxSessionClients = 1;
            if (sessionType === 'Duet') maxSessionClients = 2;
            if (sessionType === 'Trio') maxSessionClients = 3;
            
            // Hide search results
            const resultsContainer = document.getElementById('clientSearchResults');
            if (resultsContainer) resultsContainer.style.display = 'none';
        }
        
        function initClientSearch() {
            const searchInput = document.getElementById('clientSearchInput');
            const resultsContainer = document.getElementById('clientSearchResults');
            
            if (!searchInput || !resultsContainer) return;
            
            // Search as user types
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length === 0) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                // Filter clients by name
                const matchingClients = clients.filter(client => 
                    client.name.toLowerCase().includes(query) &&
                    !selectedSessionClients.includes(client.id)
                );
                
                if (matchingClients.length === 0) {
                    resultsContainer.innerHTML = '<div style="padding: 12px; color: var(--text-light); text-align: center;">No matching clients found</div>';
                    resultsContainer.style.display = 'block';
                    return;
                }
                
                resultsContainer.innerHTML = matchingClients.map(client => `
                    <div class="client-search-result" onclick="selectClientFromSearch('${client.id}')" 
                         style="padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s;"
                         onmouseover="this.style.background='var(--bg)'" 
                         onmouseout="this.style.background='white'">
                        <div style="font-weight: 500;">${client.name}</div>
                        <div style="font-size: 12px; color: var(--text-light);">${client.email || 'No email'}</div>
                    </div>
                `).join('');
                resultsContainer.style.display = 'block';
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                    resultsContainer.style.display = 'none';
                }
            });
            
            // Show results when focusing on input
            searchInput.addEventListener('focus', function() {
                if (this.value.trim().length > 0) {
                    this.dispatchEvent(new Event('input'));
                }
            });
        }
        
        function selectClientFromSearch(clientId) {
            // Check if already at max
            if (selectedSessionClients.length >= maxSessionClients) {
                alert(`Maximum ${maxSessionClients} client(s) for this session type.`);
                return;
            }
            
            // Add client if not already selected
            if (!selectedSessionClients.includes(clientId)) {
                selectedSessionClients.push(clientId);
                updateSelectedClientsDisplay();
            }
            
            // Clear search input and hide results
            const searchInput = document.getElementById('clientSearchInput');
            const resultsContainer = document.getElementById('clientSearchResults');
            if (searchInput) searchInput.value = '';
            if (resultsContainer) resultsContainer.style.display = 'none';
            
            // Disable search if at max
            if (selectedSessionClients.length >= maxSessionClients) {
                searchInput.placeholder = `Maximum ${maxSessionClients} client(s) selected`;
                searchInput.disabled = true;
            }
        }
        
        function updateSelectedClientsDisplay() {
            const chipsContainer = document.getElementById('selectedClients');
            if (!chipsContainer) return;
            
            chipsContainer.innerHTML = selectedSessionClients.map(clientId => {
                const client = clients.find(c => c.id === clientId);
                return client ? `
                    <span class="client-chip" data-client-id="${clientId}" style="display: inline-flex; align-items: center; gap: 8px; background: var(--primary); color: white; padding: 8px 12px; border-radius: 20px; margin: 4px; font-size: 13px;">
                        ${client.name}
                        <span onclick="removeSessionClient('${clientId}')" style="cursor: pointer; font-weight: bold; font-size: 16px; line-height: 1;">&times;</span>
                    </span>
                ` : '';
            }).join('');
        }
        
        function removeSessionClient(clientId) {
            const index = selectedSessionClients.indexOf(clientId);
            if (index > -1) {
                selectedSessionClients.splice(index, 1);
                updateSelectedClientsDisplay();
                
                // Re-enable search input
                const searchInput = document.getElementById('clientSearchInput');
                if (searchInput) {
                    searchInput.disabled = false;
                    searchInput.placeholder = 'Type to search clients...';
                }
            }
        }
        
        function renderSessions() {
            const container = document.getElementById('sessionsList');
            if (!container) return;
            
            if (sessions.length === 0) {
                container.innerHTML = '<p>No sessions booked yet.</p>';
                return;
            }
            
            const sorted = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sorted.map((session, index) => `
                <div style="padding: 15px; background: var(--bg); border-radius: 8px; margin-bottom: 10px;">
                    <strong>${session.type || 'Session'}</strong><br>
                    Date: ${new Date(session.date).toLocaleDateString()}<br>
                    Time: ${formatTimeDisplay(session.time)}<br>
                    Staff: ${session.teacherName || 'N/A'}<br>
                    Clients: ${session.clientNames || 'N/A'}
                    <div style="margin-top: 10px;">
                        <button class="btn-secondary" onclick="deleteSession(${sessions.indexOf(session)})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function addSession(event) {
            event.preventDefault();
            
            const type = document.getElementById('sessionType').value;
            const date = document.getElementById('sessionDate').value;
            const hour = document.getElementById('sessionHour').value;
            const minute = document.getElementById('sessionMinute').value;
            const ampm = document.getElementById('sessionAmPm').value;
            const teacher = document.getElementById('sessionTeacher').value;
            const notes = document.getElementById('sessionNotes').value;
            
            if (!type || !date || !hour) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (selectedSessionClients.length === 0) {
                alert('Please select at least one client');
                return;
            }
            
            // Convert 12-hour to 24-hour format for storage
            const time = convertTo24Hour(hour, minute, ampm);
            
            // Get client names for display
            const clientNames = selectedSessionClients.map(clientId => {
                const client = clients.find(c => c.id === clientId);
                return client ? client.name : 'Unknown';
            }).join(', ');
            
            const sessionData = {
                type: type,
                date: date,
                time: time,
                teacherName: teacher,
                clients: selectedSessionClients,
                clientNames: clientNames,
                notes: notes
            };
            
            try {
                await saveSession(sessionData);
                await loadData();
                
                // Refresh calendar to show new session
                renderCalendar();
                
                // Reset form
                document.getElementById('sessionForm').reset();
                selectedSessionClients = [];
                updateClientSelection();
                
                // Re-enable search input
                const searchInput = document.getElementById('clientSearchInput');
                if (searchInput) {
                    searchInput.disabled = false;
                    searchInput.placeholder = 'Type to search clients...';
                }
                
                alert('Session booked successfully!');
            } catch (error) {
                console.error('Error booking session:', error);
                alert('Error booking session: ' + error.message);
            }
        }

        async function deleteSession(index) {
            if (confirm('Delete this session?')) {
                const session = sessions[index];
                try {
                    await deleteSessionFromDb(session.id);
                    await loadData();
                    renderCalendar();
                    alert('Session deleted successfully!');
                } catch (error) {
                    console.error('Error deleting session:', error);
                    alert('Error deleting session: ' + error.message);
                }
            }
        }

        // ========================================
        // INVOICE MANAGEMENT
        // ========================================
        
        // Helper function to convert 12-hour to 24-hour time format
        function convertTo24Hour(hour, minute, ampm) {
            let h = parseInt(hour);
            if (ampm === 'PM' && h !== 12) {
                h += 12;
            } else if (ampm === 'AM' && h === 12) {
                h = 0;
            }
            return `${String(h).padStart(2, '0')}:${minute}`;
        }
        
        function renderInvoices() {
            const container = document.getElementById('invoicesList');
            if (!container) return;
            
            if (invoices.length === 0) {
                container.innerHTML = '<p>No invoices yet.</p>';
                return;
            }
            
            container.innerHTML = invoices.map((invoice, index) => `
                <div style="padding: 15px; background: var(--bg); border-radius: 8px; margin-bottom: 10px;">
                    <strong>Invoice #${invoice.id}</strong><br>
                    Amount: $${invoice.amount}<br>
                    Status: ${invoice.status || 'unpaid'}<br>
                    Date: ${new Date(invoice.date).toLocaleDateString()}
                    <div style="margin-top: 10px;">
                        <button class="btn-secondary" onclick="toggleInvoiceStatus(${index})">
                            Mark as ${invoice.status === 'paid' ? 'Unpaid' : 'Paid'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function generateInvoice() {
            const amount = prompt('Enter invoice amount:');
            if (!amount || isNaN(amount)) {
                alert('Invalid amount');
                return;
            }
            
            const invoice = {
                id: Date.now(),
                amount: parseFloat(amount),
                status: 'unpaid',
                date: new Date().toISOString()
            };
            
            invoices.push(invoice);
            saveData();
            renderInvoices();
            alert('Invoice created!');
        }

        function toggleInvoiceStatus(index) {
            invoices[index].status = invoices[index].status === 'paid' ? 'unpaid' : 'paid';
            saveData();
            renderInvoices();
        }

        // ========================================
        // SETTINGS FUNCTIONS
        // ========================================
        
        function loadSettings() {
            if (!isOwnerOrAdmin()) {
                document.getElementById('settingsTab').style.display = 'none';
                switchTab('clients', event);
                alert('You do not have permission to access Settings.');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            const userData = getCurrentUserData();
            
            if (userData) {
                const nameInput = document.getElementById('studioNameSetting');
                if (nameInput) {
                    nameInput.value = userData.studioName || '';
                }
                document.getElementById('mainStudioName').textContent = userData.studioName || '';
            }
            
            // Load user management (owner only)
            const userMgmtSection = document.getElementById('userManagementSection');
            if (userMgmtSection) {
                if (canManageUsers()) {
                    userMgmtSection.innerHTML = renderUserManagement();
                } else {
                    userMgmtSection.innerHTML = '';
                }
            }

        // Load QuickBooks settings (owner/admin only)
        const qbSection = document.getElementById('quickbooksSection');
        if (qbSection) {
            if (canAccessSettings()) {
                qbSection.innerHTML = renderQuickBooksSettings();
            } else {
                qbSection.innerHTML = '';
            }
        }

        renderOwnersList();
        renderClassPricing();
        }

        function saveBusinessInfo() {
            const studioName = document.getElementById('studioNameSetting').value.trim();
            
            const users = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
            const localUser = localStorage.getItem('currentUser');
            if (users[currentUser]) {
                users[currentUser].studioName = studioName;
                localStorage.setItem('studioFlowUsers', JSON.stringify(users));
            }
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            settings.studioName = studioName;
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            
            document.getElementById('mainStudioName').textContent = studioName;
            
            alert('Business information saved successfully!');
        }

        function renderOwnersList() {
            const container = document.getElementById('ownersList');
            if (!container) return;
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            const currentUserEmail = localStorage.getItem('currentUser');
            
            if (!settings.owners || settings.owners.length === 0) {
                settings.owners = [currentUserEmail];
                localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            }
            
            container.innerHTML = '<p><strong>Owners:</strong> ' + settings.owners.join(', ') + '</p>';
        }

        function addOwner() {
            const email = document.getElementById('newOwnerEmail').value.trim().toLowerCase();
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
            
            if (!users[email]) {
                alert('This user does not have an account.');
                return;
            }
            
            const currentOrgId = localStorage.getItem('currentOrganization');
            if (users[email].organizationId !== currentOrgId) {
                alert('This user belongs to a different organization.');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            if (!settings.owners) settings.owners = [];
            
            if (settings.owners.includes(email)) {
                alert('This user is already an owner');
                return;
            }
            
            settings.owners.push(email);
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            
            document.getElementById('newOwnerEmail').value = '';
            renderOwnersList();
            alert('Owner added successfully!');
        }

        function renderClassPricing() {
            const container = document.getElementById('classPricingList');
            if (!container) return;
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            
            if (!settings.sessionTypes || settings.sessionTypes.length === 0) {
                settings.sessionTypes = [
                    { name: 'Private', id: 1, defaultPrice: 120 },
                    { name: 'Duet', id: 2, defaultPrice: 60 },
                    { name: 'Trio', id: 3, defaultPrice: 45 }
                ];
                localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            }
            
            container.innerHTML = '<ul>' + settings.sessionTypes.map((type, index) => 
                '<li>' + type.name + ': $' + (type.defaultPrice || 0) + 
                ' <button class="btn-secondary" onclick="editClassPrice(' + index + ')">Edit</button>' +
                ' <button class="btn-secondary" onclick="deleteClassType(' + index + ')">Delete</button></li>'
            ).join('') + '</ul>';
        }

        function editClassPrice(index) {
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            const type = settings.sessionTypes[index];
            
            const newName = prompt('Edit class name:', type.name);
            if (newName && newName.trim()) {
                type.name = newName.trim();
            }
            
            const newPrice = prompt('Edit default price:', type.defaultPrice);
            if (newPrice && !isNaN(newPrice)) {
                type.defaultPrice = parseFloat(newPrice);
            }
            
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            renderClassPricing();
        }

        function addClassType() {
            const name = document.getElementById('newClassName').value.trim();
            const price = parseFloat(document.getElementById('newClassPrice').value) || 0;
            
            if (!name) {
                alert('Please enter a class name');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            if (!settings.sessionTypes) settings.sessionTypes = [];
            
            if (settings.sessionTypes.some(t => t.name.toLowerCase() === name.toLowerCase())) {
                alert('A class type with this name already exists');
                return;
            }
            
            settings.sessionTypes.push({
                name: name,
                id: Date.now(),
                defaultPrice: price
            });
            
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            
            document.getElementById('newClassName').value = '';
            document.getElementById('newClassPrice').value = '';
            
            renderClassPricing();
            alert('Class type added successfully!');
        }

        function deleteClassType(index) {
            if (!confirm('Delete this class type?')) return;
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            settings.sessionTypes.splice(index, 1);
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            
            renderClassPricing();
        }

        // ========================================
        // CALENDAR & EMAIL INTEGRATIONS
        // ========================================
        
        // Google Calendar Integration
        function connectGoogleCalendar() {
            if (localStorage.getItem(getOrgKey('google_calendar_connected'))) {
                alert('Google Calendar is already connected!');
                return;
            }
            
            // In production, this would initiate OAuth 2.0 flow with Google
            // Scope needed: https://www.googleapis.com/auth/calendar
            const clientId = 'YOUR_GOOGLE_CLIENT_ID';
            const redirectUri = window.location.origin + '/google-callback';
            const scope = 'https://www.googleapis.com/auth/calendar';
            
            // Production OAuth URL:
            // const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=${scope}`;
            // window.location.href = authUrl;
            
            if (confirm('Connect to Google Calendar?\n\nThis will allow automatic calendar event creation for sessions.\n\n(Demo mode - simulating connection)')) {
                localStorage.setItem(getOrgKey('google_calendar_connected'), 'true');
                localStorage.setItem(getOrgKey('google_calendar_token'), 'demo_token_' + Date.now());
                document.getElementById('google-status').style.display = 'block';
                alert(' Successfully connected to Google Calendar!\n\nCalendar events will be created when booking sessions.');
            }
        }
        
        function disconnectGoogleCalendar() {
            if (confirm('Disconnect Google Calendar?')) {
                localStorage.removeItem(getOrgKey('google_calendar_connected'));
                localStorage.removeItem(getOrgKey('google_calendar_token'));
                document.getElementById('google-status').style.display = 'none';
                alert('Disconnected from Google Calendar');
            }
        }
        
        function createGoogleCalendarEvent(sessionData) {
            const isConnected = localStorage.getItem(getOrgKey('google_calendar_connected'));
            if (!isConnected) return;
            
            // In production: POST to https://www.googleapis.com/calendar/v3/calendars/primary/events
            const event = {
                summary: `${sessionData.type} Session - ${sessionData.clientNames}`,
                description: sessionData.notes || 'Pilates session',
                start: {
                    dateTime: new Date(sessionData.date + 'T' + sessionData.time).toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                end: {
                    dateTime: new Date(new Date(sessionData.date + 'T' + sessionData.time).getTime() + 3600000).toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                attendees: sessionData.clientEmails.map(email => ({ email }))
            };
            
            console.log(' Google Calendar event created:', event.summary);
        }
        
        // Microsoft Outlook / Microsoft 365 Integration
        function connectMicrosoftOutlook() {
            if (localStorage.getItem(getOrgKey('outlook_connected'))) {
                alert('Microsoft Outlook is already connected!');
                return;
            }
            
            // In production, this would initiate OAuth 2.0 flow with Microsoft
            // Scopes needed: Calendars.ReadWrite, Mail.Send
            const clientId = 'YOUR_MICROSOFT_CLIENT_ID';
            const redirectUri = window.location.origin + '/microsoft-callback';
            const scope = 'Calendars.ReadWrite Mail.Send offline_access';
            
            // Production OAuth URL:
            // const authUrl = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${clientId}&response_type=code&redirect_uri=${redirectUri}&scope=${scope}`;
            // window.location.href = authUrl;
            
            if (confirm('Connect to Microsoft Outlook / Microsoft 365?\n\nThis enables:\n Outlook calendar event creation\n Email sending via Outlook\n Client appointment invites\n\n(Demo mode - simulating connection)')) {
                localStorage.setItem(getOrgKey('outlook_connected'), 'true');
                localStorage.setItem(getOrgKey('outlook_token'), 'demo_outlook_token_' + Date.now());
                document.getElementById('outlook-status').style.display = 'block';
                alert(' Successfully connected to Microsoft Outlook!\n\nYou can now:\n Create Outlook calendar events\n Send emails via Outlook\n Access Microsoft 365 features');
            }
        }
        
        function disconnectMicrosoftOutlook() {
            if (confirm('Disconnect Microsoft Outlook?')) {
                localStorage.removeItem(getOrgKey('outlook_connected'));
                localStorage.removeItem(getOrgKey('outlook_token'));
                document.getElementById('outlook-status').style.display = 'none';
                alert('Disconnected from Microsoft Outlook');
            }
        }
        
        function createOutlookCalendarEvent(sessionData) {
            const isConnected = localStorage.getItem(getOrgKey('outlook_connected'));
            if (!isConnected) return;
            
            // In production: POST to https://graph.microsoft.com/v1.0/me/events
            const event = {
                subject: `${sessionData.type} Session - ${sessionData.clientNames}`,
                body: {
                    contentType: 'HTML',
                    content: sessionData.notes || 'Pilates session booking'
                },
                start: {
                    dateTime: new Date(sessionData.date + 'T' + sessionData.time).toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                end: {
                    dateTime: new Date(new Date(sessionData.date + 'T' + sessionData.time).getTime() + 3600000).toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                attendees: sessionData.clientEmails.map(email => ({
                    emailAddress: { address: email },
                    type: 'required'
                }))
            };
            
            console.log(' Outlook Calendar event created:', event.subject);
        }
        
        function sendOutlookEmail(emailData) {
            const isConnected = localStorage.getItem(getOrgKey('outlook_connected'));
            if (!isConnected) {
                console.log('Outlook not connected, cannot send email');
                return false;
            }
            
            // In production: POST to https://graph.microsoft.com/v1.0/me/sendMail
            const message = {
                message: {
                    subject: emailData.subject,
                    body: {
                        contentType: 'HTML',
                        content: emailData.body
                    },
                    toRecipients: emailData.recipients.map(email => ({
                        emailAddress: { address: email }
                    }))
                },
                saveToSentItems: true
            };
            
            console.log(' Outlook email sent:', message.message.subject);
            return true;
        }
        
        // Unified function to create calendar events across all connected platforms
        function createCalendarEventsForSession(session) {
            const clientEmails = [];
            const clientNames = [];
            
            if (session.clients && Array.isArray(session.clients)) {
                session.clients.forEach(clientId => {
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        if (client.email) clientEmails.push(client.email);
                        clientNames.push(client.name);
                    }
                });
            }
            
            const sessionData = {
                type: session.type,
                clientNames: clientNames.join(', ') || 'Client',
                clientEmails: clientEmails,
                date: session.date,
                time: session.time,
                notes: session.notes
            };
            
            let eventsCreated = 0;
            
            if (localStorage.getItem(getOrgKey('google_calendar_connected'))) {
                createGoogleCalendarEvent(sessionData);
                eventsCreated++;
            }
            
            if (localStorage.getItem(getOrgKey('outlook_connected'))) {
                createOutlookCalendarEvent(sessionData);
                eventsCreated++;
            }
            
            if (eventsCreated > 0) {
                console.log(` Created ${eventsCreated} calendar event(s) for session`);
            }
        }
        
        // QuickBooks Integration
        function connectQuickBooks() {
            if (localStorage.getItem(getOrgKey('quickbooks_connected'))) {
                alert('QuickBooks is already connected!');
                return;
            }
            
            // In production: OAuth 2.0 flow with Intuit
            if (confirm('Connect to QuickBooks Online?\n\nThis enables:\n Automatic invoice generation\n Client syncing\n Payment tracking\n\n(Demo mode - simulating connection)')) {
                localStorage.setItem(getOrgKey('quickbooks_connected'), 'true');
                localStorage.setItem(getOrgKey('quickbooks_token'), 'demo_qb_token_' + Date.now());
                document.getElementById('quickbooks-status').style.display = 'block';
                alert(' Successfully connected to QuickBooks!\n\nYou can now sync clients and generate invoices.');
            }
        }
        
        function syncClientsToQuickBooks() {
            const isConnected = localStorage.getItem(getOrgKey('quickbooks_connected'));
            if (!isConnected) {
                alert('Please connect to QuickBooks first');
                return;
            }
            
            if (clients.length === 0) {
                alert('No clients to sync. Add clients first.');
                return;
            }
            
            // In production: POST to QuickBooks API to create/update customers
            console.log('Syncing ' + clients.length + ' clients to QuickBooks...');
            
            alert(` Successfully synced ${clients.length} client(s) to QuickBooks!\n\n(Demo mode - in production, clients would be created/updated in QuickBooks)`);
        }
        
        // Check integration status on page load
        function checkIntegrationStatus() {
            if (localStorage.getItem(getOrgKey('google_calendar_connected'))) {
                const statusDiv = document.getElementById('google-status');
                if (statusDiv) statusDiv.style.display = 'block';
            }
            
            if (localStorage.getItem(getOrgKey('outlook_connected'))) {
                const statusDiv = document.getElementById('outlook-status');
                if (statusDiv) statusDiv.style.display = 'block';
            }
            
            if (localStorage.getItem(getOrgKey('quickbooks_connected'))) {
                const statusDiv = document.getElementById('quickbooks-status');
                if (statusDiv) statusDiv.style.display = 'block';
            }
        }

      
        // ========================================
        // USER MANAGEMENT FUNCTIONS
        // ========================================

function removeUserFromOrganization(email) {
    if (!canManageUsers()) {
        alert('Only owners can remove users.');
        return false;
    }
    const localUser = localStorage.getItem('currentUser');
    if (email === localUser) {
        alert('You cannot remove yourself.');
        return false;
    }

    if (!confirm(`Are you sure you want to remove this user?\n\nEmail: ${email}\n\nThey will no longer be able to access this organization.`)) {
        return false;
    }

    const orgId = localStorage.getItem('currentOrganization');

    // Remove from organization users
    const orgUsers = JSON.parse(localStorage.getItem(`org_users_${orgId}`) || '{}');
    delete orgUsers[email];
    localStorage.setItem(`org_users_${orgId}`, JSON.stringify(orgUsers));

    // Remove from global users
    const allUsers = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
    delete allUsers[email];
    localStorage.setItem('studioFlowUsers', JSON.stringify(allUsers));

    return true;
}

function updateUserRole(email, newRole) {
    if (!canManageUsers()) {
        alert('Only owners can change user roles.');
        return false;
    }

    const localUser = localStorage.getItem('currentUser');
    if (email === localUser) {
        alert('You cannot change your own role.');
        return false;
    }

    const orgId = localStorage.getItem('currentOrganization');

    // Update in organization users
    const orgUsers = JSON.parse(localStorage.getItem(`org_users_${orgId}`) || '{}');
    if (orgUsers[email]) {
        orgUsers[email].role = newRole;
        localStorage.setItem(`org_users_${orgId}`, JSON.stringify(orgUsers));
    }

    // Update in global users
    const allUsers = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
    if (allUsers[email]) {
        allUsers[email].role = newRole;
        localStorage.setItem('studioFlowUsers', JSON.stringify(allUsers));
    }

    return true;
}

// ========================================
// UI RENDERING FUNCTIONS
// ========================================

function renderUserManagement() {
    if (!canManageUsers()) {
        return '<div class="card"><p>Only practice owners can manage staff.</p></div>';
    }

    // Generate invite link
    const inviteCode = organizationId ? btoa(organizationId).substring(0, 12) : '';
    const inviteLink = window.location.origin + '/login.html?invite=' + inviteCode;

    // Separate active and paused staff
    const activeStaff = staffMembers.filter(u => !u.paused);
    const pausedStaff = staffMembers.filter(u => u.paused);

    let html = `
        <div class="settings-section">
            <h3>Staff Management</h3>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Manage your practice team. Invite staff via email to ensure correct contact details for calendar invites and communications.
            </p>

            <!-- Invite via Email Section -->
            <div class="card" style="margin-bottom: 24px; background: var(--warm-light); border: 2px solid var(--coral);">
                <h4 style="margin-bottom: 12px; color: var(--coral); font-size: 16px;">Invite Staff via Email</h4>
                <p style="color: var(--text-light); font-size: 13px; margin-bottom: 16px;">
                    Send an invitation email to new staff members. They'll create their own password and their email will be verified for calendar invites.
                </p>
                <form onsubmit="handleEmailInvite(event)" style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <input type="text" id="invite-staff-name" required placeholder="Staff member's name" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 10px;">
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <input type="email" id="invite-staff-email" required placeholder="email@example.com" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 10px;">
                    </div>
                    <button type="submit" class="btn-primary" style="white-space: nowrap;">
                        Send Invite
                    </button>
                </form>
            </div>

            <!-- Or Share Invite Link -->
            <div class="card" style="margin-bottom: 24px; background: var(--sage-tint); border: 2px solid var(--sage);">
                <h4 style="margin-bottom: 12px; color: var(--forest); font-size: 16px;">Or Share Invite Link</h4>
                <p style="color: var(--text-light); font-size: 13px; margin-bottom: 12px;">
                    Staff can also self-register using this link. They'll be added with "Staff" role by default.
                </p>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="inviteLinkInput" value="${inviteLink}" readonly 
                        style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid var(--sage); border-radius: 10px; font-size: 13px; background: white;">
                    <button onclick="copyInviteLink()" class="btn-secondary" style="white-space: nowrap;">
                        Copy Link
                    </button>
                </div>
            </div>

            <!-- Active Staff List -->
            <div class="card" style="margin-bottom: 24px;">
                <h4 style="margin-bottom: 16px; color: var(--forest); font-size: 16px;">Active Staff (${activeStaff.length})</h4>
                <div class="staff-list">
    `;

    if (activeStaff.length === 0) {
        html += `
            <div style="text-align: center; padding: 32px; color: var(--text-light); background: var(--cream); border-radius: 12px;">
                <p>No active staff members yet. Send an invite above to add your first team member.</p>
            </div>
        `;
    } else {
        activeStaff.forEach(user => {
            const isCurrentUser = currentUser && user.email === currentUser.email;
            const displayName = user.displayName || user.name || user.email.split('@')[0];
            const roleColor = user.role === 'owner' ? 'var(--forest)' : user.role === 'admin' ? 'var(--sage)' : 'var(--coral)';
            const roleLabel = user.role === 'teacher' ? 'Staff' : (user.role === 'staff' ? 'Staff' : user.role.charAt(0).toUpperCase() + user.role.slice(1));

            html += `
                <div class="staff-item" style="padding: 16px; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; background: white;">
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px; color: var(--text);">
                            ${displayName} ${isCurrentUser ? '<span style="color: var(--coral); font-size: 11px; font-weight: 500;">(You)</span>' : ''}
                        </div>
                        <div style="color: var(--text-light); font-size: 13px; margin-bottom: 6px;">
                            ${user.email}
                        </div>
                        <span style="display: inline-block; padding: 3px 10px; background: ${roleColor}; color: white; border-radius: 6px; font-size: 11px; font-weight: 600;">
                            ${roleLabel}
                        </span>
                    </div>
                    ${!isCurrentUser && user.role !== 'owner' ? `
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <select onchange="handleChangeUserRole('${user.id}', this.value)" style="padding: 8px 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 12px; background: white;">
                                <option value="">Change Role...</option>
                                <option value="admin" ${user.role === 'admin' ? 'disabled' : ''}>Make Admin</option>
                                <option value="staff" ${user.role === 'staff' || user.role === 'teacher' ? 'disabled' : ''}>Make Staff</option>
                            </select>
                            <button onclick="handlePauseStaff('${user.id}')" style="padding: 8px 14px; background: var(--amber); color: var(--text); border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                Pause
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        });
    }

    html += `
                </div>
            </div>
    `;

    // Paused/Archived Staff Section
    if (pausedStaff.length > 0) {
        html += `
            <div class="card" style="background: var(--cream);">
                <h4 style="margin-bottom: 16px; color: var(--text-light); font-size: 16px;">Paused Staff (${pausedStaff.length})</h4>
                <p style="color: var(--text-light); font-size: 12px; margin-bottom: 16px;">
                    Paused staff cannot be assigned to new bookings, but their historical notes and appointments are preserved.
                </p>
                <div class="staff-list">
        `;

        pausedStaff.forEach(user => {
            const displayName = user.displayName || user.name || user.email.split('@')[0];

            html += `
                <div class="staff-item" style="padding: 16px; border: 2px dashed var(--border); border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; background: white; opacity: 0.8;">
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px; color: var(--text-light);">
                            ${displayName}
                        </div>
                        <div style="color: var(--text-light); font-size: 13px; margin-bottom: 6px;">
                            ${user.email}
                        </div>
                        <span style="display: inline-block; padding: 3px 10px; background: var(--text-light); color: white; border-radius: 6px; font-size: 11px; font-weight: 600;">
                            Paused
                        </span>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="handleReactivateStaff('${user.id}')" style="padding: 8px 14px; background: var(--sage); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">
                            Reactivate
                        </button>
                        <button onclick="handleRemoveStaffUser('${user.id}')" style="padding: 8px 14px; background: transparent; color: var(--error); border: 2px solid var(--error); border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">
                            Remove
                        </button>
                    </div>
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    }

    html += `
        </div>
    `;

    return html;
}

function copyInviteLink() {
    const input = document.getElementById('inviteLinkInput');
    input.select();
    document.execCommand('copy');
    alert('Invite link copied to clipboard! Share this with your staff.');
}

async function handleAddStaffUser(event) {
    event.preventDefault();

    const fullName = document.getElementById('new-staff-name').value.trim();
    const email = document.getElementById('new-staff-email').value.trim();
    const password = document.getElementById('new-staff-password').value;
    const role = document.getElementById('new-staff-role').value;

    if (!fullName || !email || !password || !role) {
        alert('Please fill in all fields.');
        return;
    }

    if (password.length < 6) {
        alert('Password must be at least 6 characters.');
        return;
    }

    try {
        // Create user in Firebase Auth using a secondary app to avoid logging out current user
        const secondaryApp = firebase.initializeApp(firebaseConfig, 'Secondary' + Date.now());
        const secondaryAuth = secondaryApp.auth();
        
        const userCredential = await secondaryAuth.createUserWithEmailAndPassword(email, password);
        const newUser = userCredential.user;
        
        // Create user document in Firestore
        await db.collection('users').doc(newUser.uid).set({
            email: email,
            displayName: fullName,
            name: fullName,
            role: role,
            organizationId: organizationId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Add to organization's users collection
        await getOrgCollection('users').doc(newUser.uid).set({
            email: email,
            displayName: fullName,
            name: fullName,
            role: role,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Sign out of secondary app and delete it
        await secondaryAuth.signOut();
        await secondaryApp.delete();
        
        alert(` Staff member added successfully!\n\n${fullName} can now log in with:\nEmail: ${email}\nPassword: [as set]\n\nThey should change their password after first login.`);
        
        // Clear form
        document.getElementById('new-staff-name').value = '';
        document.getElementById('new-staff-email').value = '';
        document.getElementById('new-staff-password').value = '';
        
        // Refresh data
        await loadData();
        
    } catch (error) {
        console.error('Error adding staff:', error);
        if (error.code === 'auth/email-already-in-use') {
            alert('This email is already registered. The user may need to request access to your organization.');
        } else {
            alert('Error adding staff: ' + error.message);
        }
    }
}

async function handleChangeUserRole(userId, newRole) {
    if (!newRole) return;
    
    try {
        // Update in global users collection
        await db.collection('users').doc(userId).update({ role: newRole });
        
        // Update in organization's users collection
        await getOrgCollection('users').doc(userId).update({ role: newRole });
        
        alert('Role updated successfully!');
        await loadData();
    } catch (error) {
        console.error('Error changing role:', error);
        alert('Error changing role: ' + error.message);
    }
}

async function handleRemoveStaffUser(userId) {
    if (!confirm('Remove this staff member from your organization? They will no longer have access to your practice data.\n\nNote: Their historical notes and appointments will remain in your records.')) {
        return;
    }
    
    try {
        // Remove from organization's users collection (don't delete their auth account)
        await getOrgCollection('users').doc(userId).delete();
        
        // Update their user document to remove organization association
        await db.collection('users').doc(userId).update({ 
            organizationId: null,
            role: 'removed'
        });
        
        alert('Staff member removed from your organization.');
        await loadData();
    } catch (error) {
        console.error('Error removing user:', error);
        alert('Error removing user: ' + error.message);
    }
}

async function handleEmailInvite(event) {
    event.preventDefault();
    
    const name = document.getElementById('invite-staff-name').value.trim();
    const email = document.getElementById('invite-staff-email').value.trim();
    
    if (!name || !email) {
        alert('Please enter both name and email.');
        return;
    }
    
    try {
        // Generate invite link
        const inviteCode = organizationId ? btoa(organizationId).substring(0, 12) : '';
        const inviteLink = window.location.origin + '/login.html?invite=' + inviteCode;
        
        // Store pending invite in Firestore
        await getOrgCollection('pendingInvites').add({
            name: name,
            email: email,
            invitedAt: firebase.firestore.FieldValue.serverTimestamp(),
            invitedBy: currentUser.email,
            status: 'pending'
        });
        
        // In a real implementation, you'd send an email here via a Cloud Function
        // For now, we'll show the user what to send
        
        const emailSubject = encodeURIComponent(`You're invited to join our practice on MyoMesh`);
        const emailBody = encodeURIComponent(`Hi ${name},

You've been invited to join our practice management system.

Click the link below to create your account:
${inviteLink}

Once you've created your account, you'll have access to manage clients, appointments, and session notes.

See you soon!`);
        
        // Open email client
        window.open(`mailto:${email}?subject=${emailSubject}&body=${emailBody}`, '_blank');
        
        alert(`Invitation prepared for ${name}!\n\nYour email client should open with the invitation ready to send.\n\nIf it didn't open, you can copy the invite link from the "Share Invite Link" section and send it manually.`);
        
        // Clear form
        document.getElementById('invite-staff-name').value = '';
        document.getElementById('invite-staff-email').value = '';
        
    } catch (error) {
        console.error('Error creating invite:', error);
        alert('Error creating invitation: ' + error.message);
    }
}

async function handlePauseStaff(userId) {
    const user = staffMembers.find(u => u.id === userId);
    if (!user) return;
    
    const displayName = user.displayName || user.name || user.email;
    
    if (!confirm(`Pause ${displayName}?\n\nThey will not be available for new bookings, but their historical notes and appointments will be preserved.\n\nYou can reactivate them at any time.`)) {
        return;
    }
    
    try {
        // Update in organization's users collection
        await getOrgCollection('users').doc(userId).update({ paused: true });
        
        // Update in global users collection
        await db.collection('users').doc(userId).update({ paused: true });
        
        alert(`${displayName} has been paused. They will not appear in staff selection for new bookings.`);
        await loadData();
    } catch (error) {
        console.error('Error pausing staff:', error);
        alert('Error pausing staff: ' + error.message);
    }
}

async function handleReactivateStaff(userId) {
    const user = staffMembers.find(u => u.id === userId);
    if (!user) return;
    
    const displayName = user.displayName || user.name || user.email;
    
    try {
        // Update in organization's users collection
        await getOrgCollection('users').doc(userId).update({ paused: false });
        
        // Update in global users collection
        await db.collection('users').doc(userId).update({ paused: false });
        
        alert(`${displayName} has been reactivated and can now take new bookings.`);
        await loadData();
    } catch (error) {
        console.error('Error reactivating staff:', error);
        alert('Error reactivating staff: ' + error.message);
    }
}

function renderQuickBooksSettings() {
    if (!canAccessSettings()) {
        return '';
    }

    const isConnected = localStorage.getItem(getOrgKey('quickbooks_connected'));
    
    return `
        <div class="settings-section">
            <h3> QuickBooks Online Integration</h3>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Connect your QuickBooks Online account to automatically sync clients, generate invoices, 
                and track payments.
            </p>

            <div class="card">
                ${isConnected ? `
                    <div class="status-badge" style="background: #E8F5E9; color: #1E3A34; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;"></span>
                        <div>
                            <div style="font-weight: 600;">Connected to QuickBooks</div>
                            <div style="font-size: 12px; opacity: 0.8;">Your account is synced and ready</div>
                        </div>
                    </div>

                    <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <button onclick="syncClientsToQuickBooks()" class="btn-primary">
                            Sync Clients to QuickBooks
                        </button>
                        <button onclick="disconnectQuickBooks()" class="btn-secondary" style="background: var(--error);">
                            Disconnect QuickBooks
                        </button>
                    </div>

                    <div style="background: var(--bg); padding: 15px; border-radius: 8px; font-size: 13px; color: var(--text-light);">
                        <strong>Available Features:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px; line-height: 1.8;">
                            <li>Automatic client syncing</li>
                            <li>Invoice generation</li>
                            <li>Payment tracking</li>
                            <li>Financial reporting</li>
                        </ul>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <h4 style="margin-bottom: 10px; color: var(--primary);">Connect QuickBooks Online</h4>
                        <p style="color: var(--text-light); margin-bottom: 25px; line-height: 1.6;">
                            Streamline your accounting by connecting QuickBooks. Automatically sync clients, 
                            generate invoices, and track all your studio finances in one place.
                        </p>
                        <button onclick="connectQuickBooks()" class="btn-primary">
                            Connect to QuickBooks
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}

function disconnectQuickBooks() {
    if (!canAccessSettings()) {
        alert('Only owners and admins can manage integrations.');
        return;
    }

    if (confirm('Disconnect QuickBooks?\n\nYou can reconnect at any time.')) {
        localStorage.removeItem(getOrgKey('quickbooks_connected'));
        localStorage.removeItem(getOrgKey('quickbooks_token'));
        alert('Disconnected from QuickBooks');
        loadData();
    }
}

// ========================================
// INCOME TRACKING & CHARTS
// ========================================

let incomeCharts = {};
let incomeData = [];
let orgCurrency = 'CAD';
let orgTaxRate = 13;

const currencySymbols = {
    CAD: '$', USD: '$', EUR: '', GBP: '', AUD: '$'
};

function formatCurrency(amount) {
    const symbol = currencySymbols[orgCurrency] || '$';
    return `${symbol}${parseFloat(amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}

function switchIncomeView(view) {
    document.querySelectorAll('.income-view-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('incomeMonthlyView').style.display = view === 'monthly' ? 'block' : 'none';
    document.getElementById('incomeYearlyView').style.display = view === 'yearly' ? 'block' : 'none';
    document.getElementById('incomeHistoryView').style.display = view === 'history' ? 'block' : 'none';
    
    if (view === 'yearly') {
        renderYearlyChart();
    } else if (view === 'history') {
        renderIncomeHistory();
    }
}

async function loadIncomeData() {
    if (!organizationId || !isOwnerOrAdmin()) return;
    
    try {
        // Load organization settings
        const settingsDoc = await db.collection('organizations').doc(organizationId).collection('settings').doc('general').get();
        if (settingsDoc.exists) {
            const settings = settingsDoc.data();
            orgCurrency = settings.currency || 'CAD';
            orgTaxRate = settings.taxRate || 13;
        }
        
        // Load manual income entries
        const incomeSnapshot = await db.collection('organizations').doc(organizationId).collection('income').get();
        incomeData = incomeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Calculate and render
        calculateIncomeStats();
        renderIncomeCharts();
        populateYearFilters();
    } catch (error) {
        console.error('Error loading income data:', error);
    }
}

function calculateSessionIncome(session) {
    // Calculate income from a session based on client rates
    if (!session.clients || session.clients.length === 0) return 0;
    
    let total = 0;
    const type = session.type?.toLowerCase() || 'private';
    
    for (const clientId of session.clients) {
        const client = clients.find(c => c.id === clientId);
        if (client && client.rates) {
            const rate = client.rates[type] || client.rates.private || 0;
            total += parseFloat(rate);
        }
    }
    
    return total;
}

function calculateIncomeStats() {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    // Calculate from completed sessions
    const thisWeekStart = new Date(now);
    thisWeekStart.setDate(now.getDate() - now.getDay());
    thisWeekStart.setHours(0, 0, 0, 0);
    
    const thisMonthStart = new Date(currentYear, currentMonth, 1);
    const lastMonthStart = new Date(currentYear, currentMonth - 1, 1);
    const lastMonthEnd = new Date(currentYear, currentMonth, 0);
    
    let weeklyTotal = 0, weeklyCount = 0;
    let monthlyTotal = 0, monthlyCount = 0;
    let lastMonthTotal = 0;
    
    // Filter completed/past sessions
    const pastSessions = sessions.filter(s => {
        const sessionDate = new Date(s.date);
        return sessionDate <= now;
    });
    
    for (const session of pastSessions) {
        const sessionDate = new Date(session.date);
        const sessionIncome = calculateSessionIncome(session);
        
        if (sessionDate >= thisWeekStart) {
            weeklyTotal += sessionIncome;
            weeklyCount++;
        }
        
        if (sessionDate >= thisMonthStart) {
            monthlyTotal += sessionIncome;
            monthlyCount++;
        }
        
        if (sessionDate >= lastMonthStart && sessionDate <= lastMonthEnd) {
            lastMonthTotal += sessionIncome;
        }
    }
    
    // Add manual entries for current/last month
    const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
    const lastMonthKey = `${currentMonth === 0 ? currentYear - 1 : currentYear}-${String(currentMonth === 0 ? 12 : currentMonth).padStart(2, '0')}`;
    
    const currentManual = incomeData.find(d => d.id === currentMonthKey);
    const lastManual = incomeData.find(d => d.id === lastMonthKey);
    
    if (currentManual?.manual) {
        monthlyTotal += parseFloat(currentManual.manual);
    }
    if (lastManual?.manual) {
        lastMonthTotal += parseFloat(lastManual.manual);
    }
    
    // Update UI
    document.getElementById('weeklyIncome').textContent = formatCurrency(weeklyTotal);
    document.getElementById('weeklySessions').textContent = `${weeklyCount} session${weeklyCount !== 1 ? 's' : ''}`;
    document.getElementById('monthlyIncome').textContent = formatCurrency(monthlyTotal);
    document.getElementById('monthlySessions').textContent = `${monthlyCount} session${monthlyCount !== 1 ? 's' : ''}`;
    document.getElementById('lastMonthIncome').textContent = formatCurrency(lastMonthTotal);
    
    // Month comparison
    const change = lastMonthTotal > 0 ? ((monthlyTotal - lastMonthTotal) / lastMonthTotal * 100).toFixed(1) : 0;
    const comparisonEl = document.getElementById('monthComparison');
    if (change > 0) {
        comparisonEl.textContent = ` ${change}% vs last month`;
        comparisonEl.style.color = 'var(--sage)';
    } else if (change < 0) {
        comparisonEl.textContent = ` ${Math.abs(change)}% vs last month`;
        comparisonEl.style.color = 'var(--error)';
    } else {
        comparisonEl.textContent = 'Same as last month';
    }
    
    // Calculate YTD and other stats
    calculateYTDStats();
    renderIncomeBreakdown();
}

function calculateYTDStats() {
    const now = new Date();
    const currentYear = now.getFullYear();
    const monthlyTotals = [];
    
    for (let month = 0; month <= now.getMonth(); month++) {
        const monthStart = new Date(currentYear, month, 1);
        const monthEnd = new Date(currentYear, month + 1, 0);
        
        let total = 0;
        
        // From sessions
        for (const session of sessions) {
            const sessionDate = new Date(session.date);
            if (sessionDate >= monthStart && sessionDate <= monthEnd) {
                total += calculateSessionIncome(session);
            }
        }
        
        // From manual entries
        const monthKey = `${currentYear}-${String(month + 1).padStart(2, '0')}`;
        const manual = incomeData.find(d => d.id === monthKey);
        if (manual?.total) {
            total = parseFloat(manual.total);
        } else if (manual?.manual) {
            total += parseFloat(manual.manual);
        }
        
        monthlyTotals.push(total);
    }
    
    const ytdTotal = monthlyTotals.reduce((a, b) => a + b, 0);
    const avgMonthly = monthlyTotals.length > 0 ? ytdTotal / monthlyTotals.length : 0;
    const bestMonth = Math.max(...monthlyTotals, 0);
    
    // Growth rate (compare last 3 months avg to previous 3 months)
    let growthRate = 0;
    if (monthlyTotals.length >= 6) {
        const recent = monthlyTotals.slice(-3).reduce((a, b) => a + b, 0) / 3;
        const previous = monthlyTotals.slice(-6, -3).reduce((a, b) => a + b, 0) / 3;
        if (previous > 0) {
            growthRate = ((recent - previous) / previous * 100).toFixed(1);
        }
    }
    
    document.getElementById('ytdTotal').textContent = formatCurrency(ytdTotal);
    document.getElementById('avgMonthly').textContent = formatCurrency(avgMonthly);
    document.getElementById('bestMonth').textContent = formatCurrency(bestMonth);
    document.getElementById('growthRate').textContent = `${growthRate}%`;
    
    const growthTrend = document.getElementById('growthTrend');
    if (growthRate > 0) {
        growthTrend.textContent = ' Trending up';
        growthTrend.className = 'income-stat-change positive';
    } else if (growthRate < 0) {
        growthTrend.textContent = ' Trending down';
        growthTrend.className = 'income-stat-change negative';
    } else {
        growthTrend.textContent = ' Stable';
        growthTrend.className = 'income-stat-change';
    }
}

function renderIncomeCharts() {
    renderMonthlyComparisonChart();
    renderTrendChart();
}

function renderMonthlyComparisonChart() {
    const ctx = document.getElementById('monthlyComparisonChart');
    if (!ctx) return;
    
    if (incomeCharts.comparison) {
        incomeCharts.comparison.destroy();
    }
    
    const now = new Date();
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const currentYear = now.getFullYear();
    const lastYear = currentYear - 1;
    
    const currentYearData = [];
    const lastYearData = [];
    
    for (let month = 0; month < 12; month++) {
        // Current year
        let currentTotal = 0;
        const currentKey = `${currentYear}-${String(month + 1).padStart(2, '0')}`;
        const currentManual = incomeData.find(d => d.id === currentKey);
        
        if (currentManual?.total) {
            currentTotal = parseFloat(currentManual.total);
        } else {
            // Calculate from sessions
            const monthStart = new Date(currentYear, month, 1);
            const monthEnd = new Date(currentYear, month + 1, 0);
            for (const session of sessions) {
                const sessionDate = new Date(session.date);
                if (sessionDate >= monthStart && sessionDate <= monthEnd && sessionDate <= now) {
                    currentTotal += calculateSessionIncome(session);
                }
            }
            if (currentManual?.manual) currentTotal += parseFloat(currentManual.manual);
        }
        currentYearData.push(month <= now.getMonth() ? currentTotal : null);
        
        // Last year
        let lastTotal = 0;
        const lastKey = `${lastYear}-${String(month + 1).padStart(2, '0')}`;
        const lastManual = incomeData.find(d => d.id === lastKey);
        if (lastManual?.total) {
            lastTotal = parseFloat(lastManual.total);
        }
        lastYearData.push(lastTotal);
    }
    
    incomeCharts.comparison = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [
                {
                    label: currentYear.toString(),
                    data: currentYearData,
                    backgroundColor: 'rgba(255, 107, 74, 0.8)',
                    borderRadius: 6
                },
                {
                    label: lastYear.toString(),
                    data: lastYearData,
                    backgroundColor: 'rgba(61, 139, 122, 0.5)',
                    borderRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => formatCurrency(value)
                    }
                }
            }
        }
    });
}

function renderTrendChart() {
    const ctx = document.getElementById('trendChart');
    if (!ctx) return;
    
    if (incomeCharts.trend) {
        incomeCharts.trend.destroy();
    }
    
    const now = new Date();
    const labels = [];
    const data = [];
    
    // Last 12 months
    for (let i = 11; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        labels.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
        
        let total = 0;
        const manual = incomeData.find(d => d.id === monthKey);
        if (manual?.total) {
            total = parseFloat(manual.total);
        } else {
            const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
            const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            for (const session of sessions) {
                const sessionDate = new Date(session.date);
                if (sessionDate >= monthStart && sessionDate <= monthEnd && sessionDate <= now) {
                    total += calculateSessionIncome(session);
                }
            }
            if (manual?.manual) total += parseFloat(manual.manual);
        }
        data.push(total);
    }
    
    incomeCharts.trend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Monthly Income',
                data: data,
                borderColor: '#FF6B4A',
                backgroundColor: 'rgba(255, 107, 74, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#FF6B4A',
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => formatCurrency(value)
                    }
                }
            }
        }
    });
}

function renderYearlyChart() {
    const ctx = document.getElementById('yearlyOverviewChart');
    if (!ctx) return;
    
    if (incomeCharts.yearly) {
        incomeCharts.yearly.destroy();
    }
    
    const now = new Date();
    const currentYear = now.getFullYear();
    document.getElementById('currentYearLabel').textContent = currentYear;
    
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const subtotals = [];
    const taxes = [];
    const tableBody = document.getElementById('yearlyBreakdownTable');
    tableBody.innerHTML = '';
    
    let prevTotal = 0;
    
    for (let month = 0; month < 12; month++) {
        const monthKey = `${currentYear}-${String(month + 1).padStart(2, '0')}`;
        const manual = incomeData.find(d => d.id === monthKey);
        
        let subtotal = 0, tax = 0, sessionCount = 0;
        
        if (manual) {
            subtotal = parseFloat(manual.subtotal || manual.manual || 0);
            tax = parseFloat(manual.tax || 0);
        }
        
        // Count sessions for this month
        const monthStart = new Date(currentYear, month, 1);
        const monthEnd = new Date(currentYear, month + 1, 0);
        
        if (!manual?.total) {
            for (const session of sessions) {
                const sessionDate = new Date(session.date);
                if (sessionDate >= monthStart && sessionDate <= monthEnd && sessionDate <= now) {
                    subtotal += calculateSessionIncome(session);
                    sessionCount++;
                }
            }
            // Apply tax rate if calculating from sessions
            if (subtotal > 0 && !manual) {
                tax = subtotal * (orgTaxRate / 100);
            }
        }
        
        const total = subtotal + tax;
        subtotals.push(month <= now.getMonth() ? subtotal : null);
        taxes.push(month <= now.getMonth() ? tax : null);
        
        // Change calculation
        let changeHtml = '-';
        if (month > 0 && prevTotal > 0) {
            const change = ((total - prevTotal) / prevTotal * 100).toFixed(1);
            if (change > 0) {
                changeHtml = `<span style="color: var(--sage);"> ${change}%</span>`;
            } else if (change < 0) {
                changeHtml = `<span style="color: var(--error);"> ${Math.abs(change)}%</span>`;
            }
        }
        
        if (month <= now.getMonth()) {
            tableBody.innerHTML += `
                <tr>
                    <td><strong>${months[month]} ${currentYear}</strong></td>
                    <td>${sessionCount || '-'}</td>
                    <td>${formatCurrency(subtotal)}</td>
                    <td>${formatCurrency(tax)}</td>
                    <td><strong>${formatCurrency(total)}</strong></td>
                    <td>${changeHtml}</td>
                </tr>
            `;
            prevTotal = total;
        }
    }
    
    incomeCharts.yearly = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Income',
                    data: subtotals,
                    backgroundColor: 'rgba(255, 107, 74, 0.8)',
                    borderRadius: 6
                },
                {
                    label: 'Tax Collected',
                    data: taxes,
                    backgroundColor: 'rgba(61, 139, 122, 0.6)',
                    borderRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            },
            scales: {
                x: { stacked: true },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        callback: value => formatCurrency(value)
                    }
                }
            }
        }
    });
}

function renderIncomeBreakdown() {
    const container = document.getElementById('incomeBreakdown');
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    // Get sessions from current month
    const monthSessions = sessions.filter(s => {
        const date = new Date(s.date);
        return date.getMonth() === currentMonth && date.getFullYear() === currentYear && date <= now;
    }).sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (monthSessions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon"></div>
                <div class="empty-text">No sessions this month yet. Book sessions to track earnings!</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    for (const session of monthSessions.slice(0, 20)) {
        const income = calculateSessionIncome(session);
        const date = new Date(session.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        
        html += `
            <div class="session-item" style="display: flex; justify-content: space-between; padding: 14px; border-bottom: 1px solid var(--border);">
                <div>
                    <div style="font-weight: 600; color: var(--forest);">${session.clientNames || 'Unknown Client'}</div>
                    <div style="font-size: 12px; color: var(--text-light);">${date}  ${session.type}  ${session.teacherName || ''}</div>
                </div>
                <div style="font-weight: 700; color: var(--coral);">${formatCurrency(income)}</div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function populateYearFilters() {
    const select = document.getElementById('historyYearFilter');
    const years = new Set();
    
    incomeData.forEach(d => {
        const year = d.id.split('-')[0];
        if (year) years.add(year);
    });
    
    // Add current year
    years.add(new Date().getFullYear().toString());
    
    const sortedYears = Array.from(years).sort().reverse();
    
    select.innerHTML = '<option value="all">All Years</option>';
    sortedYears.forEach(year => {
        select.innerHTML += `<option value="${year}">${year}</option>`;
    });
}

function renderIncomeHistory() {
    const tableBody = document.getElementById('incomeHistoryTable');
    const yearFilter = document.getElementById('historyYearFilter').value;
    
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                    'July', 'August', 'September', 'October', 'November', 'December'];
    
    let filteredData = [...incomeData];
    if (yearFilter !== 'all') {
        filteredData = filteredData.filter(d => d.id.startsWith(yearFilter));
    }
    
    filteredData.sort((a, b) => b.id.localeCompare(a.id));
    
    if (filteredData.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-light);">
                    No historical data found. Add entries manually or import from CSV.
                </td>
            </tr>
        `;
        return;
    }
    
    tableBody.innerHTML = filteredData.map(entry => {
        const [year, month] = entry.id.split('-');
        const monthName = months[parseInt(month) - 1];
        const source = entry.source || (entry.manual ? 'Manual' : 'Calculated');
        const subtotal = parseFloat(entry.subtotal || entry.manual || 0);
        const tax = parseFloat(entry.tax || 0);
        const total = parseFloat(entry.total || (subtotal + tax));
        
        return `
            <tr>
                <td><strong>${monthName} ${year}</strong></td>
                <td><span style="padding: 4px 8px; background: ${source === 'Import' ? 'var(--sage-tint)' : 'var(--coral-tint)'}; border-radius: 4px; font-size: 11px;">${source}</span></td>
                <td>${formatCurrency(subtotal)}</td>
                <td>${formatCurrency(tax)}</td>
                <td><strong>${formatCurrency(total)}</strong></td>
                <td style="font-size: 12px; color: var(--text-light);">${entry.notes || '-'}</td>
                <td>
                    <button class="btn-icon" onclick="editIncomeEntry('${entry.id}')" title="Edit"></button>
                    <button class="btn-icon" onclick="deleteIncomeEntry('${entry.id}')" title="Delete"></button>
                </td>
            </tr>
        `;
    }).join('');
}

// ========================================
// EMAIL SETTINGS
// ========================================

async function loadEmailSettings() {
    if (!organizationId || !isOwnerOrAdmin()) return;
    
    try {
        const doc = await db.collection('organizations').doc(organizationId).collection('settings').doc('email').get();
        if (doc.exists) {
            const settings = doc.data();
            document.getElementById('postmarkToken').value = settings.postmarkToken || '';
            document.getElementById('emailFromAddress').value = settings.fromEmail || '';
            document.getElementById('emailFromName').value = settings.fromName || '';
            document.getElementById('emailNotificationsEnabled').checked = settings.notificationsEnabled || false;
            document.getElementById('sendClientConfirmations').checked = settings.sendClientConfirmations !== false;
            document.getElementById('sendStaffNotifications').checked = settings.sendStaffNotifications !== false;
            document.getElementById('sendDaySummaries').checked = settings.sendDaySummaries !== false;
        }
    } catch (error) {
        console.error('Error loading email settings:', error);
    }
}

async function saveEmailSettings() {
    if (!isOwnerOrAdmin()) {
        alert('Only owners and admins can manage email settings.');
        return;
    }
    
    const settings = {
        postmarkToken: document.getElementById('postmarkToken').value.trim(),
        fromEmail: document.getElementById('emailFromAddress').value.trim(),
        fromName: document.getElementById('emailFromName').value.trim(),
        notificationsEnabled: document.getElementById('emailNotificationsEnabled').checked,
        sendClientConfirmations: document.getElementById('sendClientConfirmations').checked,
        sendStaffNotifications: document.getElementById('sendStaffNotifications').checked,
        sendDaySummaries: document.getElementById('sendDaySummaries').checked,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        await db.collection('organizations').doc(organizationId).collection('settings').doc('email').set(settings, { merge: true });
        alert('Email settings saved successfully!');
    } catch (error) {
        console.error('Error saving email settings:', error);
        alert('Error saving settings: ' + error.message);
    }
}

async function sendTestEmail() {
    const token = document.getElementById('postmarkToken').value.trim();
    const fromEmail = document.getElementById('emailFromAddress').value.trim();
    
    if (!token || !fromEmail) {
        alert('Please enter your Postmark token and sender email first.');
        return;
    }
    
    const testEmail = prompt('Enter email address to send test to:');
    if (!testEmail) return;
    
    try {
        // Call Cloud Function
        const sendTest = firebase.functions().httpsCallable('sendTestEmail');
        await sendTest({ orgId: organizationId, testEmail: testEmail });
        alert('Test email sent! Check your inbox.');
    } catch (error) {
        console.error('Error sending test email:', error);
        alert('Error sending test email: ' + error.message);
    }
}

// ========================================
// CURRENCY SETTINGS
// ========================================

async function loadCurrencySettings() {
    if (!organizationId || !isOwnerOrAdmin()) return;
    
    try {
        const doc = await db.collection('organizations').doc(organizationId).collection('settings').doc('general').get();
        if (doc.exists) {
            const settings = doc.data();
            orgCurrency = settings.currency || 'CAD';
            orgTaxRate = settings.taxRate || 13;
            
            document.getElementById('defaultTaxRate').value = orgTaxRate;
            
            // Update currency selector
            document.querySelectorAll('.currency-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.currency === orgCurrency);
            });
        }
    } catch (error) {
        console.error('Error loading currency settings:', error);
    }
}

function initCurrencySelector() {
    document.querySelectorAll('.currency-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.currency-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
        });
    });
}

async function saveCurrencySettings() {
    if (!isOwnerOrAdmin()) {
        alert('Only owners and admins can manage settings.');
        return;
    }
    
    const selectedCurrency = document.querySelector('.currency-option.selected');
    const currency = selectedCurrency ? selectedCurrency.dataset.currency : 'CAD';
    const taxRate = parseFloat(document.getElementById('defaultTaxRate').value) || 13;
    
    try {
        await db.collection('organizations').doc(organizationId).collection('settings').doc('general').set({
            currency: currency,
            taxRate: taxRate,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        orgCurrency = currency;
        orgTaxRate = taxRate;
        
        // Refresh income displays
        calculateIncomeStats();
        renderIncomeCharts();
        
        alert('Currency settings saved!');
    } catch (error) {
        console.error('Error saving currency settings:', error);
        alert('Error saving: ' + error.message);
    }
}

// ========================================
// INCOME IMPORT/EXPORT
// ========================================

let pendingImportData = null;

function initManualEntryYears() {
    const select = document.getElementById('manualEntryYear');
    const currentYear = new Date().getFullYear();
    
    select.innerHTML = '';
    for (let year = currentYear; year >= currentYear - 10; year--) {
        select.innerHTML += `<option value="${year}">${year}</option>`;
    }
}

async function addManualIncomeEntry() {
    if (!isOwnerOrAdmin()) {
        alert('Only owners and admins can add income entries.');
        return;
    }
    
    const month = document.getElementById('manualEntryMonth').value;
    const year = document.getElementById('manualEntryYear').value;
    const subtotal = parseFloat(document.getElementById('manualEntrySubtotal').value) || 0;
    const tax = parseFloat(document.getElementById('manualEntryTax').value) || 0;
    const notes = document.getElementById('manualEntryNotes').value.trim();
    
    if (subtotal <= 0) {
        alert('Please enter a valid subtotal amount.');
        return;
    }
    
    const entryId = `${year}-${month}`;
    
    try {
        await db.collection('organizations').doc(organizationId).collection('income').doc(entryId).set({
            subtotal: subtotal,
            tax: tax,
            total: subtotal + tax,
            manual: subtotal,
            notes: notes,
            source: 'Manual',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        // Reset form
        document.getElementById('manualEntrySubtotal').value = '';
        document.getElementById('manualEntryTax').value = '';
        document.getElementById('manualEntryNotes').value = '';
        
        // Reload data
        await loadIncomeData();
        alert('Income entry added successfully!');
    } catch (error) {
        console.error('Error adding income entry:', error);
        alert('Error adding entry: ' + error.message);
    }
}

async function editIncomeEntry(entryId) {
    const entry = incomeData.find(d => d.id === entryId);
    if (!entry) return;
    
    const newSubtotal = prompt('Enter new subtotal:', entry.subtotal || entry.manual || 0);
    if (newSubtotal === null) return;
    
    const newTax = prompt('Enter tax amount:', entry.tax || 0);
    if (newTax === null) return;
    
    const newNotes = prompt('Enter notes:', entry.notes || '');
    
    try {
        await db.collection('organizations').doc(organizationId).collection('income').doc(entryId).update({
            subtotal: parseFloat(newSubtotal) || 0,
            tax: parseFloat(newTax) || 0,
            total: (parseFloat(newSubtotal) || 0) + (parseFloat(newTax) || 0),
            notes: newNotes,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        await loadIncomeData();
        renderIncomeHistory();
        alert('Entry updated!');
    } catch (error) {
        console.error('Error updating entry:', error);
        alert('Error: ' + error.message);
    }
}

async function deleteIncomeEntry(entryId) {
    if (!confirm('Delete this income entry? This cannot be undone.')) return;
    
    try {
        await db.collection('organizations').doc(organizationId).collection('income').doc(entryId).delete();
        await loadIncomeData();
        renderIncomeHistory();
        alert('Entry deleted.');
    } catch (error) {
        console.error('Error deleting entry:', error);
        alert('Error: ' + error.message);
    }
}

function downloadIncomeTemplate() {
    const template = `month,year,subtotal,tax,total,type,notes
01,2024,4000.00,520.00,4520.00,total,January 2024 total income
02,2024,3800.00,494.00,4294.00,total,February 2024 total income
03,2024,4250.00,552.50,4802.50,total,March 2024 total income`;
    
    const blob = new Blob([template], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'income-import-template.csv';
    a.click();
    URL.revokeObjectURL(url);
}

function handleIncomeFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csv = e.target.result;
            const rows = csv.split('\n').map(row => row.split(','));
            const headers = rows[0].map(h => h.trim().toLowerCase());
            
            pendingImportData = [];
            
            for (let i = 1; i < rows.length; i++) {
                if (rows[i].length < 3) continue;
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = rows[i][index]?.trim().replace(/"/g, '') || '';
                });
                
                if (row.month && row.year && (row.subtotal || row.total)) {
                    pendingImportData.push({
                        id: `${row.year}-${row.month.padStart(2, '0')}`,
                        subtotal: parseFloat(row.subtotal) || 0,
                        tax: parseFloat(row.tax) || 0,
                        total: parseFloat(row.total) || (parseFloat(row.subtotal || 0) + parseFloat(row.tax || 0)),
                        notes: row.notes || 'Imported from CSV',
                        source: 'Import'
                    });
                }
            }
            
            // Show preview
            const preview = document.getElementById('importPreview');
            const content = document.getElementById('importPreviewContent');
            
            if (pendingImportData.length > 0) {
                content.innerHTML = `
                    <p><strong>${pendingImportData.length} entries found:</strong></p>
                    <ul style="max-height: 200px; overflow-y: auto; padding-left: 20px;">
                        ${pendingImportData.map(d => {
                            const [year, month] = d.id.split('-');
                            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            return `<li>${monthNames[parseInt(month) - 1]} ${year}: ${formatCurrency(d.total)}</li>`;
                        }).join('')}
                    </ul>
                `;
                preview.classList.add('visible');
            } else {
                alert('No valid data found in CSV. Please check the format.');
            }
        } catch (error) {
            console.error('Error parsing CSV:', error);
            alert('Error parsing CSV file: ' + error.message);
        }
    };
    reader.readAsText(file);
}

async function confirmIncomeImport() {
    if (!pendingImportData || pendingImportData.length === 0) return;
    
    try {
        const batch = db.batch();
        
        for (const entry of pendingImportData) {
            const ref = db.collection('organizations').doc(organizationId).collection('income').doc(entry.id);
            batch.set(ref, {
                ...entry,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }
        
        await batch.commit();
        
        cancelIncomeImport();
        await loadIncomeData();
        
        alert(`Successfully imported ${pendingImportData.length} entries!`);
    } catch (error) {
        console.error('Error importing data:', error);
        alert('Error importing: ' + error.message);
    }
}

function cancelIncomeImport() {
    pendingImportData = null;
    document.getElementById('importPreview').classList.remove('visible');
    document.getElementById('incomeFileInput').value = '';
}

// Initialize dropzone
function initIncomeDropzone() {
    const dropzone = document.getElementById('incomeImportDropzone');
    if (!dropzone) return;
    
    dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
    });
    
    dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
    });
    
    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        
        const file = e.dataTransfer.files[0];
        if (file && file.name.endsWith('.csv')) {
            const input = document.getElementById('incomeFileInput');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            input.files = dataTransfer.files;
            handleIncomeFileSelect({ target: { files: [file] } });
        }
    });
}

// ========================================
// SETTINGS VISIBILITY
// ========================================

function showSettingsSections() {
    if (isOwnerOrAdmin()) {
        document.getElementById('emailNotificationsSection').style.display = 'block';
        document.getElementById('currencySection').style.display = 'block';
        document.getElementById('incomeImportSection').style.display = 'block';
        
        // Load settings
        loadEmailSettings();
        loadCurrencySettings();
        initCurrencySelector();
        initManualEntryYears();
        initIncomeDropzone();
    }
}

// Modify existing loadSettings function to include new sections
const originalLoadSettings = typeof loadSettings === 'function' ? loadSettings : function() {};

loadSettings = function() {
    originalLoadSettings();
    showSettingsSections();
};

// Modify loadData to include income
const originalLoadData = loadData;
loadData = async function() {
    await originalLoadData();
    if (isOwnerOrAdmin()) {
        await loadIncomeData();
    }
};

// Logout function
function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
        auth.signOut().then(() => {
            window.location.href = 'login.html';
        }).catch((error) => {
            console.error('Logout error:', error);
            alert('Error logging out: ' + error.message);
        });
    }
}

// Initialize Lucide icons - moved to auth state listener
        
    </script>
</body>
</html>
