<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Flow - Boutique Pilates CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2C4A3E;
            --primary-light: #4A6B5D;
            --accent: #D4A574;
            --accent-light: #E8C9A1;
            --bg: #FAF8F5;
            --card: #FFFFFF;
            --text: #2A2A2A;
            --text-light: #6B6B6B;
            --border: #E5DFD6;
            --success: #5F8575;
            --warning: #D4A574;
            --error: #C86B5D;
            --shadow: rgba(44, 74, 62, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #FAF8F5 0%, #F5F1EA 100%);
            color: var(--text);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            right: -20%;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(212, 165, 116, 0.06) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: -30%;
            left: -10%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(44, 74, 62, 0.04) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

         <header>
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                <div class="logo-section">
                    <div class="logo-icon" id="logoIcon">
                        <img src="" alt="SF" id="logoImage" style="display: none;">
                        <span id="logoText">SF</span>
                    </div>
                    <div>
                        <h1 id="mainStudioName">Studio Flow</h1>
                        <div class="tagline">Boutique Studio Management</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div id="userInfo" style="text-align: right;">
                        <div id="userName" style="font-weight: 600; color: var(--primary); font-size: 16px;"></div>
                        <div id="userRole" style="font-size: 12px; color: var(--text-light); margin-top: 3px;"></div>
                    </div>
                    <button onclick="handleLogout()" style="padding: 12px 24px; background: linear-gradient(135deg, #C86B5D 0%, #B5564A 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease;">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        /* ADD THESE NEW LINES AFTER .logo-icon */
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 42px;
            font-weight: 300;
            color: var(--primary);
            letter-spacing: -0.5px;
        }

        .tagline {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-left: 65px;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 12px var(--shadow);
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 14px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-light);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(44, 74, 62, 0.2);
        }

        .tab:hover:not(.active) {
            background: var(--bg);
            color: var(--primary);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .card {
/* Settings specific styles */
.settings-section {
    margin-bottom: 40px;
}

.settings-section h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 24px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border);
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 8px;
    letter-spacing: 0.5px;
}

.form-group input[type="text"],
.form-group input[type="number"] {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-family: 'Montserrat', sans-serif;
    font-size: 14px;
    transition: all 0.3s ease;
}

.form-group input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(44, 74, 62, 0.1);
}

.logo-upload-section {
    display: flex;
    align-items: center;
    gap: 20px;
}

.logo-preview {
    width: 80px;
    height: 80px;
    background: var(--bg);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border: 2px solid var(--border);
}

.logo-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.logo-preview-text {
    font-family: 'Cormorant Garamond', serif;
    font-size: 36px;
    font-weight: 600;
    color: var(--primary);
}

.file-upload-wrapper {
    flex: 1;
}

.file-upload-btn {
    display: inline-block;
    padding: 10px 20px;
    background: var(--primary);
    color: white;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-upload-btn:hover {
    background: var(--primary-light);
    transform: translateY(-2px);
}

.file-upload-btn input[type="file"] {
    display: none;
}

.teacher-list {
    display: grid;
    gap: 12px;
}

.teacher-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: var(--bg);
    border-radius: 10px;
    border: 2px solid var(--border);
    transition: all 0.3s ease;
}

.teacher-item.inactive {
    opacity: 0.5;
    background: #f5f5f5;
}

.teacher-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.teacher-name {
    font-weight: 600;
    color: var(--primary);
}

.teacher-status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.status-active {
    background: #E8F5E9;
    color: #2C4A3E;
}

.status-inactive {
    background: #FFE5E5;
    color: #C86B5D;
}

.teacher-actions {
    display: flex;
    gap: 8px;
}

.class-pricing-list {
    display: grid;
    gap: 15px;
}

.class-pricing-item {
    display: grid;
    grid-template-columns: 1fr 150px auto;
    gap: 15px;
    align-items: end;
    padding: 16px;
    background: var(--bg);
    border-radius: 10px;
    border: 2px solid var(--border);
}

.price-input-group {
    position: relative;
}

.price-input-group label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-light);
    margin-bottom: 6px;
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.price-input-group input {
    width: 100%;
    padding: 10px 10px 10px 25px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
}

.price-input-group::before {
    content: '$';
    position: absolute;
    left: 10px;
    bottom: 11px;
    font-weight: 600;
    color: var(--text-light);
}

.owner-management-list {
    display: grid;
    gap: 12px;
}

.owner-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: linear-gradient(135deg, #E8F5E9 0%, #F1F8F4 100%);
    border-radius: 10px;
    border: 2px solid #5F8575;
}

.owner-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.owner-badge {
    padding: 4px 12px;
    background: #2C4A3E;
    color: white;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.btn-primary {
    padding: 12px 24px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-family: 'Montserrat', sans-serif;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(44, 74, 62, 0.3);
}

.btn-secondary {
    padding: 10px 20px;
    background: transparent;
    color: var(--primary);
    border: 2px solid var(--primary);
    border-radius: 8px;
    font-family: 'Montserrat', sans-serif;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: var(--primary);
    color: white;
}

.btn-danger {
    padding: 10px 20px;
    background: transparent;
    color: var(--error);
    border: 2px solid var(--error);
    border-radius: 8px;
    font-family: 'Montserrat', sans-serif;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-danger:hover {
    background: var(--error);
    color: white;
}

.btn-small {
    padding: 6px 12px;
    font-size: 11px;
}

.add-new-section {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.add-new-section input {
    flex: 1;
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
}

.permission-notice {
    background: #FFF9E6;
    border-left: 4px solid var(--warning);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 13px;
    color: var(--text);
}
            
            background: var(--card);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 2px 20px var(--shadow);
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .income-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .income-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 16px var(--shadow);
        }

        .income-card.secondary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
        }

        .income-card.quickbooks {
            background: linear-gradient(135deg, #2CA01C 0%, #46B536 100%);
        }

        .income-label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .income-amount {
            font-family: 'Cormorant Garamond', serif;
            font-size: 36px;
            font-weight: 600;
            letter-spacing: -1px;
        }

        .income-subtitle {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
        }

        .form-card h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            font-weight: 400;
            color: var(--primary);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 18px;
        }

        .form-row-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .price-input-wrapper {
            display: flex;
            flex-direction: column;
        }

        .price-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 6px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            color: var(--text);
            background: var(--bg);
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(44, 74, 62, 0.06);
        }

        select {
            cursor: pointer;
        }

        textarea {
            resize: vertical;
            min-height: 70px;
            font-size: 13px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.05) 0%, rgba(212, 165, 116, 0.02) 100%);
            border-radius: 8px;
            border: 1.5px solid var(--accent-light);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 18px;
        }

        .checkbox-group:hover {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.08) 0%, rgba(212, 165, 116, 0.04) 100%);
            border-color: var(--accent);
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .checkbox-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--primary);
            cursor: pointer;
            letter-spacing: 0.3px;
            text-transform: none;
            margin: 0;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        button {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(44, 74, 62, 0.2);
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 74, 62, 0.3);
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1.5px solid var(--border);
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--primary);
        }

        .btn-google {
            background: white;
            color: var(--primary);
            border: 1.5px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-google:hover {
            background: var(--primary);
            color: white;
        }

        .btn-quickbooks {
            background: white;
            color: #2CA01C;
            border: 1.5px solid #2CA01C;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-quickbooks:hover {
            background: #2CA01C;
            color: white;
        }

        .btn-outlook {
            background: white;
            color: #0078D4;
            border: 1.5px solid #0078D4;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-outlook:hover {
            background: #0078D4;
            color: white;
        }

        .btn-invoice {
            background: linear-gradient(135deg, #2CA01C 0%, #46B536 100%);
            color: white;
            padding: 10px 18px;
            font-size: 11px;
        }

        .btn-invoice:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 160, 28, 0.3);
        }

        .client-selector {
            margin-bottom: 18px;
        }

        .client-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .client-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .client-chip:hover {
            background: var(--primary-light);
            transform: scale(1.05);
        }

        .client-chip .remove {
            width: 16px;
            height: 16px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .sessions-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .session-item {
            padding: 20px;
            background: var(--bg);
            border-radius: 12px;
            border: 1.5px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .session-item:hover {
            background: white;
            border-color: var(--primary);
            transform: translateX(4px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .session-type {
            font-weight: 600;
            font-size: 16px;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .session-datetime {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .session-clients {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .session-client-badge {
            padding: 4px 10px;
            background: linear-gradient(135deg, rgba(44, 74, 62, 0.1) 0%, rgba(44, 74, 62, 0.05) 100%);
            color: var(--primary);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .session-price {
            font-family: 'Cormorant Garamond', serif;
            font-size: 24px;
            font-weight: 600;
            color: var(--accent);
            letter-spacing: -0.5px;
        }

        .session-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 14px;
            font-size: 11px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-top: 8px;
            margin-right: 6px;
        }

        .status-repeating {
            background: rgba(95, 133, 117, 0.15);
            color: var(--success);
        }

        .status-vacation {
            background: rgba(212, 165, 116, 0.15);
            color: var(--warning);
        }

        .status-invoiced {
            background: rgba(44, 160, 28, 0.15);
            color: #2CA01C;
        }

        .status-paid {
            background: rgba(44, 160, 28, 0.25);
            color: #2CA01C;
            font-weight: 700;
        }

        .status-unpaid {
            background: rgba(200, 107, 93, 0.15);
            color: var(--error);
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 16px;
        }

        .integration-setup {
            background: linear-gradient(135deg, rgba(44, 160, 28, 0.05) 0%, rgba(44, 160, 28, 0.02) 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1.5px solid rgba(44, 160, 28, 0.2);
            margin-bottom: 25px;
        }

        .integration-setup.google {
            background: linear-gradient(135deg, rgba(66, 133, 244, 0.05) 0%, rgba(66, 133, 244, 0.02) 100%);
            border: 1.5px solid rgba(66, 133, 244, 0.2);
        }

        .integration-setup.outlook {
            background: linear-gradient(135deg, rgba(0, 120, 212, 0.03) 0%, rgba(0, 120, 212, 0.01) 100%);
            border: 1.5px solid rgba(0, 120, 212, 0.2);
        }

        .integration-setup h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 18px;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .integration-setup p {
            font-size: 13px;
            color: var(--text-light);
            line-height: 1.6;
            margin-bottom: 14px;
        }

        .integration-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: white;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--success);
        }

        .setup-steps {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 16px;
            border: 1.5px solid var(--border);
        }

        .setup-steps ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .setup-steps li {
            font-size: 13px;
            color: var(--text);
            margin-bottom: 8px;
        }

        .setup-steps code {
            background: var(--bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: var(--primary);
        }

        .setup-steps a {
            color: #2CA01C;
            text-decoration: none;
            font-weight: 600;
        }

        .setup-steps a:hover {
            text-decoration: underline;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px;
            color: var(--text-light);
        }

        .multi-select {
            border: 1.5px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            background: var(--bg);
            max-height: 200px;
            overflow-y: auto;
        }

        .multi-select-option {
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .multi-select-option:hover {
            background: white;
        }

        .multi-select-option.selected {
            background: linear-gradient(135deg, rgba(44, 74, 62, 0.1) 0%, rgba(44, 74, 62, 0.05) 100%);
        }

        .multi-select-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .teacher-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .teacher-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg);
            border-radius: 10px;
            border: 1.5px solid var(--border);
        }

        .teacher-item.default-teacher {
            background: linear-gradient(135deg, rgba(44, 74, 62, 0.06) 0%, rgba(44, 74, 62, 0.02) 100%);
            border-color: var(--primary);
        }

        .teacher-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 15px;
        }

        .teacher-actions {
            display: flex;
            gap: 8px;
        }

        .default-badge {
            padding: 4px 10px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .warning-message {
            background: rgba(212, 165, 116, 0.1);
            border: 1.5px solid var(--accent-light);
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text);
            margin-bottom: 18px;
        }

        .rate-display {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .rate-pill {
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(44, 74, 62, 0.08) 0%, rgba(44, 74, 62, 0.04) 100%);
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            color: var(--primary);
        }

        .invoice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .invoice-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            color: var(--primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-light);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .modal-close:hover {
            color: var(--text);
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        .btn-primary {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 74, 62, 0.3);
        }

        .btn-secondary {
            padding: 12px 24px;
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--primary);
        }

        .btn-danger {
            padding: 8px 16px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }
   
    </style>
</head>
<body>
    <div class="container">
        <header>
    <div class="logo-section">
        <div class="logo-icon" id="mainLogo">SF</div>
        <h1 id="mainStudioName">Studio Flow</h1>
    </div>
            <div class="tagline">Boutique Pilates Client & Session Management</div>

            <div style="position: absolute; top: 50px; right: 50px;">
                <button onclick="logout()" style="padding: 10px 20px; background: var(--bg); border: 1.5px solid var(--border); border-radius: 8px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 12px; font-weight: 600; color: var(--text); transition: all 0.3s ease;">
                    Logout
                </button>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('clients')">üë• Clients</button>
            <button class="tab" onclick="showTab('sessions')">üóìÔ∏è Sessions</button>
            <button class="tab" id="incomeTab" onclick="showTab('income')">üí∞ Income</button>
            <button class="tab" onclick="showTab('integrations')">üîó Integrations</button>
            <button class="tab" id="settingsTab" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
        </nav>

        <!-- CLIENTS TAB -->
        <div id="clients-tab" class="tab-content active">
            <div class="main-grid">
                <div class="card form-card">
                    <h2><span class="section-icon"></span><span id="form-title">Add New Client</span></h2>
                    <form id="clientForm">
                        <div class="form-group">
                            <label for="name">Client Name</label>
                            <input type="text" id="name" required placeholder="First & Last Name">
                        </div>

                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" required placeholder="client@email.com">
                        </div>

                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" required placeholder="(555) 123-4567">
                        </div>

                        <div>
                            <div class="form-row-label">Session Rates ($)</div>
                            <div class="form-row">
                                <div class="price-input-wrapper">
                                    <label class="price-label" for="ratePrivate">Private</label>
                                    <input type="number" id="ratePrivate" required placeholder="85" min="0" step="0.01">
                                </div>
                                <div class="price-input-wrapper">
                                    <label class="price-label" for="rateDuet">Duet</label>
                                    <input type="number" id="rateDuet" required placeholder="60" min="0" step="0.01">
                                </div>
                                <div class="price-input-wrapper">
                                    <label class="price-label" for="rateTrio">Trio</label>
                                    <input type="number" id="rateTrio" required placeholder="45" min="0" step="0.01">
                                </div>
                            </div>
                        </div>

                        <label class="checkbox-group">
                            <input type="checkbox" id="waiver">
                            <span class="checkbox-label">Liability Waiver on File</span>
                        </label>

                        <div class="form-group">
                            <label for="notes">Session Notes</label>
                            <textarea id="notes" placeholder="Equipment preferences, injuries, modifications..."></textarea>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn-primary" id="submitBtn">Add Client</button>
                            <button type="button" class="btn-secondary" id="cancelBtn" style="display: none;">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="card clients-card">
                    <h2>
                        <span><span class="section-icon"></span> Your Clients</span>
                        <span class="client-count" id="clientCount" style="font-size: 14px; font-family: 'Montserrat', sans-serif; font-weight: 500; color: var(--accent); letter-spacing: 1px;">0 Clients</span>
                    </h2>
                    
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="searchInput" placeholder="Search clients by name...">
                    </div>

                    <div class="sessions-list" id="clientList">
                        <div class="empty-state">
                            <div class="empty-icon">üßò‚Äç‚ôÄÔ∏è</div>
                            <div class="empty-text">No clients yet. Add your first client to get started!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TEACHERS TAB -->
        <div id="teachers-tab" class="tab-content">
            <div class="main-grid">
                <div class="card form-card">
                    <h2><span class="section-icon"></span><span id="teacher-form-title">Add Teacher</span></h2>
                    <form id="teacherForm">
                        <div class="form-group">
                            <label for="teacherName">Teacher Name</label>
                            <input type="text" id="teacherName" required placeholder="Full Name">
                        </div>

                        <div class="form-group">
                            <label for="teacherEmail">Email Address</label>
                            <input type="email" id="teacherEmail" required placeholder="teacher@email.com">
                        </div>

                        <label class="checkbox-group">
                            <input type="checkbox" id="defaultTeacher">
                            <span class="checkbox-label">Set as Default Teacher</span>
                        </label>

                        <div class="btn-group">
                            <button type="submit" class="btn-primary" id="teacherSubmitBtn">Add Teacher</button>
                            <button type="button" class="btn-secondary" id="teacherCancelBtn" style="display: none;">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h2>
                        <span><span class="section-icon"></span> Your Teachers</span>
                        <span id="teacherCount" style="font-size: 14px; font-family: 'Montserrat', sans-serif; font-weight: 500; color: var(--accent); letter-spacing: 1px;">0 Teachers</span>
                    </h2>
                    
                    <div id="teacherLimitWarning" class="warning-message" style="display: none;">
                        You've reached the maximum of 4 teachers. Delete a teacher to add another.
                    </div>

                    <div class="teacher-list" id="teacherList">
                        <div class="empty-state">
                            <div class="empty-icon">üë®‚Äçüè´</div>
                            <div class="empty-text">No teachers added yet. Add your first teacher!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SESSIONS TAB -->
        <div id="sessions-tab" class="tab-content">
            <div class="main-grid">
                <div class="card form-card">
                    <h2><span class="section-icon"></span><span id="session-form-title">Book New Session</span></h2>
                    <form id="sessionForm">
                        <div class="form-group">
                            <label for="sessionType">Session Type</label>
                            <select id="sessionType" required onchange="updateClientSelection()">
                                <option value="">Select session type...</option>
                                <option value="Private">Private Session</option>
                                <option value="Duet">Duet Session</option>
                                <option value="Trio">Trio Session</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="sessionTeacher">Teacher</label>
                            <select id="sessionTeacher" required>
                                <option value="">Select teacher...</option>
                            </select>
                        </div>

                        <div class="form-group client-selector">
                            <label>Select Client(s)</label>
                            <div class="multi-select" id="clientMultiSelect"></div>
                            <div class="client-chips" id="selectedClients"></div>
                        </div>

                        <div class="form-group">
                            <label for="sessionDate">Date</label>
                            <input type="date" id="sessionDate" required>
                        </div>

                        <div class="form-group">
                            <label for="sessionTime">Time</label>
                            <input type="time" id="sessionTime" required>
                        </div>

                        <label class="checkbox-group">
                            <input type="checkbox" id="repeatSession">
                            <span class="checkbox-label">Repeating Session (Weekly)</span>
                        </label>

                        <div class="form-group">
                            <label for="sessionNotes">Session Notes</label>
                            <textarea id="sessionNotes" placeholder="Special instructions or modifications..."></textarea>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn-primary" id="sessionSubmitBtn">Book Session</button>
                            <button type="button" class="btn-secondary" id="sessionCancelBtn" style="display: none;">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h2><span class="section-icon"></span> Upcoming Sessions</h2>
                    
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="sessionSearchInput" placeholder="Search sessions...">
                    </div>

                    <div class="sessions-list" id="sessionsList">
                        <div class="empty-state">
                            <div class="empty-icon">üìÖ</div>
                            <div class="empty-text">No sessions booked yet. Create your first session!</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INVOICES TAB -->
        <div id="invoices-tab" class="tab-content">
            <div class="card">

                <h2 style="margin-top: 30px;"><span class="section-icon"></span> Invoice Management</h2>
                
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <button class="btn-invoice" onclick="showBulkInvoiceModal()">
                        üìÑ Generate Bulk Invoices
                    </button>
                    <button class="btn-secondary" onclick="refreshInvoiceStatus()">
                        üîÑ Refresh Payment Status
                    </button>
                </div>

                <div class="sessions-list" id="invoicesList">
                    <div class="empty-state">
                        <div class="empty-icon">üíö</div>
                        <div class="empty-text">No invoices yet. Book sessions and generate invoices!</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INCOME TAB -->
        <div id="income-tab" class="tab-content">
            <div class="income-summary">
                <div class="income-card">
                    <div class="income-label">This Week</div>
                    <div class="income-amount" id="weeklyIncome">$0</div>
                    <div class="income-subtitle" id="weeklySessions">0 sessions</div>
                </div>
                <div class="income-card">
                    <div class="income-label">This Month</div>
                    <div class="income-amount" id="monthlyIncome">$0</div>
                    <div class="income-subtitle" id="monthlySessions">0 sessions</div>
                </div>
                <div class="income-card secondary">
                    <div class="income-label">Projected Monthly</div>
                    <div class="income-amount" id="projectedIncome">$0</div>
                    <div class="income-subtitle">Based on repeating sessions</div>
                </div>
                <div class="income-card quickbooks">
                    <div class="income-label">Outstanding Invoices</div>
                    <div class="income-amount" id="outstandingInvoices">$0</div>
                    <div class="income-subtitle" id="outstandingCount">0 unpaid</div>
                </div>
            </div>

            <div class="card">
                <h2><span class="section-icon"></span> Income Breakdown</h2>
                <div class="sessions-list" id="incomeBreakdown">
                    <div class="empty-state">
                        <div class="empty-icon">üí∞</div>
                        <div class="empty-text">No income data yet. Book sessions to track earnings!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="invoice-modal" id="invoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Generate Invoices</h3>
                <button class="modal-close" onclick="closeInvoiceModal()">√ó</button>
            </div>
            
            <div class="form-group">
                <label>Select Date Range</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <input type="date" id="invoiceStartDate">
                    <input type="date" id="invoiceEndDate">
                </div>
            </div>

            <div class="form-group">
                <label>Due Date</label>
                <input type="date" id="invoiceDueDate">
            </div>

            <div id="invoicePreview" style="margin: 20px 0;">
                <!-- Preview will be inserted here -->
            </div>

            <div class="btn-group">
                <button class="btn-invoice" onclick="generateBulkInvoices()">Generate & Send Invoices</button>
                <button class="btn-secondary" onclick="closeInvoiceModal()">Cancel</button>
            </div>
        </div>
    </div>

        <div id="settings-tab" class="tab-content">
            <div class="card">
                <h2 style="font-family: 'Cormorant Garamond', serif; font-size: 32px; font-weight: 300; color: var(--primary); margin-bottom: 30px;">Settings</h2>

                <!-- Business Information Section -->
                <div class="settings-section">
                    <h3>Business Information</h3>
                    <div class="form-group">
                        <label>Business Name</label>
                        <input type="text" id="studioNameSetting" placeholder="Your Studio Name">
                    </div>
                    
                    <div class="form-group">
                        <label>Business Logo</label>
                        <div class="logo-upload-section">
                            <div class="logo-preview" id="logoPreview">
                                <span class="logo-preview-text">SF</span>
                            </div>
                            <div class="file-upload-wrapper">
                                <label class="file-upload-btn">
                                    Choose Logo Image
                                    <input type="file" id="logoUpload" accept="image/*" onchange="handleLogoUpload(event)">
                                </label>
                                <p style="margin-top: 8px; font-size: 12px; color: var(--text-light);">
                                    Upload a square image (recommended 200x200px). Max file size: 500KB.
                                </p>
                                <button class="btn-secondary btn-small" onclick="removeLogo()" style="margin-top: 10px;">Remove Logo</button>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="saveBusinessInfo()">Save Business Information</button>
                </div>

                <!-- Calendar & Email Integrations Section -->
                <div class="settings-section">
                    <h3>Calendar & Email Integrations</h3>
                    <p style="margin-bottom: 20px; font-size: 13px; color: var(--text-light);">
                        Connect your calendar and email accounts to automatically create events when booking sessions.
                    </p>

                    <div class="integration-setup google" style="margin-bottom: 20px;">
                        <h3>üìÖ Google Calendar Integration</h3>
                        <p>Connect your Google account to automatically create calendar events and send invites to clients.</p>
                        <button type="button" class="btn-google" onclick="connectGoogleCalendar()">
                            <span>üîó</span> Connect Google Calendar
                        </button>
                        <div id="google-status" style="display: none; margin-top: 12px;">
                            <span class="integration-status">‚úì Connected</span>
                            <button type="button" class="btn-secondary btn-small" onclick="disconnectGoogleCalendar()" style="margin-left: 12px;">
                                Disconnect
                            </button>
                        </div>
                    </div>

                    <div class="integration-setup outlook">
                        <h3>üìß Microsoft Outlook / Microsoft 365 Integration</h3>
                        <p>Connect your Microsoft account to access Outlook Calendar and Email for automated scheduling and client communications.</p>
                        <button type="button" class="btn-outlook" onclick="connectMicrosoftOutlook()">
                            <span>üîó</span> Connect Microsoft Outlook
                        </button>
                        <div id="outlook-status" style="display: none; margin-top: 12px;">
                            <span class="integration-status">‚úì Connected to Microsoft Outlook</span>
                            <button type="button" class="btn-secondary btn-small" onclick="disconnectMicrosoftOutlook()" style="margin-left: 12px;">
                                Disconnect
                            </button>
                        </div>
                        
                        <div class="setup-steps" style="margin-top: 16px; font-size: 13px;">
                            <p style="margin-bottom: 8px;"><strong>What you get:</strong></p>
                            <ul style="margin-left: 20px; line-height: 1.8; color: var(--text-light);">
                                <li>Automatically create Outlook calendar events for sessions</li>
                                <li>Send appointment reminders via Outlook email</li>
                                <li>Invite clients to sessions with calendar events</li>
                                <li>Works with personal Outlook and Microsoft 365 business accounts</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Owner Management Section -->
 <div id="settings-content" class="tab-content">
    <div class="card">
        <!-- User Management Section (Owner Only) -->
        <div id="userManagementSection"></div>

        <!-- QuickBooks Integration (Owner/Admin Only) -->
        <div id="quickbooksSection"></div>

        <!-- Studio Settings -->
        <div class="settings-section">
            <h3>üé® Studio Settings</h3>
            
            <div class="form-group">
                <label for="studio-name">Studio Name</label>
                <input type="text" id="studio-name" placeholder="Your Studio Name">
            </div>

            <div class="form-group logo-upload-section">
                <div>
                    <label>Studio Logo</label>
                    <input type="file" id="logo-upload" accept="image/*" onchange="handleLogoUpload(event)">
                    <p style="font-size: 12px; color: var(--text-light); margin-top: 5px;">
                        Recommended: Square image, at least 200x200px
                    </p>
                </div>
                <div class="logo-preview" id="logo-preview-settings">
                    <div class="logo-icon">SF</div>
                </div>
            </div>

            <button onclick="saveSettings()" class="btn-primary">Save Settings</button>
        </div>

        <!-- Session Types -->
        <div class="settings-section">
            <h3>üìã Session Types</h3>
            <div id="session-types-list"></div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <input type="text" id="new-session-type" placeholder="New session type..." 
                       style="flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 8px;">
                <button onclick="addSessionType()" class="btn-primary">Add Type</button>
            </div>
        </div>
    </div>
</div>

    <script>

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        
        function getOrgKey(key) {
            const orgId = localStorage.getItem('currentOrganization');
            return key + '_' + orgId;
        }

        function getCurrentUserData() {
            const currentUserEmail = localStorage.getItem('currentUser');
            const users = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
            return users[currentUserEmail] || null;
        }

        function isOwner() {
            const currentUserEmail = localStorage.getItem('currentUser');
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            
            if (!settings.owners) {
                const userData = getCurrentUserData();
                if (userData) {
                    settings.owners = [currentUserEmail];
                    localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
                    return true;
                }
                return false;
            }
            
            return settings.owners.includes(currentUserEmail);
        }

        // ========================================
        // DATA STORAGE
        // ========================================
        
        let clients = [];
        let sessions = [];
        let teachers = [];
        let invoices = [];

        function loadData() {
            clients = JSON.parse(localStorage.getItem(getOrgKey('clients')) || '[]');
            sessions = JSON.parse(localStorage.getItem(getOrgKey('sessions')) || '[]');
            teachers = JSON.parse(localStorage.getItem(getOrgKey('teachers')) || '[]');
            invoices = JSON.parse(localStorage.getItem(getOrgKey('invoices')) || '[]');
            
            renderClients();
            renderTeachers();
            renderSessions();
            renderInvoices();
        }

        function saveData() {
            localStorage.setItem(getOrgKey('clients'), JSON.stringify(clients));
            localStorage.setItem(getOrgKey('sessions'), JSON.stringify(sessions));
            localStorage.setItem(getOrgKey('teachers'), JSON.stringify(teachers));
            localStorage.setItem(getOrgKey('invoices'), JSON.stringify(invoices));
        }

        // ========================================
        // TAB SWITCHING
        // ========================================
        
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'settings') {
                loadSettings();
            }
        }

        // ========================================
        // LOGOUT
        // ========================================
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentOrganization');
                window.location.href = 'login.html';
            }
        }

        // ========================================
        // CLIENT MANAGEMENT
        // ========================================
        
        function renderClients() {
            const container = document.getElementById('clientsList');
            if (!container) return;
            
            if (clients.length === 0) {
                container.innerHTML = '<p>No clients yet. Add your first client above.</p>';
                return;
            }
            
            container.innerHTML = clients.map((client, index) => `
                <div style="padding: 15px; background: var(--bg); border-radius: 8px; margin-bottom: 10px;">
                    <strong>${client.name}</strong><br>
                    Email: ${client.email || 'N/A'}<br>
                    Phone: ${client.phone || 'N/A'}
                    <div style="margin-top: 10px;">
                        <button class="btn-secondary" onclick="editClient(${index})" style="margin-right: 5px;">Edit</button>
                        <button class="btn-secondary" onclick="deleteClient(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function addClient(event) {
            event.preventDefault();
            
            const name = document.getElementById('clientName').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();
            
            if (!name) {
                alert('Please enter a client name');
                return;
            }
            
            const client = {
                id: Date.now(),
                name: name,
                email: email,
                phone: phone,
                createdAt: new Date().toISOString()
            };
            
            clients.push(client);
            saveData();
            renderClients();
            
            document.getElementById('clientForm').reset();
            alert('Client added successfully!');
        }

        function editClient(index) {
            const client = clients[index];
            const newName = prompt('Edit name:', client.name);
            if (newName && newName.trim()) {
                clients[index].name = newName.trim();
                saveData();
                renderClients();
            }
        }

        function deleteClient(index) {
            if (confirm('Delete this client?')) {
                clients.splice(index, 1);
                saveData();
                renderClients();
            }
        }

        // ========================================
        // TEACHER MANAGEMENT
        // ========================================
        
        function renderTeachers() {
            const container = document.getElementById('teachersList');
            if (!container) return;
            
            if (teachers.length === 0) {
                container.innerHTML = '<p>No teachers yet. Add your first teacher above.</p>';
                return;
            }
            
            container.innerHTML = teachers.map((teacher, index) => `
                <div style="padding: 15px; background: var(--bg); border-radius: 8px; margin-bottom: 10px;">
                    <strong>${teacher.name}</strong><br>
                    ${teacher.email || 'No email'}<br>
                    Status: ${teacher.active !== false ? 'Active' : 'Inactive'}
                    <div style="margin-top: 10px;">
                        <button class="btn-secondary" onclick="editTeacher(${index})" style="margin-right: 5px;">Edit</button>
                        <button class="btn-secondary" onclick="deleteTeacher(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function addTeacher(event) {
            event.preventDefault();
            
            const name = document.getElementById('teacherName').value.trim();
            const email = document.getElementById('teacherEmail').value.trim();
            
            if (!name) {
                alert('Please enter a teacher name');
                return;
            }
            
            const teacher = {
                id: Date.now(),
                name: name,
                email: email,
                active: true,
                createdAt: new Date().toISOString()
            };
            
            teachers.push(teacher);
            saveData();
            renderTeachers();
            
            document.getElementById('teacherForm').reset();
            alert('Teacher added successfully!');
        }

        function editTeacher(index) {
            const teacher = teachers[index];
            const newName = prompt('Edit name:', teacher.name);
            if (newName && newName.trim()) {
                teachers[index].name = newName.trim();
                saveData();
                renderTeachers();
            }
        }

        function deleteTeacher(index) {
            if (confirm('Delete this teacher?')) {
                teachers.splice(index, 1);
                saveData();
                renderTeachers();
            }
        }

        // ========================================
        // SESSION MANAGEMENT
        // ========================================
        
        function renderSessions() {
            const container = document.getElementById('sessionsList');
            if (!container) return;
            
            if (sessions.length === 0) {
                container.innerHTML = '<p>No sessions booked yet.</p>';
                return;
            }
            
            const sorted = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sorted.map((session, index) => `
                <div style="padding: 15px; background: var(--bg); border-radius: 8px; margin-bottom: 10px;">
                    <strong>${session.type || 'Session'}</strong><br>
                    Date: ${new Date(session.date).toLocaleDateString()}<br>
                    Teacher: ${session.teacherName || 'N/A'}<br>
                    Clients: ${session.clientNames || 'N/A'}
                    <div style="margin-top: 10px;">
                        <button class="btn-secondary" onclick="deleteSession(${sessions.indexOf(session)})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function addSession(event) {
            event.preventDefault();
            
            const type = document.getElementById('sessionType').value;
            const date = document.getElementById('sessionDate').value;
            const time = document.getElementById('sessionTime').value;
            const teacher = document.getElementById('sessionTeacher').value;
            const notes = document.getElementById('sessionNotes').value;
            
            if (!type || !date || !time) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Get selected clients
            const selectedClientIds = Array.from(document.querySelectorAll('.client-chip')).map(chip => {
                return parseInt(chip.dataset.clientId);
            });
            
            const session = {
                id: Date.now(),
                type: type,
                date: date,
                time: time,
                teacherName: teacher,
                clients: selectedClientIds,
                notes: notes,
                createdAt: new Date().toISOString()
            };
            
            sessions.push(session);
            saveData();
            renderSessions();
            
            // Create calendar events on connected platforms
            createCalendarEventsForSession(session);
            
            document.getElementById('sessionForm').reset();
            alert('Session booked successfully!');
        }

        function deleteSession(index) {
            if (confirm('Delete this session?')) {
                sessions.splice(index, 1);
                saveData();
                renderSessions();
            }
        }

        // ========================================
        // INVOICE MANAGEMENT
        // ========================================
        
        function renderInvoices() {
            const container = document.getElementById('invoicesList');
            if (!container) return;
            
            if (invoices.length === 0) {
                container.innerHTML = '<p>No invoices yet.</p>';
                return;
            }
            
            container.innerHTML = invoices.map((invoice, index) => `
                <div style="padding: 15px; background: var(--bg); border-radius: 8px; margin-bottom: 10px;">
                    <strong>Invoice #${invoice.id}</strong><br>
                    Amount: $${invoice.amount}<br>
                    Status: ${invoice.status || 'unpaid'}<br>
                    Date: ${new Date(invoice.date).toLocaleDateString()}
                    <div style="margin-top: 10px;">
                        <button class="btn-secondary" onclick="toggleInvoiceStatus(${index})">
                            Mark as ${invoice.status === 'paid' ? 'Unpaid' : 'Paid'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function generateInvoice() {
            const amount = prompt('Enter invoice amount:');
            if (!amount || isNaN(amount)) {
                alert('Invalid amount');
                return;
            }
            
            const invoice = {
                id: Date.now(),
                amount: parseFloat(amount),
                status: 'unpaid',
                date: new Date().toISOString()
            };
            
            invoices.push(invoice);
            saveData();
            renderInvoices();
            alert('Invoice created!');
        }

        function toggleInvoiceStatus(index) {
            invoices[index].status = invoices[index].status === 'paid' ? 'unpaid' : 'paid';
            saveData();
            renderInvoices();
        }

        // ========================================
        // SETTINGS FUNCTIONS
        // ========================================
        
        function loadSettings() {
            if (!isOwner()) {
                document.getElementById('settingsTab').style.display = 'none';
                switchTab('clients', event);
                alert('You do not have permission to access Settings.');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            const userData = getCurrentUserData();
            
            if (userData) {
                const nameInput = document.getElementById('studioNameSetting');
                if (nameInput) {
                    nameInput.value = userData.studioName || '';
                }
                document.getElementById('mainStudioName').textContent = userData.studioName || 'Studio Flow';
            }
            
            if (settings.logo) {
                updateLogoDisplay(settings.logo);
            } else {
                updateLogoDisplay(null);
            }
            // Load user management (owner only)
            const userMgmtSection = document.getElementById('userManagementSection');
            if (userMgmtSection) {
                if (canManageUsers()) {
                    userMgmtSection.innerHTML = renderUserManagement();
                } else {
                    userMgmtSection.innerHTML = '';
                }
            }

        // Load QuickBooks settings (owner/admin only)
        const qbSection = document.getElementById('quickbooksSection');
        if (qbSection) {
            if (canAccessSettings()) {
                qbSection.innerHTML = renderQuickBooksSettings();
            } else {
                qbSection.innerHTML = '';
            }
        }

        renderOwnersList();
        renderTeachersList();
        renderClassPricing();

        function saveBusinessInfo() {
            const studioName = document.getElementById('studioNameSetting').value.trim();
            
            if (!studioName) {
                alert('Please enter a business name');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
            const currentUser = localStorage.getItem('currentUser');
            if (users[currentUser]) {
                users[currentUser].studioName = studioName;
                localStorage.setItem('studioFlowUsers', JSON.stringify(users));
            }
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            settings.studioName = studioName;
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            
            document.getElementById('mainStudioName').textContent = studioName;
            
            alert('Business information saved successfully!');
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 500000) {
                alert('File size must be less than 500KB');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
                settings.logo = imageData;
                localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
                updateLogoDisplay(imageData);
                alert('Logo uploaded successfully!');
            };
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            if (!confirm('Remove your business logo?')) return;
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            delete settings.logo;
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            updateLogoDisplay(null);
            alert('Logo removed successfully!');
        }

        function updateLogoDisplay(imageData) {
            const logoPreview = document.getElementById('logoPreview');
            const mainLogo = document.getElementById('mainLogo');
            const userData = getCurrentUserData();
            const studioName = userData ? userData.studioName : 'Studio Flow';
            const initials = studioName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
            
            if (imageData) {
                if (logoPreview) logoPreview.innerHTML = '<img src="' + imageData + '" alt="Logo" style="width:100%;height:100%;object-fit:cover;">';
                if (mainLogo) mainLogo.innerHTML = '<img src="' + imageData + '" alt="Logo" style="width:100%;height:100%;object-fit:cover;">';
            } else {
                if (logoPreview) logoPreview.innerHTML = '<span style="font-size:36px;color:var(--primary);">' + initials + '</span>';
                if (mainLogo) mainLogo.innerHTML = initials;
            }
        }

        function renderOwnersList() {
            const container = document.getElementById('ownersList');
            if (!container) return;
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            const currentUserEmail = localStorage.getItem('currentUser');
            
            if (!settings.owners || settings.owners.length === 0) {
                settings.owners = [currentUserEmail];
                localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            }
            
            container.innerHTML = '<p><strong>Owners:</strong> ' + settings.owners.join(', ') + '</p>';
        }

        function addOwner() {
            const email = document.getElementById('newOwnerEmail').value.trim().toLowerCase();
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
            
            if (!users[email]) {
                alert('This user does not have an account.');
                return;
            }
            
            const currentOrgId = localStorage.getItem('currentOrganization');
            if (users[email].organizationId !== currentOrgId) {
                alert('This user belongs to a different organization.');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            if (!settings.owners) settings.owners = [];
            
            if (settings.owners.includes(email)) {
                alert('This user is already an owner');
                return;
            }
            
            settings.owners.push(email);
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            
            document.getElementById('newOwnerEmail').value = '';
            renderOwnersList();
            alert('Owner added successfully!');
        }

        function renderTeachersList() {
            const container = document.getElementById('teachersList');
            if (!container) return;
            
            if (teachers.length === 0) {
                container.innerHTML = '<p>No teachers added yet.</p>';
                return;
            }
            
            container.innerHTML = teachers.map((teacher, index) => {
                const isActive = teacher.active !== false;
                return '<div style="padding:10px;background:var(--bg);border-radius:8px;margin-bottom:10px;">' +
                    '<strong>' + teacher.name + '</strong> - ' +
                    (isActive ? 'Active' : 'Inactive') +
                    ' <button class="btn-secondary" onclick="toggleTeacherStatus(' + index + ')" style="margin-left:10px;">' +
                    (isActive ? 'Deactivate' : 'Activate') +
                    '</button></div>';
            }).join('');
        }

        function toggleTeacherStatus(index) {
            const teacher = teachers[index];
            teacher.active = teacher.active === false;
            saveData();
            renderTeachersList();
            alert(teacher.name + ' has been ' + (teacher.active ? 'activated' : 'deactivated'));
        }

        function renderClassPricing() {
            const container = document.getElementById('classPricingList');
            if (!container) return;
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            
            if (!settings.sessionTypes || settings.sessionTypes.length === 0) {
                settings.sessionTypes = [
                    { name: 'Private', id: 1, defaultPrice: 120 },
                    { name: 'Duet', id: 2, defaultPrice: 60 },
                    { name: 'Trio', id: 3, defaultPrice: 45 }
                ];
                localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            }
            
            container.innerHTML = '<ul>' + settings.sessionTypes.map((type, index) => 
                '<li>' + type.name + ': $' + (type.defaultPrice || 0) + 
                ' <button class="btn-secondary" onclick="editClassPrice(' + index + ')">Edit</button>' +
                ' <button class="btn-secondary" onclick="deleteClassType(' + index + ')">Delete</button></li>'
            ).join('') + '</ul>';
        }

        function editClassPrice(index) {
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            const type = settings.sessionTypes[index];
            
            const newName = prompt('Edit class name:', type.name);
            if (newName && newName.trim()) {
                type.name = newName.trim();
            }
            
            const newPrice = prompt('Edit default price:', type.defaultPrice);
            if (newPrice && !isNaN(newPrice)) {
                type.defaultPrice = parseFloat(newPrice);
            }
            
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            renderClassPricing();
        }

        function addClassType() {
            const name = document.getElementById('newClassName').value.trim();
            const price = parseFloat(document.getElementById('newClassPrice').value) || 0;
            
            if (!name) {
                alert('Please enter a class name');
                return;
            }
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            if (!settings.sessionTypes) settings.sessionTypes = [];
            
            if (settings.sessionTypes.some(t => t.name.toLowerCase() === name.toLowerCase())) {
                alert('A class type with this name already exists');
                return;
            }
            
            settings.sessionTypes.push({
                name: name,
                id: Date.now(),
                defaultPrice: price
            });
            
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            
            document.getElementById('newClassName').value = '';
            document.getElementById('newClassPrice').value = '';
            
            renderClassPricing();
            alert('Class type added successfully!');
        }

        function deleteClassType(index) {
            if (!confirm('Delete this class type?')) return;
            
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            settings.sessionTypes.splice(index, 1);
            localStorage.setItem(getOrgKey('settings'), JSON.stringify(settings));
            
            renderClassPricing();
        }

        // ========================================
        // CALENDAR & EMAIL INTEGRATIONS
        // ========================================
        
        // Google Calendar Integration
        function connectGoogleCalendar() {
            if (localStorage.getItem(getOrgKey('google_calendar_connected'))) {
                alert('Google Calendar is already connected!');
                return;
            }
            
            // In production, this would initiate OAuth 2.0 flow with Google
            // Scope needed: https://www.googleapis.com/auth/calendar
            const clientId = 'YOUR_GOOGLE_CLIENT_ID';
            const redirectUri = window.location.origin + '/google-callback';
            const scope = 'https://www.googleapis.com/auth/calendar';
            
            // Production OAuth URL:
            // const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=${scope}`;
            // window.location.href = authUrl;
            
            if (confirm('Connect to Google Calendar?\n\nThis will allow automatic calendar event creation for sessions.\n\n(Demo mode - simulating connection)')) {
                localStorage.setItem(getOrgKey('google_calendar_connected'), 'true');
                localStorage.setItem(getOrgKey('google_calendar_token'), 'demo_token_' + Date.now());
                document.getElementById('google-status').style.display = 'block';
                alert('‚úì Successfully connected to Google Calendar!\n\nCalendar events will be created when booking sessions.');
            }
        }
        
        function disconnectGoogleCalendar() {
            if (confirm('Disconnect Google Calendar?')) {
                localStorage.removeItem(getOrgKey('google_calendar_connected'));
                localStorage.removeItem(getOrgKey('google_calendar_token'));
                document.getElementById('google-status').style.display = 'none';
                alert('Disconnected from Google Calendar');
            }
        }
        
        function createGoogleCalendarEvent(sessionData) {
            const isConnected = localStorage.getItem(getOrgKey('google_calendar_connected'));
            if (!isConnected) return;
            
            // In production: POST to https://www.googleapis.com/calendar/v3/calendars/primary/events
            const event = {
                summary: `${sessionData.type} Session - ${sessionData.clientNames}`,
                description: sessionData.notes || 'Pilates session',
                start: {
                    dateTime: new Date(sessionData.date + 'T' + sessionData.time).toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                end: {
                    dateTime: new Date(new Date(sessionData.date + 'T' + sessionData.time).getTime() + 3600000).toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                attendees: sessionData.clientEmails.map(email => ({ email }))
            };
            
            console.log('‚úì Google Calendar event created:', event.summary);
        }
        
        // Microsoft Outlook / Microsoft 365 Integration
        function connectMicrosoftOutlook() {
            if (localStorage.getItem(getOrgKey('outlook_connected'))) {
                alert('Microsoft Outlook is already connected!');
                return;
            }
            
            // In production, this would initiate OAuth 2.0 flow with Microsoft
            // Scopes needed: Calendars.ReadWrite, Mail.Send
            const clientId = 'YOUR_MICROSOFT_CLIENT_ID';
            const redirectUri = window.location.origin + '/microsoft-callback';
            const scope = 'Calendars.ReadWrite Mail.Send offline_access';
            
            // Production OAuth URL:
            // const authUrl = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${clientId}&response_type=code&redirect_uri=${redirectUri}&scope=${scope}`;
            // window.location.href = authUrl;
            
            if (confirm('Connect to Microsoft Outlook / Microsoft 365?\n\nThis enables:\n‚Ä¢ Outlook calendar event creation\n‚Ä¢ Email sending via Outlook\n‚Ä¢ Client appointment invites\n\n(Demo mode - simulating connection)')) {
                localStorage.setItem(getOrgKey('outlook_connected'), 'true');
                localStorage.setItem(getOrgKey('outlook_token'), 'demo_outlook_token_' + Date.now());
                document.getElementById('outlook-status').style.display = 'block';
                alert('‚úì Successfully connected to Microsoft Outlook!\n\nYou can now:\n‚Ä¢ Create Outlook calendar events\n‚Ä¢ Send emails via Outlook\n‚Ä¢ Access Microsoft 365 features');
            }
        }
        
        function disconnectMicrosoftOutlook() {
            if (confirm('Disconnect Microsoft Outlook?')) {
                localStorage.removeItem(getOrgKey('outlook_connected'));
                localStorage.removeItem(getOrgKey('outlook_token'));
                document.getElementById('outlook-status').style.display = 'none';
                alert('Disconnected from Microsoft Outlook');
            }
        }
        
        function createOutlookCalendarEvent(sessionData) {
            const isConnected = localStorage.getItem(getOrgKey('outlook_connected'));
            if (!isConnected) return;
            
            // In production: POST to https://graph.microsoft.com/v1.0/me/events
            const event = {
                subject: `${sessionData.type} Session - ${sessionData.clientNames}`,
                body: {
                    contentType: 'HTML',
                    content: sessionData.notes || 'Pilates session booking'
                },
                start: {
                    dateTime: new Date(sessionData.date + 'T' + sessionData.time).toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                end: {
                    dateTime: new Date(new Date(sessionData.date + 'T' + sessionData.time).getTime() + 3600000).toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                attendees: sessionData.clientEmails.map(email => ({
                    emailAddress: { address: email },
                    type: 'required'
                }))
            };
            
            console.log('‚úì Outlook Calendar event created:', event.subject);
        }
        
        function sendOutlookEmail(emailData) {
            const isConnected = localStorage.getItem(getOrgKey('outlook_connected'));
            if (!isConnected) {
                console.log('Outlook not connected, cannot send email');
                return false;
            }
            
            // In production: POST to https://graph.microsoft.com/v1.0/me/sendMail
            const message = {
                message: {
                    subject: emailData.subject,
                    body: {
                        contentType: 'HTML',
                        content: emailData.body
                    },
                    toRecipients: emailData.recipients.map(email => ({
                        emailAddress: { address: email }
                    }))
                },
                saveToSentItems: true
            };
            
            console.log('‚úì Outlook email sent:', message.message.subject);
            return true;
        }
        
        // Unified function to create calendar events across all connected platforms
        function createCalendarEventsForSession(session) {
            const clientEmails = [];
            const clientNames = [];
            
            if (session.clients && Array.isArray(session.clients)) {
                session.clients.forEach(clientId => {
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        if (client.email) clientEmails.push(client.email);
                        clientNames.push(client.name);
                    }
                });
            }
            
            const sessionData = {
                type: session.type,
                clientNames: clientNames.join(', ') || 'Client',
                clientEmails: clientEmails,
                date: session.date,
                time: session.time,
                notes: session.notes
            };
            
            let eventsCreated = 0;
            
            if (localStorage.getItem(getOrgKey('google_calendar_connected'))) {
                createGoogleCalendarEvent(sessionData);
                eventsCreated++;
            }
            
            if (localStorage.getItem(getOrgKey('outlook_connected'))) {
                createOutlookCalendarEvent(sessionData);
                eventsCreated++;
            }
            
            if (eventsCreated > 0) {
                console.log(`‚úì Created ${eventsCreated} calendar event(s) for session`);
            }
        }
        
        // QuickBooks Integration
        function connectQuickBooks() {
            if (localStorage.getItem(getOrgKey('quickbooks_connected'))) {
                alert('QuickBooks is already connected!');
                return;
            }
            
            // In production: OAuth 2.0 flow with Intuit
            if (confirm('Connect to QuickBooks Online?\n\nThis enables:\n‚Ä¢ Automatic invoice generation\n‚Ä¢ Client syncing\n‚Ä¢ Payment tracking\n\n(Demo mode - simulating connection)')) {
                localStorage.setItem(getOrgKey('quickbooks_connected'), 'true');
                localStorage.setItem(getOrgKey('quickbooks_token'), 'demo_qb_token_' + Date.now());
                document.getElementById('quickbooks-status').style.display = 'block';
                alert('‚úì Successfully connected to QuickBooks!\n\nYou can now sync clients and generate invoices.');
            }
        }
        
        function syncClientsToQuickBooks() {
            const isConnected = localStorage.getItem(getOrgKey('quickbooks_connected'));
            if (!isConnected) {
                alert('Please connect to QuickBooks first');
                return;
            }
            
            if (clients.length === 0) {
                alert('No clients to sync. Add clients first.');
                return;
            }
            
            // In production: POST to QuickBooks API to create/update customers
            console.log('Syncing ' + clients.length + ' clients to QuickBooks...');
            
            alert(`‚úì Successfully synced ${clients.length} client(s) to QuickBooks!\n\n(Demo mode - in production, clients would be created/updated in QuickBooks)`);
        }
        
        // Check integration status on page load
        function checkIntegrationStatus() {
            if (localStorage.getItem(getOrgKey('google_calendar_connected'))) {
                const statusDiv = document.getElementById('google-status');
                if (statusDiv) statusDiv.style.display = 'block';
            }
            
            if (localStorage.getItem(getOrgKey('outlook_connected'))) {
                const statusDiv = document.getElementById('outlook-status');
                if (statusDiv) statusDiv.style.display = 'block';
            }
            
            if (localStorage.getItem(getOrgKey('quickbooks_connected'))) {
                const statusDiv = document.getElementById('quickbooks-status');
                if (statusDiv) statusDiv.style.display = 'block';
            }
        }

        // ========================================
        // PAGE INITIALIZATION
        // ========================================
        
       window.addEventListener('DOMContentLoaded', function() {
            const currentUser = localStorage.getItem('currentUser');
            const currentOrg = localStorage.getItem('currentOrganization');
    
            if (!currentUser || !currentOrg) {
                window.location.href = 'login.html';
                return;
            }

            const userData = getCurrentUserData();
            if (!userData) {
                // User data not found, force logout
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentOrganization');
                window.location.href = 'login.html';
                return;
            }

            // Display user info
            const userNameEl = document.getElementById('userName');
            const userRoleEl = document.getElementById('userRole');
            if (userNameEl) userNameEl.textContent = userData.fullName || 'User';
            if (userRoleEl) {
                const roleDisplay = userData.role.charAt(0).toUpperCase() + userData.role.slice(1);
                userRoleEl.textContent = roleDisplay;
            }

            // Set studio name
            document.getElementById('mainStudioName').textContent = userData.studioName || 'Studio Flow';

            // Apply role-based UI restrictions
            const role = userData.role;
    
            // Hide tabs based on role
            if (role === 'teacher') {
                // Teachers can't see Income or Settings tabs
                const incomeTab = document.getElementById('incomeTab');
                const settingsTab = document.getElementById('settingsTab');
                if (incomeTab) incomeTab.style.display = 'none';
                if (settingsTab) settingsTab.style.display = 'none';
            }

            // Load settings logo if exists
            const settings = JSON.parse(localStorage.getItem(getOrgKey('settings')) || '{}');
            if (settings.logo) {
                updateLogoDisplay(settings.logo);
            }

            // Load all data
            loadData();
            checkIntegrationStatus();
        });
      loadData();
      checkIntegrationStatus();     
        });    
        // ========================================
        // ROLE-BASED ACCESS CONTROL FUNCTIONS
        // ========================================

        function getCurrentUserData() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) return null;
    
            const users = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
            return users[currentUser] || null;
        }
    
        function getUserRole() {
            const userData = getCurrentUserData();
            return userData ? userData.role : null;
        }

        function isOwner() {
            return getUserRole() === 'owner';
        }

        function isAdmin() {
            return getUserRole() === 'admin';
        }

        function isTeacher() {
            return getUserRole() === 'teacher';
        }

        function isOwnerOrAdmin() {
            const role = getUserRole();
            return role === 'owner' || role === 'admin';
        }

        function canAccessSettings() {
            return isOwnerOrAdmin();
        }

        function canAccessFinancials() {
            return isOwnerOrAdmin();
        }

        function canManageUsers() {
            return isOwner(); // Only owners can manage users
        }

        function getOrgKey(key) {
            const orgId = localStorage.getItem('currentOrganization');
            return `${key}_${orgId}`;
        }

        // ========================================
        // USER MANAGEMENT FUNCTIONS
        // ========================================

        function loadOrgUsers() {
            const orgId = localStorage.getItem('currentOrganization');
            const orgUsers = JSON.parse(localStorage.getItem(`org_users_${orgId}`) || '{}');
            return Object.values(orgUsers);
        }

        function addUserToOrganization(email, fullName, role, password) {
            const orgId = localStorage.getItem('currentOrganization');
            const currentUserData = getCurrentUserData();
    
            if (!canManageUsers()) {
                alert('Only owners can add users to the organization.');
                return false;
            }

            // Check if email already exists in global users
            const allUsers = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
            if (allUsers[email]) {
                alert('A user with this email already exists.');
                return false;
            }

    // Create user ID
        const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(7);

    // Add to global users
    allUsers[email] = {
        fullName: fullName,
        studioName: currentUserData.studioName,
        password: password,
        organizationId: orgId,
        role: role,
        createdAt: new Date().toISOString(),
        userId: userId,
        addedBy: localStorage.getItem('currentUser')
    };
    localStorage.setItem('studioFlowUsers', JSON.stringify(allUsers));

    // Add to organization users
    const orgUsers = JSON.parse(localStorage.getItem(`org_users_${orgId}`) || '{}');
    orgUsers[email] = {
        email: email,
        fullName: fullName,
        role: role,
        userId: userId,
        addedAt: new Date().toISOString(),
        addedBy: localStorage.getItem('currentUser')
    };
    localStorage.setItem(`org_users_${orgId}`, JSON.stringify(orgUsers));

    return true;
}

function removeUserFromOrganization(email) {
    if (!canManageUsers()) {
        alert('Only owners can remove users.');
        return false;
    }

    const currentUser = localStorage.getItem('currentUser');
    if (email === currentUser) {
        alert('You cannot remove yourself.');
        return false;
    }

    if (!confirm(`Are you sure you want to remove this user?\n\nEmail: ${email}\n\nThey will no longer be able to access this organization.`)) {
        return false;
    }

    const orgId = localStorage.getItem('currentOrganization');

    // Remove from organization users
    const orgUsers = JSON.parse(localStorage.getItem(`org_users_${orgId}`) || '{}');
    delete orgUsers[email];
    localStorage.setItem(`org_users_${orgId}`, JSON.stringify(orgUsers));

    // Remove from global users
    const allUsers = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
    delete allUsers[email];
    localStorage.setItem('studioFlowUsers', JSON.stringify(allUsers));

    return true;
}

function updateUserRole(email, newRole) {
    if (!canManageUsers()) {
        alert('Only owners can change user roles.');
        return false;
    }

    const currentUser = localStorage.getItem('currentUser');
    if (email === currentUser) {
        alert('You cannot change your own role.');
        return false;
    }

    const orgId = localStorage.getItem('currentOrganization');

    // Update in organization users
    const orgUsers = JSON.parse(localStorage.getItem(`org_users_${orgId}`) || '{}');
    if (orgUsers[email]) {
        orgUsers[email].role = newRole;
        localStorage.setItem(`org_users_${orgId}`, JSON.stringify(orgUsers));
    }

    // Update in global users
    const allUsers = JSON.parse(localStorage.getItem('studioFlowUsers') || '{}');
    if (allUsers[email]) {
        allUsers[email].role = newRole;
        localStorage.setItem('studioFlowUsers', JSON.stringify(allUsers));
    }

    return true;
}

// ========================================
// UI RENDERING FUNCTIONS
// ========================================

function renderUserManagement() {
    if (!canManageUsers()) {
        return '<div class="card"><p>Only organization owners can manage users.</p></div>';
    }

    const users = loadOrgUsers();
    const currentUser = localStorage.getItem('currentUser');

    let html = `
        <div class="settings-section">
            <h3>üîê User Management</h3>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Manage your team members and their access levels. Owners have full access, 
                Admins can manage settings, and Teachers can manage clients and sessions.
            </p>

            <div class="card" style="margin-bottom: 30px;">
                <h4 style="margin-bottom: 20px; color: var(--primary);">Add New User</h4>
                <form onsubmit="handleAddUser(event)" style="display: grid; gap: 15px;">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="new-user-name" required placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="new-user-email" required placeholder="john@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="new-user-password" required minlength="6" placeholder="At least 6 characters">
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="new-user-role" required>
                            <option value="">Select a role...</option>
                            <option value="admin">Admin - Can manage settings and integrations</option>
                            <option value="teacher">Teacher - Can manage clients and sessions</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">Add User</button>
                </form>
            </div>

            <div class="card">
                <h4 style="margin-bottom: 20px; color: var(--primary);">Current Users (${users.length})</h4>
                <div class="user-list">
    `;

    users.forEach(user => {
        const isCurrentUser = user.email === currentUser;
        const roleColor = user.role === 'owner' ? '#2C4A3E' : user.role === 'admin' ? '#4A6B5D' : '#D4A574';
        const roleLabel = user.role.charAt(0).toUpperCase() + user.role.slice(1);

        html += `
            <div class="user-item" style="padding: 20px; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 5px;">
                        ${user.fullName} ${isCurrentUser ? '<span style="color: var(--accent); font-size: 12px;">(You)</span>' : ''}
                    </div>
                    <div style="color: var(--text-light); font-size: 14px; margin-bottom: 8px;">
                        ${user.email}
                    </div>
                    <span style="display: inline-block; padding: 4px 12px; background: ${roleColor}; color: white; border-radius: 6px; font-size: 12px; font-weight: 600;">
                        ${roleLabel}
                    </span>
                </div>
                ${!isCurrentUser && user.role !== 'owner' ? `
                    <div style="display: flex; gap: 10px;">
                        <select onchange="handleChangeRole('${user.email}', this.value)" style="padding: 8px 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 13px;">
                            <option value="">Change Role...</option>
                            <option value="admin" ${user.role === 'admin' ? 'disabled' : ''}>Make Admin</option>
                            <option value="teacher" ${user.role === 'teacher' ? 'disabled' : ''}>Make Teacher</option>
                        </select>
                        <button onclick="handleRemoveUser('${user.email}')" class="btn-danger" style="padding: 8px 16px; background: var(--error); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            Remove
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
    });

    html += `
                </div>
            </div>
        </div>
    `;

    return html;
}

function handleAddUser(event) {
    event.preventDefault();

    const fullName = document.getElementById('new-user-name').value.trim();
    const email = document.getElementById('new-user-email').value.trim();
    const password = document.getElementById('new-user-password').value;
    const role = document.getElementById('new-user-role').value;

    if (!fullName || !email || !password || !role) {
        alert('Please fill in all fields.');
        return;
    }

    if (password.length < 6) {
        alert('Password must be at least 6 characters.');
        return;
    }

    if (addUserToOrganization(email, fullName, role, password)) {
        alert(`‚úì User added successfully!\n\n${fullName} can now log in with:\nEmail: ${email}\nPassword: [as set]\nRole: ${role}`);
        
        // Clear form
        document.getElementById('new-user-name').value = '';
        document.getElementById('new-user-email').value = '';
        document.getElementById('new-user-password').value = '';
        document.getElementById('new-user-role').value = '';

        // Refresh user list
        loadData();
    }
}

function handleRemoveUser(email) {
    if (removeUserFromOrganization(email)) {
        alert('User removed successfully.');
        loadData();
    }
}

function handleChangeRole(email, newRole) {
    if (!newRole) return;

    if (updateUserRole(email, newRole)) {
        alert(`Role updated successfully to ${newRole}.`);
        loadData();
    }
}

function renderQuickBooksSettings() {
    if (!canAccessSettings()) {
        return '';
    }

    const isConnected = localStorage.getItem(getOrgKey('quickbooks_connected'));
    
    return `
        <div class="settings-section">
            <h3>üí∞ QuickBooks Online Integration</h3>
            <p style="color: var(--text-light); margin-bottom: 20px;">
                Connect your QuickBooks Online account to automatically sync clients, generate invoices, 
                and track payments.
            </p>

            <div class="card">
                ${isConnected ? `
                    <div class="status-badge" style="background: #E8F5E9; color: #2C4A3E; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">‚úì</span>
                        <div>
                            <div style="font-weight: 600;">Connected to QuickBooks</div>
                            <div style="font-size: 12px; opacity: 0.8;">Your account is synced and ready</div>
                        </div>
                    </div>

                    <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <button onclick="syncClientsToQuickBooks()" class="btn-primary">
                            Sync Clients to QuickBooks
                        </button>
                        <button onclick="disconnectQuickBooks()" class="btn-secondary" style="background: var(--error);">
                            Disconnect QuickBooks
                        </button>
                    </div>

                    <div style="background: var(--bg); padding: 15px; border-radius: 8px; font-size: 13px; color: var(--text-light);">
                        <strong>Available Features:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px; line-height: 1.8;">
                            <li>Automatic client syncing</li>
                            <li>Invoice generation</li>
                            <li>Payment tracking</li>
                            <li>Financial reporting</li>
                        </ul>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üíº</div>
                        <h4 style="margin-bottom: 10px; color: var(--primary);">Connect QuickBooks Online</h4>
                        <p style="color: var(--text-light); margin-bottom: 25px; line-height: 1.6;">
                            Streamline your accounting by connecting QuickBooks. Automatically sync clients, 
                            generate invoices, and track all your studio finances in one place.
                        </p>
                        <button onclick="connectQuickBooks()" class="btn-primary">
                            Connect to QuickBooks
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}

function disconnectQuickBooks() {
    if (!canAccessSettings()) {
        alert('Only owners and admins can manage integrations.');
        return;
    }

    if (confirm('Disconnect QuickBooks?\n\nYou can reconnect at any time.')) {
        localStorage.removeItem(getOrgKey('quickbooks_connected'));
        localStorage.removeItem(getOrgKey('quickbooks_token'));
        alert('Disconnected from QuickBooks');
        loadData();
    }
}

// Logout function
function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('currentUser');
        localStorage.removeItem('currentOrganization');
        window.location.href = 'login.html';
    }
}


        
    </script>
</body>
</html>
                                
