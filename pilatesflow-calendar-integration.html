<!-- ADD THIS TO YOUR PILATESFLOW INDEX.HTML -->
<!-- 
Instructions:
1. Find the line with: <button class="tab" onclick="showTab('settings')">Settings</button>
2. Add this new Schedule tab button right before the Settings tab:
-->

<button class="tab" onclick="showTab('schedule')">Schedule</button>

<!-- 
3. Find the section with: <div id="settings" class="tab-content">
4. Add this new Schedule tab content right before the Settings section:
-->

<div id="schedule" class="tab-content">
    <div class="card">
        <div id="calendar-container"></div>
    </div>
</div>

<!-- 
5. Add this CSS to your existing <style> section (around line 232):
-->

<style>
/* Calendar Styles - Add to existing <style> section */
.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border);
}

.calendar-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 32px;
    font-weight: 600;
    color: var(--primary);
}

.calendar-controls {
    display: flex;
    gap: 12px;
    align-items: center;
}

.teacher-filter {
    padding: 10px 16px;
    border-radius: 8px;
    border: 2px solid var(--border);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    background: white;
    font-family: 'Montserrat', sans-serif;
}

.nav-button {
    padding: 10px 20px;
    border-radius: 8px;
    border: 2px solid var(--border);
    background: white;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
    font-family: 'Montserrat', sans-serif;
}

.nav-button:hover {
    background: var(--bg);
    border-color: var(--primary);
    color: var(--primary);
}

.nav-button.today {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    color: white;
    border-color: var(--primary);
}

.calendar-grid {
    display: flex;
    overflow-x: auto;
    min-height: 600px;
}

.time-column {
    width: 80px;
    flex-shrink: 0;
    padding-top: 60px;
}

.time-slot-label {
    height: 80px;
    display: flex;
    align-items: flex-start;
    justify-content: flex-end;
    padding-right: 12px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-light);
}

.day-column {
    flex: 1;
    position: relative;
    min-width: 150px;
}

.day-header {
    height: 60px;
    border-bottom: 2px solid var(--border);
    padding: 12px;
    text-align: center;
}

.day-header.today {
    background: var(--primary);
    color: white;
    border-radius: 8px 8px 0 0;
}

.day-name {
    font-size: 12px;
    font-weight: 600;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.day-number {
    font-size: 20px;
    font-weight: 700;
    margin-top: 4px;
}

.time-grid {
    position: relative;
    height: 1040px;
    border-right: 1px solid var(--border);
}

.time-grid-line {
    position: absolute;
    left: 0;
    right: 0;
    height: 80px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.2s;
}

.time-grid-line:hover {
    background: var(--bg);
}

.appointment-block {
    position: absolute;
    left: 4px;
    right: 4px;
    border-radius: 8px;
    padding: 8px;
    cursor: pointer;
    overflow: hidden;
    box-shadow: 0 2px 8px var(--shadow);
    transition: all 0.2s;
    color: white;
}

.appointment-block:hover {
    transform: scale(1.02);
    z-index: 10;
}

.appointment-block.pending {
    border: 2px dashed rgba(255, 255, 255, 0.5);
}

.appointment-time {
    font-size: 12px;
    font-weight: 700;
}

.appointment-client {
    font-size: 13px;
    font-weight: 600;
    margin-top: 4px;
}

.appointment-type {
    font-size: 11px;
    opacity: 0.9;
    margin-top: 2px;
}

.appointment-teacher {
    font-size: 10px;
    opacity: 0.85;
    margin-top: 4px;
    font-weight: 600;
}

.teacher-legend {
    display: flex;
    gap: 20px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.teacher-badge {
    display: flex;
    align-items: center;
    gap: 8px;
}

.teacher-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
}

.teacher-name {
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
}

.teacher-email {
    font-size: 12px;
    color: var(--text-light);
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 24px;
}

.modal-content {
    background: white;
    border-radius: 16px;
    padding: 32px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.modal-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
}

.modal-close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    font-size: 24px;
    color: var(--text-light);
}

.modal-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
}

.btn-delete {
    padding: 12px 24px;
    border-radius: 8px;
    border: 2px solid var(--error);
    background: white;
    color: var(--error);
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    font-family: 'Montserrat', sans-serif;
}

.btn-cancel {
    padding: 12px 24px;
    border-radius: 8px;
    border: 2px solid var(--border);
    background: white;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    font-family: 'Montserrat', sans-serif;
}

.btn-save {
    padding: 12px 24px;
    border-radius: 8px;
    border: none;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    color: white;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    font-family: 'Montserrat', sans-serif;
}
</style>

<!-- 
6. Add this JavaScript to your existing <script> section (at the end, before </script>):
-->

<script>
// ========================================
// CALENDAR FUNCTIONALITY
// ========================================

let calendarState = {
    selectedDate: new Date(),
    viewMode: 'all', // 'all' or teacher ID
    appointments: [],
    teachers: [
        { id: 1, name: 'Sarah Johnson', email: 'sarah@pilatesflow.com', color: '#A78BFA' },
        { id: 2, name: 'Michael Chen', email: 'michael@pilatesflow.com', color: '#FB923C' },
        { id: 3, name: 'Emma Davis', email: 'emma@pilatesflow.com', color: '#34D399' },
        { id: 4, name: 'James Wilson', email: 'james@pilatesflow.com', color: '#60A5FA' },
    ],
    appointmentTypes: [
        { id: 'private', name: 'Private Session', duration: 60, price: 100 },
        { id: 'semiprivate', name: 'Semi-Private Session', duration: 60, price: 75 },
        { id: 'group', name: 'Group Class', duration: 50, price: 30 },
        { id: 'reformer', name: 'Reformer Class', duration: 55, price: 35 },
    ]
};

function initCalendar() {
    // Load appointments from localStorage
    const stored = localStorage.getItem(getOrgKey('appointments'));
    if (stored) {
        calendarState.appointments = JSON.parse(stored);
    } else {
        // Sample appointments
        calendarState.appointments = [
            {
                id: 1,
                teacherId: 1,
                clientName: 'Emily Thompson',
                clientEmail: 'emily@email.com',
                type: 'private',
                date: getTodayString(),
                startTime: '10:00',
                duration: 60,
                status: 'confirmed'
            },
            {
                id: 2,
                teacherId: 2,
                clientName: 'John Martinez',
                clientEmail: 'john@email.com',
                type: 'group',
                date: getTodayString(),
                startTime: '14:30',
                duration: 50,
                status: 'confirmed'
            }
        ];
        saveAppointments();
    }
    
    renderCalendar();
}

function getTodayString() {
    return new Date().toISOString().split('T')[0];
}

function saveAppointments() {
    localStorage.setItem(getOrgKey('appointments'), JSON.stringify(calendarState.appointments));
}

function renderCalendar() {
    const container = document.getElementById('calendar-container');
    if (!container) return;

    const dates = getVisibleDates();
    
    let html = `
        <div class="calendar-header">
            <div>
                <div class="calendar-title">Weekly Schedule</div>
                <div class="tagline">${formatMonth(calendarState.selectedDate)}</div>
            </div>
            <div class="calendar-controls">
                <select class="teacher-filter" onchange="changeViewMode(this.value)">
                    <option value="all">All Teachers</option>
                    ${calendarState.teachers.map(t => `
                        <option value="${t.id}" ${calendarState.viewMode == t.id ? 'selected' : ''}>
                            ${t.name}
                        </option>
                    `).join('')}
                </select>
                <button class="nav-button" onclick="previousWeek()">← Previous</button>
                <button class="nav-button today" onclick="goToToday()">Today</button>
                <button class="nav-button" onclick="nextWeek()">Next →</button>
            </div>
        </div>

        <div class="teacher-legend">
            ${calendarState.teachers.map(t => `
                <div class="teacher-badge">
                    <div class="teacher-color" style="background: ${t.color};"></div>
                    <div>
                        <div class="teacher-name">${t.name}</div>
                        <div class="teacher-email">${t.email}</div>
                    </div>
                </div>
            `).join('')}
        </div>

        <div class="calendar-grid" style="margin-top: 30px;">
            <div class="time-column">
                ${generateTimeLabels()}
            </div>
            ${dates.map(date => renderDayColumn(date)).join('')}
        </div>
    `;

    container.innerHTML = html;
}

function generateTimeLabels() {
    let html = '';
    for (let hour = 8; hour <= 20; hour++) {
        const time = `${hour.toString().padStart(2, '0')}:00`;
        html += `<div class="time-slot-label">${time}</div>`;
    }
    return html;
}

function renderDayColumn(date) {
    const dateString = date.toISOString().split('T')[0];
    const isToday = dateString === getTodayString();
    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
    const dayNumber = date.getDate();
    const appointments = getAppointmentsForDate(dateString);

    let html = `
        <div class="day-column">
            <div class="day-header ${isToday ? 'today' : ''}">
                <div class="day-name">${dayName.toUpperCase()}</div>
                <div class="day-number">${dayNumber}</div>
            </div>
            <div class="time-grid">
    `;

    // Time grid lines
    for (let i = 0; i < 13; i++) {
        const hour = 8 + i;
        const time = `${hour.toString().padStart(2, '0')}:00`;
        html += `<div class="time-grid-line" style="top: ${i * 80}px;" onclick="createAppointment('${dateString}', '${time}')"></div>`;
    }

    // Appointments
    appointments.forEach(apt => {
        const teacher = calendarState.teachers.find(t => t.id === apt.teacherId);
        const style = getAppointmentStyle(apt);
        const type = calendarState.appointmentTypes.find(t => t.id === apt.type);
        
        html += `
            <div class="appointment-block ${apt.status === 'pending' ? 'pending' : ''}" 
                 style="top: ${style.top}; height: ${style.height}; background: ${teacher.color};"
                 onclick="editAppointment(${apt.id})">
                <div class="appointment-time">${apt.startTime}</div>
                <div class="appointment-client">${apt.clientName}</div>
                <div class="appointment-type">${type?.name || apt.type}</div>
                ${calendarState.viewMode === 'all' ? `<div class="appointment-teacher">${teacher.name}</div>` : ''}
            </div>
        `;
    });

    html += `
            </div>
        </div>
    `;

    return html;
}

function getAppointmentStyle(appointment) {
    const [hours, minutes] = appointment.startTime.split(':').map(Number);
    const startMinutes = hours * 60 + minutes;
    const startOfDay = 8 * 60; // 8 AM
    const pixelsPerMinute = 80 / 60;
    
    const top = (startMinutes - startOfDay) * pixelsPerMinute;
    const height = appointment.duration * pixelsPerMinute;
    
    return {
        top: `${top}px`,
        height: `${height}px`
    };
}

function getAppointmentsForDate(dateString) {
    return calendarState.appointments.filter(apt => {
        const matchesDate = apt.date === dateString;
        const matchesTeacher = calendarState.viewMode === 'all' || apt.teacherId == calendarState.viewMode;
        return matchesDate && matchesTeacher;
    });
}

function getVisibleDates() {
    const dates = [];
    const startDate = new Date(calendarState.selectedDate);
    const dayOfWeek = startDate.getDay();
    const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Monday
    startDate.setDate(startDate.getDate() + diff);
    
    for (let i = 0; i < 5; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        dates.push(date);
    }
    return dates;
}

function formatMonth(date) {
    return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
}

function changeViewMode(value) {
    calendarState.viewMode = value === 'all' ? 'all' : parseInt(value);
    renderCalendar();
}

function previousWeek() {
    calendarState.selectedDate.setDate(calendarState.selectedDate.getDate() - 7);
    renderCalendar();
}

function nextWeek() {
    calendarState.selectedDate.setDate(calendarState.selectedDate.getDate() + 7);
    renderCalendar();
}

function goToToday() {
    calendarState.selectedDate = new Date();
    renderCalendar();
}

function createAppointment(date, time) {
    showAppointmentModal(null, { date, time });
}

function editAppointment(appointmentId) {
    const appointment = calendarState.appointments.find(a => a.id === appointmentId);
    if (appointment) {
        showAppointmentModal(appointment);
    }
}

function showAppointmentModal(appointment, slot) {
    const isEdit = !!appointment;
    const formData = appointment || {
        teacherId: calendarState.teachers[0].id,
        clientName: '',
        clientEmail: '',
        type: calendarState.appointmentTypes[0].id,
        date: slot?.date || '',
        startTime: slot?.time || '10:00',
        duration: calendarState.appointmentTypes[0].duration,
    };

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">${isEdit ? 'Edit Appointment' : 'New Appointment'}</h2>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            <form class="modal-form" onsubmit="saveAppointmentFromModal(event, ${isEdit ? appointment.id : 'null'})">
                <div class="form-group">
                    <label>Teacher</label>
                    <select id="apt-teacher" required>
                        ${calendarState.teachers.map(t => `
                            <option value="${t.id}" ${formData.teacherId == t.id ? 'selected' : ''}>
                                ${t.name}
                            </option>
                        `).join('')}
                    </select>
                </div>

                <div class="form-group">
                    <label>Client Name</label>
                    <input type="text" id="apt-client-name" value="${formData.clientName}" required 
                           placeholder="Client name">
                </div>

                <div class="form-group">
                    <label>Client Email</label>
                    <input type="email" id="apt-client-email" value="${formData.clientEmail}" required 
                           placeholder="client@email.com">
                </div>

                <div class="form-group">
                    <label>Session Type</label>
                    <select id="apt-type" required onchange="updateDuration()">
                        ${calendarState.appointmentTypes.map(t => `
                            <option value="${t.id}" data-duration="${t.duration}" ${formData.type === t.id ? 'selected' : ''}>
                                ${t.name} (${t.duration} min - $${t.price})
                            </option>
                        `).join('')}
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="apt-date" value="${formData.date}" required>
                    </div>
                    <div class="form-group">
                        <label>Start Time</label>
                        <input type="time" id="apt-time" value="${formData.startTime}" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Duration (minutes)</label>
                    <input type="number" id="apt-duration" value="${formData.duration}" 
                           min="15" step="5" required>
                </div>

                <div class="modal-actions">
                    ${isEdit ? '<button type="button" class="btn-delete" onclick="deleteAppointmentFromModal(' + appointment.id + ')">Delete</button>' : ''}
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-save">${isEdit ? 'Update' : 'Create'}</button>
                </div>
            </form>
        </div>
    `;

    document.body.appendChild(modal);
}

function updateDuration() {
    const typeSelect = document.getElementById('apt-type');
    const selectedOption = typeSelect.options[typeSelect.selectedIndex];
    const duration = selectedOption.getAttribute('data-duration');
    document.getElementById('apt-duration').value = duration;
}

function saveAppointmentFromModal(event, appointmentId) {
    event.preventDefault();

    const formData = {
        teacherId: parseInt(document.getElementById('apt-teacher').value),
        clientName: document.getElementById('apt-client-name').value.trim(),
        clientEmail: document.getElementById('apt-client-email').value.trim(),
        type: document.getElementById('apt-type').value,
        date: document.getElementById('apt-date').value,
        startTime: document.getElementById('apt-time').value,
        duration: parseInt(document.getElementById('apt-duration').value),
        status: 'confirmed'
    };

    if (appointmentId) {
        // Update existing
        const index = calendarState.appointments.findIndex(a => a.id === appointmentId);
        if (index !== -1) {
            calendarState.appointments[index] = { ...formData, id: appointmentId };
            alert('✓ Appointment updated!');
        }
    } else {
        // Create new
        const newId = Math.max(0, ...calendarState.appointments.map(a => a.id)) + 1;
        calendarState.appointments.push({ ...formData, id: newId });
        alert('✓ Appointment created!');
    }

    saveAppointments();
    closeModal();
    renderCalendar();
}

function deleteAppointmentFromModal(appointmentId) {
    if (confirm('Delete this appointment?')) {
        calendarState.appointments = calendarState.appointments.filter(a => a.id !== appointmentId);
        saveAppointments();
        alert('✓ Appointment deleted');
        closeModal();
        renderCalendar();
    }
}

function closeModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// Initialize calendar when Schedule tab is shown
const originalShowTab = showTab;
showTab = function(tabName) {
    originalShowTab(tabName);
    if (tabName === 'schedule') {
        setTimeout(() => initCalendar(), 100);
    }
};
</script>

<!-- 
7. That's it! Your calendar is integrated.

To test:
- Save your HTML file
- Open it in a browser
- Click on the "Schedule" tab
- You should see a working calendar!

Features:
✓ Click empty time slots to create appointments
✓ Click appointments to edit them
✓ Filter by teacher or view all
✓ Navigate weeks
✓ All data saves to localStorage automatically

Note: This version doesn't send emails. To add email functionality, 
you'd need to set up the backend server as described in the other files.
-->
